
window.rcmail&&rcmail.addEventListener("init",function(a){var c=window.crm=getCrmWindow();var b=rcmail.env.site_URL+"index.php?";rcmail.env.compose_commands.push("yetiforce.addFilesToMail");rcmail.env.compose_commands.push("yetiforce.addFilesFromCRM");rcmail.register_command("yetiforce.addFilesToMail",function(f){var e=new Date().getTime(),d="rcmupload"+e,g=rcmail.async_upload_form_frame(d);f._uploadid=e;jQuery.ajax({url:"?_task=mail&_action=plugin.yetiforce.addFilesToMail&_id="+rcmail.env.compose_id,type:"POST",data:f,success:function(i){var j=g[0].contentWindow.document;var h=$("html",j);h.html(i)}})},true);rcmail.register_command("yetiforce.addFilesFromCRM",function(f){if(c!=false){var h={module:"Documents",src_module:"Documents",multi_select:true,url:b};var g=$(this);var d=jQuery.Event(c.Vtiger_Edit_Js.preReferencePopUpOpenEvent);g.trigger(d);var f={};var e=c.Vtiger_Popup_Js.getInstance();c.show(h,function(k){var j=JSON.parse(k);var i=[];for(var l in j){i.push(l)}rcmail.command("yetiforce.addFilesToMail",{ids:i,_uploadid:new Date().getTime()})})}},true);$("#composeheaders #oss_btn_bar .oss_btn").click(function(){var e=$(this).attr("data-input");var d=$(this).attr("data-module");var g={module:d,src_module:d,multi_select:true,url:b};var f=c.Vtiger_Popup_Js.getInstance();c.show(g,function(j){var h=JSON.parse(j);var i=Object.keys(h).length;for(var k in h){getMail(e,d,k,i)}})});jQuery.ajax({type:"Get",url:b+"module=OSSMailTemplates&action=GetTemplates",async:false,success:function(g){var d=[];var e=[];var f=[];$.each(g.result,function(h,i){e.push({name:i.module,label:i.moduleName});jQuery("#tplmenu #texttplsmenu").append('<li class="'+i.module+'"><a href="#" data-module="'+i.module+'" data-tplid="'+i.id+'" class="active">'+i.name+"</a></li>")});$.each(e,function(h,i){if(jQuery.inArray(i.name,d)==-1){jQuery("#vtmodulemenu .toolbarmenu").append('<li class="'+i.name+'"><a href="#" data-module="'+i.name+'" class="active">'+i.label+"</a></li>");d.push(i.name)}})}});jQuery("#vtmodulemenu li a").on("click",function(){var d=jQuery(this).data("module");if(d==undefined){jQuery("#tplmenu li").show()}else{jQuery("#tplmenu li."+d).show();jQuery("#tplmenu li").not("."+d).hide()}});if(rcmail.env.crmModule!=undefined){jQuery("#vtmodulemenu li."+rcmail.env.crmModule+" a").trigger("click")}jQuery("#tplmenu  li a").on("click",function(){var h=jQuery(this).data("tplid");var f=rcmail.env.crmRecord,e=rcmail.env.crmModule,d=rcmail.env.crmView;if(d=="List"){var g=jQuery(c.document).find(".listViewEntriesCheckBox")[0];f=jQuery(g).val()}jQuery.ajax({type:"Get",url:b+"module=OSSMailTemplates&action=GetTpl",data:{id:h,record_id:f,select_module:e},success:function(l){var j=jQuery('[name="_subject"]').val();var k=jQuery("<div/>").html(l.result.content).html();jQuery('[name="_subject"]').val(j+l.result.subject);if(window.tinyMCE&&(ed=tinyMCE.get(rcmail.env.composebody))){var i=tinyMCE.activeEditor.getContent();tinymce.activeEditor.setContent(k+i)}else{var i=jQuery("#composebody").val();jQuery("#composebody").val(k+i)}if(l.result.hasOwnProperty("attachments")){rcmail.command("yetiforce.addFilesToMail",l.result.attachments)}}})})});function getCrmWindow(){if(opener!==null){return opener.parent}else{if(typeof parent.app=="object"){return parent}}return false}function getMail(c,b,a,d){var e={module:"OSSMail",action:"getContactMail",mod:b,ids:a};window.crm.AppConnector.request(e).then(function(h){var l=h.result;var j=false;var f=$("#"+c).val();if(f!=""&&f.charAt(f.length-1)!=","){f=f+","}if(l.length==0){var i={text:window.crm.app.vtranslate("NoFindEmailInRecord"),animation:"show"};window.crm.Vtiger_Helper_Js.showPnotify(i)}if(l.length>1&&d==1){var k={module:"OSSMail",view:"selectEmail",resp:l};window.crm.AppConnector.request(k).then(function(m){var n={};n.cb=function(o){o.find("button.btn-success").click(function(q){var p=l[0].name+" <"+o.find("[name=selectedFields]:checked").val()+">";$("#"+c).val(f+p);window.crm.app.hideModalWindow()})};n.data=m;window.crm.app.showModalWindow(n)})}else{if(l.length>1&&d>1){j=true}}if(l.length==1||j){var g=l[0].name+" <"+l[0].email+">";$("#"+c).val(f+g)}})};