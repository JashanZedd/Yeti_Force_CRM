"use strict";var classCallCheck=function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")},createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),MultiImage=function(){function MultiImage(element){classCallCheck(this,MultiImage);var thisInstance=this;this.elements={},this.options={zoomTitleAnimation:{in:"fadeIn",out:"fadeOut"},showCarousel:!0},this.detailView=!1,this.elements.fileInput=element.find(".js-multi-image__file").eq(0),0===this.elements.fileInput.length&&(this.detailView=!0),this.elements.component=element.eq(0),this.elements.form=element.closest("form").eq(0),$(this.elements.form).on("submit",this.onFormSubmit),this.elements.addButton=this.elements.component.find(".js-multi-image__file-btn").eq(0),this.elements.values=this.elements.component.find(".js-multi-image__values").eq(0),this.elements.progressBar=this.elements.component.find(".js-multi-image__progress-bar").eq(0),this.elements.progress=this.elements.component.find(".js-multi-image__progress").eq(0),this.elements.result=this.elements.component.find(".js-multi-image__result").eq(0),this.fieldInfo=this.elements.values.data("fieldinfo"),this.options.formats=this.fieldInfo.formats,this.options.limit=this.fieldInfo.limit,this.detailView?this.files=this.elements.values.data("value"):this.files=JSON.parse(this.elements.values.val()),this.detailView||(this.elements.fileInput.detach(),this.elements.addButton.click(this.addButtonClick.bind(this)),this.elements.fileInput.fileupload({dataType:"json",replaceFileInput:!1,fileInput:this.fileInput,autoUpload:!1,submit:this.submit.bind(this),add:this.add.bind(this),progressall:this.progressAll.bind(this),change:this.change.bind(this),drop:this.change.bind(this),dragover:this.dragOver.bind(this),fail:this.uploadError.bind(this),done:this.uploadSuccess.bind(this)}),this.elements.component.on("dragleave",this.dragLeave.bind(this)),this.elements.component.on("dragend",this.dragLeave.bind(this)),this.elements.fileInput.fileupload("option","dropZone",$(this.elements.component)),this.enableDragNDrop()),this.elements.component.on("click",".js-multi-image__popover-img",(function(e){thisInstance.zoomPreview($(this).data("hash"))})),this.elements.component.on("click",".js-multi-image__popover-btn-zoom",(function(e){e.preventDefault(),thisInstance.zoomPreview($(this).data("hash"))})),this.elements.component.on("click",".js-multi-image__popover-btn-download",(function(e){e.preventDefault(),thisInstance.download($(this).data("hash"))})),this.detailView||this.elements.component.on("click",".js-multi-image__popover-btn-delete",(function(e){e.preventDefault(),thisInstance.deleteFile($(this).data("hash"))})),this.loadExistingFiles(),void 0===$.fn.animateCss&&$.fn.extend({animateCss:function(animationName,callback){var animationEnd=function(el){var animations={animation:"animationend",OAnimation:"oAnimationEnd",MozAnimation:"mozAnimationEnd",WebkitAnimation:"webkitAnimationEnd"};for(var t in animations)if(void 0!==el.style[t])return animations[t]}(document.createElement("div"));return this.addClass("animated "+animationName).one(animationEnd,(function(){$(this).removeClass("animated "+animationName),"function"==typeof callback&&callback()})),this}})}return createClass(MultiImage,[{key:"onFormSubmit",value:function(e){return!App.Fields.MultiImage.currentFileUploads||(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),bootbox.alert(app.vtranslate("JS_WAIT_FOR_FILE_UPLOAD")),!1)}},{key:"addButtonClick",value:function(e){e.preventDefault(),this.elements.fileInput.trigger("click")}},{key:"submit",value:function(e,data){data.formData={hash:data.files[0].hash},App.Fields.MultiImage.currentFileUploads++}},{key:"getFileInfo",value:function(hash){for(var i=0,len=this.files.length;i<len;i++){var file=this.files[i];if(file.hash===hash)return file}app.errorLog("File '"+hash+"' not found."),Vtiger_Helper_Js.showPnotify({text:app.vtranslate("JS_INVALID_FILE_HASH")+" ["+hash+"]"})}},{key:"addFileInfoProperty",value:function(hash,propertyName,value){var fileInfo=this.getFileInfo(hash);return fileInfo[propertyName]=value,fileInfo}},{key:"uploadError",value:function(e,data){var _this=this;app.errorLog("File upload error.");var jqXHR=data.jqXHR,files=data.files;if(void 0===jqXHR.responseJSON||null===jqXHR.responseJSON)return App.Fields.MultiImage.currentFileUploads--,Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_FILE_UPLOAD_ERROR"));var response=jqXHR.responseJSON;if(void 0!==response.result&&void 0!==response.result.attach&&Array.isArray(response.result.attach))return response.result.attach.forEach((function(fileAttach){App.Fields.MultiImage.currentFileUploads--,_this.deleteFile(fileAttach.hash,!1),"string"==typeof fileAttach.error?Vtiger_Helper_Js.showPnotify(fileAttach.error+" ["+fileAttach.name+"]"):Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_FILE_UPLOAD_ERROR")+" ["+fileAttach.name+"]")})),void this.updateFormValues();files.forEach((function(file){App.Fields.MultiImage.currentFileUploads--,_this.deleteFile(file.hash,!1),Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_FILE_UPLOAD_ERROR")+" ["+file.name+"]")})),this.updateFormValues()}},{key:"uploadSuccess",value:function(e,data){var _this2=this;data.result.result.attach.forEach((function(fileAttach){var hash=fileAttach.hash;if(!hash)return app.errorLog(new Error(app.vtranslate("JS_INVALID_FILE_HASH")+" ["+hash+"]"));if(void 0===fileAttach.key)return _this2.uploadError(e,data);void 0!==fileAttach.info&&fileAttach.info&&Vtiger_Helper_Js.showPnotify({type:"notice",text:fileAttach.info+" ["+fileAttach.name+"]"});var fileInfo=_this2.getFileInfo(hash);_this2.addFileInfoProperty(hash,"key",fileAttach.key),_this2.addFileInfoProperty(hash,"size",fileAttach.size),_this2.addFileInfoProperty(hash,"name",fileAttach.name),_this2.removePreviewPopover(hash),_this2.addPreviewPopover(fileInfo.file,fileInfo.previewElement,fileInfo.imageSrc),App.Fields.MultiImage.currentFileUploads--})),this.updateFormValues()}},{key:"updateFormValues",value:function(){this.elements.fileInput.val(null);var formValues=this.files.map((function(file){return{key:file.key,name:file.name,size:file.size}}));this.elements.values.val(JSON.stringify(formValues))}},{key:"validateFile",value:function(file){var valid=!1;return this.options.formats.forEach((function(format){file.type==="image/"+format&&(valid=!0)})),valid||Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_INVALID_FILE_TYPE")+" ["+file.name+"]\n"+app.vtranslate("JS_AVAILABLE_FILE_TYPES")+"  ["+this.options.formats.join(", ")+"]"),valid}},{key:"showLimitError",value:function(){this.elements.fileInput.val(""),Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_FILE_LIMIT")+" ["+this.options.limit+"]")}},{key:"filterValidFiles",value:function(files){var _this3=this;return files.length+this.files.length>this.options.limit?(this.showLimitError(),[]):files.filter((function(file){return _this3.validateFile(file)}))}},{key:"setFilesHash",value:function(files){for(var addedFiles=[],i=0,len=files.length;i<len;i++){var file=files[i];if(void 0===file.hash){if(!(this.files.length<this.options.limit))return this.showLimitError(),addedFiles;file.hash=App.Fields.Text.generateRandomHash(CONFIG.userId),this.files.push({hash:file.hash,imageSrc:file.imageSrc,name:file.name,file:file}),addedFiles.push(file)}}return addedFiles}},{key:"add",value:function(e,data){data.files.length>0&&data.submit()}},{key:"progressAll",value:function(e,data){var _this4=this,progress=parseInt(data.loaded/data.total*100,10);this.elements.progressBar.css({width:progress+"%"}),100===progress?setTimeout((function(){_this4.elements.progress.addClass("d-none"),_this4.elements.progressBar.css({width:"0%"})}),1e3):this.elements.progress.removeClass("d-none")}},{key:"dragOver",value:function(e){this.elements.component.addClass("c-multi-image__drop-effect")}},{key:"dragLeave",value:function(e){this.elements.component.removeClass("c-multi-image__drop-effect")}},{key:"download",value:function(hash){return"file.php"===this.getFileInfo(hash).imageSrc.substr(0,8).toLowerCase()?this.downloadFile(hash):this.downloadBase64(hash)}},{key:"downloadFile",value:function(hash){var fileInfo=this.getFileInfo(hash),link=document.createElement("a");$(link).css("display","none"),"string"==typeof link.download?(document.body.appendChild(link),link.download=fileInfo.name,link.href=fileInfo.imageSrc,link.click(),document.body.removeChild(link)):location.replace(fileInfo.imageSrc)}},{key:"downloadBase64",value:function(hash){var fileInfo=this.getFileInfo(hash),imageUrl="data:application/octet-stream;filename="+fileInfo.name+";base64,"+fileInfo.imageSrc.split(",")[1],link=document.createElement("a");$(link).css("display","none"),"string"==typeof link.download?(document.body.appendChild(link),link.download=fileInfo.name,link.href=imageUrl,link.click(),document.body.removeChild(link)):location.replace(imageUrl)}},{key:"zoomPreview",value:function(hash){var _this5=this,thisInstance=this,fileInfo=this.getFileInfo(hash),titleTemplate=function(){return'<i class="fa fa-image"></i> '+fileInfo.name},bootboxOptions={size:"large",backdrop:!0,onEscape:!0,title:'<span id="bootbox-title-'+hash+'" class="animated '+this.options.zoomTitleAnimation.in+'">'+titleTemplate()+"</span>",message:'<img src="'+fileInfo.imageSrc+'" class="w-100" />',buttons:{}};this.options.showCarousel&&(bootboxOptions.message=this.generateCarousel(hash)),this.detailView||(bootboxOptions.buttons.Delete={label:'<i class="fa fa-trash-alt"></i> '+app.vtranslate("JS_DELETE"),className:"float-left btn btn-danger",callback:function(){thisInstance.deleteFile(fileInfo.hash)}}),bootboxOptions.buttons.Download={label:'<i class="fa fa-download"></i> '+app.vtranslate("JS_DOWNLOAD"),className:"float-left btn btn-success",callback:function(){thisInstance.download(fileInfo.hash)}},bootboxOptions.buttons.Close={label:'<i class="fa fa-times"></i> '+app.vtranslate("JS_CLOSE"),className:"btn btn-warning",callback:function(){}},bootbox.dialog(bootboxOptions),this.options.showCarousel&&($("#bootbox-title-"+hash).css({"animation-duration":"350ms"}),$("#carousel-"+hash).on("slide.bs.carousel",(function(e){fileInfo=_this5.getFileInfo($(e.relatedTarget).data("hash"));var aniIn=_this5.options.zoomTitleAnimation.in,aniOut=_this5.options.zoomTitleAnimation.out;$("#bootbox-title-"+hash).animateCss(aniOut,(function(){$("#bootbox-title-"+hash).html(titleTemplate()).removeClass("animated "+aniOut).animateCss(aniIn)}))})))}},{key:"deleteFileCallback",value:function(hash){var fileInfo=this.getFileInfo(hash);fileInfo.previewElement.popover("dispose").remove(),this.files=this.files.filter((function(file){return file.hash!==fileInfo.hash})),this.updateFormValues()}},{key:"deleteFile",value:function(hash){var _this6=this,showConfirmation=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(showConfirmation){var fileInfo=this.getFileInfo(hash);bootbox.confirm({title:'<i class="fa fa-trash-alt"></i> '+app.vtranslate("JS_DELETE_FILE"),message:app.vtranslate("JS_DELETE_FILE_CONFIRMATION")+' <span class="font-weight-bold">'+fileInfo.name+"</span>?",callback:function(result){result&&_this6.deleteFileCallback(hash)}})}else this.deleteFileCallback(hash)}},{key:"change",value:function(e,data){var _this7=this;data.files=this.filterValidFiles(data.files),data.files=this.setFilesHash(data.files),this.dragLeave(e),data.files.length&&this.generatePreviewElements(data.files,(function(element){_this7.redraw()}))}},{key:"addPreviewPopover",value:function(file,template,imageSrc){var fileSize="",fileInfo=this.getFileInfo(file.hash);void 0!==fileInfo.size&&(fileSize='<div class="p-1 bg-white border rounded small position-absolute">'+fileInfo.size+"</div>");var deleteBtn="";return this.detailView||(deleteBtn='<button class="btn btn-sm btn-danger c-btn-collapsible js-multi-image__popover-btn-delete" type="button" data-hash="'+file.hash+'" data-js="click"><i class="fa fa-trash-alt"></i> <span class="c-btn-collapsible__text">'+app.vtranslate("JS_DELETE")+"</span></button>"),$(template).popover({container:this.elements.component,title:'<div class="u-text-ellipsis"><i class="fa fa-image"></i> '+file.name+"</div>",html:!0,sanitize:!1,trigger:"focus",placement:"top",content:'<img src="'+imageSrc+'" class="w-100 js-multi-image__popover-img c-multi-image__popover-img" data-hash="'+file.hash+'" data-js="click"/>',template:'<div class="popover" role="tooltip">\n\t\t\t\t<div class="arrow"></div>\n\t\t\t\t<h3 class="popover-header"></h3>\n\t\t\t\t<div class="popover-body"></div>\n\t\t\t\t<div class="text-right popover-footer js-multi-image__popover-actions">\n\t\t\t\t\t'+fileSize+"\n\t\t\t\t\t"+deleteBtn+'\n\t\t\t\t\t<button class="btn btn-sm btn-success c-btn-collapsible js-multi-image__popover-btn-download" type="button" data-hash="'+file.hash+'" data-js="click"><i class="fa fa-download"></i> <span class="c-btn-collapsible__text">'+app.vtranslate("JS_DOWNLOAD")+'</span></button>\n\t\t\t\t\t<button class="btn btn-sm btn-primary c-btn-collapsible js-multi-image__popover-btn-zoom" type="button" data-hash="'+file.hash+'" data-js="click"><i class="fa fa-search-plus"></i> <span class="c-btn-collapsible__text">'+app.vtranslate("JS_ZOOM_IN")+"</span></button>\n\t\t\t\t</div>\n\t\t\t</div>"})}},{key:"removePreviewPopover",value:function(hash){var fileInfo=this.getFileInfo(hash);void 0!==fileInfo.previewElement&&fileInfo.previewElement.popover("dispose")}},{key:"sortOver",value:function(e,ui){this.elements.result.find(".js-multi-image__preview").popover("hide")}},{key:"sortStop",value:function(e,ui){var _this8=this,actualElements=this.elements.result.find(".js-multi-image__preview").toArray();this.files=actualElements.map((function(element){for(var i=0,len=_this8.files.length;i<len;i++){var elementHash=$(element).data("hash");if(_this8.files[i].hash===elementHash)return _this8.files[i]}})),this.redraw()}},{key:"redraw",value:function(){var _this9=this;this.files.forEach((function(file){_this9.elements.result.append(file.previewElement)})),this.updateFormValues()}},{key:"enableDragNDrop",value:function(){this.elements.result.sortable({handle:".js-multi-image__preview-img",items:".js-multi-image__preview",over:this.sortOver.bind(this),stop:this.sortStop.bind(this)}).disableSelection().on("mousedown",".js-multi-image__preview-img",(function(e){this.focus()}))}},{key:"generatePreviewElements",value:function(files,callback){var _this10=this;files.forEach((function(file){file instanceof File?_this10.generatePreviewFromFile(file,(function(template,imageSrc){file.preview=_this10.addPreviewPopover(file,template,imageSrc),_this10.addFileInfoProperty(file.hash,"previewElement",file.preview),callback(file.preview)})):_this10.generatePreviewFromValue(file,(function(template,imageSrc){file.preview=_this10.addPreviewPopover(file,template,imageSrc),_this10.addFileInfoProperty(file.hash,"previewElement",file.preview),callback(file.preview)}))}))}},{key:"generatePreviewFromFile",value:function(file,callback){var _this11=this,fr=new FileReader;fr.onload=function(){file.imageSrc=fr.result,_this11.addFileInfoProperty(file.hash,"imageSrc",file.imageSrc),callback('<div class="d-inline-block mr-1 js-multi-image__preview" id="js-multi-image__preview-hash-'+file.hash+'" data-hash="'+file.hash+'" data-js="container|click">\n\t\t\t\t\t<div class="img-thumbnail js-multi-image__preview-img c-multi-image__preview-img" data-hash="'+file.hash+'" data-js="drag" style="background-image:url('+fr.result+')" tabindex="0" title="'+file.name+'"></div>\n\t\t\t</div>',fr.result)},fr.readAsDataURL(file)}},{key:"generatePreviewFromValue",value:function(file,callback){callback('<div class="d-inline-block mr-1 js-multi-image__preview" id="js-multi-image__preview-hash-'+file.hash+'" data-hash="'+file.hash+'" data-js="container|click">\n\t\t\t\t<div class="img-thumbnail js-multi-image__preview-img c-multi-image__preview-img" data-hash="'+file.hash+'" data-js="drag" style="background-image:url('+file.imageSrc+')" tabindex="0" title="'+file.name+'"></div>\n\t\t</div>',file.imageSrc)}},{key:"loadExistingFiles",value:function(){var _this12=this;this.files=this.files.map((function(file){return file.hash=App.Fields.Text.generateRandomHash(CONFIG.userId),file})).slice(0,this.options.limit),this.generatePreviewElements(this.files,(function(element){_this12.elements.result.append(element)})),this.updateFormValues()}},{key:"generateCarousel",value:function(hash){if(this.files.length<=1)return'<img class="d-block w-100" src="'+this.getFileInfo(hash).imageSrc+'">';var template='<div id="carousel-'+hash+'" class="carousel slide c-carousel" data-ride="carousel" data-js="container">\n\t\t  <div class="carousel-inner">';return this.files.forEach((function(file){template+='<div class="carousel-item c-carousel__item',file.hash===hash&&(template+=" active"),template+='" data-hash="'+file.hash+'">\n\t\t      <img class="d-block w-100 c-carousel__image" src="'+file.imageSrc+'">\n\t\t    </div>'})),template+='<a class="carousel-control-prev c-carousel__prevnext-btn c-carousel__prev-btn" href="#carousel-'+hash+'" role="button" data-slide="prev" data-js="click">\n\t\t    <span class="fas fa-caret-left fa-2x c-carousel__prev-icon mr-1" aria-hidden="true"></span>\n\t\t  </a>\n\t\t  <a class="carousel-control-next c-carousel__prevnext-btn c-carousel__next-btn" href="#carousel-'+hash+'" role="button" data-slide="next" data-js="click">\n\t\t    <span class="fas fa-caret-right fa-2x c-carousel__next-icon ml-1" aria-hidden="true"></span>\n\t\t  </a>\n\t\t</div>'}}]),MultiImage}();
//# sourceMappingURL=MultiImage.min.js.map
