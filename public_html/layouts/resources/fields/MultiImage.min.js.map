{"version":3,"file":"MultiImage.min.js","sources":["MultiImage.js"],"sourcesContent":["/* {[The file is published on the basis of YetiForce Public License 3.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */\n'use strict';\n\nclass MultiImage {\n\t/**\n\t * Create class instance\n\t *\n\t * @param {HTMLElement|jQuery} inputElement - input type file element inside component\n\t */\n\tconstructor(element) {\n\t\tconst thisInstance = this;\n\t\tthis.elements = {};\n\t\tthis.options = {\n\t\t\tzoomTitleAnimation: {\n\t\t\t\tin: 'fadeIn',\n\t\t\t\tout: 'fadeOut'\n\t\t\t},\n\t\t\tshowCarousel: true\n\t\t};\n\t\tthis.detailView = false;\n\t\tthis.elements.fileInput = element.find('.js-multi-image__file').eq(0);\n\t\tif (this.elements.fileInput.length === 0) {\n\t\t\tthis.detailView = true;\n\t\t}\n\t\tthis.elements.component = element.eq(0);\n\t\tthis.elements.form = element.closest('form').eq(0);\n\t\t$(this.elements.form).on('submit', this.onFormSubmit);\n\t\tthis.elements.addButton = this.elements.component.find('.js-multi-image__file-btn').eq(0);\n\t\tthis.elements.values = this.elements.component.find('.js-multi-image__values').eq(0);\n\t\tthis.elements.progressBar = this.elements.component.find('.js-multi-image__progress-bar').eq(0);\n\t\tthis.elements.progress = this.elements.component.find('.js-multi-image__progress').eq(0);\n\t\tthis.elements.result = this.elements.component.find('.js-multi-image__result').eq(0);\n\t\tthis.fieldInfo = this.elements.values.data('fieldinfo');\n\t\tthis.options.formats = this.fieldInfo.formats;\n\t\tthis.options.limit = this.fieldInfo.limit;\n\t\tif (!this.detailView) {\n\t\t\tthis.files = JSON.parse(this.elements.values.val());\n\t\t} else {\n\t\t\tthis.files = this.elements.values.data('value');\n\t\t}\n\t\tif (!this.detailView) {\n\t\t\tthis.elements.fileInput.detach();\n\t\t\tthis.elements.addButton.click(this.addButtonClick.bind(this));\n\t\t\tthis.elements.fileInput.fileupload({\n\t\t\t\tdataType: 'json',\n\t\t\t\treplaceFileInput: false,\n\t\t\t\tfileInput: this.fileInput,\n\t\t\t\tautoUpload: false,\n\t\t\t\tsubmit: this.submit.bind(this),\n\t\t\t\tadd: this.add.bind(this),\n\t\t\t\tprogressall: this.progressAll.bind(this),\n\t\t\t\tchange: this.change.bind(this),\n\t\t\t\tdrop: this.change.bind(this),\n\t\t\t\tdragover: this.dragOver.bind(this),\n\t\t\t\tfail: this.uploadError.bind(this),\n\t\t\t\tdone: this.uploadSuccess.bind(this)\n\t\t\t});\n\t\t\tthis.elements.component.on('dragleave', this.dragLeave.bind(this));\n\t\t\tthis.elements.component.on('dragend', this.dragLeave.bind(this));\n\t\t\tthis.elements.fileInput.fileupload('option', 'dropZone', $(this.elements.component));\n\t\t\tthis.enableDragNDrop();\n\t\t}\n\t\tthis.elements.component.on('click', '.js-multi-image__popover-img', function(e) {\n\t\t\tthisInstance.zoomPreview($(this).data('hash'));\n\t\t});\n\t\tthis.elements.component.on('click', '.js-multi-image__popover-btn-zoom', function(e) {\n\t\t\te.preventDefault();\n\t\t\tthisInstance.zoomPreview($(this).data('hash'));\n\t\t});\n\t\tthis.elements.component.on('click', '.js-multi-image__popover-btn-download', function(e) {\n\t\t\te.preventDefault();\n\t\t\tthisInstance.download($(this).data('hash'));\n\t\t});\n\t\tif (!this.detailView) {\n\t\t\tthis.elements.component.on('click', '.js-multi-image__popover-btn-delete', function(e) {\n\t\t\t\te.preventDefault();\n\t\t\t\tthisInstance.deleteFile($(this).data('hash'));\n\t\t\t});\n\t\t}\n\t\tthis.loadExistingFiles();\n\t\tif (typeof $.fn.animateCss === 'undefined') {\n\t\t\t$.fn.extend({\n\t\t\t\tanimateCss: function(animationName, callback) {\n\t\t\t\t\tlet animationEnd = (function(el) {\n\t\t\t\t\t\tlet animations = {\n\t\t\t\t\t\t\tanimation: 'animationend',\n\t\t\t\t\t\t\tOAnimation: 'oAnimationEnd',\n\t\t\t\t\t\t\tMozAnimation: 'mozAnimationEnd',\n\t\t\t\t\t\t\tWebkitAnimation: 'webkitAnimationEnd'\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (let t in animations) {\n\t\t\t\t\t\t\tif (el.style[t] !== undefined) {\n\t\t\t\t\t\t\t\treturn animations[t];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t})(document.createElement('div'));\n\t\t\t\t\tthis.addClass('animated ' + animationName).one(animationEnd, function() {\n\t\t\t\t\t\t$(this).removeClass('animated ' + animationName);\n\n\t\t\t\t\t\tif (typeof callback === 'function') callback();\n\t\t\t\t\t});\n\t\t\t\t\treturn this;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * Prevent form submission before file upload end\n\t * @param e\n\t */\n\tonFormSubmit(e) {\n\t\tif (App.Fields.MultiImage.currentFileUploads) {\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\t\t\te.stopImmediatePropagation();\n\t\t\tbootbox.alert(app.vtranslate('JS_WAIT_FOR_FILE_UPLOAD'));\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\t/**\n\t * Prevent form submission\n\t *\n\t * @param {Event} e\n\t */\n\taddButtonClick(e) {\n\t\te.preventDefault();\n\t\tthis.elements.fileInput.trigger('click');\n\t}\n\n\t/**\n\t * Submit event handler from jQuery-file-upload\n\t *\n\t * @param {Event} e\n\t * @param {Object} data\n\t */\n\tsubmit(e, data) {\n\t\tdata.formData = {\n\t\t\thash: data.files[0].hash\n\t\t};\n\t\tApp.Fields.MultiImage.currentFileUploads++;\n\t}\n\n\t/**\n\t * Get file information\n\t *\n\t * @param {String} hash - file id\n\t * @returns {Object}\n\t */\n\tgetFileInfo(hash) {\n\t\tfor (let i = 0, len = this.files.length; i < len; i++) {\n\t\t\tconst file = this.files[i];\n\t\t\tif (file.hash === hash) {\n\t\t\t\treturn file;\n\t\t\t}\n\t\t}\n\t\tapp.errorLog(`File '${hash}' not found.`);\n\t\tVtiger_Helper_Js.showPnotify({ text: app.vtranslate('JS_INVALID_FILE_HASH') + ` [${hash}]` });\n\t}\n\n\t/**\n\t * Add property to file info object\n\t *\n\t * @param {String} hash - file id\n\t * @param {String} propertyName\n\t * @param {any} value\n\t * @returns {Object}\n\t */\n\taddFileInfoProperty(hash, propertyName, value) {\n\t\tconst fileInfo = this.getFileInfo(hash);\n\t\tfileInfo[propertyName] = value;\n\t\treturn fileInfo;\n\t}\n\n\t/**\n\t * Error event handler from file upload request\n\t *\n\t * @param {Event} e\n\t * @param {Object} data\n\t */\n\tuploadError(e, data) {\n\t\tapp.errorLog('File upload error.');\n\t\tconst { jqXHR, files } = data;\n\t\tif (typeof jqXHR.responseJSON === 'undefined' || jqXHR.responseJSON === null) {\n\t\t\tApp.Fields.MultiImage.currentFileUploads--;\n\t\t\treturn Vtiger_Helper_Js.showPnotify(app.vtranslate('JS_FILE_UPLOAD_ERROR'));\n\t\t}\n\t\tconst response = jqXHR.responseJSON;\n\t\t// first try to show error for concrete file\n\t\tif (\n\t\t\ttypeof response.result !== 'undefined' &&\n\t\t\ttypeof response.result.attach !== 'undefined' &&\n\t\t\tArray.isArray(response.result.attach)\n\t\t) {\n\t\t\tresponse.result.attach.forEach(fileAttach => {\n\t\t\t\tApp.Fields.MultiImage.currentFileUploads--;\n\t\t\t\tthis.deleteFile(fileAttach.hash, false);\n\t\t\t\tif (typeof fileAttach.error === 'string') {\n\t\t\t\t\tVtiger_Helper_Js.showPnotify(fileAttach.error + ` [${fileAttach.name}]`);\n\t\t\t\t} else {\n\t\t\t\t\tVtiger_Helper_Js.showPnotify(app.vtranslate('JS_FILE_UPLOAD_ERROR') + ` [${fileAttach.name}]`);\n\t\t\t\t}\n\t\t\t});\n\t\t\tthis.updateFormValues();\n\t\t\treturn;\n\t\t}\n\t\t// else show default upload error\n\t\tfiles.forEach(file => {\n\t\t\tApp.Fields.MultiImage.currentFileUploads--;\n\t\t\tthis.deleteFile(file.hash, false);\n\t\t\tVtiger_Helper_Js.showPnotify(app.vtranslate('JS_FILE_UPLOAD_ERROR') + ` [${file.name}]`);\n\t\t});\n\t\tthis.updateFormValues();\n\t}\n\n\t/**\n\t * Success event handler from file upload request\n\t *\n\t * @param {Event} e\n\t * @param {Object} data\n\t */\n\tuploadSuccess(e, data) {\n\t\tconst { result } = data;\n\t\tconst attach = result.result.attach;\n\t\tattach.forEach(fileAttach => {\n\t\t\tconst hash = fileAttach.hash;\n\t\t\tif (!hash) {\n\t\t\t\treturn app.errorLog(new Error(app.vtranslate('JS_INVALID_FILE_HASH') + ` [${hash}]`));\n\t\t\t}\n\t\t\tif (typeof fileAttach.key === 'undefined') {\n\t\t\t\treturn this.uploadError(e, data);\n\t\t\t}\n\t\t\tif (typeof fileAttach.info !== 'undefined' && fileAttach.info) {\n\t\t\t\tVtiger_Helper_Js.showPnotify({ type: 'notice', text: fileAttach.info + ` [${fileAttach.name}]` });\n\t\t\t}\n\t\t\tconst fileInfo = this.getFileInfo(hash);\n\t\t\tthis.addFileInfoProperty(hash, 'key', fileAttach.key);\n\t\t\tthis.addFileInfoProperty(hash, 'size', fileAttach.size);\n\t\t\tthis.addFileInfoProperty(hash, 'name', fileAttach.name);\n\t\t\tthis.removePreviewPopover(hash);\n\t\t\tthis.addPreviewPopover(fileInfo.file, fileInfo.previewElement, fileInfo.imageSrc);\n\t\t\tApp.Fields.MultiImage.currentFileUploads--;\n\t\t});\n\t\tthis.updateFormValues();\n\t}\n\n\t/**\n\t * Update form input values\n\t */\n\tupdateFormValues() {\n\t\tthis.elements.fileInput.val(null);\n\t\tconst formValues = this.files.map(file => {\n\t\t\treturn { key: file.key, name: file.name, size: file.size };\n\t\t});\n\t\tthis.elements.values.val(JSON.stringify(formValues));\n\t}\n\n\t/**\n\t * Validate file\n\t *\n\t * @param {Object} file\n\t * @returns {boolean}\n\t */\n\tvalidateFile(file) {\n\t\tlet valid = false;\n\t\tthis.options.formats.forEach(format => {\n\t\t\tif (file.type === 'image/' + format) {\n\t\t\t\tvalid = true;\n\t\t\t}\n\t\t});\n\t\tif (!valid) {\n\t\t\tVtiger_Helper_Js.showPnotify(\n\t\t\t\t`${app.vtranslate('JS_INVALID_FILE_TYPE')} [${file.name}]\\n${app.vtranslate(\n\t\t\t\t\t'JS_AVAILABLE_FILE_TYPES'\n\t\t\t\t)}  [${this.options.formats.join(', ')}]`\n\t\t\t);\n\t\t}\n\t\treturn valid;\n\t}\n\n\t/**\n\t * Show limit error\n\t */\n\tshowLimitError() {\n\t\tthis.elements.fileInput.val('');\n\t\tVtiger_Helper_Js.showPnotify(`${app.vtranslate('JS_FILE_LIMIT')} [${this.options.limit}]`);\n\t}\n\n\t/**\n\t * Get only valid files from list\n\t *\n\t * @param {Array} files\n\t * @returns {Array}\n\t */\n\tfilterValidFiles(files) {\n\t\tif (files.length + this.files.length > this.options.limit) {\n\t\t\tthis.showLimitError();\n\t\t\treturn [];\n\t\t}\n\t\treturn files.filter(file => {\n\t\t\treturn this.validateFile(file);\n\t\t});\n\t}\n\n\t/**\n\t * Set files hash\n\t * @param {Array} files\n\t * @returns {Array}\n\t */\n\tsetFilesHash(files) {\n\t\tconst addedFiles = [];\n\t\tfor (let i = 0, len = files.length; i < len; i++) {\n\t\t\tconst file = files[i];\n\t\t\tif (typeof file.hash === 'undefined') {\n\t\t\t\tif (this.files.length < this.options.limit) {\n\t\t\t\t\tfile.hash = App.Fields.Text.generateRandomHash(CONFIG.userId);\n\t\t\t\t\tthis.files.push({ hash: file.hash, imageSrc: file.imageSrc, name: file.name, file });\n\t\t\t\t\taddedFiles.push(file);\n\t\t\t\t} else {\n\t\t\t\t\tthis.showLimitError();\n\t\t\t\t\treturn addedFiles;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn addedFiles;\n\t}\n\n\t/**\n\t * Add event handler from jQuery-file-upload\n\t *\n\t * @param {Event} e\n\t * @param {object} data\n\t */\n\tadd(e, data) {\n\t\tif (data.files.length > 0) {\n\t\t\tdata.submit();\n\t\t}\n\t}\n\n\t/**\n\t * Progressall event handler from jQuery-file-upload\n\t *\n\t * @param {Event} e\n\t * @param {Object} data\n\t */\n\tprogressAll(e, data) {\n\t\tconst progress = parseInt((data.loaded / data.total) * 100, 10);\n\t\tthis.elements.progressBar.css({ width: progress + '%' });\n\t\tif (progress === 100) {\n\t\t\tsetTimeout(() => {\n\t\t\t\tthis.elements.progress.addClass('d-none');\n\t\t\t\tthis.elements.progressBar.css({ width: '0%' });\n\t\t\t}, 1000);\n\t\t} else {\n\t\t\tthis.elements.progress.removeClass('d-none');\n\t\t}\n\t}\n\n\t/**\n\t * Dragover event handler from jQuery-file-upload\n\t *\n\t * @param {Event} e\n\t */\n\tdragOver(e) {\n\t\tthis.elements.component.addClass('c-multi-image__drop-effect');\n\t}\n\n\t/**\n\t * Dragleave event handler\n\t * @param {Event} e\n\t */\n\tdragLeave(e) {\n\t\tthis.elements.component.removeClass('c-multi-image__drop-effect');\n\t}\n\n\t/**\n\t * Download file according to source type (base64/file from server)\n\t *\n\t * @param {String} hash\n\t */\n\tdownload(hash) {\n\t\tconst fileInfo = this.getFileInfo(hash);\n\t\tif (fileInfo.imageSrc.substr(0, 8).toLowerCase() === 'file.php') {\n\t\t\treturn this.downloadFile(hash);\n\t\t} else {\n\t\t\treturn this.downloadBase64(hash);\n\t\t}\n\t}\n\n\t/**\n\t * Download file that exists on the server already\n\t * @param {String} hash\n\t */\n\tdownloadFile(hash) {\n\t\tconst fileInfo = this.getFileInfo(hash);\n\t\tconst link = document.createElement('a');\n\t\t$(link).css('display', 'none');\n\t\tif (typeof link.download === 'string') {\n\t\t\tdocument.body.appendChild(link); // Firefox requires the link to be in the body\n\t\t\tlink.download = fileInfo.name;\n\t\t\tlink.href = fileInfo.imageSrc;\n\t\t\tlink.click();\n\t\t\tdocument.body.removeChild(link); // remove the link when done\n\t\t} else {\n\t\t\tlocation.replace(fileInfo.imageSrc);\n\t\t}\n\t}\n\n\t/**\n\t * Download file from base64 image\n\t *\n\t * @param {String} hash\n\t */\n\tdownloadBase64(hash) {\n\t\tconst fileInfo = this.getFileInfo(hash);\n\t\tconst imageUrl =\n\t\t\t`data:application/octet-stream;filename=${fileInfo.name};base64,` + fileInfo.imageSrc.split(',')[1];\n\t\tconst link = document.createElement('a');\n\t\t$(link).css('display', 'none');\n\t\tif (typeof link.download === 'string') {\n\t\t\tdocument.body.appendChild(link); // Firefox requires the link to be in the body\n\t\t\tlink.download = fileInfo.name;\n\t\t\tlink.href = imageUrl;\n\t\t\tlink.click();\n\t\t\tdocument.body.removeChild(link); // remove the link when done\n\t\t} else {\n\t\t\tlocation.replace(imageUrl);\n\t\t}\n\t}\n\n\t/**\n\t * Display modal window with large preview\n\t *\n\t * @param {string} hash\n\t */\n\tzoomPreview(hash) {\n\t\tconst thisInstance = this;\n\t\tlet fileInfo = this.getFileInfo(hash);\n\t\tconst titleTemplate = () => `<i class=\"fa fa-image\"></i> ${fileInfo.name}`;\n\t\tconst bootboxOptions = {\n\t\t\tsize: 'large',\n\t\t\tbackdrop: true,\n\t\t\tonEscape: true,\n\t\t\ttitle: `<span id=\"bootbox-title-${hash}\" class=\"animated ${\n\t\t\t\tthis.options.zoomTitleAnimation.in\n\t\t\t}\">${titleTemplate()}</span>`,\n\t\t\tmessage: `<img src=\"${fileInfo.imageSrc}\" class=\"w-100\" />`,\n\t\t\tbuttons: {}\n\t\t};\n\t\tif (this.options.showCarousel) {\n\t\t\tbootboxOptions.message = this.generateCarousel(hash);\n\t\t}\n\t\tif (!this.detailView) {\n\t\t\tbootboxOptions.buttons.Delete = {\n\t\t\t\tlabel: `<i class=\"fa fa-trash-alt\"></i> ${app.vtranslate('JS_DELETE')}`,\n\t\t\t\tclassName: 'float-left btn btn-danger',\n\t\t\t\tcallback() {\n\t\t\t\t\tthisInstance.deleteFile(fileInfo.hash);\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t\tbootboxOptions.buttons.Download = {\n\t\t\tlabel: `<i class=\"fa fa-download\"></i> ${app.vtranslate('JS_DOWNLOAD')}`,\n\t\t\tclassName: 'float-left btn btn-success',\n\t\t\tcallback() {\n\t\t\t\tthisInstance.download(fileInfo.hash);\n\t\t\t}\n\t\t};\n\t\tbootboxOptions.buttons.Close = {\n\t\t\tlabel: `<i class=\"fa fa-times\"></i> ${app.vtranslate('JS_CLOSE')}`,\n\t\t\tclassName: 'btn btn-warning',\n\t\t\tcallback: () => {}\n\t\t};\n\t\tbootbox.dialog(bootboxOptions);\n\t\tif (this.options.showCarousel) {\n\t\t\t$(`#bootbox-title-${hash}`).css({\n\t\t\t\t'animation-duration': '350ms'\n\t\t\t});\n\t\t\t$(`#carousel-${hash}`).on('slide.bs.carousel', e => {\n\t\t\t\tfileInfo = this.getFileInfo($(e.relatedTarget).data('hash'));\n\t\t\t\tconst aniIn = this.options.zoomTitleAnimation.in;\n\t\t\t\tconst aniOut = this.options.zoomTitleAnimation.out;\n\t\t\t\t$(`#bootbox-title-${hash}`).animateCss(aniOut, () => {\n\t\t\t\t\t$(`#bootbox-title-${hash}`)\n\t\t\t\t\t\t.html(titleTemplate())\n\t\t\t\t\t\t.removeClass('animated ' + aniOut)\n\t\t\t\t\t\t.animateCss(aniIn);\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * Remove file from preview and from file list\n\t *\n\t * @param {String} hash\n\t */\n\tdeleteFileCallback(hash) {\n\t\tconst fileInfo = this.getFileInfo(hash);\n\t\tfileInfo.previewElement.popover('dispose').remove();\n\t\tthis.files = this.files.filter(file => file.hash !== fileInfo.hash);\n\t\tthis.updateFormValues();\n\t}\n\n\t/**\n\t * Delete image from input field\n\t * Should be called with this pointing on button element with data-hash attribute\n\t *\n\t * @param {string} hash\n\t * @param {boolean} showConfirmation - dialog?\n\t */\n\tdeleteFile(hash, showConfirmation = true) {\n\t\tif (showConfirmation) {\n\t\t\tconst fileInfo = this.getFileInfo(hash);\n\t\t\tbootbox.confirm({\n\t\t\t\ttitle: `<i class=\"fa fa-trash-alt\"></i> ${app.vtranslate('JS_DELETE_FILE')}`,\n\t\t\t\tmessage: `${app.vtranslate('JS_DELETE_FILE_CONFIRMATION')} <span class=\"font-weight-bold\">${\n\t\t\t\t\tfileInfo.name\n\t\t\t\t}</span>?`,\n\t\t\t\tcallback: result => {\n\t\t\t\t\tif (result) {\n\t\t\t\t\t\tthis.deleteFileCallback(hash);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tthis.deleteFileCallback(hash);\n\t\t}\n\t}\n\n\t/**\n\t * File change event handler from jQuery-file-upload\n\t *\n\t * @param {Event} e\n\t * @param {object} data\n\t */\n\tchange(e, data) {\n\t\tdata.files = this.filterValidFiles(data.files);\n\t\tdata.files = this.setFilesHash(data.files);\n\t\tthis.dragLeave(e);\n\t\tif (data.files.length) {\n\t\t\tthis.generatePreviewElements(data.files, element => {\n\t\t\t\tthis.redraw();\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * Generate and apply popover to preview\n\t *\n\t * @param {File} file\n\t * @param {string} template\n\t * @param {string} imageSrc\n\t * @returns {jQuery}\n\t */\n\taddPreviewPopover(file, template, imageSrc) {\n\t\tconst thisInstance = this;\n\t\tlet fileSize = '';\n\t\tconst fileInfo = this.getFileInfo(file.hash);\n\t\tif (typeof fileInfo.size !== 'undefined') {\n\t\t\tfileSize = `<div class=\"p-1 bg-white border rounded small position-absolute\">${fileInfo.size}</div>`;\n\t\t}\n\t\tlet deleteBtn = '';\n\t\tif (!this.detailView) {\n\t\t\tdeleteBtn = `<button class=\"btn btn-sm btn-danger c-btn-collapsible js-multi-image__popover-btn-delete\" type=\"button\" data-hash=\"${\n\t\t\t\tfile.hash\n\t\t\t}\" data-js=\"click\"><i class=\"fa fa-trash-alt\"></i> <span class=\"c-btn-collapsible__text\">${app.vtranslate(\n\t\t\t\t'JS_DELETE'\n\t\t\t)}</span></button>`;\n\t\t}\n\t\treturn $(template).popover({\n\t\t\tcontainer: thisInstance.elements.component,\n\t\t\ttitle: `<div class=\"u-text-ellipsis\"><i class=\"fa fa-image\"></i> ${file.name}</div>`,\n\t\t\thtml: true,\n\t\t\tsanitize: false,\n\t\t\ttrigger: 'focus',\n\t\t\tplacement: 'top',\n\t\t\tcontent: `<img src=\"${imageSrc}\" class=\"w-100 js-multi-image__popover-img c-multi-image__popover-img\" data-hash=\"${\n\t\t\t\tfile.hash\n\t\t\t}\" data-js=\"click\"/>`,\n\t\t\ttemplate: `<div class=\"popover\" role=\"tooltip\">\n\t\t\t\t<div class=\"arrow\"></div>\n\t\t\t\t<h3 class=\"popover-header\"></h3>\n\t\t\t\t<div class=\"popover-body\"></div>\n\t\t\t\t<div class=\"text-right popover-footer js-multi-image__popover-actions\">\n\t\t\t\t\t${fileSize}\n\t\t\t\t\t${deleteBtn}\n\t\t\t\t\t<button class=\"btn btn-sm btn-success c-btn-collapsible js-multi-image__popover-btn-download\" type=\"button\" data-hash=\"${\n\t\t\t\t\t\tfile.hash\n\t\t\t\t\t}\" data-js=\"click\"><i class=\"fa fa-download\"></i> <span class=\"c-btn-collapsible__text\">${app.vtranslate(\n\t\t\t\t'JS_DOWNLOAD'\n\t\t\t)}</span></button>\n\t\t\t\t\t<button class=\"btn btn-sm btn-primary c-btn-collapsible js-multi-image__popover-btn-zoom\" type=\"button\" data-hash=\"${\n\t\t\t\t\t\tfile.hash\n\t\t\t\t\t}\" data-js=\"click\"><i class=\"fa fa-search-plus\"></i> <span class=\"c-btn-collapsible__text\">${app.vtranslate(\n\t\t\t\t'JS_ZOOM_IN'\n\t\t\t)}</span></button>\n\t\t\t\t</div>\n\t\t\t</div>`\n\t\t});\n\t}\n\n\t/**\n\t * Remove preview popover\n\t *\n\t * @param {String} hash\n\t */\n\tremovePreviewPopover(hash) {\n\t\tconst fileInfo = this.getFileInfo(hash);\n\t\tif (typeof fileInfo.previewElement !== 'undefined') {\n\t\t\tfileInfo.previewElement.popover('dispose');\n\t\t}\n\t}\n\n\t/**\n\t * Hide popovers when user starts moving file preview\n\t *\n\t * @param {Event} e\n\t * @param {Object} ui\n\t */\n\tsortOver(e, ui) {\n\t\tthis.elements.result.find('.js-multi-image__preview').popover('hide');\n\t}\n\n\t/**\n\t * Update file position according to elements order\n\t *\n\t * @param {Event} e\n\t * @param {Object} ui\n\t */\n\tsortStop(e, ui) {\n\t\tconst actualElements = this.elements.result.find('.js-multi-image__preview').toArray();\n\t\tthis.files = actualElements.map(element => {\n\t\t\tfor (let i = 0, len = this.files.length; i < len; i++) {\n\t\t\t\tconst elementHash = $(element).data('hash');\n\t\t\t\tif (this.files[i].hash === elementHash) {\n\t\t\t\t\treturn this.files[i];\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\tthis.redraw();\n\t}\n\n\t/**\n\t * Redraw view according to in-memory positions\n\t */\n\tredraw() {\n\t\tthis.files.forEach(file => {\n\t\t\tthis.elements.result.append(file.previewElement);\n\t\t});\n\t\tthis.updateFormValues();\n\t}\n\n\t/**\n\t * Enable drag and drop files repositioning\n\t */\n\tenableDragNDrop() {\n\t\tthis.elements.result\n\t\t\t.sortable({\n\t\t\t\thandle: '.js-multi-image__preview-img',\n\t\t\t\titems: '.js-multi-image__preview',\n\t\t\t\tover: this.sortOver.bind(this),\n\t\t\t\tstop: this.sortStop.bind(this)\n\t\t\t})\n\t\t\t.disableSelection()\n\t\t\t.on('mousedown', '.js-multi-image__preview-img', function(e) {\n\t\t\t\tthis.focus(); // focus to show popover\n\t\t\t});\n\t}\n\n\t/**\n\t * Generate preview of images and append to multi image results view\n\t *\n\t * @param {Array} files - array of Files\n\t * @param {function} callback\n\t */\n\tgeneratePreviewElements(files, callback) {\n\t\tfiles.forEach(file => {\n\t\t\tif (file instanceof File) {\n\t\t\t\tthis.generatePreviewFromFile(file, (template, imageSrc) => {\n\t\t\t\t\tfile.preview = this.addPreviewPopover(file, template, imageSrc);\n\t\t\t\t\tthis.addFileInfoProperty(file.hash, 'previewElement', file.preview);\n\t\t\t\t\tcallback(file.preview);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tthis.generatePreviewFromValue(file, (template, imageSrc) => {\n\t\t\t\t\tfile.preview = this.addPreviewPopover(file, template, imageSrc);\n\t\t\t\t\tthis.addFileInfoProperty(file.hash, 'previewElement', file.preview);\n\t\t\t\t\tcallback(file.preview);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Generate preview of image as html string\n\t *\n\t * @param {File} file\n\t * @param {function} callback\n\t */\n\tgeneratePreviewFromFile(file, callback) {\n\t\tconst fr = new FileReader();\n\t\tfr.onload = () => {\n\t\t\tfile.imageSrc = fr.result;\n\t\t\tthis.addFileInfoProperty(file.hash, 'imageSrc', file.imageSrc);\n\t\t\tcallback(\n\t\t\t\t`<div class=\"d-inline-block mr-1 js-multi-image__preview\" id=\"js-multi-image__preview-hash-${\n\t\t\t\t\tfile.hash\n\t\t\t\t}\" data-hash=\"${file.hash}\" data-js=\"container|click\">\n\t\t\t\t\t<div class=\"img-thumbnail js-multi-image__preview-img c-multi-image__preview-img\" data-hash=\"${\n\t\t\t\t\t\tfile.hash\n\t\t\t\t\t}\" data-js=\"drag\" style=\"background-image:url(${fr.result})\" tabindex=\"0\" title=\"${file.name}\"></div>\n\t\t\t</div>`,\n\t\t\t\tfr.result\n\t\t\t);\n\t\t};\n\t\tfr.readAsDataURL(file);\n\t}\n\n\t/**\n\t * Generate preview of image as html string from existing values\n\t *\n\t * @param {File} file\n\t * @param {function} callback\n\t */\n\tgeneratePreviewFromValue(file, callback) {\n\t\tcallback(\n\t\t\t`<div class=\"d-inline-block mr-1 js-multi-image__preview\" id=\"js-multi-image__preview-hash-${\n\t\t\t\tfile.hash\n\t\t\t}\" data-hash=\"${file.hash}\" data-js=\"container|click\">\n\t\t\t\t<div class=\"img-thumbnail js-multi-image__preview-img c-multi-image__preview-img\" data-hash=\"${\n\t\t\t\t\tfile.hash\n\t\t\t\t}\" data-js=\"drag\" style=\"background-image:url(${file.imageSrc})\" tabindex=\"0\" title=\"${file.name}\"></div>\n\t\t</div>`,\n\t\t\tfile.imageSrc\n\t\t);\n\t}\n\n\t/**\n\t * Load files that were in valueInput as json string\n\t */\n\tloadExistingFiles() {\n\t\tthis.files = this.files\n\t\t\t.map(file => {\n\t\t\t\tfile.hash = App.Fields.Text.generateRandomHash(CONFIG.userId);\n\t\t\t\treturn file;\n\t\t\t})\n\t\t\t.slice(0, this.options.limit);\n\t\tthis.generatePreviewElements(this.files, element => {\n\t\t\tthis.elements.result.append(element);\n\t\t});\n\t\tthis.updateFormValues();\n\t}\n\n\t/**\n\t * Generate carousel for all files in large preview\n\t *\n\t * @param {String} hash\n\t */\n\tgenerateCarousel(hash) {\n\t\tif (this.files.length <= 1) {\n\t\t\tconst fileInfo = this.getFileInfo(hash);\n\t\t\treturn `<img class=\"d-block w-100\" src=\"${fileInfo.imageSrc}\">`;\n\t\t}\n\t\tlet template = `<div id=\"carousel-${hash}\" class=\"carousel slide c-carousel\" data-ride=\"carousel\" data-js=\"container\">\n\t\t  <div class=\"carousel-inner\">`;\n\t\tthis.files.forEach(file => {\n\t\t\ttemplate += `<div class=\"carousel-item c-carousel__item`;\n\t\t\tif (file.hash === hash) {\n\t\t\t\ttemplate += ` active`;\n\t\t\t}\n\t\t\ttemplate += `\" data-hash=\"${file.hash}\">\n\t\t      <img class=\"d-block w-100 c-carousel__image\" src=\"${file.imageSrc}\">\n\t\t    </div>`;\n\t\t});\n\t\ttemplate += `<a class=\"carousel-control-prev c-carousel__prevnext-btn c-carousel__prev-btn\" href=\"#carousel-${hash}\" role=\"button\" data-slide=\"prev\" data-js=\"click\">\n\t\t    <span class=\"fas fa-caret-left fa-2x c-carousel__prev-icon mr-1\" aria-hidden=\"true\"></span>\n\t\t  </a>\n\t\t  <a class=\"carousel-control-next c-carousel__prevnext-btn c-carousel__next-btn\" href=\"#carousel-${hash}\" role=\"button\" data-slide=\"next\" data-js=\"click\">\n\t\t    <span class=\"fas fa-caret-right fa-2x c-carousel__next-icon ml-1\" aria-hidden=\"true\"></span>\n\t\t  </a>\n\t\t</div>`;\n\t\treturn template;\n\t}\n}\n"],"names":["MultiImage","element","thisInstance","elements","options","detailView","fileInput","find","eq","length","component","form","closest","on","onFormSubmit","addButton","values","progressBar","progress","result","fieldInfo","data","formats","limit","files","JSON","parse","val","detach","click","addButtonClick","bind","fileupload","submit","add","progressAll","change","dragOver","uploadError","uploadSuccess","dragLeave","$","enableDragNDrop","e","zoomPreview","preventDefault","download","deleteFile","loadExistingFiles","fn","animateCss","extend","animationName","callback","animationEnd","el","animations","t","style","undefined","document","createElement","addClass","one","removeClass","App","Fields","currentFileUploads","stopPropagation","stopImmediatePropagation","alert","app","vtranslate","trigger","formData","hash","i","len","file","errorLog","showPnotify","text","propertyName","value","fileInfo","getFileInfo","jqXHR","responseJSON","Vtiger_Helper_Js","response","attach","Array","isArray","forEach","fileAttach","error","name","updateFormValues","Error","key","info","type","addFileInfoProperty","size","removePreviewPopover","addPreviewPopover","previewElement","imageSrc","formValues","map","stringify","valid","format","join","showLimitError","filter","validateFile","addedFiles","Text","generateRandomHash","CONFIG","userId","push","parseInt","loaded","total","css","width","substr","toLowerCase","downloadFile","downloadBase64","link","body","appendChild","href","removeChild","replace","imageUrl","split","titleTemplate","bootboxOptions","zoomTitleAnimation","in","showCarousel","message","generateCarousel","buttons","Delete","Download","Close","dialog","relatedTarget","aniIn","aniOut","out","html","popover","remove","showConfirmation","confirm","deleteFileCallback","filterValidFiles","setFilesHash","generatePreviewElements","redraw","template","fileSize","deleteBtn","ui","actualElements","toArray","elementHash","append","sortable","sortOver","sortStop","disableSelection","focus","File","generatePreviewFromFile","preview","generatePreviewFromValue","fr","FileReader","onload","readAsDataURL","slice"],"mappings":"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"}