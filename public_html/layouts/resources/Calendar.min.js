"use strict";var classCallCheck=function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")},createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),inherits=function(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)},possibleConstructorReturn=function(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call};window.Calendar_Js=function(){function _class(){var container=arguments.length>0&&void 0!==arguments[0]?arguments[0]:$(".js-base-container"),readonly=arguments.length>1&&void 0!==arguments[1]&&arguments[1],browserHistory=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];classCallCheck(this,_class),this.calendarView=!1,this.calendarCreateView=!1,this.container=container,this.readonly=readonly,this.eventCreate=app.getMainParams("eventCreate"),this.eventEdit=app.getMainParams("eventEdit"),this.browserHistory=!readonly&&browserHistory,this.browserHistoryConfig=this.browserHistory?{}:this.setBrowserHistoryOptions(),this.calendarOptions=this.setCalendarOptions(),this.eventTypeKeyName=!1,this.module=app.getModuleName()}return createClass(_class,[{key:"setCalendarOptions",value:function(){return Object.assign(this.setCalendarBasicOptions(),this.setCalendarAdvancedOptions(),this.setCalendarModuleOptions(),this.browserHistoryConfig)}},{key:"setCalendarBasicOptions",value:function(){var eventLimit=app.getMainParams("eventLimit"),userDefaultActivityView=app.getMainParams("activity_view"),defaultView=app.moduleCacheGet("defaultView"),userDefaultTimeFormat=CONFIG.hourFormat;eventLimit="true"==eventLimit||"false"!=eventLimit&&parseInt(eventLimit)+1,userDefaultActivityView="Today"===userDefaultActivityView?app.getMainParams("dayView"):"This Week"===userDefaultActivityView?app.getMainParams("weekView"):"month",null!=defaultView&&(userDefaultActivityView=defaultView);var options={timeFormat:userDefaultTimeFormat=24==userDefaultTimeFormat?"H:mm":"h:mmt",slotLabelFormat:userDefaultTimeFormat,defaultView:userDefaultActivityView,slotMinutes:15,defaultEventMinutes:0,forceEventDuration:!0,defaultTimedEventDuration:"01:00:00",eventLimit:eventLimit,eventLimitText:app.vtranslate("JS_MORE"),selectHelper:!0,scrollTime:app.getMainParams("startHour")+":00",monthNamesShort:[app.vtranslate("JS_JAN"),app.vtranslate("JS_FEB"),app.vtranslate("JS_MAR"),app.vtranslate("JS_APR"),app.vtranslate("JS_MAY"),app.vtranslate("JS_JUN"),app.vtranslate("JS_JUL"),app.vtranslate("JS_AUG"),app.vtranslate("JS_SEP"),app.vtranslate("JS_OCT"),app.vtranslate("JS_NOV"),app.vtranslate("JS_DEC")],dayNames:[app.vtranslate("JS_SUNDAY"),app.vtranslate("JS_MONDAY"),app.vtranslate("JS_TUESDAY"),app.vtranslate("JS_WEDNESDAY"),app.vtranslate("JS_THURSDAY"),app.vtranslate("JS_FRIDAY"),app.vtranslate("JS_SATURDAY")],buttonText:{today:app.vtranslate("JS_CURRENT"),year:app.vtranslate("JS_YEAR"),month:app.vtranslate("JS_MONTH"),week:app.vtranslate("JS_WEEK"),day:app.vtranslate("JS_DAY")},allDayText:app.vtranslate("JS_ALL_DAY")};if(null!==app.moduleCacheGet("start")){var s=moment(app.moduleCacheGet("start")).valueOf(),e=moment(app.moduleCacheGet("end")).valueOf();options.defaultDate=moment(moment(s+(e-s)/2).format("YYYY-MM-DD"))}return Object.assign(this.setCalendarMinimalOptions(),options)}},{key:"parseDateFormat",value:function(partOfDate){var parseWeekAndDayFormat={"yyyy-mm-dd":"YYYY-MMM-D","mm-dd-yyyy":"MMM-D-YYYY","dd-mm-yyyy":"D-MMM-YYYY","yyyy.mm.dd":"YYYY.MMM.D","mm.dd.yyyy":"MMM.D.YYYY","dd.mm.yyyy":"D.MMM.YYYY","yyyy/mm/dd":"YYYY/MMM/D","mm/dd/yyyy":"MMM/D/YYYY","dd/mm/yyyy":"D/MMM/YYYY"},formatDate=CONFIG.dateFormat;switch(partOfDate){case"month":return{"yyyy-mm-dd":"YYYY-MMMM","mm-dd-yyyy":"MMMM-YYYY","dd-mm-yyyy":"MMMM-YYYY","yyyy.mm.dd":"YYYY.MMMM","mm.dd.yyyy":"MMMM.YYYY","dd.mm.yyyy":"MMMM.YYYY","yyyy/mm/dd":"YYYY/MMMM","mm/dd/yyyy":"MMMM/YYYY","dd/mm/yyyy":"MMMM/YYYY"}[formatDate];case"week":case"day":return parseWeekAndDayFormat[formatDate]}}},{key:"setCalendarMinimalOptions",value:function(){var hiddenDays=[];return"workDays"===app.getMainParams("switchingDays")&&(hiddenDays=app.getMainParams("hiddenDays",!0)),{firstDay:CONFIG.firstDayOfWeekNo,selectable:!0,hiddenDays:hiddenDays,monthNames:[app.vtranslate("JS_JANUARY"),app.vtranslate("JS_FEBRUARY"),app.vtranslate("JS_MARCH"),app.vtranslate("JS_APRIL"),app.vtranslate("JS_MAY"),app.vtranslate("JS_JUNE"),app.vtranslate("JS_JULY"),app.vtranslate("JS_AUGUST"),app.vtranslate("JS_SEPTEMBER"),app.vtranslate("JS_OCTOBER"),app.vtranslate("JS_NOVEMBER"),app.vtranslate("JS_DECEMBER")],dayNamesShort:[app.vtranslate("JS_SUN"),app.vtranslate("JS_MON"),app.vtranslate("JS_TUE"),app.vtranslate("JS_WED"),app.vtranslate("JS_THU"),app.vtranslate("JS_FRI"),app.vtranslate("JS_SAT")]}}},{key:"setCalendarAdvancedOptions",value:function(){var self=this;return{editable:!this.readonly&&this.eventEdit,selectable:!this.readonly&&this.eventCreate,header:{left:"month,"+app.getMainParams("weekView")+","+app.getMainParams("dayView"),center:"title today",right:"prev,next"},allDaySlot:app.getMainParams("allDaySlot"),views:{basic:{eventLimit:!1},month:{titleFormat:this.parseDateFormat("month")},week:{titleFormat:this.parseDateFormat("week")},day:{titleFormat:this.parseDateFormat("day")}},eventDrop:function(event,delta,revertFunc){self.updateEvent(event,delta,revertFunc)},eventResize:function(event,delta,revertFunc){self.updateEvent(event,delta,revertFunc)},viewRender:function(){self.loadCalendarData()},eventRender:self.eventRenderer,height:this.setCalendarHeight(this.container)}}},{key:"updateEvent",value:function(event,delta,revertFunc){var progressInstance=jQuery.progressIndicator({blockInfo:{enabled:!0}}),start=event.start.format(),params={module:CONFIG.module,action:"Calendar",mode:"updateEvent",id:event.id,start:start,delta:delta._data,allDay:event.allDay};AppConnector.request(params).done((function(response){response.result?window.popoverCache={}:(Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_NO_EDIT_PERMISSION")),revertFunc()),progressInstance.progressIndicator({mode:"hide"})})).fail((function(){progressInstance.progressIndicator({mode:"hide"}),Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_NO_EDIT_PERMISSION")),revertFunc()}))}},{key:"eventRenderer",value:function(event,element){element.find(".fc-title").html(event.title),"background"===event.rendering&&(element.append('<span class="js-popover-text d-block"><span class="'+event.icon+' js-popover-icon mr-1"></span>'+event.title+"</span>"),element.addClass("js-popover-tooltip--ellipsis").attr("data-content",event.title),app.registerPopoverEllipsis({element:element}))}},{key:"setCalendarHeight",value:function(){var _this=this;if($(window).width()>993){var calendarContainer=this.container.find(".js-calendar__container"),calendarPadding=void 0;calendarPadding=this.container.hasClass("js-modal-container")?this.container.find(".js-modal-header").outerHeight():this.container.find(".js-contents-div").css("margin-left").replace("px","");new ResizeSensor(this.container.find(".contentsDiv"),(function(){calendarContainer.fullCalendar("option","height",$(window).height()-_this.container.find(".js-calendar__container").offset().top-$(".js-footer").height()-calendarPadding)}))}return"auto"}},{key:"setCalendarModuleOptions",value:function(){return{}}},{key:"setBrowserHistoryOptions",value:function(){var historyParams=app.getMainParams("historyParams",!0),options=null;if(historyParams&&(historyParams.length||Object.keys(historyParams).length)){options={start:historyParams.start,end:historyParams.end,user:historyParams.user.split(",").map((function(x){return parseInt(x)})),time:historyParams.time,hiddenDays:historyParams.hiddenDays.split(",").map((function(x){var parsedValue=parseInt(x);return isNaN(parsedValue)?"":parsedValue})),cvid:historyParams.cvid,defaultView:historyParams.viewType};var dateFormat=CONFIG.dateFormat.toUpperCase(),s=moment(options.start,dateFormat).valueOf(),e=moment(options.end,dateFormat).valueOf();options.defaultDate=moment(moment(s+(e-s)/2).format("YYYY-MM-DD")),Object.keys(options).forEach((function(key){return"undefined"===options[key]&&delete options[key]})),app.moduleCacheSet("browserHistoryEvent",!1),app.setMainParams("showType",options.time),app.setMainParams("usersId",options.user),app.setMainParams("defaultView",options.defaultView)}return window.addEventListener("popstate",(function(event){app.moduleCacheSet("browserHistoryEvent",!0)}),!1),options}},{key:"registerEvents",value:function(){this.renderCalendar(),this.registerSitebarEvents(),this.registerButtonSelectAll(),this.registerAddButton()}},{key:"renderCalendar",value:function(){this.getCalendarView().fullCalendar(this.calendarOptions)}},{key:"registerSitebarEvents",value:function(){var _this2=this;$(".bodyContents").on("Vtiger.Widget.Load.undefined",(function(){_this2.registerSelect2Event()}))}},{key:"loadCalendarData",value:function(){var _this3=this,defaultParams=this.getDefaultParams();if(this.getCalendarView().fullCalendar("removeEvents"),!defaultParams.emptyFilters){var progressInstance=$.progressIndicator();AppConnector.request(defaultParams).done((function(events){_this3.getCalendarView().fullCalendar("addEventSource",events.result),progressInstance.hide()}))}}},{key:"getDefaultParams",value:function(){var formatDate=CONFIG.dateFormat.toUpperCase(),view=this.getCalendarView().fullCalendar("getView"),users=app.moduleCacheGet("calendar-users")||CONFIG.userId,params={module:CONFIG.module,action:"Calendar",mode:"getEvents",start:view.start.format(formatDate),end:view.end.format(formatDate),user:users,emptyFilters:0===users.length};return app.moduleCacheGet("calendar-types")?(params.types=app.moduleCacheGet("calendar-types"),params.emptyFilters=0===users.length||0===params.types.length):params.types=[],params}},{key:"registerSelect2Event",value:function(){var self=this;$(".siteBarRight .js-calendar__filter__select").each((function(){var element=$(this),name=element.data("cache"),cachedValue=app.moduleCacheGet(name);if(element.length>0&&void 0!==cachedValue)"SELECT"==element.prop("tagName")&&element.val(cachedValue);else if(element.length>0&&void 0===cachedValue&&!element.find(":selected").length){var allOptions=[];element.find("option").each((function(i,option){allOptions.push($(option).val())})),element.val(allOptions),app.moduleCacheSet(name,cachedValue)}}));var selectsElements=$(".siteBarRight .select2, .siteBarRight .filterField");selectsElements.off("change"),App.Fields.Picklist.showSelect2ElementView(selectsElements),selectsElements.on("change",(function(){var element=$(this),value=element.val();null==value&&(value=""),"checkbox"==element.attr("type")&&(value=element.is(":checked")),app.moduleCacheSet(element.data("cache"),value),self.loadCalendarData()}))}},{key:"registerButtonSelectAll",value:function(){$(".selectAllBtn").on("click",(function(e){var selectAllLabel=$(this).find(".selectAll"),deselectAllLabel=$(this).find(".deselectAll");selectAllLabel.hasClass("d-none")?(selectAllLabel.removeClass("d-none"),deselectAllLabel.addClass("d-none"),$(this).closest(".quickWidget").find("select option").prop("selected",!1)):($(this).closest(".quickWidget").find("select option").prop("selected",!0),deselectAllLabel.removeClass("d-none"),selectAllLabel.addClass("d-none")),$(this).closest(".quickWidget").find("select").trigger("change")}))}},{key:"registerAddButton",value:function(){var self=this;$(".js-add").on("click",(function(e){self.getCalendarCreateView().done((function(data){(new Vtiger_Header_Js).handleQuickCreateData(data,{callbackFunction:function(data){self.addCalendarEvent(data.result)}})}))}))}},{key:"getCalendarCreateView",value:function(){var self=this,aDeferred=jQuery.Deferred();if(!1!==this.calendarCreateView)return aDeferred.resolve(this.calendarCreateView.clone(!0,!0)),aDeferred.promise();var progressInstance=jQuery.progressIndicator();return this.loadCalendarCreateView().done((function(data){progressInstance.hide(),self.calendarCreateView=data,aDeferred.resolve(data.clone(!0,!0))})).fail((function(){progressInstance.hide()})),aDeferred.promise()}},{key:"loadCalendarCreateView",value:function(){var aDeferred=jQuery.Deferred(),moduleName=app.getModuleName(),url="index.php?module="+moduleName+"&view=QuickCreateAjax";return Vtiger_Header_Js.getInstance().getQuickCreateForm(url,moduleName).done((function(data){aDeferred.resolve(jQuery(data))})).fail((function(textStatus,errorThrown){aDeferred.reject(textStatus,errorThrown)})),aDeferred.promise()}},{key:"getEventRenderData",value:function(calendarDetails){var calendar=this.getCalendarView();return{id:calendarDetails._recordId,title:calendarDetails._recordLabel,start:calendar.fullCalendar("moment",calendarDetails.date_start.value+" "+calendarDetails.time_start.value).format(),end:calendar.fullCalendar("moment",calendarDetails.due_date.value+" "+calendarDetails.time_end.value).format(),start_display:calendarDetails.date_start.display_value+" "+calendarDetails.time_start.display_value,end_display:calendarDetails.due_date.display_value+" "+calendarDetails.time_end.display_value,url:"index.php?module="+CONFIG.module+"&view=Detail&record="+calendarDetails._recordId,className:"js-popover-tooltip--record ownerCBg_"+calendarDetails.assigned_user_id.value+" picklistCBr_"+CONFIG.module+"_"+($('.js-calendar__filter__select[data-cache="calendar-types"]').length?this.eventTypeKeyName+"_"+calendarDetails[this.eventTypeKeyName].value:""),allDay:void 0!==calendarDetails.allday&&"on"==calendarDetails.allday.value}}},{key:"isNewEventToDisplay",value:function(eventObject){var ownerSelects=$('.js-calendar__filter__select[data-cache="calendar-users"]').add($('.js-calendar__filter__select[data-cache="calendar-groups"]'));if($.inArray(eventObject.assigned_user_id.value,ownerSelects.val())<0)return this.refreshFilterValues(eventObject,ownerSelects),!1;var calendarTypes=$('.js-calendar__filter__select[data-cache="calendar-types"]');return!(calendarTypes.length&&(this.eventTypeKeyName||this.setEventTypeKey(eventObject),$.inArray(eventObject[this.eventTypeKeyName].value,calendarTypes.val())<0))}},{key:"setEventTypeKey",value:function(eventObject){var self=this;Object.keys(eventObject).forEach((function(key,index){key.endsWith("type")&&(self.eventTypeKeyName=key)}))}},{key:"refreshFilterValues",value:function(eventObject,filtersValues){var _this4=this;if(CONFIG.searchShowOwnerOnlyInList){var allOptions=[];filtersValues.find("option").each((function(i,option){allOptions.push($(option).val())})),$.inArray(eventObject.assigned_user_id.value,allOptions)<0&&AppConnector.request("module="+CONFIG.module+"&view=RightPanel&mode=getUsersList").done((function(usersData){var filterUsers=$(".js-calendar__filter--users"),filterGroups=$(".js-calendar__filter--groups");filterUsers.html(usersData),usersData&&filterUsers.closest(".js-toggle-panel").removeClass("d-none"),filterGroups.length?AppConnector.request("module="+CONFIG.module+"&view=RightPanel&mode=getGroupsList").done((function(groupsData){filterGroups.html(groupsData),groupsData&&filterGroups.closest(".js-toggle-panel").removeClass("d-none"),_this4.registerSelect2Event()})):_this4.registerSelect2Event()}))}}},{key:"addCalendarEvent",value:function(eventObject){this.isNewEventToDisplay(eventObject)&&this.getCalendarView().fullCalendar("renderEvent",this.getEventRenderData(eventObject))}},{key:"getCalendarView",value:function(){return 0==this.calendarView&&(this.calendarView=this.container.find(".js-calendar__container")),this.calendarView}}]),_class}(),window.Calendar_Unselectable_Js=function(_Calendar_Js){function _class2(){return classCallCheck(this,_class2),possibleConstructorReturn(this,(_class2.__proto__||Object.getPrototypeOf(_class2)).apply(this,arguments))}return inherits(_class2,_Calendar_Js),createClass(_class2,[{key:"setCalendarModuleOptions",value:function(){var self=this;return{allDaySlot:!1,dayClick:!!this.eventCreate&&function(date){self.registerDayClickEvent(date.format()),self.getCalendarView().fullCalendar("unselect")},selectable:!1}}},{key:"registerDayClickEvent",value:function(date){var self=this;self.getCalendarCreateView().done((function(data){if(!(data.length<=0)){var dateFormat=data.find('[name="date_start"]').data("dateFormat").toUpperCase(),defaultTimeFormat="hh:mm A";24==data.find('[name="time_start"]').data("format")&&(defaultTimeFormat="HH:mm");var startDateInstance=Date.parse(date),startDateString=moment(date).format(dateFormat),startTimeString=moment(date).format(defaultTimeFormat),endDateInstance=Date.parse(date),endDateString=moment(date).format(dateFormat),endTimeString=void 0;if("month"==self.getCalendarView().fullCalendar("getView").name)if(parseInt((endDateInstance-startDateInstance)/864e5)>1){var explodedTime=app.getMainParams("startHour").split(":");startTimeString=explodedTime[0],endTimeString=(explodedTime=app.getMainParams("endHour").split(":"))[0]}else{var now=new Date;startTimeString=moment(now).format(defaultTimeFormat),endTimeString=moment(now).add(15,"minutes").format(defaultTimeFormat)}else endTimeString=moment(endDateInstance).add(30,"minutes").format(defaultTimeFormat);data.find('[name="date_start"]').val(startDateString),data.find('[name="due_date"]').val(endDateString),data.find('[name="time_start"]').val(startTimeString),data.find('[name="time_end"]').val(endTimeString),(new Vtiger_Header_Js).handleQuickCreateData(data,{callbackFunction:function(data){self.addCalendarEvent(data.result,dateFormat)}})}}))}}]),_class2}(Calendar_Js);
//# sourceMappingURL=Calendar.min.js.map
