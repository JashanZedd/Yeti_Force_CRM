'use strict';

var classCallCheck = function (instance, Constructor) {
  if (!(instance instanceof Constructor)) {
    throw new TypeError("Cannot call a class as a function");
  }
};

var createClass = function () {
  function defineProperties(target, props) {
    for (var i = 0; i < props.length; i++) {
      var descriptor = props[i];
      descriptor.enumerable = descriptor.enumerable || false;
      descriptor.configurable = true;
      if ("value" in descriptor) descriptor.writable = true;
      Object.defineProperty(target, descriptor.key, descriptor);
    }
  }

  return function (Constructor, protoProps, staticProps) {
    if (protoProps) defineProperties(Constructor.prototype, protoProps);
    if (staticProps) defineProperties(Constructor, staticProps);
    return Constructor;
  };
}();

window.Chat_JS=function(){function Chat_Js(container){classCallCheck(this,Chat_Js),this.init(container),this.sendByEnter='true'!==app.getCookie('chat-notSendByEnter'),this.isSearchMode=!1,this.searchValue=null,this.isSearchParticipantsMode=!1,this.timerMessage=null,this.amountOfNewMessages=null,this.isSoundNotification='true'===app.getCookie('chat-isSoundNotification');}return createClass(Chat_Js,[{key:'init',value:function init(container){this.container=container,this.messageContainer=this.container.find('.js-chat_content'),this.maxLengthMessage=this.messageContainer.data('maxLengthMessage'),this.searchInput=this.container.find('.js-search-message'),this.searchCancel=this.container.find('.js-search-cancel'),this.searchParticipantsInput=this.container.find('.js-search-participants'),this.searchParticipantsCancel=this.container.find('.js-search-participants-cancel'),this.participants=this.container.find('.js-participants-list .js-users');}},{key:'request',value:function request(){var data=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},progress=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],elementTo=2<arguments.length&&void 0!==arguments[2]?arguments[2]:this.messageContainer,aDeferred=$.Deferred(),progressIndicator=null;return progress&&(progressIndicator=this.progressShow(elementTo)),AppConnector.request($.extend({module:'Chat'},data)).done(function(data){aDeferred.resolve(data);}).always(function(){progress&&progressIndicator.progressIndicator({mode:'hide'});}),aDeferred.promise()}},{key:'getLastMessageId',value:function getLastMessageId(){return this.messageContainer.find('.js-chat-item:last').data('mid')}},{key:'progressShow',value:function progressShow(elementTo){return $.progressIndicator({position:'html',blockInfo:{enabled:!0,elementToBlock:elementTo}})}},{key:'sendMessage',value:function sendMessage(inputMessage){var _this=this,len=inputMessage.html().length;if(0!==len)if(len<this.maxLengthMessage){clearTimeout(this.timerMessage);var mid=null;this.isSearchMode||(mid=this.messageContainer.find('.js-chat-item:last').data('mid')),this.request({view:'Entries',mode:'send',roomType:this.getCurrentRoomType(),recordId:this.getCurrentRecordId(),message:inputMessage.html(),mid:mid}).done(function(html){_this.isSearchMode?(_this.messageContainer.html(html),_this.turnOffSearchMode(),_this.registerLoadMore()):_this.messageContainer.append(html),_this.getMessage(!0),_this.buildParticipantsFromMessage($('<div></div>').html(html)),_this.scrollToBottom(!1);}),inputMessage.html('');}else Vtiger_Helper_Js.showPnotify({text:app.vtranslate('JS_MESSAGE_TOO_LONG'),type:'error',animation:'show'});}},{key:'getAll',value:function getAll(){var _this2=this,reloadParticipants=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];clearTimeout(this.timerMessage),this.request({view:'Entries',mode:'get',roomType:this.getCurrentRoomType(),recordId:this.getCurrentRecordId()},!1).done(function(html){html&&(!_this2.isRoomActive()&&_this2.activateRoom(),reloadParticipants&&_this2.buildParticipantsFromInput($('<div></div>').html(html).find('.js-participants-data'),!0),_this2.messageContainer.html(html),_this2.scrollToBottom(),_this2.registerLoadMore()),_this2.getMessage(!0);});}},{key:'getMore',value:function getMore(btn){var _this3=this;clearTimeout(this.timerMessage),this.request({view:'Entries',mode:'getMore',lastId:btn.data('mid'),roomType:this.getCurrentRoomType(),recordId:this.getCurrentRecordId()},!1).done(function(html){html&&(btn.before(html),btn.remove(),_this3.registerLoadMore()),_this3.getMessage(!0);});}},{key:'searchMessage',value:function searchMessage(){var _this4=this,btn=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;clearTimeout(this.timerMessage);var mid=null;null!==btn&&(mid=btn.data('mid')),this.request({view:'Entries',mode:'search',searchVal:this.searchInput.val(),mid:mid,roomType:this.getCurrentRoomType(),recordId:this.getCurrentRecordId()},!1).done(function(html){null===btn?_this4.messageContainer.html(html):(btn.before(html),btn.remove()),_this4.registerLoadMore(),null==mid&&_this4.scrollToBottom();});}},{key:'turnOffSearchMode',value:function turnOffSearchMode(){this.searchCancel.addClass('hide'),this.searchInput.val(''),this.isSearchMode=!1;}},{key:'turnOffSearchParticipantsMode',value:function turnOffSearchParticipantsMode(){this.searchParticipantsCancel.addClass('hide'),this.searchParticipantsInput.val(''),this.isSearchParticipantsMode=!1,this.participants.find('.js-item-user').each(function(index,element){$(element).removeClass('hide');});}},{key:'searchParticipants',value:function searchParticipants(){var searchVal=this.searchParticipantsInput.val().toLowerCase();this.participants.find('.js-item-user').each(function(index,element){var userName=$(element).find('.js-user-name').text().toLowerCase();$(element).toggleClass('hide',!(0<=userName.indexOf(searchVal)));}),this.container.find('.js-participants-list').scrollTop(0);}},{key:'createParticipantItem',value:function createParticipantItem(){var data=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},itemUser=this.container.find('.js-participants-list .js-temp-item-user').clone(!1,!1);return itemUser.removeClass('js-temp-item-user'),itemUser.removeClass('hide'),itemUser.find('.js-user-name').html(data.userName),itemUser.find('.js-role').html(data.role),itemUser.find('.js-message').html(data.message),itemUser.data('userId',data.userId),data.image&&(itemUser.find('.js-image .js-chat-image_icon').addClass('hide'),itemUser.find('.js-image .js-chat-image_src').removeClass('hide').attr('src',data.image)),itemUser}},{key:'getParticipantsFromMessages',value:function getParticipantsFromMessages(messageContainer){var participantsId=[];return messageContainer.find('.js-chat-item').each(function(index,element){var userId=$(element).data('userId');0>$.inArray(userId,participantsId)&&participantsId.push(userId);}),participantsId}},{key:'createParticipants',value:function createParticipants(){var participantsId=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];if(participantsId.length)for(var len=participantsId.length,i=0;i<len;++i){var userId=participantsId[i],lastMessage=this.messageContainer.find('.js-chat-item[data-user-id='+userId+']:last');lastMessage.length&&this.participants.append(this.createParticipantItem({userName:lastMessage.find('.js-author').data('userName'),role:lastMessage.find('.js-author').data('roleName'),message:lastMessage.find('.messages').html(),userId:userId,image:lastMessage.find('.js-author .js-image .js-chat-image_src').attr('src')}));}}},{key:'buildParticipantsFromMessage',value:function buildParticipantsFromMessage(messageContainer){if(!this.isSearchParticipantsMode){var currentParticipants=[];this.participants.find('.js-item-user').each(function(index,element){var userId=$(element).data('userId');currentParticipants.push(userId);var lastMessage=messageContainer.find('.js-chat-item[data-user-id='+userId+']:last');lastMessage.length&&$(element).find('.js-message').html(lastMessage.find('.js-message').html());}),this.createParticipants($(this.getParticipantsFromMessages(messageContainer)).not(currentParticipants).get());}}},{key:'buildParticipantsFromInput',value:function buildParticipantsFromInput(element){var reload=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1];if(!this.isSearchParticipantsMode&&(reload&&this.participants.html(''),element.length))for(var users=JSON.parse(element.val()),len=users.length,i=0;i<len;++i)this.participants.append(this.createParticipantItem({userName:users[i].user_name,role:users[i].role_name,message:users[i].message,userId:users[i].user_id,image:users[i].image}));}},{key:'isRoomActive',value:function isRoomActive(){return 0===this.container.find('.js-container-chat').length||!this.container.find('.js-container-chat').hasClass('hide')}},{key:'getCurrentRoomType',value:function getCurrentRoomType(){return this.messageContainer.data('currentRoomType')}},{key:'getCurrentRecordId',value:function getCurrentRecordId(){return this.messageContainer.data('currentRecordId')}},{key:'getMessageTimer',value:function getMessageTimer(){return this.messageContainer.data('messageTimer')}},{key:'scrollToBottom',value:function scrollToBottom(){var scrollToTop=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],chatContent=this.messageContainer.closest('.js-chat-main-content');scrollToTop&&chatContent.scrollTop(0),chatContent.length&&chatContent.animate({scrollTop:chatContent[0].scrollHeight},300);}},{key:'getMessage',value:function getMessage(){var _this5=this,timer=!!(0<arguments.length&&void 0!==arguments[0])&&arguments[0];timer&&clearTimeout(this.timerMessage),this.timerMessage=setTimeout(function(){_this5.request({view:'Entries',mode:'get',lastId:_this5.getLastMessageId(),roomType:_this5.getCurrentRoomType(),recordId:_this5.getCurrentRecordId(),viewForRecord:!0},!1).done(function(html){html&&(!_this5.isRoomActive()&&_this5.activateRoom(),_this5.messageContainer.append(html),_this5.buildParticipantsFromMessage($('<div></div>').html(html)),_this5.scrollToBottom(!1)),timer&&_this5.getMessage(!0);});},this.getMessageTimer());}},{key:'registerSendEvent',value:function registerSendEvent(){var _this6=this,inputMessage=this.container.find('.js-chat-message');inputMessage.on('keydown',function(e){_this6.sendByEnter&&(e.shiftKey||13!==e.keyCode||(e.preventDefault(),_this6.sendMessage(inputMessage)));}),this.container.find('.js-btn-send').on('click',function(){_this6.sendMessage(inputMessage);});}},{key:'registerButtonFavorites',value:function registerButtonFavorites(){var _this7=this,btnRemove=this.container.find('.js-remove-from-favorites'),btnAdd=this.container.find('.js-add-from-favorites');btnRemove.off('click').on('click',function(){btnRemove.toggleClass('hide'),btnAdd.toggleClass('hide'),_this7.request({action:'Room',mode:'removeFromFavorites',roomType:_this7.getCurrentRoomType(),recordId:_this7.getCurrentRecordId()});}),btnAdd.off('click').on('click',function(){btnRemove.toggleClass('hide'),btnAdd.toggleClass('hide'),_this7.request({action:'Room',mode:'addToFavorites',roomType:_this7.getCurrentRoomType(),recordId:_this7.getCurrentRecordId()});});}},{key:'registerLoadMore',value:function registerLoadMore(){var _this8=this;this.messageContainer.find('.js-load-more').off('click').on('click',function(e){var btn=$(e.currentTarget);_this8.isSearchMode?_this8.searchMessage(btn):_this8.getMore(btn);});}},{key:'registerSearchMessage',value:function registerSearchMessage(){var _this9=this;this.searchInput.off('keydown').on('keydown',function(e){13===e.keyCode&&(e.preventDefault(),''===_this9.searchInput.val()?(_this9.searchCancel.addClass('hide'),_this9.isSearchMode=!1):(_this9.isSearchMode=!0,_this9.searchCancel.removeClass('hide'),_this9.searchMessage()));}),this.container.find('.js-icon-search-message').on('click',function(e){e.preventDefault(),''===_this9.searchInput.val()?(_this9.searchCancel.addClass('hide'),_this9.isSearchMode=!1):(_this9.isSearchMode=!0,_this9.searchCancel.removeClass('hide'),_this9.searchMessage());}),this.searchCancel.off('click').on('click',function(e){e.preventDefault(),_this9.turnOffSearchMode(),_this9.getAll(!1);});}},{key:'registerSearchParticipants',value:function registerSearchParticipants(){var _this10=this;this.searchParticipantsInput.off('keyup').on('keyup',function(){var len=_this10.searchParticipantsInput.val().length;1<len?(_this10.isSearchParticipantsMode=!0,_this10.searchParticipantsCancel.removeClass('hide')):0===len&&_this10.turnOffSearchParticipantsMode(),_this10.searchParticipants();}),this.searchParticipantsCancel.off('click').on('click',function(){_this10.turnOffSearchParticipantsMode(),_this10.searchParticipants();});}},{key:'registerBaseEvents',value:function registerBaseEvents(){var _this11=this;this.registerSendEvent(),this.registerLoadMore(),this.getMessage(!0),this.registerButtonFavorites(),this.registerSearchMessage(),this.registerSearchParticipants(),new App.Fields.Text.Completions(this.container.find('.js-completions')),setTimeout(function(){_this11.scrollToBottom();},100);}},{key:'unregisterEvents',value:function unregisterEvents(){clearTimeout(this.timerMessage);}}],[{key:'getInstance',value:function getInstance(container){var typeInstance=1<arguments.length&&void 0!==arguments[1]?arguments[1]:'modal';return 'undefined'==typeof Chat_Js.instance&&(Chat_Js.instance={}),'undefined'==typeof Chat_Js.instance[typeInstance]?Chat_Js.instance[typeInstance]=new Chat_Js(container):Chat_Js.instance[typeInstance].init(container),Chat_Js.instance[typeInstance]}},{key:'isDesktopNotification',value:function isDesktopNotification(){return 'true'===app.getCookie('chat-isDesktopNotification')}},{key:'checkDesktopPermission',value:function checkDesktopPermission(){return 0===PNotify.modules.Desktop.checkPermission()}}]),Chat_Js}();
//# sourceMappingURL=Chat.min.js.map
