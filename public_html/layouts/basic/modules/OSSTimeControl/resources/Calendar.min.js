'use strict';

jQuery.Class('OSSTimeControl_Calendar_Js',{registerUserListWidget:function registerUserListWidget(){var widgetContainer=$('.widgetContainer');widgetContainer.hover(function(){$(this).css('overflow','visible');},function(){$(this).css('overflow','hidden');}),this.registerColorField(widgetContainer.find('#calendarUserList'),'userCol'),this.registerColorField(widgetContainer.find('#timecontrolTypes'),'listCol'),widgetContainer.find('.select2').on('change',function(){$(this).closest('.siteBarContent').find('.refreshHeader').removeClass('d-none');});},registerColorField:function registerColorField(field,fieldClass){var params={};params.dropdownCss={"z-index":0},params.formatSelection=function(object,container){var selectedId=object.id,selectedOptionTag=field.find('option[value="'+selectedId+'"]');container.addClass(fieldClass+'_'+selectedId);var element='<div>'+selectedOptionTag.text()+'</div>';return element},App.Fields.Picklist.changeSelectElementView(field,'select2',params);}},{calendarView:!1,calendarCreateView:!1,registerCalendar:function registerCalendar(){var thisInstance=this,eventLimit=jQuery('#eventLimit').val();eventLimit=!('true'!=eventLimit)||'false'!=eventLimit&&parseInt(eventLimit)+1;var weekView=jQuery('#weekView').val(),dayView=jQuery('#dayView').val(),userDefaultActivityView=jQuery('#activity_view').val();userDefaultActivityView='Today'==userDefaultActivityView?dayView:'This Week'==userDefaultActivityView?weekView:'month';var userDefaultTimeFormat=jQuery('#time_format').val(),popoverTimeFormat=void 0;24==userDefaultTimeFormat?(userDefaultTimeFormat='H:mm',popoverTimeFormat='HH:mm'):(userDefaultTimeFormat='h:mmt',popoverTimeFormat='hh:mm A');var convertedFirstDay=CONFIG.firstDayOfWeekNo,defaultFirstHour=jQuery('#start_hour').val(),explodedTime=defaultFirstHour.split(':');defaultFirstHour=explodedTime[0],thisInstance.getCalendarView().fullCalendar('destroy'),thisInstance.getCalendarView().fullCalendar({header:{left:'month,'+weekView+','+dayView,center:'title today',right:'prev,next'},timeFormat:userDefaultTimeFormat,axisFormat:userDefaultTimeFormat,firstHour:defaultFirstHour,firstDay:convertedFirstDay,defaultView:userDefaultActivityView,editable:!0,slotMinutes:15,defaultEventMinutes:0,forceEventDuration:!0,defaultTimedEventDuration:'01:00:00',eventLimit:eventLimit,allDaySlot:!1,height:app.setCalendarHeight(),views:{basic:{eventLimit:!1}},dayClick:function dayClick(date){thisInstance.selectDay(date.format()),thisInstance.getCalendarView().fullCalendar('unselect');},eventDrop:function eventDrop(event,delta,revertFunc){thisInstance.updateEvent(event,delta,revertFunc);},eventResize:function eventResize(event,delta,revertFunc){thisInstance.updateEvent(event,delta,revertFunc);},eventRender:function eventRender(event,element){app.showPopoverElementView(element.find('.fc-content'),{title:event.title+'<a href="index.php?module=OSSTimeControl&view=Edit&record='+event.id+'" class="float-right"><span class="fas fa-edit"></span></a><a href="index.php?module=OSSTimeControl&view=Detail&record='+event.id+'" class="float-right mx-1"><span class="fas fa-th-list"></span></a>',container:'body',html:!0,placement:'auto',template:'<div class="popover calendarPopover" role="tooltip"><div class="arrow"></div><h3 class="popover-header"></h3><div class="popover-body"></div></div>',content:'<div><span class="far fa-clock"></span> <label>'+app.vtranslate('JS_START_DATE')+'</label>: '+event.start_display+'</div><div><span class="far fa-clock"></span> <label>'+app.vtranslate('JS_END_DATE')+'</label>: '+event.end_display+'</div><div><span class="far fa-clock"></span> <label>'+app.vtranslate('JS_TOTAL_TIME')+'</label>: '+event.totalTime+'</div><div><span class="fas fa-bars"></span> <label>'+app.vtranslate('JS_NUMBER')+'</label>: '+event.number+'</div><div><span class="fas fa-question-circle"></span> <label>'+app.vtranslate('JS_TYPE')+'</label>: <span class="picklistCT_OSSTimeControl_timecontrol_type_'+event.type_value+'">'+event.type+'</span></div>'+(event.status?'<div><span class="far fa-star"></span> <label>'+app.vtranslate('JS_STATUS')+'</label>: <span class="picklistCT_OSSTimeControl_osstimecontrol_status_'+event.sta+'">'+event.status+'</span></div>':'')+(event.linkl?'<div><span class="userIcon-'+event.linkm+'" aria-hidden="true"></span> <label>'+app.vtranslate('JS_RELATION')+'</label>: <a class="modCT_'+event.linkm+'" target="_blank" href="index.php?module='+event.linkm+'&view=Detail&record='+event.link+'">'+event.linkl+'</a></div>':'')+(event.linkexl?'<div><span class="userIcon-'+event.linkexm+'" aria-hidden="true"></span> <label>'+app.vtranslate('JS_RELATION_EXTEND')+'</label>: <a class="modCT_'+event.linkexm+'" target="_blank" href="index.php?module='+event.linkexm+'&view=Detail&record='+event.linkextend+'">'+event.linkexl+'</a></div>':'')+(event.procl?'<div><span class="userIcon-'+event.procm+'" aria-hidden="true"></span> <label>'+app.vtranslate('JS_PROCESS')+'</label>: <a class="modCT_'+event.procm+'" target="_blank" href="index.php?module='+event.procm+'&view=Detail&record='+event.process+'">'+event.procl+'</a></div>':'')+(event.subprocl?'<div><span class="userIcon-'+event.subprocm+'" aria-hidden="true"></span> <label>'+app.vtranslate('JS_SUB_PROCESS')+'</label>: <a class="modCT_'+event.subprocm+'" target="_blank" href="index.php?module='+event.subprocm+'&view=Detail&record='+event.subprocess+'">'+event.subprocl+'</a></div>':'')+(event.smownerid?'<div><span class="fas fa-user"></span> <label>'+app.vtranslate('JS_ASSIGNED_TO')+'</label>: '+event.smownerid+'</div>':'')});},monthNames:[app.vtranslate('JS_JANUARY'),app.vtranslate('JS_FEBRUARY'),app.vtranslate('JS_MARCH'),app.vtranslate('JS_APRIL'),app.vtranslate('JS_MAY'),app.vtranslate('JS_JUNE'),app.vtranslate('JS_JULY'),app.vtranslate('JS_AUGUST'),app.vtranslate('JS_SEPTEMBER'),app.vtranslate('JS_OCTOBER'),app.vtranslate('JS_NOVEMBER'),app.vtranslate('JS_DECEMBER')],monthNamesShort:[app.vtranslate('JS_JAN'),app.vtranslate('JS_FEB'),app.vtranslate('JS_MAR'),app.vtranslate('JS_APR'),app.vtranslate('JS_MAY'),app.vtranslate('JS_JUN'),app.vtranslate('JS_JUL'),app.vtranslate('JS_AUG'),app.vtranslate('JS_SEP'),app.vtranslate('JS_OCT'),app.vtranslate('JS_NOV'),app.vtranslate('JS_DEC')],dayNames:[app.vtranslate('JS_SUNDAY'),app.vtranslate('JS_MONDAY'),app.vtranslate('JS_TUESDAY'),app.vtranslate('JS_WEDNESDAY'),app.vtranslate('JS_THURSDAY'),app.vtranslate('JS_FRIDAY'),app.vtranslate('JS_SATURDAY')],dayNamesShort:[app.vtranslate('JS_SUN'),app.vtranslate('JS_MON'),app.vtranslate('JS_TUE'),app.vtranslate('JS_WED'),app.vtranslate('JS_THU'),app.vtranslate('JS_FRI'),app.vtranslate('JS_SAT')],buttonText:{today:app.vtranslate('JS_TODAY'),month:app.vtranslate('JS_MONTH'),week:app.vtranslate('JS_WEEK'),day:app.vtranslate('JS_DAY')},allDayText:app.vtranslate('JS_ALL_DAY'),eventLimitText:app.vtranslate('JS_MORE')});},registerRefreshEvent:function registerRefreshEvent(){var thisInstance=this;$('.refreshCalendar').on('click',function(){$(this).closest('.refreshHeader').addClass('d-none'),thisInstance.loadCalendarData();});},registerButtonSelectAll:function registerButtonSelectAll(){var selectBtn=$('.selectAllBtn');selectBtn.on('click',function(){var selectAllLabel=$(this).find('.selectAll'),deselectAllLabel=$(this).find('.deselectAll');selectAllLabel.hasClass('d-none')?(selectAllLabel.removeClass('d-none'),deselectAllLabel.addClass('d-none'),$(this).closest('.quickWidget').find('select option').prop('selected',!1)):($(this).closest('.quickWidget').find('select option').prop('selected',!0),deselectAllLabel.removeClass('d-none'),selectAllLabel.addClass('d-none')),$(this).closest('.quickWidget').find('select').trigger('change');});},loadCalendarData:function loadCalendarData(allEvents){var progressInstance=jQuery.progressIndicator(),thisInstance=this;thisInstance.getCalendarView().fullCalendar('removeEvents');var user,view=thisInstance.getCalendarView().fullCalendar('getView'),formatDate=CONFIG.dateFormat.toUpperCase();if(user=0==jQuery('#calendarUserList').length?CONFIG.userId:jQuery('#calendarUserList').val(),0<jQuery('#timecontrolTypes').length)var types=jQuery('#timecontrolTypes').val();else allEvents=!0;if(!0==allEvents||null!=types){var params={module:'OSSTimeControl',action:'Calendar',mode:'getEvent',start:view.start.format(formatDate),end:view.end.format(formatDate),user:user,types:types};AppConnector.request(params).done(function(events){thisInstance.getCalendarView().fullCalendar('addEventSource',events.result),progressInstance.hide();});}else thisInstance.getCalendarView().fullCalendar('removeEvents'),progressInstance.hide();},updateEvent:function updateEvent(event,delta,revertFunc){var progressInstance=jQuery.progressIndicator(),start=event.start.format(),end=event.end.format(),params={module:'OSSTimeControl',action:'Calendar',mode:'updateEvent',id:event.id,start:start,delta:delta._data};AppConnector.request(params).done(function(response){response.result||(Vtiger_Helper_Js.showPnotify(app.vtranslate('JS_NO_EDIT_PERMISSION')),revertFunc()),progressInstance.hide();}).fail(function(){progressInstance.hide(),Vtiger_Helper_Js.showPnotify(app.vtranslate('JS_NO_EDIT_PERMISSION')),revertFunc();});},selectDay:function selectDay(date){var thisInstance=this;thisInstance.getCalendarCreateView().done(function(data){if(!(0>=data.length)){var dateFormat=data.find('[name="date_start"]').data('dateFormat').toUpperCase(),timeFormat=data.find('[name="time_start"]').data('format');if(24==timeFormat)var defaultTimeFormat='HH:mm';else defaultTimeFormat='hh:mm A';var startDateInstance=Date.parse(date),startDateString=moment(date).format(dateFormat),startTimeString=moment(date).format(defaultTimeFormat),endDateInstance=Date.parse(date),endDateString=moment(date).format(dateFormat),view=thisInstance.getCalendarView().fullCalendar('getView');if('month'==view.name){var endTimeString,diffDays=parseInt((endDateInstance-startDateInstance)/86400000);if(1<diffDays){var defaultFirstHour=jQuery('#start_hour').val(),explodedTime=defaultFirstHour.split(':');startTimeString=explodedTime[0];var defaultLastHour=jQuery('#end_hour').val();explodedTime=defaultLastHour.split(':'),endTimeString=explodedTime[0];}else{var now=new Date;startTimeString=moment(now).format(defaultTimeFormat),endTimeString=moment(now).add(15,'minutes').format(defaultTimeFormat);}}else endTimeString=moment(endDateInstance).add(30,'minutes').format(defaultTimeFormat);data.find('[name="date_start"]').val(startDateString),data.find('[name="due_date"]').val(endDateString),data.find('[name="time_start"]').val(startTimeString),data.find('[name="time_end"]').val(endTimeString);var headerInstance=new Vtiger_Header_Js;headerInstance.handleQuickCreateData(data,{callbackFunction:function callbackFunction(data){thisInstance.addCalendarEvent(data.result,dateFormat);}}),jQuery('.modal-body').css({"max-height":app.getScreenHeight(70)+'px',"overflow-y":'auto'});}});},addCalendarEvent:function addCalendarEvent(calendarDetails){var usersList=$('#calendarUserList').val();if(0===usersList.length&&(usersList=[CONFIG.userId.toString()]),!(0>$.inArray(calendarDetails.assigned_user_id.value,usersList))){var types=$('#timecontrolTypes').val();if(!(0>$.inArray(calendarDetails.timecontrol_type.value,types)&&0<types.length)){var calendar=this.getCalendarView(),eventObject={id:calendarDetails._recordId,title:calendarDetails.name.display_value,start:calendar.fullCalendar('moment',calendarDetails.date_start.value+' '+calendarDetails.time_start.value).format(),end:calendar.fullCalendar('moment',calendarDetails.due_date.value+' '+calendarDetails.time_end.value).format(),start_display:calendarDetails.date_start.display_value+' '+calendarDetails.time_start.display_value,end_display:calendarDetails.due_date.display_value+' '+calendarDetails.time_end.display_value,url:'index.php?module=OSSTimeControl&view=Detail&record='+calendarDetails._recordId,className:'ownerCBg_'+calendarDetails.assigned_user_id.value+' picklistCBr_OSSTimeControl_timecontrol_type_'+calendarDetails.timecontrol_type.value,totalTime:calendarDetails.sum_time.display_value,number:calendarDetails.osstimecontrol_no.display_value,type:calendarDetails.timecontrol_type.display_value,type_value:calendarDetails.timecontrol_type.value,status:calendarDetails.osstimecontrol_status.display_value,sta:calendarDetails.osstimecontrol_status.value,smownerid:calendarDetails.assigned_user_id.display_value};this.getCalendarView().fullCalendar('renderEvent',eventObject);}}},getCalendarCreateView:function getCalendarCreateView(){var thisInstance=this,aDeferred=jQuery.Deferred();if(!1!==this.calendarCreateView)return aDeferred.resolve(this.calendarCreateView.clone(!0,!0)),aDeferred.promise();var progressInstance=jQuery.progressIndicator();return this.loadCalendarCreateView().done(function(data){progressInstance.hide(),thisInstance.calendarCreateView=data,aDeferred.resolve(data.clone(!0,!0));}).fail(function(){progressInstance.hide();}),aDeferred.promise()},loadCalendarCreateView:function loadCalendarCreateView(){var aDeferred=jQuery.Deferred(),moduleName=app.getModuleName(),headerInstance=Vtiger_Header_Js.getInstance();return headerInstance.getQuickCreateForm('index.php?module='+moduleName+'&view=QuickCreateAjax',moduleName).done(function(data){aDeferred.resolve(jQuery(data));}).fail(function(textStatus,errorThrown){aDeferred.reject(textStatus,errorThrown);}),aDeferred.promise()},getCalendarView:function getCalendarView(){return !1==this.calendarView&&(this.calendarView=jQuery('.js-calendar__container')),this.calendarView},registerChangeView:function registerChangeView(){var thisInstance=this;thisInstance.getCalendarView().find('button.fc-button:not(.dropdown-toggle)').on('click',function(){thisInstance.loadCalendarData();});},registerAddButton:function registerAddButton(){var self=this;$('.js-add').on('click',function(){self.getCalendarCreateView().done(function(data){var headerInstance=new Vtiger_Header_Js;headerInstance.handleQuickCreateData(data,{callbackFunction:function callbackFunction(data){self.addCalendarEvent(data.result);}});});});},registerEvents:function registerEvents(){this.registerCalendar(),this.loadCalendarData(!0),this.registerChangeView(),this.registerButtonSelectAll(),this.registerRefreshEvent(),this.registerAddButton();}});
//# sourceMappingURL=Calendar.min.js.map
