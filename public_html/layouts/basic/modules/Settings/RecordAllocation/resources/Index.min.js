jQuery.Class("Settings_RecordAllocation_Index_Js",{},{container:false,registerDataTables:function(a){var b=this;$.extend($.fn.dataTable.defaults,{language:{sLengthMenu:app.vtranslate("JS_S_LENGTH_MENU"),sZeroRecords:app.vtranslate("JS_NO_RESULTS_FOUND"),sInfo:app.vtranslate("JS_S_INFO"),sInfoEmpty:app.vtranslate("JS_S_INFO_EMPTY"),sSearch:app.vtranslate("JS_SEARCH"),sEmptyTable:app.vtranslate("JS_NO_RESULTS_FOUND"),sInfoFiltered:app.vtranslate("JS_S_INFO_FILTERED"),sLoadingRecords:app.vtranslate("JS_LOADING_OF_RECORDS"),sProcessing:app.vtranslate("JS_LOADING_OF_RECORDS"),oAria:{sSortAscending:app.vtranslate("JS_S_SORT_ASCENDING"),sSortDescending:app.vtranslate("JS_S_SORT_DESCENDING")}}});if(a==undefined){a=b.getContainer()}a.find(".js-data-table").dataTable({scrollY:200,deferRender:true,scroller:true,paging:false,info:false})},registerDragDropEvent:function(b){var d=this;if(b==undefined){return}var a=b.closest(".js-panel");var c=a.data("index");b.find(".js-drag-drop-"+c).draggable({appendTo:"body",helper:"clone",start:function(h,g){var f=$(g.helper.context).width();$(g.helper).css("width",f).addClass("dataTableDragDrop bg-primary")},zIndex:9999999999});b.find(".dataTables_scrollBody .js-data-table").droppable({activeClass:"ui-state-default",hoverClass:"ui-state-hover",accept:".js-drag-drop-"+c,drop:function(g,h){var f=$(h.draggable).closest(".js-data-table");var e=$(this);if(f.data("mode")!=e.data("mode")){f.DataTable().row(h.draggable).remove().draw();e.DataTable().row.add(h.draggable[0]).draw();var e=e.data("mode")=="active"?e:f;d.save(e.closest(".js-panel"))}}})},save:function(b){var c={module:b.data("modulename"),userid:b.find(".js-base-user").val(),type:app.getMainParams("fieldType")};var a=[];var d=b.find(".dataTables_scrollBody:first tbody tr");d.each(function(f){var h=jQuery(this).data("id");var g=jQuery(this).data("type");if(h&&g){if(!a[g]){a[g]=[]}a[g].push(h)}});c.ids=jQuery.extend({},a);app.saveAjax("save",jQuery.extend({},c))},registerModalButton:function(){var b=this;var a=this.getContainer();a.find("button.js-add-panel").on("click",function(){var d=a.find(".js-modal-add-panel").clone(true,true);var c=b.getModules();d.find("select option").each(function(){if($.inArray($(this).val(),c)!=-1){$(this).remove()}});app.showModalWindow(d,function(g){var e=g.find("select");App.Fields.Picklist.showSelect2ElementView(e);var f=g.find("form");f.on("submit",function(j){var i=$(j.currentTarget);var h=i.find(".js-modules-list");if(h.length&&h.val()){b.addPanel(h.val())}j.preventDefault()})})})},getModules:function(){var a=[];this.getContainer().find(".js-panel").each(function(){a.push(jQuery(this).data("modulename"))});return a},addPanel:function(b){var c=this;var a=jQuery.Deferred();var e=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var d=this.getContainer().find(".js-panel:last");var f={};f.index=d.data("index");f.module=app.getModuleName();f.parent=app.getParentModuleName();f.sourceModule=b;f.view="Index";f.mode="getPanel";f.type=app.getMainParams("fieldType");AppConnector.request(f).then(function(h){var g=c.getContainer().find(".js-panels-container").append(h);App.Fields.Picklist.changeSelectElementView(g.find(".chzn-select"));app.hideModalWindow();e.progressIndicator({mode:"hide"});a.resolve(h)},function(g){e.progressIndicator({mode:"hide"});a.reject(g)});return a.promise()},registerLoadData:function(){var a=this;this.getContainer().on("change",".js-base-user",function(j){var h=jQuery(j.currentTarget);var b=h.closest(".js-panel-item");var c=b.find(".js-module-allocation-data").val();var g=[];if(c&&c!="null"){g=JSON.parse(c)}var d=g[h.val()];var i=b.find(".js-active-panel");if(i.length){i.remove()}var i=b.find(".js-clear-tables").clone(true,true);if(d!=undefined){var k=i.find(".js-data-table .dropContainer:first");var f=i.find(".js-data-table .dropContainer:last");f.find("tr").each(function(){var e=jQuery(this).data("type");var l=jQuery(this).data("id");if(jQuery.inArray(l.toString(),d[e])!=-1){k.append(jQuery(this))}})}b.find(".js-panel-body").removeClass("d-none").append(i.removeClass("js-clear-tables d-none").addClass("js-active-panel"));a.registerDataTables(i);a.registerDragDropEvent(i)})},registerHeaderElements:function(){this.getContainer().on("click",".js-remove-panel",function(f){var d=jQuery(f.currentTarget);var a=d.closest(".js-panel");var c={module:a.data("modulename"),type:app.getMainParams("fieldType")};var b=app.vtranslate("JS_ARE_YOU_SURE_YOU_WANT_TO_DELETE_PANEL");Vtiger_Helper_Js.showConfirmationBox({message:b}).then(function(g){app.saveAjax("removePanel",c).then(function(){a.fadeOut(300,function(){$(this).remove()})})})});this.registerLoadData()},getContainer:function(){if(this.container==false){this.container=jQuery("div.contentsDiv")}return this.container},registerEvents:function(){this.registerModalButton();this.registerHeaderElements()}});