{"version":3,"file":"Roles.min.js","sources":["Roles.js"],"sourcesContent":["/*+***********************************************************************************\n * The contents of this file are subject to the vtiger CRM Public License Version 1.0\n * (\"License\"); You may not use this file except in compliance with the License\n * The Original Code is:  vtiger CRM Open Source\n * The Initial Developer of the Original Code is vtiger.\n * Portions created by vtiger are Copyright (C) vtiger.\n * All Rights Reserved.\n *************************************************************************************/\n'use strict';\n\nvar Settings_Roles_Js = {\n\n\tnewPriviliges: false,\n\n\tinitDeleteView: function () {\n\t\tjQuery('#roleDeleteForm').validationEngine(app.validationEngineOptions);\n\n\t\tjQuery('[data-action=\"popup\"]').on('click', function (e) {\n\t\t\te.preventDefault();\n\t\t\tvar target = $(e.currentTarget);\n\t\t\tvar field = target.data('field');\n\n\t\t\tvar popupInstance = Vtiger_Popup_Js.getInstance();\n\t\t\tpopupInstance.show(target.data('url'));\n\t\t\tpopupInstance.retrieveSelectedRecords(function (data) {\n\t\t\t\ttry {\n\t\t\t\t\tdata = JSON.parse(data);\n\t\t\t\t} catch (e) {\n\t\t\t\t}\n\n\t\t\t\tif (typeof data == 'object') {\n\t\t\t\t\tjQuery('[name=\"' + field + '_display\"]').val(data.label);\n\t\t\t\t\tdata = data.value;\n\t\t\t\t}\n\t\t\t\tjQuery('[name=\"' + field + '\"]').val(data);\n\t\t\t});\n\t\t});\n\n\t\tjQuery('#clearRole').on('click', function (e) {\n\t\t\tjQuery('[name=\"transfer_record_display\"]').val('');\n\t\t\tjQuery('[name=\"transfer_record\"]').val('');\n\t\t});\n\t},\n\n\tinitPopupView: function () {\n\t\tjQuery('.roleEle').on('click', function (e) {\n\t\t\tvar target = $(e.currentTarget);\n\t\t\t// jquery_windowmsg plugin expects second parameter to be string.\n\t\t\tjQuery.triggerParentEvent('postSelection', JSON.stringify({\n\t\t\t\tvalue: target.closest('li').data('roleid'),\n\t\t\t\tlabel: target.text()\n\t\t\t}));\n\t\t\tself.close();\n\t\t});\n\t},\n\n\tinitEditView: function () {\n\n\t\tfunction applyMoveChanges(roleid, parent_roleid) {\n\t\t\tvar params = {\n\t\t\t\tmodule: 'Roles',\n\t\t\t\taction: 'MoveAjax',\n\t\t\t\tparent: 'Settings',\n\t\t\t\trecord: roleid,\n\t\t\t\tparent_roleid: parent_roleid\n\t\t\t}\n\n\t\t\tAppConnector.request(params).done(function (res) {\n\t\t\t\tif (!res.success) {\n\t\t\t\t\tapp.showAlert(app.vtranslate('JS_FAILED_TO_SAVE'));\n\t\t\t\t\twindow.location.reload();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tjQuery('[rel=\"tooltip\"]').tooltip();\n\n\t\tfunction modalActionHandler(event) {\n\t\t\tvar target = $(event.currentTarget);\n\t\t\tapp.showModalWindow(null, target.data('url'), function (data) {\n\t\t\t\tSettings_Roles_Js.initDeleteView();\n\t\t\t});\n\t\t}\n\n\t\tjQuery('[data-action=\"modal\"]').on('click', modalActionHandler);\n\n\t\tjQuery('.toolbar').hide();\n\n\t\tjQuery('.toolbar-handle').on('mouseover', function (e) {\n\t\t\tvar target = $(e.currentTarget);\n\t\t\tjQuery('.toolbar', target).css({display: 'inline'});\n\t\t});\n\t\tjQuery('.toolbar-handle').on('mouseout', function (e) {\n\t\t\tvar target = $(e.currentTarget);\n\t\t\tjQuery('.toolbar', target).hide();\n\t\t});\n\n\t\tjQuery('.draggable').draggable({\n\t\t\tcontainment: '.treeView',\n\t\t\tstart: function (event, ui) {\n\t\t\t\tvar container = jQuery(ui.helper);\n\t\t\t\tvar referenceid = container.data('refid');\n\t\t\t\tvar sourceGroup = jQuery('[data-grouprefid=\"' + referenceid + '\"]');\n\t\t\t\tvar sourceRoleId = sourceGroup.data('roleid');\n\t\t\t\tif (sourceRoleId == 'H5' || sourceRoleId == 'H2') {\n\t\t\t\t\tvar params = {};\n\t\t\t\t\tparams.title = app.vtranslate('JS_PERMISSION_DENIED');\n\t\t\t\t\tparams.text = app.vtranslate('JS_NO_PERMISSIONS_TO_MOVE');\n\t\t\t\t\tparams.type = 'error';\n\t\t\t\t\tSettings_Vtiger_Index_Js.showMessage(params);\n\t\t\t\t}\n\t\t\t},\n\t\t\thelper: function (event) {\n\t\t\t\tvar target = $(event.currentTarget);\n\t\t\t\tvar targetGroup = target.closest('li');\n\t\t\t\tvar timestamp = +(new Date());\n\n\t\t\t\tvar container = $('<div/>');\n\t\t\t\tcontainer.data('refid', timestamp);\n\t\t\t\tcontainer.html(targetGroup.clone());\n\n\t\t\t\t// For later reference we shall assign the id before we return\n\t\t\t\ttargetGroup.attr('data-grouprefid', timestamp);\n\n\t\t\t\treturn container;\n\t\t\t}\n\t\t});\n\t\tjQuery('.droppable').droppable({\n\t\t\thoverClass: 'btn-primary',\n\t\t\ttolerance: 'pointer',\n\t\t\tdrop: function (event, ui) {\n\t\t\t\tvar container = $(ui.helper);\n\t\t\t\tvar referenceid = container.data('refid');\n\t\t\t\tvar sourceGroup = $('[data-grouprefid=\"' + referenceid + '\"]');\n\n\t\t\t\tvar thisWrapper = $(this).closest('div');\n\n\t\t\t\tvar targetRole = thisWrapper.closest('li').data('role');\n\t\t\t\tvar targetRoleId = thisWrapper.closest('li').data('roleid');\n\t\t\t\tvar sourceRole = sourceGroup.data('role');\n\t\t\t\tvar sourceRoleId = sourceGroup.data('roleid');\n\n\t\t\t\t// Attempt to push parent-into-its own child hierarchy?\n\t\t\t\tif (targetRole.indexOf(sourceRole + '::') == 0) {\n\t\t\t\t\t// Sorry\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t//Attempt to move the roles CEO and Sales Person\n\t\t\t\tif (sourceRoleId == 'H5' || sourceRoleId == 'H2') {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tsourceGroup.appendTo(thisWrapper.next('ul'));\n\n\t\t\t\tapplyMoveChanges(sourceRoleId, targetRoleId);\n\t\t\t}\n\t\t});\n\t},\n\n\tregisterSubmitEvent: function () {\n\t\tvar thisInstance = this;\n\t\tvar form = jQuery('#EditView');\n\t\tform.on('submit', function (e) {\n\t\t\tif (form.data('submit') == 'true' && form.data('performCheck') == 'true') {\n\t\t\t\treturn true;\n\t\t\t} else {\n\t\t\t\tvar selectElement = jQuery('#profilesList');\n\t\t\t\tvar select2Element = app.getSelect2ElementFromSelect(selectElement);\n\t\t\t\tvar result = Vtiger_MultiSelect_Validator_Js.invokeValidation(selectElement);\n\t\t\t\tif (result != true) {\n\t\t\t\t\tselect2Element.validationEngine('showPrompt', result, 'error', 'bottomLeft', true);\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\treturn;\n\t\t\t\t} else {\n\t\t\t\t\tselect2Element.validationEngine('hide');\n\t\t\t\t}\n\n\t\t\t\tif (form.data('jqv').InvalidFields.length <= 0) {\n\t\t\t\t\tvar formData = form.serializeFormData();\n\t\t\t\t\tthisInstance.checkDuplicateName({\n\t\t\t\t\t\t'rolename': formData.rolename,\n\t\t\t\t\t\t'record': formData.record\n\t\t\t\t\t}).done(function (data) {\n\t\t\t\t\t\tform.data('submit', 'true');\n\t\t\t\t\t\tform.data('performCheck', 'true');\n\t\t\t\t\t\tform.submit();\n\t\t\t\t\t\tjQuery.progressIndicator({\n\t\t\t\t\t\t\t'blockInfo': {\n\t\t\t\t\t\t\t\t'enabled': true\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}).fail(function (data, err) {\n\t\t\t\t\t\tvar params = {};\n\t\t\t\t\t\tparams['text'] = data['message'];\n\t\t\t\t\t\tparams['type'] = 'error';\n\t\t\t\t\t\tSettings_Vtiger_Index_Js.showMessage(params);\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\t//If validation fails, form should submit again\n\t\t\t\t\tform.removeData('submit');\n\t\t\t\t\tapp.formAlignmentAfterValidation(form);\n\t\t\t\t}\n\t\t\t\te.preventDefault();\n\t\t\t}\n\t\t});\n\t},\n\n\t/*\n\t * Function to check Duplication of Role Names\n\t * returns boolean true or false\n\t */\n\n\tcheckDuplicateName: function (details) {\n\t\tvar aDeferred = jQuery.Deferred();\n\n\t\tvar params = {\n\t\t\t'module': app.getModuleName(),\n\t\t\t'parent': app.getParentModuleName(),\n\t\t\t'action': 'EditAjax',\n\t\t\t'mode': 'checkDuplicate',\n\t\t\t'rolename': details.rolename,\n\t\t\t'record': details.record\n\t\t}\n\n\t\tAppConnector.request(params).done(function (data) {\n\t\t\tvar response = data['result'];\n\t\t\tvar result = response['success'];\n\t\t\tif (result == true) {\n\t\t\t\taDeferred.reject(response);\n\t\t\t} else {\n\t\t\t\taDeferred.resolve(response);\n\t\t\t}\n\t\t}).fail(function (error, err) {\n\t\t\taDeferred.reject(error, err);\n\t\t});\n\t\treturn aDeferred.promise();\n\t},\n\t/**\n\t * Register button to open modal logo upload form\n\t */\n\tregisterModalUploadButton: function () {\n\t\tconst thisInstance = this;\n\t\t$('.js-upload-logo').on('click', function () {\n\t\t\tapp.showModalWindow(null, $(this).data('url'), function (data) {\n\t\t\t\tthisInstance.registerUploadButton(data.find('form'));\n\t\t\t});\n\t\t});\n\t},\n\t/**\n\t * Register button send form\n\t * @param {jQuery} form\n\t */\n\tregisterUploadButton: function (form) {\n\t\tform.on('submit', function (e) {\n\t\t\te.preventDefault();\n\t\t\tif (form.validationEngine('validate') === true) {\n\t\t\t\tapp.removeEmptyFilesInput(form[0]);\n\t\t\t\tlet formData = new FormData(form[0]),\n\t\t\t\t\tprogressIndicatorElement = jQuery.progressIndicator({\n\t\t\t\t\t\tblockInfo: {'enabled': true}\n\t\t\t\t\t}),\n\t\t\t\t\tnotifyType = '';\n\t\t\t\tAppConnector.request({\n\t\t\t\t\turl: 'index.php',\n\t\t\t\t\ttype: 'POST',\n\t\t\t\t\tdata: formData,\n\t\t\t\t\tprocessData: false,\n\t\t\t\t\tcontentType: false\n\t\t\t\t}).done(function (data) {\n\t\t\t\t\tprogressIndicatorElement.progressIndicator({'mode': 'hide'});\n\t\t\t\t\tif (true === data.result.success) {\n\t\t\t\t\t\tnotifyType = 'success';\n\t\t\t\t\t} else {\n\t\t\t\t\t\tnotifyType = 'error';\n\t\t\t\t\t}\n\t\t\t\t\tVtiger_Helper_Js.showPnotify({\n\t\t\t\t\t\ttitle: app.vtranslate('JS_MESSAGE'),\n\t\t\t\t\t\ttext: app.vtranslate(data.result.message),\n\t\t\t\t\t\ttype: notifyType\n\t\t\t\t\t});\n\t\t\t\t\tapp.hideModalWindow();\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t},\n\tregisterEvents: function () {\n\t\tSettings_Roles_Js.registerModalUploadButton();\n\t\tSettings_Roles_Js.initEditView();\n\t\tSettings_Roles_Js.registerSubmitEvent();\n\t}\n}\njQuery(document).ready(function () {\n\tSettings_Roles_Js.registerEvents();\n})\n"],"names":["Settings_Roles_Js","validationEngine","app","validationEngineOptions","on","e","preventDefault","target","$","currentTarget","field","data","popupInstance","Vtiger_Popup_Js","getInstance","show","retrieveSelectedRecords","JSON","parse","val","label","value","triggerParentEvent","stringify","closest","text","close","tooltip","event","showModalWindow","initDeleteView","hide","css","display","draggable","ui","referenceid","jQuery","helper","sourceRoleId","params","title","vtranslate","type","showMessage","targetGroup","timestamp","Date","container","html","clone","attr","droppable","sourceGroup","thisWrapper","this","targetRole","targetRoleId","sourceRole","indexOf","appendTo","next","request","done","res","success","showAlert","location","reload","thisInstance","form","selectElement","select2Element","getSelect2ElementFromSelect","result","Vtiger_MultiSelect_Validator_Js","invokeValidation","InvalidFields","length","formData","serializeFormData","checkDuplicateName","rolename","record","submit","progressIndicator","fail","err","removeData","formAlignmentAfterValidation","details","aDeferred","Deferred","getModuleName","getParentModuleName","response","reject","resolve","error","promise","registerUploadButton","find","removeEmptyFilesInput","FormData","progressIndicatorElement","enabled","notifyType","mode","showPnotify","message","hideModalWindow","registerModalUploadButton","initEditView","registerSubmitEvent","document","ready","registerEvents"],"mappings":"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"}