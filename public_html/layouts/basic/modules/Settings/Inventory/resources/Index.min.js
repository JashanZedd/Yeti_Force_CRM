jQuery.Class("Settings_Inventory_Index_Js",{},{duplicateCheckCache:{},edit:function(url,currentTrElement){var aDeferred=jQuery.Deferred();var thisInstance=this;var progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});AppConnector.request(url).then(function(data){var callBackFunction=function(data){thisInstance.duplicateCheckCache={};var form=jQuery("#formInventory");var params=app.validationEngineOptions;params.onValidationComplete=function(form,valid){if(valid){thisInstance.saveDetails(form,currentTrElement);return valid}};form.validationEngine(params);form.on("submit",function(e){e.preventDefault()})};progressIndicatorElement.progressIndicator({mode:"hide"});app.showModalWindow(data,function(data){if(typeof callBackFunction=="function"){callBackFunction(data)}},{})},function(error){aDeferred.reject(error)});return aDeferred.promise()},saveDetails:function(form,currentTrElement){var thisInstance=this;var params=form.serializeFormData();var saveButton=form.find('[type="submit"]');saveButton.prop("disabled",true);if(typeof params==="undefined"){params={}}thisInstance.validateName(params).then(function(data){if(typeof data==="undefined"){saveButton.prop("disabled",false);return false}var progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});params.module=app.getModuleName();params.parent=app.getParentModuleName();params.action="SaveAjax";params.view=app.getViewName();AppConnector.request(params).then(function(data){progressIndicatorElement.progressIndicator({mode:"hide"});app.hideModalWindow();if(typeof data=="string"){data=JSON.parse(data)}if(form.find(".addView").val()=="true"){thisInstance.addDetails(data["result"])}else{thisInstance.updateDetails(data["result"],currentTrElement)}var params={text:app.vtranslate("JS_SAVE_CHANGES")};Settings_Vtiger_Index_Js.showMessage(params)})},function(data,err){saveButton.prop("disabled",false);return false})},addDetails:function(details){var container=jQuery("#inventory");var currency=jQuery("#currency");var symbol="%";if(currency.length>0){var currency=JSON.parse(currency.val());symbol=currency.currency_symbol}var table=$(".inventoryTable",container);if(details.default===1){var defaultCheck=" checked";table.find(".default").prop("checked",false)}var trElement=jQuery('<tr class="opacity" data-id="'+details.id+'">\n\t\t\t\t\t<td class="textAlignCenter '+details.row_type+'"><label class="name">'+details.name+'</label></td>\n\t\t\t\t\t<td class="textAlignCenter '+details.row_type+'"><span class="value">'+details.value+" "+symbol+'</span></td>\n\t\t\t\t\t<td class="textAlignCenter '+details.row_type+'"><input class="status js-update-field" checked type="checkbox"></td>\n\t\t\t\t\t<td class="textAlignCenter '+details.row_type+'"><input class="default js-update-field"'+defaultCheck+' data-field-name="default" type="checkbox">\n\t\t\t\t\t\t<div class="float-right actions">\n\t\t\t\t\t\t\t<button class="btn btn-info btn-sm text-white editInventory u-cursor-pointer" data-url="'+details._editurl+'"><span title="Edycja" class="fas fa-edit alignBottom"></span></button>\n\t\t\t\t\t\t\t<button class="removeInventory u-cursor-pointer btn btn-danger btn-sm text-white" data-url="'+details._editurl+'"><span title="UsuÅ„" class="fas fa-trash-alt alignBottom"></span></button>&nbsp;\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</td></tr>');table.append(trElement)},updateDetails:function(data,currentTrElement){var currency=jQuery("#currency");var symbol="%";if(currency.length>0){var currency=JSON.parse(currency.val());symbol=currency.currency_symbol}currentTrElement.find(".name").text(data["name"]);currentTrElement.find(".value").text(data["value"]+" "+symbol);if(data["status"]===0){currentTrElement.find(".status").prop("checked",true)}else{currentTrElement.find(".status").prop("checked",false)}if(data["default"]===1){let table=$(".inventoryTable");table.find(".default").prop("checked",false);currentTrElement.find(".default").prop("checked",true)}else{currentTrElement.find(".default").prop("checked",false)}},validateName:function(data){var thisInstance=this;var aDeferred=jQuery.Deferred();var name=data.name;var form=jQuery("#formInventory");var nameElement=form.find('[name="name"]');if(!(name in thisInstance.duplicateCheckCache)){thisInstance.checkDuplicateName(data).then(function(data){thisInstance.duplicateCheckCache[name]=data["success"];if(data["success"]){thisInstance.duplicateCheckCache["message"]=data["message"];nameElement.validationEngine("showPrompt",data["message"],"error","bottomLeft",true);aDeferred.reject(data)}aDeferred.resolve(data)},function(data,err){aDeferred.reject(data)})}else{if(thisInstance.duplicateCheckCache[name]==true){var result=thisInstance.duplicateCheckCache["message"];nameElement.validationEngine("showPrompt",result,"error","bottomLeft",true);aDeferred.reject()}else{aDeferred.resolve()}}return aDeferred.promise()},checkDuplicateName:function(details){var aDeferred=jQuery.Deferred();var name=details.name;var id=details.id;var moduleName=app.getModuleName();var params={module:moduleName,parent:app.getParentModuleName(),action:"SaveAjax",mode:"checkDuplicateName",name:name,id:id,view:app.getViewName()};AppConnector.request(params).then(function(data){if(typeof data=="string"){data=JSON.parse(data)}var response=data["result"];var result=response["success"];aDeferred.resolve(response)},function(error,err){aDeferred.reject()});return aDeferred.promise()},updateCheckbox:function(currentTarget){var aDeferred=jQuery.Deferred();var currentTrElement=currentTarget.closest("tr");var id=currentTrElement.data("id");var progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var updatedCheckbox=currentTarget.data("field-name");var params={module:app.getModuleName(),parent:app.getParentModuleName(),action:"SaveAjax",id:id,view:app.getViewName()};if(updatedCheckbox==="status"){params.status=currentTarget.is(":checked")?0:1}else if(updatedCheckbox==="default"){params.default=currentTarget.is(":checked")?1:0;let table=$(".inventoryTable");if(params.default===1){table.find(".default").not(currentTarget).prop("checked",false)}}AppConnector.request(params).then(function(data){progressIndicatorElement.progressIndicator({mode:"hide"});aDeferred.resolve(data)},function(error,err){progressIndicatorElement.progressIndicator({mode:"hide"});aDeferred.reject(error)});return aDeferred.promise()},removeInventory:function(inventoryElement){var thisInstance=this;var message=app.vtranslate("JS_DELETE_INVENTORY_CONFIRMATION");Vtiger_Helper_Js.showConfirmationBox({message:message}).then(function(e){var params={};params["view"]=app.getViewName();params["id"]=inventoryElement.data("id");app.saveAjax("deleteInventory",params).then(function(data){Settings_Vtiger_Index_Js.showMessage({type:"success",text:data.result.message});inventoryElement.remove()})},function(error,err){})},registerActions:function(){var thisInstance=this;var container=jQuery("#inventory");container.find(".addInventory").on("click",function(e){var addInventoryButton=jQuery(e.currentTarget);var createUrl=addInventoryButton.data("url");thisInstance.edit(createUrl)});container.on("click",".editInventory",function(e){var editButton=jQuery(e.currentTarget);var currentTrElement=editButton.closest("tr");thisInstance.edit(editButton.data("url"),currentTrElement)});container.on("click",".removeInventory",function(e){var removeInventoryButton=jQuery(e.currentTarget);var currentTrElement=removeInventoryButton.closest("tr");thisInstance.removeInventory(currentTrElement)});container.on("click",'[type="checkbox"]',function(e){var currentTarget=jQuery(e.currentTarget);thisInstance.updateCheckbox(currentTarget).then(function(data){var params={};params.text=app.vtranslate("JS_SAVE_CHANGES");Settings_Vtiger_Index_Js.showMessage(params)},function(error){})})},registerEvents:function(){this.registerActions()}});jQuery(document).ready(function(e){var instance=new Settings_Inventory_Index_Js;instance.registerEvents()});