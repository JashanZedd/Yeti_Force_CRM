{"version":3,"file":"Edit.min.js","sources":["Edit.js"],"sourcesContent":["/* {[The file is published on the basis of YetiForce Public License 3.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */\n'use strict';\n\njQuery.Class('Settings_TreesManager_Edit_Js', {}, {\n\tjstreeInstance: false,\n\tjstreeLastID: 0,\n\tregisterEvents: function () {\n\t\tconst self = this,\n\t\t\teditContainer = $(\"#EditView\"),\n\t\t\tjstreeInstance = self.createTree();\n\t\teditContainer.validationEngine();\n\t\t$('.addNewElementBtn').on('click', () => {\n\t\t\tconst newElement = $('input.addNewElement'),\n\t\t\t\tref = jstreeInstance.jstree(true);\n\t\t\tif (newElement.val() === '') {\n\t\t\t\tconst message = app.vtranslate('JS_FIELD_CAN_NOT_BE_EMPTY');\n\t\t\t\tnewElement.validationEngine('showPrompt', message, 'error', 'bottomLeft', true);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tself.jstreeLastID += 1;\n\t\t\tref.create_node('#', {\n\t\t\t\tid: self.jstreeLastID,\n\t\t\t\ttext: newElement.val(),\n\t\t\t\ticon: false\n\t\t\t}, 'last');\n\t\t\tnewElement.val('');\n\t\t});\n\t\t$('.saveTree').on('click', () => {\n\t\t\tjstreeInstance.jstree('deselect_all', true);\n\t\t\tconst json = jstreeInstance.jstree(\"get_json\");\n\t\t\tlet forSave = [];\n\t\t\t$.each(json, function (index, value) {\n\t\t\t\tif (value.text == value.li_attr.text) {\n\t\t\t\t\tvalue.text = value.li_attr.key;\n\t\t\t\t}\n\t\t\t\tforSave[index] = value;\n\t\t\t});\n\t\t\t$('#treeValues').val(JSON.stringify(forSave));\n\t\t\teditContainer.submit();\n\t\t});\n\t\t$('.addNewElement').on('keydown', (event) => {\n\t\t\tif (event.keyCode == 13) {\n\t\t\t\t$('.addNewElementBtn').trigger(\"click\");\n\t\t\t\tevent.preventDefault();\n\t\t\t\treturn false;\n\t\t\t}\n\t\t});\n\t},\n\tcreateTree: function () {\n\t\tconst self = this;\n\t\tif (this.jstreeInstance == false) {\n\t\t\tself.jstreeLastID = parseInt($('#treeLastID').val());\n\t\t\tlet treeValues = $('#treeValues').val(),\n\t\t\t\tdata = JSON.parse(treeValues);\n\t\t\tself.jstreeInstance = $(\"#treeContents\");\n\t\t\tself.jstreeInstance.jstree({\n\t\t\t\tcore: {\n\t\t\t\t\tdata: data,\n\t\t\t\t\tthemes: {\n\t\t\t\t\t\tname: 'proton',\n\t\t\t\t\t\tresponsive: true\n\t\t\t\t\t},\n\t\t\t\t\tcheck_callback: true\n\t\t\t\t},\n\t\t\t\tcontextmenu: {\n\t\t\t\t\titems: {\n\t\t\t\t\t\tcreate: {\n\t\t\t\t\t\t\tlabel: app.vtranslate('JS_JSTREE_CREATE'),\n\t\t\t\t\t\t\taction: function (data) {\n\t\t\t\t\t\t\t\tlet treeInstance = $.jstree.reference(data.reference),\n\t\t\t\t\t\t\t\t\tselectedNode = treeInstance.get_node(data.reference);\n\t\t\t\t\t\t\t\tself.jstreeLastID = self.jstreeLastID + 1;\n\t\t\t\t\t\t\t\ttreeInstance.create_node(selectedNode, {\n\t\t\t\t\t\t\t\t\tid: self.jstreeLastID,\n\t\t\t\t\t\t\t\t\ttext: app.vtranslate('JS_NEW_ITEM')\n\t\t\t\t\t\t\t\t}, \"last\", function (new_node) {\n\t\t\t\t\t\t\t\t\tsetTimeout(function () {\n\t\t\t\t\t\t\t\t\t\ttreeInstance.edit(new_node);\n\t\t\t\t\t\t\t\t\t}, 0);\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\trename: {\n\t\t\t\t\t\t\tlabel: app.vtranslate('JS_JSTREE_RENAME'),\n\t\t\t\t\t\t\taction: function (data) {\n\t\t\t\t\t\t\t\tlet treeInstance = $.jstree.reference(data.reference),\n\t\t\t\t\t\t\t\t\tselectedNode = treeInstance.get_node(data.reference);\n\t\t\t\t\t\t\t\ttreeInstance.edit(selectedNode);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\tchangeIcon: {\n\t\t\t\t\t\t\tlabel: app.vtranslate('JS_JSTREE_CHANGE_ICON'),\n\t\t\t\t\t\t\taction: function (data) {\n\t\t\t\t\t\t\t\tlet treeInstance = $.jstree.reference(data.reference),\n\t\t\t\t\t\t\t\t\tselectedNode = treeInstance.get_node(data.reference);\n\t\t\t\t\t\t\t\tSettings_Vtiger_Index_Js.selectIcon().done(function (data) {\n\t\t\t\t\t\t\t\t\tif (data['name'] == '-') {\n\t\t\t\t\t\t\t\t\t\tself.jstreeInstance.jstree(true).set_icon(selectedNode.id, false);\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\tself.jstreeInstance.jstree(true).set_icon(selectedNode.id, data['name']);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\tremove: {\n\t\t\t\t\t\t\tlabel: app.vtranslate('JS_JSTREE_REMOVE'),\n\t\t\t\t\t\t\taction: function (data) {\n\t\t\t\t\t\t\t\tlet treeInstance = $.jstree.reference(data.reference),\n\t\t\t\t\t\t\t\t\tid = treeInstance.get_selected(),\n\t\t\t\t\t\t\t\t\tstatus = true;\n\t\t\t\t\t\t\t\t$.each(id, function (index, value) {\n\t\t\t\t\t\t\t\t\tlet menu = treeInstance.get_node(value);\n\t\t\t\t\t\t\t\t\tif (menu.children.length > 0) {\n\t\t\t\t\t\t\t\t\t\tSettings_Vtiger_Index_Js.showMessage({\n\t\t\t\t\t\t\t\t\t\t\ttext: app.vtranslate('JS_YOU_CANNOT_DELETE_PERENT_ITEM'),\n\t\t\t\t\t\t\t\t\t\t\ttype: 'error'\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\tstatus = false;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\tif (status) {\n\t\t\t\t\t\t\t\t\tself.deleteItemEvent(id, treeInstance).done(function (e) {\n\t\t\t\t\t\t\t\t\t\tif (e.length > 0) {\n\t\t\t\t\t\t\t\t\t\t\t$.each(id, function (index, value) {\n\t\t\t\t\t\t\t\t\t\t\t\ttreeInstance.delete_node(value);\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\tccp: {\n\t\t\t\t\t\t\tlabel: app.vtranslate('JS_JSTREE_CCP'),\n\t\t\t\t\t\t\tsubmenu: {\n\t\t\t\t\t\t\t\tcut: {\n\t\t\t\t\t\t\t\t\tlabel: app.vtranslate('JS_JSTREE_CUT'),\n\t\t\t\t\t\t\t\t\t\"action\": function (data) {\n\t\t\t\t\t\t\t\t\t\tlet treeInstance = $.jstree.reference(data.reference),\n\t\t\t\t\t\t\t\t\t\t\tselectedNode = treeInstance.get_node(data.reference);\n\t\t\t\t\t\t\t\t\t\tif (treeInstance.is_selected(selectedNode)) {\n\t\t\t\t\t\t\t\t\t\t\ttreeInstance.cut(treeInstance.get_top_selected());\n\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\ttreeInstance.cut(selectedNode);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tpaste: {\n\t\t\t\t\t\t\t\t\tlabel: app.vtranslate('JS_JSTREE_PASTE'),\n\t\t\t\t\t\t\t\t\t\"action\": function (data) {\n\t\t\t\t\t\t\t\t\t\tlet treeInstance = $.jstree.reference(data.reference),\n\t\t\t\t\t\t\t\t\t\t\tselectedNode = treeInstance.get_node(data.reference);\n\t\t\t\t\t\t\t\t\t\ttreeInstance.paste(selectedNode);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tplugins: [\"contextmenu\", \"dnd\"]\n\t\t\t});\n\t\t}\n\t\treturn this.jstreeInstance;\n\t},\n\tdeleteItemEvent: function (id, inst) {\n\t\tlet self = this,\n\t\t\taDeferred = jQuery.Deferred(),\n\t\t\tdata = inst.get_json();\n\t\t$.each(id, function (index, id) {\n\t\t\tdata = self.checkChildren(id, data);\n\t\t});\n\t\tif (data.length == 0) {\n\t\t\tSettings_Vtiger_Index_Js.showMessage({\n\t\t\t\ttext: app.vtranslate('JS_YOU_CANNOT_DELETE_ALL_THE_ITEMS'),\n\t\t\t\ttype: 'error'\n\t\t\t})\n\t\t\taDeferred.resolve();\n\t\t\treturn aDeferred.promise();\n\t\t}\n\t\tapp.showModalWindow(null, 'index.php?module=TreesManager&parent=Settings&view=ReplaceTreeItem', function (wizardContainer) {\n\t\t\tlet jstreeInstanceReplace = wizardContainer.find('#treePopupContents');\n\t\t\tjstreeInstanceReplace.jstree({\n\t\t\t\tcore: {\n\t\t\t\t\tdata: data,\n\t\t\t\t\tthemes: {\n\t\t\t\t\t\tname: 'proton',\n\t\t\t\t\t\tresponsive: true\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t}).on(\"loaded.jstree\", function (event, data) {\n\t\t\t\t$(this).jstree(\"open_all\");\n\t\t\t});\n\t\t\twizardContainer.find('.js-modal__save').on('click', () => {\n\t\t\t\tlet selected = jstreeInstanceReplace.jstree(\"get_selected\"),\n\t\t\t\t\treplaceIdsElement = $('#replaceIds'),\n\t\t\t\t\treplaceIds = replaceIdsElement.val(),\n\t\t\t\t\tdata = [];\n\t\t\t\tif (replaceIds !== '') {\n\t\t\t\t\tdata = JSON.parse(replaceIds);\n\t\t\t\t}\n\t\t\t\tif (!selected.length || selected.length > 1) {\n\t\t\t\t\tlet message = 'JS_ONLY_ONE_ITEM_SELECTED';\n\t\t\t\t\tif (!selected.length) {\n\t\t\t\t\t\tmessage = 'JS_NO_ITEM_SELECTED';\n\t\t\t\t\t}\n\t\t\t\t\tSettings_Vtiger_Index_Js.showMessage({\n\t\t\t\t\t\ttype: 'error',\n\t\t\t\t\t\ttext: app.vtranslate(message)\n\t\t\t\t\t});\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tdata = $.merge(data, [{'old': id, 'new': selected}]);\n\t\t\t\treplaceIdsElement.val(JSON.stringify(data));\n\t\t\t\tapp.hideModalWindow();\n\t\t\t\taDeferred.resolve(selected);\n\t\t\t});\n\t\t});\n\t\treturn aDeferred.promise();\n\t},\n\tcheckChildren: function (id, data) {\n\t\tlet self = this,\n\t\t\tdataNew = [];\n\t\tfor (var key in data) {\n\t\t\tif (data[key].id != id) {\n\t\t\t\tif (data[key].children.length) {\n\t\t\t\t\tdata[key].children = self.checkChildren(id, data[key].children);\n\t\t\t\t}\n\t\t\t\tdataNew.push(data[key]);\n\t\t\t}\n\t\t}\n\t\treturn dataNew;\n\t}\n});\n"],"names":["jQuery","Class","self","this","editContainer","$","jstreeInstance","createTree","validationEngine","on","newElement","ref","jstree","val","message","app","vtranslate","jstreeLastID","create_node","json","forSave","each","index","value","text","li_attr","key","JSON","stringify","submit","event","keyCode","trigger","preventDefault","parseInt","treeValues","data","parse","treeInstance","reference","selectedNode","get_node","new_node","edit","selectIcon","done","set_icon","id","get_selected","status","children","length","showMessage","deleteItemEvent","e","delete_node","is_selected","cut","get_top_selected","paste","inst","aDeferred","Deferred","get_json","checkChildren","resolve","promise","showModalWindow","wizardContainer","jstreeInstanceReplace","find","selected","replaceIdsElement","replaceIds","merge","old","new","hideModalWindow","dataNew","push"],"mappings":"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"}