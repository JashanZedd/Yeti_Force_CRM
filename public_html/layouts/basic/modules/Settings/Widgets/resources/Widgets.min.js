"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};jQuery.Class("Settings_Widgets_Index_Js",{},{getTabId:function(){return $(".WidgetsManage [name='tabid']").val()},getType:function(){return $(".form-modalAddWidget [name='type']").val()},createStep2:function(type){var thisInstance=this,tabId=thisInstance.getTabId(),progressIndicatorElement=jQuery.progressIndicator({position:"html"});app.showModalWindow(null,"index.php?parent=Settings&module=Widgets&view=Widget&mode=createStep2&type="+type+"&tabId="+tabId,(function(wizardContainer){app.showPopoverElementView(wizardContainer.find(".js-help-info")),"RelatedModule"===type&&(thisInstance.loadFilters(wizardContainer),thisInstance.relatedModuleFields(wizardContainer),wizardContainer.find("select[name='relation_id']").on("change",(function(){thisInstance.changeRelatedModule(),thisInstance.relatedModuleFields(wizardContainer)}))),progressIndicatorElement.progressIndicator({mode:"hide"});var form=jQuery("form",wizardContainer);form.validationEngine(app.validationEngineOptions),form.on("submit",(function(e){if(e.preventDefault(),form.validationEngine("validate")){var save=!0;if(form&&form.hasClass("validateForm")&&form.data("jqv").InvalidFields.length>0&&(app.formAlignmentAfterValidation(form),save=!1),save){var formData=form.serializeFormData();thisInstance.registerSaveEvent("saveWidget",{data:formData,tabid:tabId}).done((function(_){thisInstance.reloadWidgets(),app.hideModalWindow()}))}}}))}))},loadWidgets:function(){var thisInstance=this;jQuery(".blocksSortable").sortable({revert:!0,connectWith:".blocksSortable",tolerance:"pointer",cursor:"move",placeholder:"state-highlight",stop:function(event,ui){thisInstance.updateSequence()}})},updateSequence:function(){var params={};$(".blockSortable").each((function(index){params[$(this).data("id")]={index:index,column:$(this).closest(".blocksSortable").data("column")}}));var progress=$.progressIndicator({message:app.vtranslate("Saving changes"),blockInfo:{enabled:!0}});this.registerSaveEvent("updateSequence",{data:params,tabid:$("input[name='tabid']").val()}),progress.progressIndicator({mode:"hide"})},reloadWidgets:function(){var thisInstance=this,Indicator=jQuery.progressIndicator({message:app.vtranslate("Loading data"),position:"html",blockInfo:{enabled:!0}}),params={module:"Widgets",view:"Index",parent:"Settings"};params.source=$("input[name='tabid']").val(),AppConnector.request(params).done((function(data){var container=jQuery("div.contentsDiv").html(data);thisInstance.registerEvents(container),Indicator.progressIndicator({mode:"hide"})}))},registerSaveEvent:function(mode,data){var aDeferred=$.Deferred();return AppConnector.request({module:app.getModuleName(),parent:app.getParentModuleName(),action:"SaveAjax",mode:mode,params:data,async:"saveWidget"!==mode,dataType:"json"}).done((function(data){aDeferred.resolve(data),Vtiger_Helper_Js.showPnotify({text:data.result.message,type:"success"})})).fail((function(textStatus,errorThrown){aDeferred.reject(textStatus,errorThrown)})),aDeferred.promise()},loadFilters:function(contener){var types=["filter","checkbox","switchHeader"],selected=contener.find("select[name='relation_id'] option:selected"),relatedModuleInput=contener.find("input[name='relatedmodule']"),relatedModule=relatedModuleInput.val();0==relatedModule&&(relatedModule=selected.data("relatedmodule"),relatedModuleInput.val(selected.data("relatedmodule")));var _loop=function(i){var filters=app.getMainParams(types[i]+"All",!0),filterField=contener.find("select[name='"+types[i]+"']"),filterSelected=contener.find("input#"+types[i]+"_selected").val();filterField.empty(),filterField.append($("<option/>",{value:"-",text:app.vtranslate("None")})),void 0!==filters[relatedModule]?(filterField.closest(".form-group").removeClass("d-none"),$.each(filters[relatedModule],(function(index,value){"object"===(void 0===value?"undefined":_typeof(value))&&(value=value.label);var option={value:index,text:value};filterSelected==index&&(option.selected="selected"),filterField.append($("<option/>",option))})),App.Fields.Picklist.showSelect2ElementView(filterField)):filterField.closest(".form-group").addClass("d-none")};for(var i in types)_loop(i)},relatedModuleFields:function(container){var relatedModule=parseInt(container.find("input[name='relatedmodule']").val()),relatedfields=container.find("select[name='relatedfields']");relatedfields.find("optgroup").each((function(index,optgroup){optgroup=$(optgroup),relatedModule!==optgroup.data("module")?(optgroup.addClass("d-none"),optgroup.prop("disabled","disabled")):(optgroup.removeClass("d-none"),optgroup.prop("disabled",!1)),optgroup.find("option").each((function(index,option){option=$(option),relatedModule!==option.data("module")?(option.addClass("d-none"),option.prop("disabled","disabled")):(option.removeClass("d-none"),option.prop("disabled",!1))}))})),relatedfields.trigger("change:select2")},changeRelatedModule:function(e){var form=jQuery(".form-modalAddWidget");this.loadFilters(form)},modalFormEdit:function(wizardContainer){var thisInstance=this;$("#massEditHeader.modal-title").text(app.vtranslate("JS_EDIT_WIDGET")),app.showPopoverElementView(wizardContainer.find(".js-help-info")),"RelatedModule"==thisInstance.getType()&&(thisInstance.loadFilters(wizardContainer),thisInstance.relatedModuleFields(wizardContainer),wizardContainer.find("select[name='relatedmodule']").on("change",(function(){thisInstance.changeRelatedModule(),thisInstance.relatedModuleFields(wizardContainer)})));var form=$("form",wizardContainer);form.validationEngine(app.validationEngineOptions),form.on("submit",(function(e){if(e.preventDefault(),form.validationEngine("validate")){var progress=$.progressIndicator({message:app.vtranslate("Loading data"),blockInfo:{enabled:!0}});thisInstance.registerSaveEvent("saveWidget",{data:form.serializeFormData(),tabid:$("input[name='tabid']").val()}).done((function(){thisInstance.reloadWidgets(),app.hideModalWindow(),progress.progressIndicator({mode:"hide"})}))}}))},registerEvents:function(container){var _this=this,thisInstance=this;this.loadWidgets(),void 0===container&&(container=jQuery(".WidgetsManage")),App.Fields.Picklist.showSelect2ElementView(container.find(".select2")),container.find("select.js-module__list").on("change",(function(e){var target=$(e.currentTarget);$("input[name='tabid']").val(target.val()),thisInstance.reloadWidgets()})),container.find(".js-widget__add").on("click",(function(e){var progressIndicatorElement=jQuery.progressIndicator({position:"html"}),module=$(".WidgetsManage select.js-module__list").val();app.showModalWindow(null,"index.php?parent=Settings&module=Widgets&view=Widget&mod="+module,(function(wizardContainer){progressIndicatorElement.progressIndicator({mode:"hide"});var form=jQuery("form",wizardContainer);form.on("submit",(function(e){e.preventDefault();var type=form.find('[name="type"]').val();thisInstance.createStep2(type)}))}))})),container.find(".js-widget__edit").on("click",(function(e){app.showModalWindow({url:"index.php?parent=Settings&module=Widgets&view=Widget&mode=edit&id="+$(e.currentTarget).closest(".blockSortable").data("id"),cb:function(wizardContainer){_this.modalFormEdit(wizardContainer)}})})),container.find(".js-widget__remove").on("click",(function(e){var blockSortable=$(e.currentTarget).closest(".blockSortable");thisInstance.registerSaveEvent("removeWidget",{wid:blockSortable.data("id")}),thisInstance.reloadWidgets()}))}});
//# sourceMappingURL=Widgets.min.js.map
