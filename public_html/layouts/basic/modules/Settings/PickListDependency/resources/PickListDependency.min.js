"use strict";jQuery.Class("Settings_PickListDependency_Js",{pickListDependencyInstance:!1,triggerAdd:function(event){event.stopPropagation();var instance=Settings_PickListDependency_Js.pickListDependencyInstance;instance.updatedSourceValues=[],instance.showEditView(instance.listViewForModule).done((function(data){instance.registerAddViewEvents()}))},triggerEdit:function(event,module,sourceField,targetField){event.stopPropagation();var instance=Settings_PickListDependency_Js.pickListDependencyInstance;instance.updatedSourceValues=[],instance.showEditView(module,sourceField,targetField).done((function(data){jQuery("#pickListDependencyForm").find('select[name="sourceModule"],select[name="sourceField"],select[name="targetField"]').prop("disabled",!0),instance.registerDependencyGraphEvents(),instance.registerSubmitEvent()}))},triggerDelete:function(event,module,sourceField,targetField){event.stopPropagation();var currentTrEle=jQuery(event.currentTarget).closest("tr"),instance=Settings_PickListDependency_Js.pickListDependencyInstance,message=app.vtranslate("JS_LBL_ARE_YOU_SURE_YOU_WANT_TO_DELETE");Vtiger_Helper_Js.showConfirmationBox({message:message}).done((function(e){instance.deleteDependency(module,sourceField,targetField).done((function(data){var params={};params.text=app.vtranslate("JS_DEPENDENCY_DELETED_SUEESSFULLY"),Settings_Vtiger_Index_Js.showMessage(params),currentTrEle.fadeOut("slow").remove()}))}))}},{init:function(){Settings_PickListDependency_Js.pickListDependencyInstance=this},listViewForModule:"",updatedSourceValues:[],valueMapping:[],selectedSourceValues:[],showEditView:function(module,sourceField,targetField){var aDeferred=jQuery.Deferred(),progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),params={};return params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.view="Edit",params.sourceModule=module,params.sourcefield=sourceField,params.targetfield=targetField,AppConnector.requestPjax(params).done((function(data){progressIndicatorElement.progressIndicator({mode:"hide"});var container=jQuery(".contentsDiv");container.html(data),App.Fields.Picklist.showSelect2ElementView(container.find("select.select2"),{dropdownCss:{"z-index":0}}),aDeferred.resolve(data)})).fail((function(error){progressIndicatorElement.progressIndicator({mode:"hide"}),aDeferred.reject(error)})),aDeferred.promise()},getModuleDependencyGraph:function(form){var thisInstance=this;form.find('[name="sourceModule"]').on("change",(function(){var forModule=form.find('[name="sourceModule"]').val();thisInstance.showEditView(forModule).done((function(data){thisInstance.registerAddViewEvents()}))}))},registerPicklistFieldsChangeEvent:function(form){var thisInstance=this;form.find('[name="sourceField"],[name="targetField"]').on("change",(function(){thisInstance.checkValuesForDependencyGraph(form)}))},checkValuesForDependencyGraph:function(form){var thisInstance=this,sourceField=form.find('[name="sourceField"]'),targetField=form.find('[name="targetField"]'),select2SourceField=app.getSelect2ElementFromSelect(sourceField),select2TargetField=app.getSelect2ElementFromSelect(targetField),sourceFieldValue=sourceField.val(),targetFieldValue=targetField.val(),dependencyGraph=jQuery("#dependencyGraph");if(""!=sourceFieldValue&&""!=targetFieldValue){var resultMessage=app.vtranslate("JS_SOURCE_AND_TARGET_FIELDS_SHOULD_NOT_BE_SAME");if(form.find(".errorMessage").addClass("d-none"),sourceFieldValue==targetFieldValue)select2TargetField.validationEngine("showPrompt",resultMessage,"error","topLeft",!0),dependencyGraph.html("");else{select2SourceField.validationEngine("hide"),select2TargetField.validationEngine("hide");var sourceModule=form.find('[name="sourceModule"]').val(),progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}});thisInstance.checkCyclicDependency(sourceModule,sourceFieldValue,targetFieldValue).done((function(data){data.result.result?(progressIndicatorElement.progressIndicator({mode:"hide"}),form.find(".errorMessage").removeClass("d-none"),form.find(".cancelAddView").removeClass("d-none"),dependencyGraph.html("")):(thisInstance.addNewDependencyPickList(sourceModule,sourceFieldValue,targetFieldValue),progressIndicatorElement.progressIndicator({mode:"hide"}))})).fail((function(error,err){progressIndicatorElement.progressIndicator({mode:"hide"})}))}}else{form.find(".errorMessage").addClass("d-none");var result=app.vtranslate("JS_SELECT_SOME_VALUE");""==sourceFieldValue?select2SourceField.validationEngine("showPrompt",result,"error","topLeft",!0):""==targetFieldValue&&select2TargetField.validationEngine("showPrompt",result,"error","topLeft",!0)}},checkCyclicDependency:function(sourceModule,sourceFieldValue,targetFieldValue){var aDeferred=jQuery.Deferred(),params={mode:"checkCyclicDependency"};return params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.action="Index",params.sourceModule=sourceModule,params.sourcefield=sourceFieldValue,params.targetfield=targetFieldValue,AppConnector.request(params).done((function(data){aDeferred.resolve(data)}),(function(error,err){aDeferred.reject()})),aDeferred.promise()},addNewDependencyPickList:function(sourceModule,sourceFieldValue,targetFieldValue){var thisInstance=this,dependencyGraph=$("#dependencyGraph");thisInstance.updatedSourceValues=[],AppConnector.request({mode:"getDependencyGraph",module:app.getModuleName(),parent:app.getParentModuleName(),view:"IndexAjax",sourceModule:sourceModule,sourcefield:sourceFieldValue,targetfield:targetFieldValue}).done((function(data){dependencyGraph.html(data).css({padding:"10px",border:"1px solid #ddd",background:"#fff"}),thisInstance.registerDependencyGraphEvents()}))},deleteDependency:function(module,sourceField,targetField){var aDeferred=jQuery.Deferred(),params={};return params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.action="DeleteAjax",params.sourceModule=module,params.sourcefield=sourceField,params.targetfield=targetField,AppConnector.request(params).done((function(data){aDeferred.resolve(data)})).fail((function(error,err){aDeferred.reject(error,err)})),aDeferred.promise()},registerCancelAddView:function(form){var thisInstance=this,cancelDiv=form.find(".cancelAddView");cancelDiv.removeClass("d-none"),cancelDiv.find(".cancelLink").on("click",(function(){thisInstance.loadListViewContents(thisInstance.listViewForModule)}))},registerAddViewEvents:function(){var form=jQuery("#pickListDependencyForm");this.registerCancelAddView(form),this.getModuleDependencyGraph(form),this.registerPicklistFieldsChangeEvent(form),this.registerSubmitEvent()},registerDependencyGraphEvents:function(){var form=jQuery("#pickListDependencyForm"),dependencyGraph=jQuery("#dependencyGraph");form.find(".cancelAddView").addClass("d-none"),this.registerTargetFieldsClickEvent(dependencyGraph),this.registerTargetFieldsUnmarkAll(dependencyGraph),this.registerSelectSourceValuesClick(dependencyGraph),this.registerCancelDependency(form)},registerListViewEvents:function(){var forModule=jQuery(".contentsDiv").find(".pickListSupportedModules").val();this.listViewForModule=forModule,this.registerSourceModuleChangeEvent()},registerCancelDependency:function(form){var thisInstance=this;form.find(".cancelDependency").on("click",(function(){thisInstance.loadListViewContents(thisInstance.listViewForModule)}))},registerTargetFieldsClickEvent:function(dependencyGraph){var thisInstance=this;thisInstance.updatedSourceValues=[],dependencyGraph.find("td.picklistValueMapping").on("click",(function(e){var currentTarget=jQuery(e.currentTarget),sourceValue=currentTarget.data("sourceValue");-1==jQuery.inArray(sourceValue,thisInstance.updatedSourceValues)&&thisInstance.updatedSourceValues.push(sourceValue),currentTarget.hasClass("selectedCell")?currentTarget.addClass("unselectedCell").removeClass("selectedCell"):currentTarget.addClass("selectedCell").removeClass("unselectedCell")}))},registerTargetFieldsUnmarkAll:function(dependencyGraph){var thisInstance=this;thisInstance.updatedSourceValues=[],dependencyGraph.find(".unmarkAll").on("click",(function(e){dependencyGraph.find("td.picklistValueMapping").each((function(index){var currentTarget=jQuery(this),sourceValue=currentTarget.data("sourceValue");-1==jQuery.inArray(sourceValue,thisInstance.updatedSourceValues)&&thisInstance.updatedSourceValues.push(sourceValue),currentTarget.addClass("unselectedCell").removeClass("selectedCell")}))}))},updateValueMapping:function(dependencyGraph){this.valueMapping=[];var sourceValuesArray=this.updatedSourceValues,dependencyTable=dependencyGraph.find(".pickListDependencyTable");for(var key in sourceValuesArray){var encodedSourceValue=void 0;encodedSourceValue="string"==typeof sourceValuesArray[key]?sourceValuesArray[key].replace(/"/g,'\\"'):sourceValuesArray[key];var selectedTargetValues=dependencyTable.find('td[data-source-value="'+encodedSourceValue+'"]').filter(".selectedCell"),targetValues=[];selectedTargetValues.length>0?jQuery.each(selectedTargetValues,(function(index,element){targetValues.push(jQuery(element).data("targetValue"))})):targetValues.push(""),this.valueMapping.push({sourcevalue:sourceValuesArray[key],targetvalues:targetValues})}},registerSelectSourceValuesClick:function(dependencyGraph){var _this=this;dependencyGraph.find("button.sourceValues").on("click",(function(){var selectSourceValues=dependencyGraph.find(".modalCloneCopy"),clonedContainer=selectSourceValues.clone(!0,!0).removeClass("modalCloneCopy");app.showModalWindow(clonedContainer,(function(data){data.find(".sourcePicklistValuesModal").removeClass("d-none"),data.find('[name="saveButton"]').on("click",(function(e){_this.selectedSourceValues=[];var sourceValues=data.find(".sourceValue");$.each(sourceValues,(function(index,ele){var element=$(ele),elementId=element.attr("id"),hiddenElement=selectSourceValues.find("#"+elementId);element.is(":checked")?(_this.selectedSourceValues.push(element.val()),hiddenElement.prop("checked",!0)):hiddenElement.prop("checked",!1)})),app.hideModalWindow(),_this.loadMappingForSelectedValues(dependencyGraph)}))}),{width:"1000px"})}))},loadMappingForSelectedValues:function(dependencyGraph){var allSourcePickListValues=JSON.parse(dependencyGraph.find(".allSourceValues").val()),dependencyTable=dependencyGraph.find(".pickListDependencyTable");for(var key in allSourcePickListValues){if("string"==typeof allSourcePickListValues[key])var encodedSourcePickListValue=allSourcePickListValues[key].replace(/"/g,'\\"');else encodedSourcePickListValue=allSourcePickListValues[key];var mappingCells=dependencyTable.find('[data-source-value="'+encodedSourcePickListValue+'"]');-1==jQuery.inArray(allSourcePickListValues[key],this.selectedSourceValues)?mappingCells.hide():mappingCells.show()}},savePickListDependency:function(form){var self=this,progressIndicatorElement=$.progressIndicator({position:"html",blockInfo:{enabled:!0}}),params=form.serializeFormData();params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.action="SaveAjax",params.mapping=JSON.stringify(self.valueMapping),AppConnector.request(params).done((function(data){data.success&&(progressIndicatorElement.progressIndicator({mode:"hide"}),Vtiger_Helper_Js.showMessage({text:app.vtranslate("JS_PICKLIST_DEPENDENCY_SAVED"),type:"success"}),self.loadListViewContents(params.sourceModule))})).fail((function(error){progressIndicatorElement.progressIndicator({mode:"hide"})}))},loadListViewContents:function(forModule){var thisInstance=this,progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),params={};params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.view="List",params.formodule=forModule,AppConnector.requestPjax(params).done((function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),jQuery(".contentsDiv").html(data),App.Fields.Picklist.changeSelectElementView(jQuery(".contentsDiv")),thisInstance.registerListViewEvents()})).fail((function(error,err){progressIndicatorElement.progressIndicator({mode:"hide"})}))},triggerDisplayTypeEvent:function(){var widthType=app.cacheGet("widthType","narrowWidthType");widthType&&jQuery(".listViewEntriesTable").find("td,th").attr("class",widthType)},registerSourceModuleChangeEvent:function(){var thisInstance=this;jQuery(".contentsDiv").find(".pickListSupportedModules").on("change",(function(e){var forModule=jQuery(e.currentTarget).val();thisInstance.loadListViewContents(forModule)}))},registerSubmitEvent:function(){var thisInstance=this,form=jQuery("#pickListDependencyForm"),dependencyGraph=jQuery("#dependencyGraph");form.on("submit",(function(e){e.preventDefault();try{thisInstance.updateValueMapping(dependencyGraph)}catch(e){return void bootbox.alert(e.message)}if("true"!=form.find(".editDependency").val()&&thisInstance.valueMapping.length<1){var params={};params.text=app.vtranslate("JS_PICKLIST_DEPENDENCY_NO_SAVED"),params.type="info",Settings_Vtiger_Index_Js.showMessage(params)}else thisInstance.savePickListDependency(form)}))},registerEvents:function(){var form=jQuery("#pickListDependencyForm");form.length>0?"true"==form.find(".editDependency").val()?(form.find('select[name="sourceModule"],select[name="sourceField"],select[name="targetField"]').prop("disabled",!0),this.registerDependencyGraphEvents(),this.registerSubmitEvent()):this.registerAddViewEvents():this.registerListViewEvents()}}),jQuery(document).ready((function(){(new Settings_PickListDependency_Js).registerEvents()}));
//# sourceMappingURL=PickListDependency.min.js.map
