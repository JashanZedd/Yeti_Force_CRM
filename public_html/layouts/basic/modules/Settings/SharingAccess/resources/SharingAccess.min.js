"use strict";jQuery.Class("Settings_Sharing_Access_Js",{},{contentTable:!1,contentsContainer:!1,init:function(){this.setContentTable(".sharingAccessDetails").setContentContainer("#sharingAccessContainer")},setContentTable:function(element){return element instanceof jQuery?(this.contentTable=element,this):(this.contentTable=jQuery(element),this)},setContentContainer:function(element){return element instanceof jQuery?(this.contentsContainer=element,this):(this.contentsContainer=jQuery(element),this)},getContentTable:function(){return this.contentTable},getContentContainer:function(){return this.contentsContainer},getCustomRuleContainerClassName:function(parentModuleName){return"js-"+parentModuleName+"-custom-rule-list"},showCustomRulesNextToElement:function(parentElement,rulesListElement){var moduleName=parentElement.data("moduleName"),trElementForRuleList=jQuery('<tr class="'+this.getCustomRuleContainerClassName(moduleName)+'"><td class="js-custom-rule-container" data-js="container" colspan="6"></td></tr>');jQuery("td",trElementForRuleList).append(rulesListElement),jQuery(".ruleListContainer",trElementForRuleList).css("display","none"),parentElement.after(trElementForRuleList).addClass("collapseRow"),jQuery(".ruleListContainer",trElementForRuleList).slideDown("slow")},getCustomRules:function(forModule){var aDeferred=jQuery.Deferred(),params={};return params.for_module=forModule,params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.view="IndexAjax",params.mode="showRules",AppConnector.request(params).done((function(data){aDeferred.resolve(data)})).fail((function(error){aDeferred.reject(error)})),aDeferred.promise()},save:function(data){var aDeferred=jQuery.Deferred(),progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}});return void 0===data&&(data={}),AppConnector.request(data).done((function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),aDeferred.resolve(data)})).fail((function(error,errorThrown){progressIndicatorElement.progressIndicator({mode:"hide"}),aDeferred.reject(error)})),aDeferred.promise()},saveCustomRule:function(form,e){var thisInstance=this,data=form.serializeFormData();void 0===data&&(data={});var progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}});data.module=app.getModuleName(),data.parent=app.getParentModuleName(),data.action="IndexAjax",data.mode="saveRule",AppConnector.request(data).done((function(data){progressIndicatorElement.progressIndicator({mode:"hide"});var response=data.result;if(response&&response.success){app.hideModalWindow();var moduleName=$('[name="for_module"]',form).val();thisInstance.loadCustomRulesList(moduleName),Vtiger_Helper_Js.showPnotify({type:"success",text:response.message})}else Vtiger_Helper_Js.showPnotify({type:"error",text:"JS_ERROR"})}))},loadCustomRulesList:function(moduleName){var thisInstance=this,contentTable=this.getContentTable();thisInstance.getCustomRules(moduleName).done((function(data){jQuery("."+thisInstance.getCustomRuleContainerClassName(moduleName),contentTable).find("td.js-custom-rule-container").html(data)}))},editCustomRule:function(url){var thisInstance=this,progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}});app.showModalWindow(null,url,(function(modalContainer){progressIndicatorElement.progressIndicator({mode:"hide"}),modalContainer.find(".js-edit-rule-form").on("submit",(function(e){e.preventDefault();var formElement=$(e.currentTarget);thisInstance.saveCustomRule(formElement,e)}))}))},deleteCustomRule:function(deleteElement){var deleteUrl=deleteElement.data("url"),currentRow=deleteElement.closest(".js-custom-rule-entries"),message=app.vtranslate("LBL_DELETE_CONFIRMATION");Vtiger_Helper_Js.showConfirmationBox({message:message}).done((function(data){AppConnector.request(deleteUrl).done((function(data){var response=data.result;if(response&&response.success){currentRow.fadeOut("slow");var customRuleTable=currentRow.closest(".js-custom-rule-table"),nextRows=currentRow.nextAll("js-custom-rule-entries");nextRows.length>0&&jQuery.each(nextRows,(function(i,element){var currentSequenceElement=jQuery(element).find(".js-sequence-number"),updatedNumber=parseInt(currentSequenceElement.text())-1;currentSequenceElement.text(updatedNumber)})),currentRow.remove(),customRuleTable.find(".js-custom-rule-entries").length<1&&(customRuleTable.find(".js-custom-rule-headers").fadeOut("slow").remove(),customRuleTable.parent().find(".js-record-details").removeClass("d-none"),customRuleTable.addClass("d-none"))}else Vtiger_Helper_Js.showPnotify({type:"error",text:"JS_ERROR"})}))}))},registerSharingAccessEdit:function(){var contentContainer=this.getContentContainer();contentContainer.one("click","input:radio",(function(e){contentContainer.find("button:submit").removeClass("d-none")}))},registerDependentModulesPrivilegesChange:function(){var container=this.getContentContainer(),contentTable=this.getContentTable(),modulesList=JSON.parse(container.find(".dependentModules").val());jQuery.each(modulesList,(function(moduleName,dependentList){contentTable.find('[data-module-name="'+moduleName+'"]').find('[data-action-state="Private"]').on("change",(function(e){if(jQuery(e.currentTarget).is(":checked")){var message=app.vtranslate("JS_DEPENDENT_PRIVILEGES_SHOULD_CHANGE");bootbox.alert(message),jQuery.each(dependentList,(function(index,module){contentTable.find('[data-module-name="'+module+'"]').find('[data-action-state="Private"]').attr("checked","checked")}))}}))}))},registerEvents:function(){var thisInstance=this,contentTable=thisInstance.getContentTable(),contentContainer=thisInstance.getContentContainer();thisInstance.registerSharingAccessEdit(),thisInstance.registerDependentModulesPrivilegesChange(),contentTable.on("click","td.triggerCustomSharingAccess",(function(e){var element=$(e.currentTarget),trElement=element.closest("tr"),moduleName=trElement.data("moduleName"),customRuleListContainer=$("."+thisInstance.getCustomRuleContainerClassName(moduleName),contentTable);if(customRuleListContainer.length>0)app.isHidden(customRuleListContainer)?(customRuleListContainer.show(),$(".ruleListContainer",customRuleListContainer).slideDown("slow"),trElement.addClass("collapseRow"),element.find("button.arrowDown").addClass("d-none"),element.find("button.arrowUp").removeClass("d-none").show()):($(".ruleListContainer",customRuleListContainer).slideUp("slow",(function(e){customRuleListContainer.css("display","none")})),element.find("button.arrowUp").addClass("d-none"),element.find("button.arrowDown").removeClass("d-none").show(),trElement.removeClass("collapseRow"));else{var progressIndicatorElement=$.progressIndicator({position:"html",blockInfo:{enabled:!0}});thisInstance.getCustomRules(moduleName).done((function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),thisInstance.showCustomRulesNextToElement(trElement,data),element.find("button.arrowDown").addClass("d-none"),element.find("button.arrowUp").removeClass("d-none").show()}))}})),contentTable.on("click",".js-add-custom-rule",(function(e){var button=$(e.currentTarget);thisInstance.editCustomRule(button.data("url"))})),contentTable.on("click",".js-edit",(function(e){var editUrl=$(e.currentTarget).data("url");thisInstance.editCustomRule(editUrl)})),contentTable.on("click",".js-delete",(function(e){var deleteElement=$(e.currentTarget);thisInstance.deleteCustomRule(deleteElement)})),contentContainer.on("submit","#js-edit-sharing-access",(function(e){e.preventDefault();var data=$(e.currentTarget).serializeFormData();thisInstance.save(data).done((function(data){contentContainer.find("button:submit").addClass("d-none"),thisInstance.registerSharingAccessEdit(),Vtiger_Helper_Js.showPnotify({text:app.vtranslate("JS_NEW_SHARING_RULES_APPLIED_SUCCESSFULLY"),type:"success"})}))}))}}),$(document).ready((function(){(new Settings_Sharing_Access_Js).registerEvents()}));
//# sourceMappingURL=SharingAccess.min.js.map
