"use strict";if(void 0===ImportJs){var ImportJs={toogleMergeConfiguration:function(){var mergeChecked=jQuery("#auto_merge").is(":checked"),duplicateMergeConfiguration=jQuery("#duplicates_merge_configuration");mergeChecked?duplicateMergeConfiguration.show():duplicateMergeConfiguration.hide()},checkFileType:function(){var filePath=jQuery("#import_file").val();if(""!=filePath){var fileExtension=filePath.split(".").pop();jQuery("#type").val(fileExtension),ImportJs.handleFileTypeChange()}},handleFileTypeChange:function(){var fileType=jQuery(".js-type").val(),delimiterContainer=jQuery(".js-delimiter-container"),hasHeaderContainer=jQuery(".js-has-header-container"),xmlTpl=jQuery(".js-xml-tpl"),extension=jQuery(".js-zip-extension");switch(fileType){case"xml":delimiterContainer.addClass("d-none"),hasHeaderContainer.addClass("d-none"),xmlTpl.removeClass("d-none"),extension.addClass("d-none");break;case"zip":delimiterContainer.addClass("d-none"),hasHeaderContainer.addClass("d-none"),extension.removeClass("d-none");break;default:delimiterContainer.removeClass("d-none"),hasHeaderContainer.removeClass("d-none"),extension.addClass("d-none"),xmlTpl.addClass("d-none")}},uploadAndParse:function(){return!!ImportJs.validateFilePath()&&!!ImportJs.validateMergeCriteria()},registerImportClickEvent:function(){$("#importButton").removeAttr("disabled").on("click",(function(e){return ImportJs.sanitizeAndSubmit()}))},validateFilePath:function(){var importFile=jQuery("#import_file"),filePath=importFile.val();if(""==jQuery.trim(filePath)){var params={text:app.vtranslate("JS_IMPORT_FILE_CAN_NOT_BE_EMPTY"),type:"error"};return Vtiger_Helper_Js.showMessage(params),importFile.focus(),!1}return!!ImportJs.uploadFilter("import_file","csv|vcf|xml|zip|ics|ical")&&!!ImportJs.uploadFileSize("import_file")},uploadFilter:function(elementId,allowedExtensions){var obj=jQuery("#"+elementId);if(obj){var fileParts=obj.val().toLowerCase().split("."),fileType=fileParts[fileParts.length-1],validExtensions=allowedExtensions.toLowerCase().split("|");if(validExtensions.indexOf(fileType)<0){var params={text:app.vtranslate("JS_SELECT_FILE_EXTENSION")+"\n"+validExtensions,type:"error"};return Vtiger_Helper_Js.showMessage(params),obj.focus(),!1}}return!0},uploadFileSize:function(elementId){var element=jQuery("#"+elementId),importMaxUploadSize=element.closest("td").data("importUploadSize"),importMaxUploadSizeInMb=element.closest("td").data("importUploadSizeMb");if(element.get(0).files[0].size>importMaxUploadSize){var params={text:app.vtranslate("JS_UPLOADED_FILE_SIZE_EXCEEDS")+" "+importMaxUploadSizeInMb+" MB."+app.vtranslate("JS_PLEASE_SPLIT_FILE_AND_IMPORT_AGAIN"),type:"error"};return Vtiger_Helper_Js.showMessage(params),!1}return!0},validateMergeCriteria:function(){if(jQuery("#auto_merge").is(":checked")&&0==jQuery("#selected_merge_fields option").length){var params={text:app.vtranslate("JS_PLEASE_SELECT_ONE_FIELD_FOR_MERGE"),type:"error"};return Vtiger_Helper_Js.showMessage(params),!1}return ImportJs.convertOptionsToJSONArray("#selected_merge_fields","#merge_fields"),!0},convertOptionsToJSONArray:function(objName,targetObjName){var obj=jQuery(objName),arr=[];if(void 0!==obj&&""!=obj[0])for(var i=0;i<obj[0].length;++i)arr.push(obj[0].options[i].value);if("undefined"!==targetObjName){var targetObj=$(targetObjName);void 0!==targetObj&&targetObj.val(JSON.stringify(arr))}return arr},copySelectedOptions:function(source,destination){var srcObj=jQuery(source),destObj=jQuery(destination);if(void 0!==srcObj&&void 0!==destObj)for(var i=0;i<srcObj[0].length;i++)if(1==srcObj[0].options[i].selected){for(var rowFound=!1,existingObj=null,j=0;j<destObj[0].length;j++)if(destObj[0].options[j].value==srcObj[0].options[i].value){rowFound=!0,existingObj=destObj[0].options[j];break}if(1!=rowFound){var opt=$("<option selected>");opt.attr("value",srcObj[0].options[i].value),opt.text(srcObj[0].options[i].text),jQuery(destObj[0]).append(opt),srcObj[0].options[i].selected=!1}else null!=existingObj&&(existingObj.selected=!0)}},removeSelectedOptions:function(objName){var obj=jQuery(objName);if(obj.length)for(var i=obj[0].options.length-1;i>=0;i--)1==obj[0].options[i].selected&&(obj[0].options[i]=null)},sanitizeAndSubmit:function(){return!!ImportJs.sanitizeFieldMapping()&&!!ImportJs.validateCustomMap()},sanitizeFieldMapping:function(){for(var fieldsList=jQuery(".fieldIdentifier"),mappedFields={},inventoryMappedFields={},params={},mappedDefaultValues={},i=0;i<fieldsList.length;++i){var fieldElement=jQuery(fieldsList.get(i)),rowId=jQuery("[name=row_counter]",fieldElement).get(0).value,selectElement=jQuery("select",fieldElement),selectedFieldElement=selectElement.find("option:selected"),selectedFieldName=selectedFieldElement.val(),selectedFieldDefaultValueElement=jQuery("#"+selectedFieldName+"_defaultvalue",fieldElement),defaultValue="";if(defaultValue="checkbox"==selectedFieldDefaultValueElement.attr("type")?selectedFieldDefaultValueElement.is(":checked"):selectedFieldDefaultValueElement.val(),""!=selectedFieldName){var stopImmediately;if(selectElement.hasClass("inventory")?(stopImmediately=ImportJs.checkIfMappedFieldExist(selectedFieldName,inventoryMappedFields,selectedFieldElement),inventoryMappedFields[selectedFieldName]=rowId-1):(stopImmediately=ImportJs.checkIfMappedFieldExist(selectedFieldName,mappedFields,selectedFieldElement),mappedFields[selectedFieldName]=rowId-1),stopImmediately)return!1;""!=defaultValue&&(mappedDefaultValues[selectedFieldName]=defaultValue)}}var mandatoryFields=JSON.parse(jQuery("#mandatory_fields").val()),missingMandatoryFields=[];for(var mandatoryFieldName in mandatoryFields)mandatoryFieldName in mappedFields||missingMandatoryFields.push('"'+mandatoryFields[mandatoryFieldName]+'"');return missingMandatoryFields.length>0?(params={text:app.vtranslate("JS_MAP_MANDATORY_FIELDS")+missingMandatoryFields.join(","),type:"error"},Vtiger_Helper_Js.showMessage(params),!1):(jQuery("#field_mapping").val(JSON.stringify(mappedFields)),jQuery("#inventory_field_mapping").val(JSON.stringify(inventoryMappedFields)),jQuery("#default_values").val(JSON.stringify(mappedDefaultValues)),!0)},checkIfMappedFieldExist:function(selectedFieldName,mappedFields,selectedFieldElement){if(selectedFieldName in mappedFields){var params={text:app.vtranslate("JS_FIELD_MAPPED_MORE_THAN_ONCE")+" "+selectedFieldElement.data("label"),type:"error"};return Vtiger_Helper_Js.showMessage(params),!0}return!1},validateCustomMap:function(){var params={};if(jQuery("#save_map").is(":checked")){var mapName=jQuery("#save_map_as").val();if(""==jQuery.trim(mapName))return params={text:app.vtranslate("JS_MAP_NAME_CAN_NOT_BE_EMPTY"),type:"error"},Vtiger_Helper_Js.showMessage(params),!1;for(var mapOptions=jQuery("#saved_maps option"),i=0;i<mapOptions.length;++i){if(jQuery(mapOptions.get(i)).html()==mapName)return params={text:app.vtranslate("JS_MAP_NAME_ALREADY_EXISTS"),type:"error"},Vtiger_Helper_Js.showMessage(params),!1}}return!0},loadSavedMap:function(){var selectedMapElement=jQuery("#saved_maps option:selected"),mapId=selectedMapElement.attr("id"),fieldsList=jQuery(".fieldIdentifier"),deleteMapContainer=jQuery("#delete_map_container");if(fieldsList.each((function(i,element){var fieldElement=jQuery(element);jQuery("[name=mapped_fields]",fieldElement).val("")})),-1!=mapId){deleteMapContainer.show();var mappingString=selectedMapElement.val();if(""!=mappingString){for(var mappingPairs=mappingString.split("&"),mapping={},i=0;i<mappingPairs.length;++i){var mappingPair=mappingPairs[i].split("="),header=mappingPair[0];header=(header=header.replace(/\/eq\//g,"=")).replace(/\/amp\//g,"&"),mapping["'"+header+"'"]=mappingPair[1]}fieldsList.each((function(i,element){var fieldElement=jQuery(element),mappedFields=jQuery("[name=mapped_fields]",fieldElement),rowId=jQuery("[name=row_counter]",fieldElement).get(0).value,headerNameElement=jQuery("[name=header_name]",fieldElement).get(0),headerName=jQuery(headerNameElement).html();"'"+headerName+"'"in mapping?mappedFields.val(mapping["'"+headerName+"'"]):rowId in mapping&&mappedFields.val($rowId),mappedFields.trigger("change"),ImportJs.loadDefaultValueWidget(fieldElement.attr("id"))}))}}else deleteMapContainer.hide()},deleteMap:function(module){app.showConfirmModal(app.vtranslate("LBL_DELETE_CONFIRMATION"),(function(){var mapId=jQuery("#saved_maps option:selected").attr("id"),status=jQuery("#status");status.show();var postData={module:module,view:"Import",mode:"deleteMap",mapid:mapId};AppConnector.request(postData).done((function(data){jQuery("#savedMapsContainer").html(data),status.hide();var parent=jQuery("#saved_maps");App.Fields.Picklist.changeSelectElementView(parent)})).fail((function(error,err){console.error(error)}))}))},loadDefaultValueWidget:function(rowIdentifierId){var affectedRow=jQuery("#"+rowIdentifierId);if(void 0!==affectedRow&&null!=affectedRow){var selectedFieldElement=jQuery("[name=mapped_fields]",affectedRow).get(0),selectedFieldName=jQuery(selectedFieldElement).val(),defaultValueContainer=jQuery(jQuery("[name=default_value_container]",affectedRow).get(0)),allDefaultValuesContainer=jQuery("#defaultValuesElementsContainer");if(defaultValueContainer.children.length>0)jQuery(":first",defaultValueContainer).detach().appendTo(allDefaultValuesContainer);jQuery("#"+selectedFieldName+"_defaultvalue_container",allDefaultValuesContainer).detach().appendTo(defaultValueContainer)}},loadDefaultValueWidgetForMappedFields:function(){jQuery(".fieldIdentifier").each((function(i,element){var fieldElement=jQuery(element);""!=jQuery("[name=mapped_fields]",fieldElement).val()&&ImportJs.loadDefaultValueWidget(fieldElement.attr("id"))}))},submitAction:function(){jQuery('[name="importAdvanced"]').on("submit",(function(){$.progressIndicator({message:app.vtranslate("JS_SAVE_LOADER_INFO"),position:"html",blockInfo:{enabled:!0}})}))},openListInModal:function(){$(".js-open-list-in-modal").on("click",(function(){var element=$(this),moduleName=element.data("module-name"),type="",forUser=element.data("for-user"),forModule=element.data("for-module");""!==$(this).attr("data-type")&&(type="&type="+element.data("type")),app.showModalWindow(null,"index.php?module="+moduleName+"&view=List&mode=getImportDetails"+type+"&start=1&foruser="+forUser+"&forModule="+forModule,(function(data){var container=data.find(".listViewEntriesDiv"),containerH=container.height(),containerOffsetTop=container.offset().top,footerH=$(".js-footer").height(),windowH=$(window).height();Quasar.plugins.Platform.is.desktop&&(containerH+containerOffsetTop+footerH>windowH&&container.height(windowH-(containerOffsetTop+footerH)),app.showNewScrollbarTopBottomRight(container))}))}))}};jQuery(document).ready((function(){ImportJs.toogleMergeConfiguration(),ImportJs.openListInModal(),ImportJs.submitAction(),ImportJs.loadDefaultValueWidgetForMappedFields(),ImportJs.registerImportClickEvent(),App.Fields.Date.register(jQuery(".contentsDiv"))}))}
//# sourceMappingURL=Import.min.js.map
