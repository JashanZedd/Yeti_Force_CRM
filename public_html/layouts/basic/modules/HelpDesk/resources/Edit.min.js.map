{"version":3,"file":"Edit.min.js","sources":["Edit.js"],"sourcesContent":["/* {[The file is published on the basis of YetiForce Public License 3.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */\n'use strict';\n\nVtiger_Edit_Js(\n\t'HelpDesk_Edit_Js',\n\t{},\n\t{\n\t\t/**\n\t\t * Register pre save event\n\t\t * @param {jQuery} form\n\t\t */\n\t\tregisterRecordPreSaveEventEvent: function(form) {\n\t\t\tconst self = this;\n\t\t\tlet lockSave = true;\n\t\t\tform.on(Vtiger_Edit_Js.recordPreSave, function(e, data) {\n\t\t\t\tlet closedStatus = JSON.parse(app.getMainParams('closeTicketForStatus'));\n\t\t\t\tlet status = form.find('[name=\"ticketstatus\"] :selected').val();\n\t\t\t\tlet progress = $.progressIndicator({ position: 'html', blockInfo: { enabled: true } });\n\t\t\t\tlet isClosedStatusSet = status in closedStatus;\n\t\t\t\tconst recordId = app.getRecordId();\n\t\t\t\tif (\n\t\t\t\t\t(app.getMainParams('checkIfRecordHasTimeControl') || app.getMainParams('checkIfRelatedTicketsAreClosed')) &&\n\t\t\t\t\tisClosedStatusSet &&\n\t\t\t\t\trecordId &&\n\t\t\t\t\t!data.module\n\t\t\t\t) {\n\t\t\t\t\tif (lockSave && recordId) {\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\tAppConnector.request({\n\t\t\t\t\t\t\taction: 'CheckValidateToClose',\n\t\t\t\t\t\t\tmodule: app.getModuleName(),\n\t\t\t\t\t\t\trecord: recordId,\n\t\t\t\t\t\t\tstatus: form.find('[name=\"ticketstatus\"] :selected').val()\n\t\t\t\t\t\t}).done(response => {\n\t\t\t\t\t\t\tprogress.progressIndicator({ mode: 'hide' });\n\t\t\t\t\t\t\tif (response.result.hasTimeControl.result && response.result.relatedTicketsClosed.result) {\n\t\t\t\t\t\t\t\tlockSave = false;\n\t\t\t\t\t\t\t\tform.submit();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (!response.result.hasTimeControl.result) {\n\t\t\t\t\t\t\t\tVtiger_Helper_Js.showPnotify({\n\t\t\t\t\t\t\t\t\ttext: response.result.hasTimeControl.message,\n\t\t\t\t\t\t\t\t\ttype: 'info'\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\tself.addTimeControl({\n\t\t\t\t\t\t\t\t\trecordId: recordId,\n\t\t\t\t\t\t\t\t\turl: `index.php?module=OSSTimeControl&view=Edit&sourceModule=HelpDesk&sourceRecord=${recordId}&relationOperation=true&subprocess=${recordId}&subprocess=${recordId}`\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (!response.result.relatedTicketsClosed.result) {\n\t\t\t\t\t\t\t\tVtiger_Helper_Js.showPnotify({\n\t\t\t\t\t\t\t\t\ttext: response.result.relatedTicketsClosed.message,\n\t\t\t\t\t\t\t\t\ttype: 'info'\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (isClosedStatusSet && (!recordId || data.module)) {\n\t\t\t\t\tVtiger_Helper_Js.showPnotify({\n\t\t\t\t\t\ttext: app.vtranslate('JS_CANT_CLOSE_NEW_RECROD'),\n\t\t\t\t\t\ttype: 'info'\n\t\t\t\t\t});\n\t\t\t\t\tprogress.progressIndicator({ mode: 'hide' });\n\t\t\t\t\te.preventDefault();\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\t/**\n\t\t * Add time control when closed ticket\n\t\t * @param {array} params\n\t\t */\n\t\taddTimeControl: function(params) {\n\t\t\tlet aDeferred = jQuery.Deferred();\n\t\t\tlet referenceModuleName = 'OSSTimeControl';\n\t\t\tlet parentId = params.recordId;\n\t\t\tlet parentModule = 'HelpDesk';\n\t\t\tlet quickCreateParams = {};\n\t\t\tlet relatedParams = {};\n\t\t\tlet relatedField = 'subprocess';\n\t\t\tlet fullFormUrl = params.url;\n\t\t\trelatedParams[relatedField] = parentId;\n\t\t\tlet eliminatedKeys = new Array('view', 'module', 'mode', 'action');\n\n\t\t\tlet preQuickCreateSave = function(data) {\n\t\t\t\tlet index, queryParam, queryParamComponents;\n\t\t\t\tlet queryParameters = [];\n\n\t\t\t\tif (typeof fullFormUrl !== 'undefined' && fullFormUrl.indexOf('?') !== -1) {\n\t\t\t\t\tlet urlSplit = fullFormUrl.split('?');\n\t\t\t\t\tlet queryString = urlSplit[1];\n\t\t\t\t\tqueryParameters = queryString.split('&');\n\t\t\t\t\tfor (index = 0; index < queryParameters.length; index++) {\n\t\t\t\t\t\tqueryParam = queryParameters[index];\n\t\t\t\t\t\tqueryParamComponents = queryParam.split('=');\n\t\t\t\t\t\tif (queryParamComponents[0] == 'mode' && queryParamComponents[1] == 'Calendar') {\n\t\t\t\t\t\t\tdata.find('a[data-tab-name=\"Task\"]').trigger('click');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tjQuery('<input type=\"hidden\" name=\"sourceModule\" value=\"' + parentModule + '\" />').appendTo(data);\n\t\t\t\tjQuery('<input type=\"hidden\" name=\"sourceRecord\" value=\"' + parentId + '\" />').appendTo(data);\n\t\t\t\tjQuery('<input type=\"hidden\" name=\"relationOperation\" value=\"true\" />').appendTo(data);\n\n\t\t\t\tif (typeof relatedField !== 'undefined') {\n\t\t\t\t\tlet field = data.find('[name=\"' + relatedField + '\"]');\n\t\t\t\t\tif (field.length == 0) {\n\t\t\t\t\t\tjQuery('<input type=\"hidden\" name=\"' + relatedField + '\" value=\"' + parentId + '\" />').appendTo(data);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tfor (index = 0; index < queryParameters.length; index++) {\n\t\t\t\t\tqueryParam = queryParameters[index];\n\t\t\t\t\tqueryParamComponents = queryParam.split('=');\n\t\t\t\t\tif (\n\t\t\t\t\t\tjQuery.inArray(queryParamComponents[0], eliminatedKeys) == '-1' &&\n\t\t\t\t\t\tdata.find('[name=\"' + queryParamComponents[0] + '\"]').length == 0\n\t\t\t\t\t) {\n\t\t\t\t\t\tjQuery(\n\t\t\t\t\t\t\t'<input type=\"hidden\" name=\"' + queryParamComponents[0] + '\" value=\"' + queryParamComponents[1] + '\" />'\n\t\t\t\t\t\t).appendTo(data);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t\tif (typeof fullFormUrl !== 'undefined' && fullFormUrl.indexOf('?') !== -1) {\n\t\t\t\tlet urlSplit = fullFormUrl.split('?');\n\t\t\t\tlet queryString = urlSplit[1];\n\t\t\t\tlet queryParameters = queryString.split('&');\n\t\t\t\tfor (let index = 0; index < queryParameters.length; index++) {\n\t\t\t\t\tlet queryParam = queryParameters[index];\n\t\t\t\t\tlet queryParamComponents = queryParam.split('=');\n\t\t\t\t\tif (jQuery.inArray(queryParamComponents[0], eliminatedKeys) == '-1') {\n\t\t\t\t\t\trelatedParams[queryParamComponents[0]] = queryParamComponents[1];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tquickCreateParams['data'] = relatedParams;\n\t\t\tquickCreateParams['callbackFunction'] = function() {};\n\t\t\tquickCreateParams['callbackPostShown'] = preQuickCreateSave;\n\t\t\tquickCreateParams['noCache'] = true;\n\t\t\tVtiger_Header_Js.getInstance().quickCreateModule(referenceModuleName, quickCreateParams);\n\t\t\treturn aDeferred.promise();\n\t\t}\n\t}\n);\n"],"names":["Vtiger_Edit_Js","form","self","lockSave","on","recordPreSave","e","data","closedStatus","JSON","parse","app","getMainParams","status","find","val","progress","$","progressIndicator","position","blockInfo","enabled","isClosedStatusSet","recordId","getRecordId","module","preventDefault","request","getModuleName","done","mode","response","result","hasTimeControl","relatedTicketsClosed","submit","showPnotify","message","addTimeControl","vtranslate","params","aDeferred","jQuery","Deferred","referenceModuleName","parentId","parentModule","quickCreateParams","relatedParams","relatedField","fullFormUrl","url","eliminatedKeys","Array","preQuickCreateSave","index","queryParam","queryParamComponents","queryParameters","indexOf","urlSplit","split","queryString","length","trigger","appendTo","field","inArray","getInstance","quickCreateModule","promise"],"mappings":";;AAAA;AACA;AAEAA,eACC,kBADD,EAEC,EAFD,EAGC;;;;;kCAKkC,yCAASC,IAAT,EAAe;MACzCC,OAAO,IAAb;MACIC,WAAW,IAAf;OACKC,EAAL,CAAQJ,eAAeK,aAAvB,EAAsC,UAASC,CAAT,EAAYC,IAAZ,EAAkB;OACnDC,eAAeC,KAAKC,KAAL,CAAWC,IAAIC,aAAJ,CAAkB,sBAAlB,CAAX,CAAnB;OACIC,SAASZ,KAAKa,IAAL,CAAU,iCAAV,EAA6CC,GAA7C,EAAb;OACIC,WAAWC,EAAEC,iBAAF,CAAoB,EAAEC,UAAU,MAAZ,EAAoBC,WAAW,EAAEC,SAAS,IAAX,EAA/B,EAApB,CAAf;OACIC,oBAAoBT,UAAUL,YAAlC;OACMe,WAAWZ,IAAIa,WAAJ,EAAjB;OAEC,CAACb,IAAIC,aAAJ,CAAkB,6BAAlB,KAAoDD,IAAIC,aAAJ,CAAkB,gCAAlB,CAArD,KACAU,iBADA,IAEAC,QAFA,IAGA,CAAChB,KAAKkB,MAJP,EAKE;QACGtB,YAAYoB,QAAhB,EAA0B;OACvBG,cAAF;kBACaC,OAAb,CAAqB;cACZ,sBADY;cAEZhB,IAAIiB,aAAJ,EAFY;cAGZL,QAHY;cAIZtB,KAAKa,IAAL,CAAU,iCAAV,EAA6CC,GAA7C;MAJT,EAKGc,IALH,CAKQ,oBAAY;eACVX,iBAAT,CAA2B,EAAEY,MAAM,MAAR,EAA3B;UACIC,SAASC,MAAT,CAAgBC,cAAhB,CAA+BD,MAA/B,IAAyCD,SAASC,MAAT,CAAgBE,oBAAhB,CAAqCF,MAAlF,EAA0F;kBAC9E,KAAX;YACKG,MAAL;;UAEG,CAACJ,SAASC,MAAT,CAAgBC,cAAhB,CAA+BD,MAApC,EAA4C;wBAC1BI,WAAjB,CAA6B;cACtBL,SAASC,MAAT,CAAgBC,cAAhB,CAA+BI,OADT;cAEtB;QAFP;YAIKC,cAAL,CAAoB;kBACTf,QADS;+FAEkEA,QAArF,2CAAmIA,QAAnI,oBAA0JA;QAF3J;;UAKG,CAACQ,SAASC,MAAT,CAAgBE,oBAAhB,CAAqCF,MAA1C,EAAkD;wBAChCI,WAAjB,CAA6B;cACtBL,SAASC,MAAT,CAAgBE,oBAAhB,CAAqCG,OADf;cAEtB;QAFP;;MAtBF;;;OA8BEf,sBAAsB,CAACC,QAAD,IAAahB,KAAKkB,MAAxC,CAAJ,EAAqD;qBACnCW,WAAjB,CAA6B;WACtBzB,IAAI4B,UAAJ,CAAe,0BAAf,CADsB;WAEtB;KAFP;aAISrB,iBAAT,CAA2B,EAAEY,MAAM,MAAR,EAA3B;MACEJ,cAAF;;GAlDF;EARF;;;;;iBAkEiB,wBAASc,MAAT,EAAiB;MAC5BC,YAAYC,OAAOC,QAAP,EAAhB;MACIC,sBAAsB,gBAA1B;MACIC,WAAWL,OAAOjB,QAAtB;MACIuB,eAAe,UAAnB;MACIC,oBAAoB,EAAxB;MACIC,gBAAgB,EAApB;MACIC,eAAe,YAAnB;MACIC,cAAcV,OAAOW,GAAzB;gBACcF,YAAd,IAA8BJ,QAA9B;MACIO,iBAAiB,IAAIC,KAAJ,CAAU,MAAV,EAAkB,QAAlB,EAA4B,MAA5B,EAAoC,QAApC,CAArB;;MAEIC,qBAAqB,SAArBA,kBAAqB,CAAS/C,IAAT,EAAe;OACnCgD,cAAJ;OAAWC,mBAAX;OAAuBC,6BAAvB;OACIC,kBAAkB,EAAtB;;OAEI,OAAOR,WAAP,KAAuB,WAAvB,IAAsCA,YAAYS,OAAZ,CAAoB,GAApB,MAA6B,CAAC,CAAxE,EAA2E;QACtEC,WAAWV,YAAYW,KAAZ,CAAkB,GAAlB,CAAf;QACIC,cAAcF,SAAS,CAAT,CAAlB;sBACkBE,YAAYD,KAAZ,CAAkB,GAAlB,CAAlB;SACKN,QAAQ,CAAb,EAAgBA,QAAQG,gBAAgBK,MAAxC,EAAgDR,OAAhD,EAAyD;kBAC3CG,gBAAgBH,KAAhB,CAAb;4BACuBC,WAAWK,KAAX,CAAiB,GAAjB,CAAvB;SACIJ,qBAAqB,CAArB,KAA2B,MAA3B,IAAqCA,qBAAqB,CAArB,KAA2B,UAApE,EAAgF;WAC1E3C,IAAL,CAAU,yBAAV,EAAqCkD,OAArC,CAA6C,OAA7C;;;;UAII,qDAAqDlB,YAArD,GAAoE,MAA3E,EAAmFmB,QAAnF,CAA4F1D,IAA5F;UACO,qDAAqDsC,QAArD,GAAgE,MAAvE,EAA+EoB,QAA/E,CAAwF1D,IAAxF;UACO,+DAAP,EAAwE0D,QAAxE,CAAiF1D,IAAjF;;GAEyC;QACpC2D,QAAQ3D,KAAKO,IAAL,CAAU,YAAYmC,YAAZ,GAA2B,IAArC,CAAZ;QACIiB,MAAMH,MAAN,IAAgB,CAApB,EAAuB;YACf,gCAAgCd,YAAhC,GAA+C,WAA/C,GAA6DJ,QAA7D,GAAwE,MAA/E,EAAuFoB,QAAvF,CAAgG1D,IAAhG;;;QAGGgD,QAAQ,CAAb,EAAgBA,QAAQG,gBAAgBK,MAAxC,EAAgDR,OAAhD,EAAyD;iBAC3CG,gBAAgBH,KAAhB,CAAb;2BACuBC,WAAWK,KAAX,CAAiB,GAAjB,CAAvB;QAECnB,OAAOyB,OAAP,CAAeV,qBAAqB,CAArB,CAAf,EAAwCL,cAAxC,KAA2D,IAA3D,IACA7C,KAAKO,IAAL,CAAU,YAAY2C,qBAAqB,CAArB,CAAZ,GAAsC,IAAhD,EAAsDM,MAAtD,IAAgE,CAFjE,EAGE;YAEA,gCAAgCN,qBAAqB,CAArB,CAAhC,GAA0D,WAA1D,GAAwEA,qBAAqB,CAArB,CAAxE,GAAkG,MADnG,EAEEQ,QAFF,CAEW1D,IAFX;;;GAjCH;MAuCI,OAAO2C,WAAP,KAAuB,WAAvB,IAAsCA,YAAYS,OAAZ,CAAoB,GAApB,MAA6B,CAAC,CAAxE,EAA2E;OACtEC,WAAWV,YAAYW,KAAZ,CAAkB,GAAlB,CAAf;OACIC,cAAcF,SAAS,CAAT,CAAlB;OACIF,kBAAkBI,YAAYD,KAAZ,CAAkB,GAAlB,CAAtB;QACK,IAAIN,QAAQ,CAAjB,EAAoBA,QAAQG,gBAAgBK,MAA5C,EAAoDR,OAApD,EAA6D;QACxDC,aAAaE,gBAAgBH,KAAhB,CAAjB;QACIE,uBAAuBD,WAAWK,KAAX,CAAiB,GAAjB,CAA3B;QACInB,OAAOyB,OAAP,CAAeV,qBAAqB,CAArB,CAAf,EAAwCL,cAAxC,KAA2D,IAA/D,EAAqE;mBACtDK,qBAAqB,CAArB,CAAd,IAAyCA,qBAAqB,CAArB,CAAzC;;;;;oBAKe,MAAlB,IAA4BT,aAA5B;oBACkB,kBAAlB,IAAwC,YAAW,EAAnD;oBACkB,mBAAlB,IAAyCM,kBAAzC;oBACkB,SAAlB,IAA+B,IAA/B;mBACiBc,WAAjB,GAA+BC,iBAA/B,CAAiDzB,mBAAjD,EAAsEG,iBAAtE;SACON,UAAU6B,OAAV,EAAP;;CA1IH"}