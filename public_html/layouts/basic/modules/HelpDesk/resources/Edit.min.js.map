{"version":3,"file":"Edit.min.js","sources":["Edit.js"],"sourcesContent":["/* {[The file is published on the basis of YetiForce Public License 5.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */\n'use strict';\n\nVtiger_Edit_Js(\n\t'HelpDesk_Edit_Js',\n\t{},\n\t{\n\t\t/**\n\t\t * Register pre save event\n\t\t * @param {jQuery} form\n\t\t */\n\t\tregisterRecordPreSaveEventEvent: function (form) {\n\t\t\tthis._super(form);\n\t\t\tform.on(Vtiger_Edit_Js.recordPreSave, (e, data) => {\n\t\t\t\ttry {\n\t\t\t\t\tthis.validateToClose(form).done((response) => {\n\t\t\t\t\t\tif (response !== true) {\n\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t} catch (error) {\n\t\t\t\t\tapp.errorLog(error);\n\t\t\t\t\tapp.showNotify({\n\t\t\t\t\t\ttext: app.vtranslate('JS_ERROR'),\n\t\t\t\t\t\ttype: 'error'\n\t\t\t\t\t});\n\t\t\t\t\te.preventDefault();\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\tvalidateToClose: function (form) {\n\t\t\tconst aDeferred = $.Deferred();\n\t\t\tlet closedStatus = app.getMainParams('closeTicketForStatus', true);\n\t\t\tlet status = form.find('[name=\"ticketstatus\"] :selected').val();\n\t\t\tlet progress = $.progressIndicator({ position: 'html', blockInfo: { enabled: true } });\n\t\t\tlet isClosedStatusSet = status in closedStatus;\n\t\t\tconst recordId = form.find('[name=\"record\"]').val();\n\t\t\tif (\n\t\t\t\t(app.getMainParams('checkIfRecordHasTimeControl') || app.getMainParams('checkIfRelatedTicketsAreClosed')) &&\n\t\t\t\tisClosedStatusSet &&\n\t\t\t\trecordId\n\t\t\t) {\n\t\t\t\tlet formData = {\n\t\t\t\t\taction: 'CheckValidateToClose',\n\t\t\t\t\tmodule: app.getModuleName(),\n\t\t\t\t\trecord: recordId,\n\t\t\t\t\tstatus: form.find('[name=\"ticketstatus\"] :selected').val()\n\t\t\t\t};\n\t\t\t\tAppConnector.request({\n\t\t\t\t\tasync: false,\n\t\t\t\t\turl: 'index.php',\n\t\t\t\t\ttype: 'POST',\n\t\t\t\t\tdata: formData\n\t\t\t\t}).done((response) => {\n\t\t\t\t\tprogress.progressIndicator({ mode: 'hide' });\n\t\t\t\t\tif (response.result.hasTimeControl.result && response.result.relatedTicketsClosed.result) {\n\t\t\t\t\t\taDeferred.resolve(true);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (!response.result.hasTimeControl.result) {\n\t\t\t\t\t\t\tapp.showNotify({\n\t\t\t\t\t\t\t\ttext: response.result.hasTimeControl.message,\n\t\t\t\t\t\t\t\ttype: 'info'\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tthis.addTimeControl({\n\t\t\t\t\t\t\t\trecordId: recordId,\n\t\t\t\t\t\t\t\turl: `index.php?module=OSSTimeControl&view=Edit&sourceModule=HelpDesk&sourceRecord=${recordId}&relationOperation=true&subprocess=${recordId}&subprocess=${recordId}`\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!response.result.relatedTicketsClosed.result) {\n\t\t\t\t\t\t\tapp.showNotify({\n\t\t\t\t\t\t\t\ttext: response.result.relatedTicketsClosed.message,\n\t\t\t\t\t\t\t\ttype: 'info'\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\taDeferred.resolve(false);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} else if (isClosedStatusSet && !recordId) {\n\t\t\t\tapp.showNotify({\n\t\t\t\t\ttext: app.vtranslate('JS_CANT_CLOSE_NEW_RECROD'),\n\t\t\t\t\ttype: 'info'\n\t\t\t\t});\n\t\t\t\tprogress.progressIndicator({ mode: 'hide' });\n\t\t\t\taDeferred.resolve(false);\n\t\t\t} else {\n\t\t\t\taDeferred.resolve(true);\n\t\t\t}\n\n\t\t\treturn aDeferred.promise();\n\t\t},\n\t\t/**\n\t\t * Add time control when closed ticket\n\t\t * @param {array} params\n\t\t * @returns {Promise}\n\t\t */\n\t\taddTimeControl: function (params) {\n\t\t\tlet aDeferred = jQuery.Deferred();\n\t\t\tlet referenceModuleName = 'OSSTimeControl';\n\t\t\tlet parentId = params.recordId;\n\t\t\tlet parentModule = 'HelpDesk';\n\t\t\tlet quickCreateParams = {};\n\t\t\tlet relatedParams = {};\n\t\t\tlet relatedField = 'subprocess';\n\t\t\tlet fullFormUrl = params.url;\n\t\t\trelatedParams[relatedField] = parentId;\n\t\t\tlet eliminatedKeys = new Array('view', 'module', 'mode', 'action');\n\n\t\t\tlet preQuickCreateSave = function (data) {\n\t\t\t\tlet index, queryParam, queryParamComponents;\n\t\t\t\tlet queryParameters = [];\n\n\t\t\t\tif (typeof fullFormUrl !== 'undefined' && fullFormUrl.indexOf('?') !== -1) {\n\t\t\t\t\tlet urlSplit = fullFormUrl.split('?');\n\t\t\t\t\tlet queryString = urlSplit[1];\n\t\t\t\t\tqueryParameters = queryString.split('&');\n\t\t\t\t\tfor (index = 0; index < queryParameters.length; index++) {\n\t\t\t\t\t\tqueryParam = queryParameters[index];\n\t\t\t\t\t\tqueryParamComponents = queryParam.split('=');\n\t\t\t\t\t\tif (queryParamComponents[0] == 'mode' && queryParamComponents[1] == 'Calendar') {\n\t\t\t\t\t\t\tdata.find('a[data-tab-name=\"Task\"]').trigger('click');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tjQuery('<input type=\"hidden\" name=\"sourceModule\" value=\"' + parentModule + '\" />').appendTo(data);\n\t\t\t\tjQuery('<input type=\"hidden\" name=\"sourceRecord\" value=\"' + parentId + '\" />').appendTo(data);\n\t\t\t\tjQuery('<input type=\"hidden\" name=\"relationOperation\" value=\"true\" />').appendTo(data);\n\n\t\t\t\tif (typeof relatedField !== 'undefined') {\n\t\t\t\t\tlet field = data.find('[name=\"' + relatedField + '\"]');\n\t\t\t\t\tif (field.length == 0) {\n\t\t\t\t\t\tjQuery('<input type=\"hidden\" name=\"' + relatedField + '\" value=\"' + parentId + '\" />').appendTo(data);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tfor (index = 0; index < queryParameters.length; index++) {\n\t\t\t\t\tqueryParam = queryParameters[index];\n\t\t\t\t\tqueryParamComponents = queryParam.split('=');\n\t\t\t\t\tif (\n\t\t\t\t\t\tjQuery.inArray(queryParamComponents[0], eliminatedKeys) == '-1' &&\n\t\t\t\t\t\tdata.find('[name=\"' + queryParamComponents[0] + '\"]').length == 0\n\t\t\t\t\t) {\n\t\t\t\t\t\tjQuery(\n\t\t\t\t\t\t\t'<input type=\"hidden\" name=\"' + queryParamComponents[0] + '\" value=\"' + queryParamComponents[1] + '\" />'\n\t\t\t\t\t\t).appendTo(data);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t\tif (typeof fullFormUrl !== 'undefined' && fullFormUrl.indexOf('?') !== -1) {\n\t\t\t\tlet urlSplit = fullFormUrl.split('?');\n\t\t\t\tlet queryString = urlSplit[1];\n\t\t\t\tlet queryParameters = queryString.split('&');\n\t\t\t\tfor (let index = 0; index < queryParameters.length; index++) {\n\t\t\t\t\tlet queryParam = queryParameters[index];\n\t\t\t\t\tlet queryParamComponents = queryParam.split('=');\n\t\t\t\t\tif (jQuery.inArray(queryParamComponents[0], eliminatedKeys) == '-1') {\n\t\t\t\t\t\trelatedParams[queryParamComponents[0]] = queryParamComponents[1];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tquickCreateParams['data'] = relatedParams;\n\t\t\tquickCreateParams['callbackFunction'] = function () {};\n\t\t\tquickCreateParams['callbackPostShown'] = preQuickCreateSave;\n\t\t\tquickCreateParams['noCache'] = true;\n\t\t\tApp.Components.QuickCreate.createRecord(referenceModuleName, quickCreateParams);\n\t\t\treturn aDeferred.promise();\n\t\t}\n\t}\n);\n"],"names":["Vtiger_Edit_Js","registerRecordPreSaveEventEvent","form","_super","on","recordPreSave","e","validateToClose","done","response","preventDefault","error","app","errorLog","showNotify","text","vtranslate","type","aDeferred","$","Deferred","closedStatus","getMainParams","status","find","val","progress","progressIndicator","position","blockInfo","enabled","isClosedStatusSet","recordId","action","module","getModuleName","record","AppConnector","request","async","url","data","formData","mode","result","hasTimeControl","relatedTicketsClosed","resolve","message","addTimeControl","promise","params","jQuery","parentId","quickCreateParams","relatedParams","relatedField","fullFormUrl","eliminatedKeys","preQuickCreateSave","queryParam","queryParamComponents","queryParameters","indexOf","urlSplit","split","queryString","index","length","trigger","appendTo","field","inArray","App","Components","QuickCreate","createRecord"],"mappings":";;AAAA,kKACA,YAAY,CAEZA,cAAc,CACb,kBAAkB,CAClB,EAAE,CACF;AAED;AACA;AACA,KACEC,+BAA+B,CAAE,SAAUC,+BAAAA,CAAAA,IAAI,CAAE,CAChD,IAAA,KAAA,CAAA,IAAA,CAAA,IAAI,CAACC,MAAM,CAACD,IAAI,CAAC,CACjBA,IAAI,CAACE,EAAE,CAACJ,cAAc,CAACK,aAAa,CAAE,SAACC,CAAC,CAAW,CAClD,GAAI,CACH,KAAI,CAACC,eAAe,CAACL,IAAI,CAAC,CAACM,IAAI,CAAC,SAACC,QAAQ,CAAK,CACzC,KAAAA,QAAiB,EACpBH,CAAC,CAACI,cAAc,GAElB,CAAC,EACF,CAAE,MAAOC,KAAK,CAAE,CACfC,GAAG,CAACC,QAAQ,CAACF,KAAK,CAAC,CACnBC,GAAG,CAACE,UAAU,CAAC,CACdC,IAAI,CAAEH,GAAG,CAACI,UAAU,CAAC,UAAU,CAAC,CAChCC,IAAI,CAAE,OACP,CAAC,CAAC,CACFX,CAAC,CAACI,cAAc,GACjB,CACD,CAAC,EACF,CAAC,CACDH,eAAe,CAAE,SAAUL,eAAAA,CAAAA,IAAI,CAAE,CAAA,IAAA,MAAA,CAAA,IAAA,CAC1BgB,SAAS,CAAGC,CAAC,CAACC,QAAQ,EAAE,CAC1BC,YAAY,CAAGT,GAAG,CAACU,aAAa,CAAC,sBAAsB,CAAO,CAAA,CAAA,CAAA,CAC9DC,MAAM,CAAGrB,IAAI,CAACsB,IAAI,CAAC,mCAAiC,CAAC,CAACC,GAAG,EAAE,CAC3DC,QAAQ,CAAGP,CAAC,CAACQ,iBAAiB,CAAC,CAAEC,QAAQ,CAAE,MAAM,CAAEC,SAAS,CAAE,CAAEC,OAAO,CAAA,CAAA,CAAO,CAAE,CAAC,CAAC,CAClFC,iBAAiB,EAAGR,MAAM,gBAAgB,CACxCS,CAAAA,QAAQ,CAAG9B,IAAI,CAACsB,IAAI,CAAC,mBAAiB,CAAC,CAACC,GAAG,EAAE,CACnD,GACC,CAACb,GAAG,CAACU,aAAa,CAAC,6BAA6B,CAAC,EAAIV,GAAG,CAACU,aAAa,CAAC,gCAAgC,CAAC,GACxGS,iBAAiB,EACjBC,QAAQ,CACP,CACD,YAAY,CAAG,CACdC,MAAM,CAAE,sBAAsB,CAC9BC,MAAM,CAAEtB,GAAG,CAACuB,aAAa,EAAE,CAC3BC,MAAM,CAAEJ,QAAQ,CAChBT,MAAM,CAAErB,IAAI,CAACsB,IAAI,CAAC,mCAAiC,CAAC,CAACC,GAAG,EACzD,CAAC,CACDY,YAAY,CAACC,OAAO,CAAC,CACpBC,KAAK,GAAO,CACZC,GAAG,CAAE,WAAW,CAChBvB,IAAI,CAAE,MAAM,CACZwB,IAAI,CAAEC,QACP,CAAC,CAAC,CAAClC,IAAI,CAAC,SAACC,QAAQ,CAAK,CACrBiB,QAAQ,CAACC,iBAAiB,CAAC,CAAEgB,IAAI,CAAE,MAAO,CAAC,CAAC,CACxClC,QAAQ,CAACmC,MAAM,CAACC,cAAc,CAACD,MAAM,EAAInC,QAAQ,CAACmC,MAAM,CAACE,oBAAoB,CAACF,MAAM,CACvF1B,SAAS,CAAC6B,OAAO,IAAM,EAEnB,CAACtC,QAAQ,CAACmC,MAAM,CAACC,cAAc,CAACD,MAAM,GACzChC,GAAG,CAACE,UAAU,CAAC,CACdC,IAAI,CAAEN,QAAQ,CAACmC,MAAM,CAACC,cAAc,CAACG,OAAO,CAC5C/B,IAAI,CAAE,MACP,CAAC,CAAC,CACF,MAAI,CAACgC,cAAc,CAAC,CACnBjB,QAAQ,CAAEA,QAAQ,CAClBQ,GAAG,CAAA,+EAAA,CAAA,MAAA,CAAkFR,QAAQ,CAAsCA,qCAAAA,CAAAA,CAAAA,MAAAA,CAAAA,QAAQ,wBAAeA,QAAQ,CACnK,CAAC,CAAC,CAEC,CAAA,CAACvB,QAAQ,CAACmC,MAAM,CAACE,oBAAoB,CAACF,MAAM,EAC/ChC,GAAG,CAACE,UAAU,CAAC,CACdC,IAAI,CAAEN,QAAQ,CAACmC,MAAM,CAACE,oBAAoB,CAACE,OAAO,CAClD/B,IAAI,CAAE,MACP,CAAC,CAAC,CAEHC,SAAS,CAAC6B,OAAO,IAAO,EAE1B,CAAC,EACF,CAAC,KAAUhB,iBAAiB,EAAI,CAACC,QAAQ,EACxCpB,GAAG,CAACE,UAAU,CAAC,CACdC,IAAI,CAAEH,GAAG,CAACI,UAAU,CAAC,0BAA0B,CAAC,CAChDC,IAAI,CAAE,MACP,CAAC,CAAC,CACFS,QAAQ,CAACC,iBAAiB,CAAC,CAAEgB,IAAI,CAAE,MAAO,CAAC,CAAC,CAC5CzB,SAAS,CAAC6B,OAAO,CAAA,CAAA,CAAA,CAAO,EAExB7B,SAAS,CAAC6B,OAAO,CAAA,CAAA,CAAA,CAAM,CAGxB,gBAAgB,CAACG,OAAO,EACzB,CAAC;AAEH;AACA;AACA;AACA,KACED,cAAc,CAAE,SAAA,cAAA,CAAUE,MAAM,CAAE,CAC7BjC,IAAAA,SAAS,CAAGkC,MAAM,CAAChC,QAAQ,EAAE,CAE7BiC,QAAQ,CAAGF,MAAM,CAACnB,QAAQ,CAE1BsB,iBAAiB,CAAG,EAAE,CACtBC,aAAa,CAAG,EAAE,CAClBC,YAAY,CAAG,YAAY,CAC3BC,WAAW,CAAGN,MAAM,CAACX,GAAG,CAC5Be,aAAa,CAACC,YAAY,CAAC,CAAGH,QAAQ,CAClCK,IAAAA,cAAc,CAAG,IAAS,KAAA,CAAC,MAAM,CAAE,QAAQ,CAAE,MAAM,CAAE,QAAQ,CAAC,CAE9DC,kBAAkB,CAAG,SAArBA,kBAAkB,CAAalB,IAAI,CAAE,CAAA,IAC/B,KAAA,CAAEmB,UAAU,CAAEC,oBAAoB,CACvCC,eAAe,CAAG,EAAE,CAExB,GAA2B,WAAW,EAAlC,OAAOL,WAA2B,EAAiC,CAAC,CAAC,GAA/BA,WAAW,CAACM,OAAO,CAAC,GAAG,CAAQ,CAAE,CACtEC,IAAAA,QAAQ,CAAGP,WAAW,CAACQ,KAAK,CAAC,GAAG,CAAC,CACjCC,WAAW,CAAGF,QAAQ,CAAC,CAAC,CAAC,CAE7B,IADAF,eAAe,CAAGI,WAAW,CAACD,KAAK,CAAC,GAAG,CAAC,CACnCE,KAAK,CAAG,CAAC,CAAEA,KAAK,CAAGL,eAAe,CAACM,MAAM,CAAED,KAAK,EAAE,CACtDP,UAAU,CAAGE,eAAe,CAACK,KAAK,CAAC,CACnCN,oBAAoB,CAAGD,UAAU,CAACK,KAAK,CAAC,GAAG,CAAC,CACb,MAAM,EAAjCJ,oBAAoB,CAAC,CAAC,CAAW,EAA+B,UAAU,EAArCA,oBAAoB,CAAC,CAAC,CAAe,EAC7EpB,IAAI,CAACjB,IAAI,CAAC,2BAAyB,CAAC,CAAC6C,OAAO,CAAC,OAAO,EAGvD,CAKA,GAJAjB,MAAM,CAAC,uDAAkD,CAxBvC,UAwBsD,CAAG,OAAM,CAAC,CAACkB,QAAQ,CAAC7B,IAAI,CAAC,CACjGW,MAAM,CAAC,uDAAkD,CAAGC,QAAQ,CAAG,OAAM,CAAC,CAACiB,QAAQ,CAAC7B,IAAI,CAAC,CAC7FW,MAAM,CAAC,qEAA+D,CAAC,CAACkB,QAAQ,CAAC7B,IAAI,CAAC,CAE1D,WAAW,EAAnC,OAAOe,YAA4B,CAAE,CACxC,IAAIe,KAAK,CAAG9B,IAAI,CAACjB,IAAI,CAAC,UAAS,CAAGgC,YAAY,CAAG,KAAI,CAAC,CAClC,CAAC,EAAjBe,KAAK,CAACH,MAAW,EACpBhB,MAAM,CAAC,gCAA6B,CAAGI,YAAY,CAAG,aAAW,CAAGH,QAAQ,CAAG,OAAM,CAAC,CAACiB,QAAQ,CAAC7B,IAAI,EAEtG,CACA,IAAK0B,KAAK,CAAG,CAAC,CAAEA,KAAK,CAAGL,eAAe,CAACM,MAAM,CAAED,KAAK,EAAE,CACtDP,UAAU,CAAGE,eAAe,CAACK,KAAK,CAAC,CACnCN,oBAAoB,CAAGD,UAAU,CAACK,KAAK,CAAC,GAAG,CAAC,CAEgB,IAAI,EAA/Db,MAAM,CAACoB,OAAO,CAACX,oBAAoB,CAAC,CAAC,CAAC,CAAEH,cAAc,CAAS,EACC,CAAC,EAAjEjB,IAAI,CAACjB,IAAI,CAAC,UAAS,CAAGqC,oBAAoB,CAAC,CAAC,CAAC,CAAG,KAAI,CAAC,CAACO,MAAW,EAEjEhB,MAAM,CACL,gCAA6B,CAAGS,oBAAoB,CAAC,CAAC,CAAC,CAAG,aAAW,CAAGA,oBAAoB,CAAC,CAAC,CAAC,CAAG,OAAM,CACxG,CAACS,QAAQ,CAAC7B,IAAI,EAGlB,CAAC,CACD,GAA2B,WAAW,EAAlC,OAAkC,WAAA,EAAiC,CAAC,CAAC,GAA/BgB,WAAW,CAACM,OAAO,CAAC,GAAG,CAAQ,CAIxE,IAHIC,IAAAA,QAAQ,CAAGP,WAAW,CAACQ,KAAK,CAAC,GAAG,CAAC,CACjCC,WAAW,CAAGF,QAAQ,CAAC,CAAC,CAAC,CACzBF,eAAe,CAAGI,WAAW,CAACD,KAAK,CAAC,GAAG,CAAC,CACnCE,KAAK,CAAG,CAAC,CAAEA,KAAK,CAAGL,eAAe,CAACM,MAAM,CAAED,KAAK,EAAE,CAAE,CACxDP,IAAAA,UAAU,CAAGE,eAAe,CAACK,KAAK,CAAC,CACnCN,oBAAoB,CAAGD,UAAU,CAACK,KAAK,CAAC,GAAG,CAAC,CACe,IAAI,EAA/Db,MAAM,CAACoB,OAAO,CAACX,oBAAoB,CAAC,CAAC,CAAC,CAAEH,cAAc,CAAS,GAClEH,aAAa,CAACM,oBAAoB,CAAC,CAAC,CAAC,CAAC,CAAGA,oBAAoB,CAAC,CAAC,CAAC,EAElE,CAQD,OALAP,iBAAiB,CAAQ,IAAA,CAAGC,aAAa,CACzCD,iBAAiB,CAAA,gBAAoB,CAAG,UAAY,EAAE,CACtDA,iBAAiB,CAAA,iBAAqB,CAAGK,kBAAkB,CAC3DL,iBAAiB,CAAW,OAAA,CAAA,CAAA,CAAO,CACnCmB,GAAG,CAACC,UAAU,CAACC,WAAW,CAACC,YAAY,CAlEb,gBAAgB,CAkEmBtB,iBAAiB,CAAC,CACxEpC,SAAS,CAACgC,OAAO,EACzB,CACD,CAAC,CACD;;"}