{"version":3,"file":"Edit.min.js","sources":["Edit.js"],"sourcesContent":["/* {[The file is published on the basis of YetiForce Public License 3.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */\n'use strict';\n\nVtiger_Edit_Js(\n\t'HelpDesk_Edit_Js',\n\t{},\n\t{\n\t\t/**\n\t\t * Register pre save event\n\t\t * @param {jQuery} form\n\t\t */\n\t\tregisterRecordPreSaveEventEvent: function(form) {\n\t\t\tconst self = this;\n\t\t\tlet lockSave = true;\n\t\t\tform.on(Vtiger_Edit_Js.recordPreSave, function(e, data) {\n\t\t\t\tlet closedStatus = JSON.parse(app.getMainParams('closeTicketForStatus'));\n\t\t\t\tlet status = form.find('[name=\"ticketstatus\"] :selected').val();\n\t\t\t\tlet progress = $.progressIndicator({ position: 'html', blockInfo: { enabled: true } });\n\t\t\t\tlet isClosedStatusSet = status in closedStatus;\n\t\t\t\tconst recordId = app.getRecordId();\n\t\t\t\tif (\n\t\t\t\t\t(app.getMainParams('checkIfRecordHasTimeControl') || app.getMainParams('checkIfRelatedTicketsAreClosed')) &&\n\t\t\t\t\tisClosedStatusSet &&\n\t\t\t\t\trecordId &&\n\t\t\t\t\t!data.module\n\t\t\t\t) {\n\t\t\t\t\tif (lockSave && recordId) {\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\tAppConnector.request({\n\t\t\t\t\t\t\taction: 'CheckValidateToClose',\n\t\t\t\t\t\t\tmodule: app.getModuleName(),\n\t\t\t\t\t\t\trecord: recordId,\n\t\t\t\t\t\t\tstatus: form.find('[name=\"ticketstatus\"] :selected').val()\n\t\t\t\t\t\t}).done(response => {\n\t\t\t\t\t\t\tprogress.progressIndicator({ mode: 'hide' });\n\t\t\t\t\t\t\tif (response.result.hasTimeControl.result && response.result.relatedTicketsClosed.result) {\n\t\t\t\t\t\t\t\tlockSave = false;\n\t\t\t\t\t\t\t\tform.submit();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (!response.result.hasTimeControl.result) {\n\t\t\t\t\t\t\t\tVtiger_Helper_Js.showPnotify({\n\t\t\t\t\t\t\t\t\ttext: response.result.hasTimeControl.message,\n\t\t\t\t\t\t\t\t\ttype: 'info'\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\tself.addTimeControl({\n\t\t\t\t\t\t\t\t\trecordId: recordId,\n\t\t\t\t\t\t\t\t\turl: `index.php?module=OSSTimeControl&view=Edit&sourceModule=HelpDesk&sourceRecord=${recordId}&relationOperation=true&subprocess=${recordId}&subprocess=${recordId}`\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (!response.result.relatedTicketsClosed.result) {\n\t\t\t\t\t\t\t\tVtiger_Helper_Js.showPnotify({\n\t\t\t\t\t\t\t\t\ttext: response.result.relatedTicketsClosed.message,\n\t\t\t\t\t\t\t\t\ttype: 'info'\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (isClosedStatusSet && (!recordId || data.module)) {\n\t\t\t\t\tVtiger_Helper_Js.showPnotify({\n\t\t\t\t\t\ttext: app.vtranslate('JS_CANT_CLOSE_NEW_RECROD'),\n\t\t\t\t\t\ttype: 'info'\n\t\t\t\t\t});\n\t\t\t\t\tprogress.progressIndicator({ mode: 'hide' });\n\t\t\t\t\te.preventDefault();\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\t/**\n\t\t * Add time control when closed ticket\n\t\t * @param {array} params\n\t\t */\n\t\taddTimeControl: function(params) {\n\t\t\tlet aDeferred = jQuery.Deferred();\n\t\t\tlet referenceModuleName = 'OSSTimeControl';\n\t\t\tlet parentId = params.recordId;\n\t\t\tlet parentModule = 'HelpDesk';\n\t\t\tlet quickCreateParams = {};\n\t\t\tlet relatedParams = {};\n\t\t\tlet relatedField = 'subprocess';\n\t\t\tlet fullFormUrl = params.url;\n\t\t\trelatedParams[relatedField] = parentId;\n\t\t\tlet eliminatedKeys = new Array('view', 'module', 'mode', 'action');\n\n\t\t\tlet preQuickCreateSave = function(data) {\n\t\t\t\tlet index, queryParam, queryParamComponents;\n\t\t\t\tlet queryParameters = [];\n\n\t\t\t\tif (typeof fullFormUrl !== 'undefined' && fullFormUrl.indexOf('?') !== -1) {\n\t\t\t\t\tlet urlSplit = fullFormUrl.split('?');\n\t\t\t\t\tlet queryString = urlSplit[1];\n\t\t\t\t\tqueryParameters = queryString.split('&');\n\t\t\t\t\tfor (index = 0; index < queryParameters.length; index++) {\n\t\t\t\t\t\tqueryParam = queryParameters[index];\n\t\t\t\t\t\tqueryParamComponents = queryParam.split('=');\n\t\t\t\t\t\tif (queryParamComponents[0] == 'mode' && queryParamComponents[1] == 'Calendar') {\n\t\t\t\t\t\t\tdata.find('a[data-tab-name=\"Task\"]').trigger('click');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tjQuery('<input type=\"hidden\" name=\"sourceModule\" value=\"' + parentModule + '\" />').appendTo(data);\n\t\t\t\tjQuery('<input type=\"hidden\" name=\"sourceRecord\" value=\"' + parentId + '\" />').appendTo(data);\n\t\t\t\tjQuery('<input type=\"hidden\" name=\"relationOperation\" value=\"true\" />').appendTo(data);\n\n\t\t\t\tif (typeof relatedField !== 'undefined') {\n\t\t\t\t\tlet field = data.find('[name=\"' + relatedField + '\"]');\n\t\t\t\t\tif (field.length == 0) {\n\t\t\t\t\t\tjQuery('<input type=\"hidden\" name=\"' + relatedField + '\" value=\"' + parentId + '\" />').appendTo(data);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tfor (index = 0; index < queryParameters.length; index++) {\n\t\t\t\t\tqueryParam = queryParameters[index];\n\t\t\t\t\tqueryParamComponents = queryParam.split('=');\n\t\t\t\t\tif (\n\t\t\t\t\t\tjQuery.inArray(queryParamComponents[0], eliminatedKeys) == '-1' &&\n\t\t\t\t\t\tdata.find('[name=\"' + queryParamComponents[0] + '\"]').length == 0\n\t\t\t\t\t) {\n\t\t\t\t\t\tjQuery(\n\t\t\t\t\t\t\t'<input type=\"hidden\" name=\"' + queryParamComponents[0] + '\" value=\"' + queryParamComponents[1] + '\" />'\n\t\t\t\t\t\t).appendTo(data);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t\tif (typeof fullFormUrl !== 'undefined' && fullFormUrl.indexOf('?') !== -1) {\n\t\t\t\tlet urlSplit = fullFormUrl.split('?');\n\t\t\t\tlet queryString = urlSplit[1];\n\t\t\t\tlet queryParameters = queryString.split('&');\n\t\t\t\tfor (let index = 0; index < queryParameters.length; index++) {\n\t\t\t\t\tlet queryParam = queryParameters[index];\n\t\t\t\t\tlet queryParamComponents = queryParam.split('=');\n\t\t\t\t\tif (jQuery.inArray(queryParamComponents[0], eliminatedKeys) == '-1') {\n\t\t\t\t\t\trelatedParams[queryParamComponents[0]] = queryParamComponents[1];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tquickCreateParams['data'] = relatedParams;\n\t\t\tquickCreateParams['callbackFunction'] = function() {};\n\t\t\tquickCreateParams['callbackPostShown'] = preQuickCreateSave;\n\t\t\tquickCreateParams['noCache'] = true;\n\t\t\tVtiger_Header_Js.getInstance().quickCreateModule(referenceModuleName, quickCreateParams);\n\t\t\treturn aDeferred.promise();\n\t\t}\n\t}\n);\n"],"names":["Vtiger_Edit_Js","form","self","this","lockSave","on","recordPreSave","e","data","closedStatus","JSON","parse","app","getMainParams","status","find","val","progress","$","progressIndicator","position","blockInfo","enabled","isClosedStatusSet","recordId","getRecordId","module","preventDefault","request","getModuleName","done","mode","response","result","hasTimeControl","relatedTicketsClosed","submit","showPnotify","message","addTimeControl","vtranslate","params","aDeferred","jQuery","Deferred","parentId","quickCreateParams","relatedParams","fullFormUrl","url","eliminatedKeys","Array","indexOf","queryParameters","split","index","length","queryParamComponents","inArray","trigger","appendTo","getInstance","quickCreateModule","promise"],"mappings":"aAGAA,eACC,mBACA,GACA,iCAKkC,SAASC,UACnCC,KAAOC,KACTC,UAAW,OACVC,GAAGL,eAAeM,eAAe,SAASC,EAAGC,UAC7CC,aAAeC,KAAKC,MAAMC,IAAIC,cAAc,yBAC5CC,OAASb,KAAKc,KAAK,mCAAmCC,MACtDC,SAAWC,EAAEC,kBAAkB,CAAEC,SAAU,OAAQC,UAAW,CAAEC,SAAS,KACzEC,kBAAoBT,UAAUL,aAC5Be,SAAWZ,IAAIa,eAEnBb,IAAIC,cAAc,gCAAkCD,IAAIC,cAAc,oCACvEU,mBACAC,WACChB,KAAKkB,QAEFtB,UAAYoB,aACbG,8BACWC,QAAQ,QACZ,8BACAhB,IAAIiB,uBACJL,gBACAvB,KAAKc,KAAK,mCAAmCC,QACnDc,MAAK,4BACEX,kBAAkB,CAAEY,KAAM,SAC/BC,SAASC,OAAOC,eAAeD,QAAUD,SAASC,OAAOE,qBAAqBF,mBACtE,OACNG,UAEDJ,SAASC,OAAOC,eAAeD,0BAClBI,YAAY,MACtBL,SAASC,OAAOC,eAAeI,aAC/B,cAEFC,eAAe,UACTf,6FAC2EA,+CAA8CA,wBAAuBA,YAGvJQ,SAASC,OAAOE,qBAAqBF,yBACxBI,YAAY,MACtBL,SAASC,OAAOE,qBAAqBG,aACrC,cAMPf,mBAAuBC,WAAYhB,KAAKkB,0BAC1BW,YAAY,MACtBzB,IAAI4B,WAAW,iCACf,kBAEErB,kBAAkB,CAAEY,KAAM,WACjCJ,qCAQW,SAASc,YACpBC,UAAYC,OAAOC,WAEnBC,SAAWJ,OAAOjB,SAElBsB,kBAAoB,GACpBC,cAAgB,GAEhBC,YAAcP,OAAOQ,kBACzB,WAA8BJ,aAC1BK,eAAiB,IAAIC,MAAM,OAAQ,SAAU,OAAQ,kBAyC9B,IAAhBH,cAA6D,IAA9BA,YAAYI,QAAQ,aAGzDC,gBAFWL,YAAYM,MAAM,KACN,GACOA,MAAM,KAC/BC,MAAQ,EAAGA,MAAQF,gBAAgBG,OAAQD,QAAS,KAExDE,qBADaJ,gBAAgBE,OACKD,MAAM,KACmB,MAA3DX,OAAOe,QAAQD,qBAAqB,GAAIP,gCAC7BO,qBAAqB,IAAMA,qBAAqB,6BAKjE,KAA4BV,gCAC5B,iBAAwC,+BACxC,kBAtDyB,SAASvC,UAC7B+C,aAAmBE,4BACnBJ,gBAAkB,WAEK,IAAhBL,cAA6D,IAA9BA,YAAYI,QAAQ,yBAC9CJ,YAAYM,MAAM,KACN,GACGA,MAAM,KAC/BC,MAAQ,EAAGA,MAAQF,gBAAgBG,OAAQD,QAGhB,8BAFlBF,gBAAgBE,OACKD,MAAM,MACf,IAA2C,YAA3BG,qBAAqB,SACxD1C,KAAK,2BAA2B4C,QAAQ,oBAIzC,gEAA4EC,SAASpD,aACrF,mDAAqDqC,SAAW,QAAQe,SAASpD,aACjF,iEAAiEoD,SAASpD,MAI5D,GADRA,KAAKO,KAAK,uBACZyC,eACF,iDAA6DX,SAAW,QAAQe,SAASpD,MAG7F+C,MAAQ,EAAGA,MAAQF,gBAAgBG,OAAQD,6BAClCF,gBAAgBE,OACKD,MAAM,KAEoB,MAA3DX,OAAOe,QAAQD,qBAAqB,GAAIP,iBACwB,GAAhE1C,KAAKO,KAAK,UAAY0C,qBAAqB,GAAK,MAAMD,eAGrD,8BAAgCC,qBAAqB,GAAK,YAAcA,qBAAqB,GAAK,QACjGG,SAASpD,yBAoBd,SAA+B,mBACdqD,cAAcC,kBAlEL,iBAkE4ChB,mBAC/DJ,UAAUqB"}