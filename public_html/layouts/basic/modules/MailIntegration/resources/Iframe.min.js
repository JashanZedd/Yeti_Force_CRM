"use strict";var MailIntegration_Iframe={mailId:0,container:{},iframe:{},iframeWindow:{},moduleSelect:{},addRecordBtn:{},loaderParams:{blockInfo:{enabled:!0},message:!1},connector:function(request){var _this=this;return AppConnector.request(request).fail((function(error){_this.hideIframeLoader(),_this.showResponseMessage(!1)}))},showResponseMessage:function(success){var message=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";success?this.mailItem.notificationMessages.replaceAsync("information",{type:"informationalMessage",message:message,icon:"iconid",persistent:!1}):this.mailItem.notificationMessages.replaceAsync("error",{type:"errorMessage",message:app.vtranslate("JS_ERROR")+" "+message})},registerListItemEvents:function(){this.container.on("click",".js-list-item-click",this.onClickListItem.bind(this)),$(document).on("click",".popover a",this.onClickLink.bind(this)),this.container.on("click",".js-add-related-record",this.onClickQuickCreateBtn.bind(this)),this.container.on("click",".js-remove-record",this.onClickDeleteRelation.bind(this))},onClickListItem:function(event){var currentTarget=$(event.currentTarget);this.toggleActiveListItems(currentTarget),this.onClickLink(event,currentTarget.find(".js-record-link").attr("href"))},onClickLink:function(event,url){event.preventDefault(),url||(url=$(event.currentTarget).attr("href")),this.changeIframeSource(url)},onClickDeleteRelation:function(event){var _this2=this;event.stopPropagation();var recordData=$(event.currentTarget).closest(".js-list-item-click").data();this.connector({module:"MailIntegration",action:"Mail",mode:"deleteRelation",mailId:this.mailId,record:recordData.id,recordModule:recordData.module}).done((function(response){_this2.showResponseMessage(response.success,app.vtranslate("JS_REMOVED_RELATION_SUCCESSFULLY")),_this2.reloadView(response.success)}))},onClickQuickCreateBtn:function(event){var _this3=this;event.stopPropagation();var recordData=$(event.currentTarget).closest(".js-list-item-click").data(),newRecordData={sourceModule:recordData.module,sourceRecord:recordData.id};this.showQuickCreateForm(event.currentTarget.dataset.module,{data:newRecordData,callbackFunction:function(){_this3.iframeWindow.location.reload()}})},fillNewRecordData:function(moduleName){var _this4=this,data={email:this.mailItem.from.emailAddress,email1:this.mailItem.from.emailAddress,relationOperation:!0,relatedRecords:$.map(this.container.find(".js-list-item-click"),(function(record){return{module:record.dataset.module,id:record.dataset.id}}))},fillNameFields=function(){var nameData=_this4.mailItem.from.displayName.split(" "),firstName=nameData.shift(),lastName=nameData.join(" ");data.firstname=firstName,data.lastname=lastName};switch(moduleName){case"Leads":data.company=this.mailItem.from.displayName,fillNameFields();break;case"Contacts":fillNameFields();break;case"Project":data.projectname=this.mailItem.subject;break;case"HelpDesk":data.ticket_title=this.mailItem.subject;break;case"Products":data.productname=this.mailItem.subject;break;case"Services":data.servicename=this.mailItem.subject}return this.asyncGetMailBody((function(body){return data.description=body,data}))},toggleActiveListItems:function(targetListItem){targetListItem.siblings().removeClass("active"),targetListItem.addClass("active")},changeIframeSource:function(url){this.iframe.attr("src",url),this.showIframeLoader()},addRelation:function(recordId,moduleName){var _this5=this;this.connector({module:"MailIntegration",action:"Mail",mode:"addRelation",mailId:this.mailId,record:recordId,recordModule:moduleName}).done((function(response){_this5.showResponseMessage(response.success,app.vtranslate("JS_ADDED_RELATION_SUCCESSFULLY")),_this5.reloadView(response.success)}))},showQuickCreateForm:function(moduleName){var quickCreateParams=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};quickCreateParams=Object.assign({noCache:!0,data:{}},quickCreateParams),this.fillNewRecordData(moduleName).then((function(data){quickCreateParams.data=Object.assign(data,quickCreateParams.data),App.Components.QuickCreate.createRecord(moduleName,quickCreateParams)}))},registerIframeEvents:function(){var _this6=this,link=this.container.find(".js-list-item-click").first();this.initIframeLoader(),link.length?(link.addClass("active"),this.iframe.attr("src",link.find(".js-record-link").attr("href")),this.iframe.on("load",(function(){_this6.hideIframeLoader()}))):this.hideIframeLoader()},registerImportClick:function(){var _this7=this;this.container.on("click",".js-import-mail",(function(e){_this7.showIframeLoader(),_this7.getMailDetails().then((function(mails){_this7.connector(Object.assign({module:"MailIntegration",action:"Import"},mails,window.PanelParams)).done((function(response){_this7.hideIframeLoader(),_this7.showResponseMessage(response.success,app.vtranslate("JS_IMPORT")),_this7.reloadView(response.success)}))}))}))},getMailDetails:function(){var mailItem=this.mailItem;if(mailItem.attachments.length>0)for(var i=0;i<mailItem.attachments.length;i++){var attachment=mailItem.attachments[i];"<BR>"+i+". Name: ",attachment.name,"<BR>ID: "+attachment.id,"<BR>contentType: "+attachment.contentType,"<BR>size: "+attachment.size,"<BR>attachmentType: "+attachment.attachmentType,"<BR>isInline: "+attachment.isInline}var mailDetails={mailFrom:this.parseEmailAddressDetails(mailItem.from),mailSender:mailItem.sender.emailAddress,mailTo:this.parseEmailAddressDetails(mailItem.to),mailCc:this.parseEmailAddressDetails(mailItem.cc),mailMessageId:mailItem.internetMessageId,mailSubject:mailItem.subject,mailNormalizedSubject:mailItem.normalizedSubject,mailDateTimeCreated:mailItem.dateTimeCreated.toISOString()};return this.asyncGetMailBody((function(body){return mailDetails.mailBody=body,mailDetails}))},asyncGetMailBody:function(callback){var _this8=this;return new Promise((function(resolve,reject){_this8.mailItem.body.getAsync(Office.CoercionType.Html,(function(body){"succeeded"===body.status?resolve(callback(body.value)):reject(body)}))}))},parseEmailAddressDetails:function(data){var fn=function(row){return row.emailAddress};if($.isArray(data)){var rows=[];return $.each(data,(function(index,value){rows[index]=fn(value)})),rows}return fn(data)},setIframeHeight:function(){this.iframe.height($(window).height()-this.iframe.offset().top)},showIframeLoader:function(){this.iframeLoader.progressIndicator(this.loaderParams)},hideIframeLoader:function(){this.iframeLoader.progressIndicator({mode:"hide"})},initIframeLoader:function(){this.iframeLoader=$.progressIndicator(this.loaderParams)},registerModulesSelect:function(){var _this9=this;this.moduleSelect=App.Fields.Picklist.showSelect2ElementView(this.container.find(".js-modules")),this.moduleSelect.on("change",this.registerModulesSelectChange.bind(this)),this.container.find(".js-select-record").on("click",(function(e){var params={module:_this9.moduleSelect[0].value,src_module:"OSSMailView"};app.showRecordsList(params,(function(modal,instance){instance.setSelectEvent((function(responseData,e){_this9.addRelation(responseData.id,params.module)}))}))}))},registerModulesSelectChange:function(){this.moduleSelect.select2("data")[0].element.dataset.addRecord?this.addRecordBtn.removeClass("d-none"):this.addRecordBtn.addClass("d-none")},registerAddRecord:function(){var _this10=this;this.addRecordBtn.on("click",(function(e){var moduleName=_this10.moduleSelect[0].value,quickCreateParams={callbackFunction:function(_ref){var result=_ref.result;_this10.addRelation(result._recordId,moduleName)}};_this10.showQuickCreateForm(moduleName,quickCreateParams)}))},reloadView:function(condition){condition&&window.location.reload()},registerEvents:function(){this.container=$("#page"),this.iframe=$("#js-iframe"),this.iframeWindow=this.iframe[0].contentWindow,this.addRecordBtn=this.container.find(".js-add-record"),this.mailId=this.container.find(".js-iframe-container").data("mailId"),this.mailItem=Office.context.mailbox.item,this.iframe.length&&(this.registerListItemEvents(),this.registerIframeEvents(),this.setIframeHeight(),this.mailId?(this.registerModulesSelect(),this.registerAddRecord()):this.registerImportClick())}};$,MailIntegration_Iframe.registerEvents();
//# sourceMappingURL=Iframe.min.js.map
