{"version":3,"file":"CustomView.min.js","sources":["CustomView.js"],"sourcesContent":["/*+***********************************************************************************\n * The contents of this file are subject to the vtiger CRM Public License Version 1.0\n * (\"License\"); You may not use this file except in compliance with the License\n * The Original Code is:  vtiger CRM Open Source\n * The Initial Developer of the Original Code is vtiger.\n * Portions created by vtiger are Copyright (C) vtiger.\n * All Rights Reserved.\n * Contributor(s): YetiForce.com\n *************************************************************************************/\n'use strict';\n\nclass CustomView {\n\tconstructor(url) {\n\t\tlet progressIndicatorElement = $.progressIndicator();\n\t\tapp.showModalWindow(null, url, () => {\n\t\t\tthis.contentsCotainer = $('.js-filter-modal__container');\n\t\t\tthis.advanceFilterInstance = new Vtiger_ConditionBuilder_Js(\n\t\t\t\tthis.contentsCotainer.find('.js-condition-builder'),\n\t\t\t\tthis.contentsCotainer.find('#sourceModule').val()\n\t\t\t);\n\t\t\tthis.advanceFilterInstance.registerEvents();\n\t\t\t//This will store the columns selection container\n\t\t\tthis.columnSelectElement = false;\n\t\t\tthis.registerEvents();\n\t\t\tprogressIndicatorElement.progressIndicator({ mode: 'hide' });\n\t\t});\n\t}\n\n\tloadDateFilterValues() {\n\t\tlet selectedDateFilter = $('#standardDateFilter option:selected');\n\t\tlet currentDate = selectedDateFilter.data('currentdate');\n\t\tlet endDate = selectedDateFilter.data('enddate');\n\t\t$('#standardFilterCurrentDate').val(currentDate);\n\t\t$('#standardFilterEndDate').val(endDate);\n\t}\n\n\t/**\n\t * Function to get the contents container\n\t * @return : jQuery object of contents container\n\t */\n\tgetContentsContainer() {\n\t\tif (this.contentsCotainer == false) {\n\t\t\tthis.contentsCotainer = $('.js-filter-modal__container');\n\t\t}\n\t\treturn this.contentsCotainer;\n\t}\n\n\t/**\n\t * Function to get the view columns selection element\n\t * @return : jQuery object of view columns selection element\n\t */\n\tgetColumnSelectElement() {\n\t\tif (this.columnSelectElement == false) {\n\t\t\tthis.columnSelectElement = $('#viewColumnsSelect');\n\t\t}\n\t\treturn this.columnSelectElement;\n\t}\n\n\t/**\n\t * Function which will get the selected columns\n\t * @return : array of selected values\n\t */\n\tgetSelectedColumns() {\n\t\tlet columnListSelectElement = this.getColumnSelectElement();\n\t\treturn columnListSelectElement.val();\n\t}\n\n\tsaveFilter() {\n\t\tlet aDeferred = $.Deferred();\n\t\tlet formData = $('#CustomView').serializeFormData();\n\t\tAppConnector.request(formData, true)\n\t\t\t.done(function(data) {\n\t\t\t\taDeferred.resolve(data);\n\t\t\t})\n\t\t\t.fail(function(error) {\n\t\t\t\taDeferred.reject(error);\n\t\t\t});\n\t\treturn aDeferred.promise();\n\t}\n\n\tsaveAndViewFilter() {\n\t\tthis.saveFilter().done(function(data) {\n\t\t\tlet response = data.result;\n\t\t\tif (response && response.success) {\n\t\t\t\tlet url;\n\t\t\t\tif (app.getParentModuleName() == 'Settings') {\n\t\t\t\t\turl = 'index.php?module=CustomView&parent=Settings&view=Index&sourceModule=' + $('#sourceModule').val();\n\t\t\t\t} else {\n\t\t\t\t\turl = response.listviewurl;\n\t\t\t\t}\n\t\t\t\twindow.location.href = url;\n\t\t\t} else {\n\t\t\t\t$.unblockUI();\n\t\t\t\tVtiger_Helper_Js.showPnotify({\n\t\t\t\t\ttitle: app.vtranslate('JS_DUPLICATE_RECORD'),\n\t\t\t\t\ttext: response.message\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\tregisterIconEvents() {\n\t\tthis.getContentsContainer()\n\t\t\t.find('.js-filter-preferences')\n\t\t\t.on('change', '.js-filter-preference', e => {\n\t\t\t\tlet currentTarget = $(e.currentTarget);\n\t\t\t\tlet iconElement = currentTarget.next();\n\t\t\t\tif (currentTarget.prop('checked')) {\n\t\t\t\t\ticonElement.removeClass(iconElement.data('unchecked')).addClass(iconElement.data('check'));\n\t\t\t\t} else {\n\t\t\t\t\ticonElement.removeClass(iconElement.data('check')).addClass(iconElement.data('unchecked'));\n\t\t\t\t}\n\t\t\t});\n\t}\n\n\tregisterBlockToggleEvent() {\n\t\tconst container = this.getContentsContainer();\n\t\tcontainer.on('click', '.blockHeader', function(e) {\n\t\t\tconst target = $(e.target);\n\t\t\tif (\n\t\t\t\ttarget.is('input') ||\n\t\t\t\ttarget.is('button') ||\n\t\t\t\ttarget.parents().is('button') ||\n\t\t\t\ttarget.hasClass('js-stop-propagation') ||\n\t\t\t\ttarget.parents().hasClass('js-stop-propagation')\n\t\t\t) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tconst blockHeader = $(e.currentTarget);\n\t\t\tconst blockContents = blockHeader.next();\n\t\t\tconst iconToggle = blockHeader.find('.iconToggle');\n\t\t\tif (blockContents.hasClass('d-none')) {\n\t\t\t\tblockContents.removeClass('d-none');\n\t\t\t\ticonToggle.removeClass(iconToggle.data('hide')).addClass(iconToggle.data('show'));\n\t\t\t} else {\n\t\t\t\tblockContents.addClass('d-none');\n\t\t\t\ticonToggle.removeClass(iconToggle.data('show')).addClass(iconToggle.data('hide'));\n\t\t\t}\n\t\t});\n\t}\n\n\tregisterColorEvent() {\n\t\tconst container = this.getContentsContainer();\n\t\tlet picker = container.find('.js-color-picker');\n\t\tlet pickerField = picker.find('.js-color-picker__field');\n\t\tlet showPicker = () => {\n\t\t\tApp.Fields.Colors.showPicker({\n\t\t\t\tcolor: pickerField.val(),\n\t\t\t\tbgToUpdate: picker.find('.js-color-picker__color'),\n\t\t\t\tfieldToUpdate: pickerField\n\t\t\t});\n\t\t};\n\t\tpicker.on('click', showPicker);\n\t}\n\n\t/**\n\t * Get list of fields to duplicates\n\t * @returns {Array}\n\t */\n\tgetDuplicateFields() {\n\t\tlet fields = [];\n\t\tconst container = this.getContentsContainer();\n\t\tcontainer.find('.js-duplicates-container .js-duplicates-row').each(function() {\n\t\t\tfields.push({\n\t\t\t\tfieldid: $(this)\n\t\t\t\t\t.find('.js-duplicates-field')\n\t\t\t\t\t.val(),\n\t\t\t\tignore: $(this)\n\t\t\t\t\t.find('.js-duplicates-ignore')\n\t\t\t\t\t.is(':checked')\n\t\t\t});\n\t\t});\n\t\treturn fields;\n\t}\n\t/**\n\t * Register events for block \"Find duplicates\"\n\t */\n\tregisterDuplicatesEvents() {\n\t\tconst container = this.getContentsContainer();\n\t\tApp.Fields.Picklist.showSelect2ElementView(container.find('.js-duplicates-container .js-duplicates-field'));\n\t\tcontainer.on('click', '.js-duplicates-remove', function(e) {\n\t\t\t$(this)\n\t\t\t\t.closest('.js-duplicates-row')\n\t\t\t\t.remove();\n\t\t});\n\t\tcontainer.find('.js-duplicate-add-field').on('click', function() {\n\t\t\tlet template = container.find('.js-duplicates-field-template').clone();\n\t\t\ttemplate.removeClass('d-none');\n\t\t\ttemplate.removeClass('js-duplicates-field-template');\n\t\t\tApp.Fields.Picklist.showSelect2ElementView(template.find('.js-duplicates-field'));\n\t\t\tcontainer.find('.js-duplicates-container').append(template);\n\t\t});\n\t}\n\tregisterSubmitEvent(select2Element) {\n\t\t$('#CustomView').on('submit', e => {\n\t\t\tlet selectElement = this.getColumnSelectElement();\n\t\t\tif ($('#viewname').val().length > 100) {\n\t\t\t\tVtiger_Helper_Js.showPnotify({\n\t\t\t\t\ttitle: app.vtranslate('JS_MESSAGE'),\n\t\t\t\t\ttext: app.vtranslate('JS_VIEWNAME_ALERT')\n\t\t\t\t});\n\t\t\t\te.preventDefault();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t//Mandatory Fields selection validation\n\t\t\t//Any one Mandatory Field should select while creating custom view.\n\t\t\tlet mandatoryFieldsList = JSON.parse($('#mandatoryFieldsList').val());\n\t\t\tlet selectedOptions = selectElement.val();\n\t\t\tlet mandatoryFieldsMissing = true;\n\t\t\tif (selectedOptions) {\n\t\t\t\tfor (let i = 0; i < selectedOptions.length; i++) {\n\t\t\t\t\tif ($.inArray(selectedOptions[i], mandatoryFieldsList) >= 0) {\n\t\t\t\t\t\tmandatoryFieldsMissing = false;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (mandatoryFieldsMissing) {\n\t\t\t\tselectElement.validationEngine(\n\t\t\t\t\t'showPrompt',\n\t\t\t\t\tapp.vtranslate('JS_PLEASE_SELECT_ATLEAST_ONE_MANDATORY_FIELD'),\n\t\t\t\t\t'error',\n\t\t\t\t\t'topLeft',\n\t\t\t\t\ttrue\n\t\t\t\t);\n\t\t\t\te.preventDefault();\n\t\t\t\treturn;\n\t\t\t} else {\n\t\t\t\tselect2Element.validationEngine('hide');\n\t\t\t}\n\t\t\t//Mandatory Fields validation ends\n\t\t\tlet result = $(e.currentTarget).validationEngine('validate');\n\t\t\tif (result == true) {\n\t\t\t\t//handled standard filters saved values.\n\t\t\t\tlet stdfilterlist = {};\n\n\t\t\t\tif (\n\t\t\t\t\t$('#standardFilterCurrentDate').val() != '' &&\n\t\t\t\t\t$('#standardFilterEndDate').val() != '' &&\n\t\t\t\t\t$('select.standardFilterColumn option:selected').val() != 'none'\n\t\t\t\t) {\n\t\t\t\t\tstdfilterlist['columnname'] = $('select.standardFilterColumn option:selected').val();\n\t\t\t\t\tstdfilterlist['stdfilter'] = $('select#standardDateFilter option:selected').val();\n\t\t\t\t\tstdfilterlist['startdate'] = $('#standardFilterCurrentDate').val();\n\t\t\t\t\tstdfilterlist['enddate'] = $('#standardFilterEndDate').val();\n\t\t\t\t\t$('#stdfilterlist').val(JSON.stringify(stdfilterlist));\n\t\t\t\t}\n\t\t\t\t//handled advanced filters saved values.\n\t\t\t\tlet advfilterlist = this.advanceFilterInstance.getConditions();\n\t\t\t\t$('#advfilterlist').val(JSON.stringify(advfilterlist));\n\t\t\t\t$('[name=\"duplicatefields\"]').val(JSON.stringify(this.getDuplicateFields()));\n\t\t\t\t$('input[name=\"columnslist\"]', this.getContentsContainer()).val(\n\t\t\t\t\tJSON.stringify(this.getSelectedColumns())\n\t\t\t\t);\n\t\t\t\tthis.saveAndViewFilter();\n\t\t\t\treturn false;\n\t\t\t} else {\n\t\t\t\tapp.formAlignmentAfterValidation($(e.currentTarget));\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Block submit on press enter key\n\t */\n\tregisterDisableSubmitOnEnter() {\n\t\tthis.getContentsContainer()\n\t\t\t.find('#viewname, [name=\"color\"]')\n\t\t\t.keydown(function(e) {\n\t\t\t\tif (e.keyCode === 13) {\n\t\t\t\t\te.preventDefault();\n\t\t\t\t}\n\t\t\t});\n\t}\n\n\tregisterEvents() {\n\t\tthis.registerIconEvents();\n\t\tnew App.Fields.Text.Editor(this.getContentsContainer().find('.js-editor'));\n\t\tthis.registerBlockToggleEvent();\n\t\tthis.registerColorEvent();\n\t\tthis.registerDuplicatesEvents();\n\t\tlet select2Element = App.Fields.Picklist.showSelect2ElementView(this.getColumnSelectElement());\n\t\tthis.registerSubmitEvent(select2Element);\n\t\t$('.stndrdFilterDateSelect').datepicker();\n\t\t$('#standardDateFilter').on('change', () => {\n\t\t\tthis.loadDateFilterValues();\n\t\t});\n\t\t$('#CustomView').validationEngine(app.validationEngineOptions);\n\t\tthis.registerDisableSubmitOnEnter();\n\t}\n}\n"],"names":["CustomView","url","progressIndicatorElement","$","progressIndicator","showModalWindow","contentsCotainer","advanceFilterInstance","Vtiger_ConditionBuilder_Js","_this","find","val","registerEvents","columnSelectElement","mode","selectedDateFilter","currentDate","data","endDate","this","getColumnSelectElement","aDeferred","Deferred","formData","serializeFormData","request","done","resolve","fail","error","reject","promise","saveFilter","response","result","success","app","getParentModuleName","listviewurl","location","href","unblockUI","showPnotify","vtranslate","message","getContentsContainer","on","currentTarget","e","iconElement","next","prop","removeClass","addClass","target","is","parents","hasClass","blockHeader","blockContents","iconToggle","picker","pickerField","Fields","Colors","showPicker","fields","each","push","container","Picklist","showSelect2ElementView","closest","remove","template","clone","append","select2Element","selectElement","_this2","length","preventDefault","mandatoryFieldsList","JSON","parse","selectedOptions","mandatoryFieldsMissing","i","inArray","validationEngine","stdfilterlist","stringify","advfilterlist","getConditions","getDuplicateFields","getSelectedColumns","saveAndViewFilter","formAlignmentAfterValidation","keydown","keyCode","registerIconEvents","App","Text","Editor","registerBlockToggleEvent","registerColorEvent","registerDuplicatesEvents","registerSubmitEvent","datepicker","loadDateFilterValues","validationEngineOptions","registerDisableSubmitOnEnter"],"mappings":"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"}