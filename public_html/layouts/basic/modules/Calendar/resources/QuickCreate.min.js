"use strict";var classCallCheck=function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")},createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),inherits=function(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)},possibleConstructorReturn=function(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call};window.Calendar_CalendarModal_Js=function(_Calendar_CalendarExt){function _class(container,readonly){classCallCheck(this,_class);var _this=possibleConstructorReturn(this,(_class.__proto__||Object.getPrototypeOf(_class)).call(this,container,readonly));return _this.isSwitchAllDays=!1,_this.sidebarName="add",_this.eventCreate=!0,_this.module="Calendar",_this.renderCalendar(),_this.registerEvents(),_this}return inherits(_class,_Calendar_CalendarExt),createClass(_class,[{key:"setCalendarModuleOptions",value:function(){return{hiddenDays:app.getMainParams("hiddenDays",!0)}}},{key:"registerEvents",value:function(){this.registerSwitchEvents(),this.registerUsersChange(),this.registerAutofillTime(),this.registerPopoverButtonsClickEvent()}},{key:"registerSwitchEvents",value:function(){var _this2=this;if(!1!==app.getMainParams("hiddenDays",!0)){var calendarview=this.getCalendarView(),switchContainer=$('<div class="js-calendar-switch-container"></div>').insertAfter(calendarview.find(".fc-center"));$(this.switchTpl(app.vtranslate("JS_WORK_DAYS"),app.vtranslate("JS_ALL"),this.isSwitchAllDays)).prependTo(switchContainer).on("change","input",(function(e){var hiddenDays=[];void 0!==$(e.currentTarget).data("on-text")?(hiddenDays=app.getMainParams("hiddenDays",!0),_this2.isSwitchAllDays=!1):_this2.isSwitchAllDays=!0,_this2.getCalendarView().fullCalendar("option","hiddenDays",hiddenDays),"year"===_this2.getCalendarView().fullCalendar("getView").type&&_this2.registerViewRenderEvents(_this2.getCalendarView().fullCalendar("getView")),_this2.registerSwitchEvents()}))}}},{key:"registerUsersChange",value:function(){var _this3=this;this.container.find(".assigned_user_id").on("change",(function(){_this3.getCalendarView().fullCalendar("getCalendar").view.options.loadView()}))}},{key:"getSelectedUsersCalendar",value:function(){return this.container.find(".assigned_user_id").val()}},{key:"selectDays",value:function(startDate,endDate){var _this4=this;if("status"===this.sidebarName)return this.sidebarName="add",void this.getCalendarCreateView().done((function(){_this4.selectDays(startDate,endDate)}));var startHour=app.getMainParams("startHour"),endHour=app.getMainParams("endHour"),view=this.getCalendarView().fullCalendar("getView");if(0==endDate.hasTime()&&endDate.add(-1,"days"),startDate=startDate.format(),endDate=endDate.format(),""==startHour&&(startHour="00"),""==endHour&&(endHour="00"),"agendaDay"!=view.name&&"agendaWeek"!=view.name&&(startDate=startDate+"T"+startHour+":00")==(endDate=endDate+"T"+endHour+":00")){var activityType=this.container.find('[name="activitytype"]').val(),activityDurations=JSON.parse(this.container.find('[name="defaultOtherEventDuration"]').val()),minutes=0;for(var i in activityDurations)if(activityDurations[i].activitytype===activityType){minutes=parseInt(activityDurations[i].duration);break}endDate=moment(endDate).add(minutes,"minutes").toISOString()}var dateFormat=this.container.find('[name="date_start"]').data("dateFormat").toUpperCase(),defaultTimeFormat="";(defaultTimeFormat=24==this.container.find('[name="time_start"]').data("format")?"HH:mm":"hh:mm A",this.container.find('[name="date_start"]').val(moment(startDate).format(dateFormat)),this.container.find('[name="due_date"]').val(moment(endDate).format(dateFormat)),!0===this.container.find(".js-autofill").prop("checked"))?(new Calendar_Edit_Js).getFreeTime(this.container):(this.container.find('[name="time_start"]').val(moment(startDate).format(defaultTimeFormat)),this.container.find('[name="time_end"]').val(moment(endDate).format(defaultTimeFormat)))}},{key:"registerEditForm",value:function(sideBar){var _this5=this,editViewInstance=Vtiger_Edit_Js.getInstanceByModuleName(sideBar.find('[name="module"]').val()),headerInstance=new Vtiger_Header_Js,rightFormCreate=sideBar.find('form[name="QuickCreate"]');editViewInstance.registerBasicEvents(rightFormCreate),rightFormCreate.validationEngine(app.validationEngineOptions),headerInstance.registerHelpInfo(rightFormCreate),App.Fields.Picklist.showSelect2ElementView(sideBar.find("select")),sideBar.find(".js-summary-close-edit").on("click",(function(){_this5.getCalendarCreateView()})),headerInstance.registerQuickCreatePostLoadEvents(rightFormCreate,[]),new App.Fields.Text.Editor(sideBar.find(".js-editor"),{height:"5em",toolbar:"Min"})}},{key:"updateSidebar",value:function(sidebar,data){var modalTitles=$(".js-modal-title__container").find('[class*="js-modal-title"]');if(data=$(data),modalTitles.addClass("d-none"),data.hasClass("js-edit-form")){var title=data.find(".js-sidebar-title ").data("title");modalTitles.filter(".js-modal-title--"+title).removeClass("d-none"),this.sidebarName=title}else data.hasClass("js-activity-state")&&(modalTitles.filter(".js-modal-title--status").removeClass("d-none"),this.sidebarName="status");sidebar.find(".js-qc-form").html(data)}}]),_class}(Calendar_CalendarExtended_Js),jQuery.Class("Calendar_QuickCreate_Js",{},{container:!1,getContainer:function(){return this.container},setContainer:function(container){this.container=container},registerExtendCalendar:function(){new Calendar_CalendarModal_Js($(".js-modal-container"),!0);var container=this.getContainer();container.find(".js-activity-buttons button").on("click",(function(e){var form=container.find("form"),currentTarget=$(e.currentTarget);1===currentTarget.data("type")?(form.append('<input type=hidden name="activitystatus" value="'+currentTarget.data("state")+'">'),form.submit()):(container.find(".js-activity-buttons").remove(),form.find('[name="record"]').val(""),form.append('<input type=hidden name="postponed" value="true">'),form.append('<input type=hidden name="followup" value="'+currentTarget.data("id")+'">'))}))},registerStandardCalendar:function(){var thisInstance=this,data=this.getContainer().find("form"),user=data.find('[name="assigned_user_id"]'),dateStartEl=data.find('[name="date_start"]'),dateEnd=data.find('[name="due_date"]');user.on("change",(function(e){var data=$(e.currentTarget).closest("form");thisInstance.getNearCalendarEvent(data)})),dateStartEl.on("change",(function(e){var data=$(e.currentTarget).closest("form");thisInstance.getNearCalendarEvent(data)})),data.find("ul li a").on("click",(function(e){var data=$(e.currentTarget).closest("form");data.find(".addedNearCalendarEvent").remove(),thisInstance.getNearCalendarEvent(data)})),data.on("click",".nextDayBtn",(function(){var dateStartEl=data.find('[name="date_start"]'),startDay=dateStartEl.val(),dateStartFormat=dateStartEl.data("date-format");startDay=moment(Vtiger_Helper_Js.convertToDateString(startDay,dateStartFormat,"+7"," ")).format(dateStartFormat.toUpperCase()),dateStartEl.val(startDay),dateEnd.val(startDay),thisInstance.getNearCalendarEvent(data)})),data.on("click",".previousDayBtn",(function(){var dateStartEl=data.find('[name="date_start"]'),startDay=dateStartEl.val(),dateStartFormat=dateStartEl.data("date-format");startDay=moment(Vtiger_Helper_Js.convertToDateString(startDay,dateStartFormat,"-7"," ")).format(dateStartFormat.toUpperCase()),dateStartEl.val(startDay),dateEnd.val(startDay),thisInstance.getNearCalendarEvent(data)})),data.on("click",".dateBtn",(function(e){var element=$(e.currentTarget);dateStartEl.val(element.data("date")),data.find('[name="due_date"]').val(element.data("date")),data.find('[name="date_start"]').trigger("change")})),thisInstance.getNearCalendarEvent(data)},getNearCalendarEvent:function(container){var dateStartVal=container.find('[name="date_start"]').val();if(void 0!==dateStartVal&&""!==dateStartVal){var params={module:"Calendar",view:"QuickCreateEvents",currentDate:dateStartVal,user:container.find('[name="assigned_user_id"]').val()},progressIndicatorElement=$.progressIndicator({position:"html",blockInfo:{enabled:!0,elementToBlock:container.find(".eventsTable")}});AppConnector.request(params).done((function(events){progressIndicatorElement.progressIndicator({mode:"hide"}),container.find(".eventsTable").remove(),container.append(events),Vtiger_Header_Js.getInstance().registerHelpInfo(container)}))}},registerEvents:function(container){var calendarType=container.closest(".js-modal-container").find(".js-calendar-type").val();this.setContainer(container),"Extended"===calendarType?this.registerExtendCalendar():this.registerStandardCalendar()}});
//# sourceMappingURL=QuickCreate.min.js.map
