"use strict";var classCallCheck=function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")},createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),get=function get(object,property,receiver){null===object&&(object=Function.prototype);var desc=Object.getOwnPropertyDescriptor(object,property);if(void 0===desc){var parent=Object.getPrototypeOf(object);return null===parent?void 0:get(parent,property,receiver)}if("value"in desc)return desc.value;var getter=desc.get;return void 0!==getter?getter.call(receiver):void 0},inherits=function(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)},possibleConstructorReturn=function(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call};window.Calendar_Calendar_Js=function(_Calendar_Js){function _class(){return classCallCheck(this,_class),possibleConstructorReturn(this,(_class.__proto__||Object.getPrototypeOf(_class)).apply(this,arguments))}return inherits(_class,_Calendar_Js),createClass(_class,[{key:"setCalendarModuleOptions",value:function(){var self=this;return{select:function(start,end){self.selectDays(start,end),self.getCalendarView().fullCalendar("unselect")},eventClick:function(calEvent,jsEvent,view){jsEvent.preventDefault();var link=new URL($(this)[0].href);if(self.createView){var progressInstance=jQuery.progressIndicator({blockInfo:{enabled:!0}});app.showModalWindow({url:"index.php?module="+this.module+"&view=ActivityStateModal&record="+link.searchParams.get("record"),cb:function(data){progressInstance.progressIndicator({mode:"hide"})}})}else window.location.assign("index.php?module="+this.module+"&view=Detail&record="+link.searchParams.get("record"))}}}},{key:"getValuesFromSelect2",value:function(element,data,text){if(element.hasClass("select2-hidden-accessible"))for(var types=element.select2("data"),i=0;i<types.length;i++)text?data.push(types[i].text):data.push(types[i].id);return data}},{key:"getDefaultParams",value:function(){var parentParams=get(_class.prototype.__proto__||Object.getPrototypeOf(_class.prototype),"getDefaultParams",this).call(this),users=app.moduleCacheGet("calendar-groups")||[],filters=[];$(".calendarFilters .filterField").each((function(){var element=$(this),name=void 0,value=void 0;"checkbox"==element.attr("type")?(name=element.val(),value=element.prop("checked")?1:0):(name=element.attr("name"),value=element.val()),filters.push({name:name,value:value})}));var params={time:app.getMainParams("showType"),filters:filters};return users.length&&(params.user=parentParams.user.concat(users),params.emptyFilters=!1),params=Object.assign(parentParams,params)}},{key:"selectDays",value:function(startDate,endDate){var thisInstance=this,start_hour=app.getMainParams("startHour"),end_hour=app.getMainParams("endHour");0==endDate.hasTime()&&endDate.add(-1,"days"),startDate=startDate.format(),endDate=endDate.format();var view=thisInstance.getCalendarView().fullCalendar("getView");""==start_hour&&(start_hour="00"),""==end_hour&&(end_hour="00"),this.getCalendarCreateView().done((function(data){if(!(data.length<=0)){if("agendaDay"!=view.name&&"agendaWeek"!=view.name&&(startDate=startDate+"T"+start_hour+":00")==(endDate=endDate+"T"+start_hour+":00")){var activityType=data.find('[name="activitytype"]').val(),activityDurations=JSON.parse(data.find('[name="defaultOtherEventDuration"]').val()),minutes=0;for(var i in activityDurations)if(activityDurations[i].activitytype===activityType){minutes=parseInt(activityDurations[i].duration);break}endDate=moment(endDate).add(minutes,"minutes").toISOString()}var dateFormat=data.find('[name="date_start"]').data("dateFormat").toUpperCase();if(24==data.find('[name="time_start"]').data("format"))var defaultTimeFormat="HH:mm";else defaultTimeFormat="hh:mm A";var startDateString=moment(startDate).format(dateFormat),startTimeString=moment(startDate).format(defaultTimeFormat),endDateString=moment(endDate).format(dateFormat),endTimeString=moment(endDate).format(defaultTimeFormat);data.find('[name="date_start"]').val(startDateString),data.find('[name="due_date"]').val(endDateString),data.find('[name="time_start"]').val(startTimeString),data.find('[name="time_end"]').val(endTimeString),(new Vtiger_Header_Js).handleQuickCreateData(data,{callbackFunction:function(data){thisInstance.addCalendarEvent(data.result)}})}}))}},{key:"isNewEventToDisplay",value:function(eventObject){if(get(_class.prototype.__proto__||Object.getPrototypeOf(_class.prototype),"isNewEventToDisplay",this).call(this,eventObject)){var taskstatus=$.inArray(eventObject.activitystatus.value,["PLL_POSTPONED","PLL_CANCELLED","PLL_COMPLETED"]),state=$(".fc-toolbar .js-switch--label-on").last().hasClass("active");return!(!0===state&&taskstatus>=0||1!=state&&-1==taskstatus)}return!1}},{key:"getCalendarCreateView",value:function(){var thisInstance=this,aDeferred=jQuery.Deferred();if(!1!==this.calendarCreateView)return aDeferred.resolve(this.calendarCreateView.clone(!0,!0)),aDeferred.promise();var progressInstance=jQuery.progressIndicator({blockInfo:{enabled:!0}});return this.loadCalendarCreateView().done((function(data){progressInstance.progressIndicator({mode:"hide"}),thisInstance.calendarCreateView=data,aDeferred.resolve(data.clone(!0,!0))})).fail((function(error){progressInstance.progressIndicator({mode:"hide"}),console.error(error)})),aDeferred.promise()}},{key:"loadCalendarCreateView",value:function(){var aDeferred=jQuery.Deferred(),url="index.php?module="+this.module+"&view=QuickCreateAjax";return Vtiger_Header_Js.getInstance().getQuickCreateForm(url,this.module).done((function(data){aDeferred.resolve(jQuery(data))})).fail((function(){aDeferred.reject()})),aDeferred.promise()}},{key:"switchTpl",value:function(on,off,state){return'<div class="btn-group btn-group-toggle js-switch c-calendar-switch" data-toggle="buttons">\n\t\t\t\t\t<label class="btn btn-outline-primary c-calendar-switch__button js-switch--label-on '+(state?"":"active")+'">\n\t\t\t\t\t\t<input type="radio" name="options" data-on-text="'+on+'" autocomplete="off" '+(state?"":"checked")+">\n\t\t\t\t\t\t"+on+'\n\t\t\t\t\t</label>\n\t\t\t\t\t<label class="btn btn-outline-primary c-calendar-switch__button '+(state?"active":"")+'">\n\t\t\t\t\t\t<input type="radio" name="options" data-off-text="'+off+'" autocomplete="off" '+(state?"checked":"")+">\n\t\t\t\t\t\t"+off+"\n\t\t\t\t\t</label>\n\t\t\t\t</div>"}},{key:"registerSwitchEvents",value:function(){var _this2=this,calendarview=this.getCalendarView(),switchHistory=void 0,switchAllDays=void 0,switchContainer=$('<div class="js-calendar-switch-container"></div>').insertAfter(calendarview.find(".fc-center"));switchHistory="current"!=app.getMainParams("showType")||"history"==app.moduleCacheGet("defaultShowType"),$(this.switchTpl(app.vtranslate("JS_TO_REALIZE"),app.vtranslate("JS_HISTORY"),switchHistory)).prependTo(switchContainer).on("change","input",(function(e){var currentTarget=$(e.currentTarget);void 0!==currentTarget.data("on-text")?(app.setMainParams("showType","current"),app.moduleCacheSet("defaultShowType","current")):void 0!==currentTarget.data("off-text")&&(app.setMainParams("showType","history"),app.moduleCacheSet("defaultShowType","history")),_this2.loadCalendarData()})),switchAllDays="workDays"!==app.getMainParams("switchingDays")||"all"===app.moduleCacheGet("defaultSwitchingDays"),!1!==app.getMainParams("hiddenDays",!0)&&$(this.switchTpl(app.vtranslate("JS_WORK_DAYS"),app.vtranslate("JS_ALL"),switchAllDays)).prependTo(switchContainer).on("change","input",(function(e){var currentTarget=$(e.currentTarget),hiddenDays=[];void 0!==currentTarget.data("on-text")?(app.setMainParams("switchingDays","workDays"),app.moduleCacheSet("defaultSwitchingDays","workDays"),hiddenDays=app.getMainParams("hiddenDays",!0)):void 0!==currentTarget.data("off-text")&&(app.setMainParams("switchingDays","all"),app.moduleCacheSet("defaultSwitchingDays","all")),calendarview.fullCalendar("option","hiddenDays",hiddenDays),_this2.registerSwitchEvents(),_this2.loadCalendarData()}))}},{key:"registerCacheSettings",value:function(){var calendar=this.getCalendarView();if("all"==app.moduleCacheGet("defaultSwitchingDays")?app.setMainParams("switchingDays","all"):app.setMainParams("switchingDays","workDays"),"history"==app.moduleCacheGet("defaultShowType")?app.setMainParams("showType","history"):app.setMainParams("showType","current"),$(".siteBarRight .filterField").each((function(index){var name=$(this).attr("id"),value=app.moduleCacheGet(name),element=$("#"+name);element.length>0&&null!=value&&"checkbox"==element.attr("type")&&element.prop("checked",value)})),calendar.find(".fc-toolbar .fc-button").on("click",(function(e){var view=void 0,element=$(e.currentTarget);view=calendar.fullCalendar("getView"),element.hasClass("fc-"+view.name+"-button")?app.moduleCacheSet("defaultView",view.name):(element.hasClass("fc-prev-button")||element.hasClass("fc-next-button")||element.hasClass("fc-today-button"))&&(app.moduleCacheSet("start",view.start.format()),app.moduleCacheSet("end",view.end.format()))})),app.moduleCacheKeys().length>0){var alert=$("#moduleCacheAlert");$(".bodyContents").on("Vtiger.Widget.Load.undefined",(function(e,data){alert.removeClass("d-none")})),alert.find(".cacheClear").on("click",(function(e){app.moduleCacheClear(),alert.addClass("d-none"),location.reload()}))}}},{key:"registerEvents",value:function(){get(_class.prototype.__proto__||Object.getPrototypeOf(_class.prototype),"registerEvents",this).call(this),this.registerCacheSettings(),this.registerSwitchEvents()}}]),_class}(Calendar_Js);
//# sourceMappingURL=CalendarView.min.js.map
