'use strict';

Vtiger_Edit_Js('Products_Edit_Js',{},{baseCurrency:'',baseCurrencyName:'',multiCurrencyContainer:!1,unitPrice:!1,getUnitPrice:function getUnitPrice(){return !1==this.unitPrice&&(this.unitPrice=$('input.unitPrice',this.getForm())),this.unitPrice},getMoreCurrenciesContainer:function getMoreCurrenciesContainer(){return !1==this.multiCurrencyContainer&&(this.multiCurrencyContainer=$('.multiCurrencyEditUI')),this.multiCurrencyContainer},alignBelowUnitPrice:function alignBelowUnitPrice(dataToAlign){var parentElem=$('input[name="unit_price"]',this.getForm());return dataToAlign.position({of:parentElem,my:'left top',at:'left bottom',collision:'flip'}),this},getCurrentElem:function getCurrentElem(e){return $(e.currentTarget)},registerEventForTaxes:function registerEventForTaxes(){var thisInstance=this,formElem=this.getForm();return $('.taxes').on('change',function(e){var elem=thisInstance.getCurrentElem(e),taxBox=elem.data('taxName');elem.is(':checked')?$('input[name='+taxBox+']',formElem).removeAttr('readonly'):$('input[name='+taxBox+']',formElem).attr('readonly','readonly');}),this},registerEventForEnableBaseCurrency:function registerEventForEnableBaseCurrency(){var container=this.getMoreCurrenciesContainer(),currencyLabel=$('.js-currency'),thisInstance=this;return $(container).on('change','.baseCurrency',function(e){var elem=thisInstance.getCurrentElem(e),parentElem=elem.closest('tr');if(elem.is(':checked')){var convertedPrice=$('.convertedPrice',parentElem).val();thisInstance.baseCurrencyName=parentElem.data('currencyId'),thisInstance.baseCurrency=convertedPrice,currencyLabel.text(parentElem.data('currency-symbol'));}}),this},registerEventForResetCurrency:function registerEventForResetCurrency(){var container=this.getMoreCurrenciesContainer(),thisInstance=this;return $(container).on('click','.currencyReset',function(e){var parentElem=thisInstance.getCurrentElem(e).closest('tr'),unitPriceFieldData=thisInstance.getUnitPrice().data(),unitPrice=thisInstance.getDataBaseFormatUnitPrice(),conversionRate=$('.conversionRate',parentElem).val(),price=parseFloat(unitPrice)*parseFloat(conversionRate),calculatedPrice=app.parseNumberToShow(price);$('.convertedPrice',parentElem).val(calculatedPrice);}),this},getDataBaseFormatUnitPrice:function getDataBaseFormatUnitPrice(){var field=this.getUnitPrice(),unitPrice=field.getNumberFromValue();return unitPrice},calculateConversionRate:function calculateConversionRate(){var container=this.getMoreCurrenciesContainer(),baseCurrencyRow=container.find('.baseCurrency').filter(':checked').closest('tr'),baseCurrencyConvestationRate=baseCurrencyRow.find('.conversionRate');if('1'!=baseCurrencyConvestationRate.val()){var baseCurrencyRatePrevValue=baseCurrencyConvestationRate.val();container.find('.conversionRate').each(function(key,domElement){var element=$(domElement);if(!element.is(baseCurrencyConvestationRate)){var prevValue=element.val();element.val(prevValue/baseCurrencyRatePrevValue);}}),baseCurrencyConvestationRate.val('1');}},registerEventForEnableCurrency:function registerEventForEnableCurrency(){var container=this.getMoreCurrenciesContainer(),thisInstance=this;return $(container).on('change','.enableCurrency',function(e){var elem=thisInstance.getCurrentElem(e),parentRow=elem.closest('tr');if(elem.is(':checked')){elem.attr('checked','checked');var conversionRate=$('.conversionRate',parentRow).val(),unitPriceFieldData=thisInstance.getUnitPrice().data(),unitPrice=thisInstance.getDataBaseFormatUnitPrice(),price=parseFloat(unitPrice)*parseFloat(conversionRate);$('input',parentRow).attr('disabled',!0).removeAttr('disabled'),$('button.currencyReset',parentRow).attr('disabled',!0).removeAttr('disabled');var calculatedPrice=app.parseNumberToShow(price);$('input.convertedPrice',parentRow).val(calculatedPrice);}else{var baseCurrency=$('.baseCurrency',parentRow);if(baseCurrency.is(':checked')){var currencyName=$('.currencyName',parentRow).text(),params={type:'error',title:app.vtranslate('JS_ERROR'),text:app.vtranslate('JS_BASE_CURRENCY_CHANGED_TO_DISABLE_CURRENCY')+'"'+currencyName+'"'};return Vtiger_Helper_Js.showPnotify(params),void elem.prop('checked',!0)}$('input',parentRow).attr('disabled',!0),$('input.enableCurrency',parentRow).removeAttr('disabled'),$('button.currencyReset',parentRow).attr('disabled','disabled');}}),this},getMoreCurrenciesUI:function getMoreCurrenciesUI(){var aDeferred=$.Deferred(),moduleName=app.getModuleName(),baseCurrency=$('input[name="base_currency"]').val(),recordId=$('input[name="record"]').val(),moreCurrenciesContainer=$('#moreCurrenciesContainer');moreCurrenciesUi=moreCurrenciesContainer.find('.multiCurrencyEditUI');var moreCurrenciesUi;if(0==moreCurrenciesUi.length){AppConnector.request({module:moduleName,view:'MoreCurrenciesList',currency:baseCurrency,record:recordId}).done(function(data){moreCurrenciesContainer.html(data),aDeferred.resolve(data);}).fail(function(textStatus,errorThrown){aDeferred.reject(textStatus,errorThrown);});}else aDeferred.resolve();return aDeferred.promise()},registerEventForMoreCurrencies:function registerEventForMoreCurrencies(){var thisInstance=this,form=this.getForm();$('#moreCurrencies').on('click',function(){var progressInstance=$.progressIndicator();thisInstance.getMoreCurrenciesUI().done(function(){var moreCurrenciesUi;if(moreCurrenciesUi=$('#moreCurrenciesContainer').find('.multiCurrencyEditUI'),0<moreCurrenciesUi.length){moreCurrenciesUi=moreCurrenciesUi.clone(!0,!0),progressInstance.hide();var callback=function(data){var params=app.validationEngineOptionsForRecord,form=data.find('#currencyContainer');params.onValidationComplete=function(form,valid){return valid&&thisInstance.saveCurrencies(),!1},form.validationEngine(params),app.showScrollBar(data.find('.currencyContent'),{height:'400px'}),thisInstance.baseCurrency=thisInstance.getUnitPrice().val();var multiCurrencyEditUI=$('.multiCurrencyEditUI');thisInstance.multiCurrencyContainer=multiCurrencyEditUI,thisInstance.calculateConversionRate(),thisInstance.registerEventForEnableCurrency(),thisInstance.registerEventForEnableBaseCurrency(),thisInstance.registerEventForResetCurrency(),thisInstance.triggerForBaseCurrencyCalc();},moreCurrenciesContainer=$('#moreCurrenciesContainer').find('.multiCurrencyEditUI'),contentInsideForm=moreCurrenciesUi.find('.multiCurrencyContainer').html();moreCurrenciesUi.find('.multiCurrencyContainer').remove();$('<form id="currencyContainer"></form>').insertAfter(moreCurrenciesUi.find('.modal-header')),moreCurrenciesUi.find('form').html(contentInsideForm),moreCurrenciesContainer.find('input[name^=curname]').each(function(index,element){var dataValue=$(element).val(),dataId=$(element).attr('id');moreCurrenciesUi.find('#'+dataId).val(dataValue);});var modalWindowParams={data:moreCurrenciesUi,css:{"text-align":'left',width:'65%'},cb:callback};app.showModalWindow(modalWindowParams);}});});},triggerForBaseCurrencyCalc:function triggerForBaseCurrencyCalc(){var multiCurrencyEditUI=this.getMoreCurrenciesContainer(),baseCurrency=multiCurrencyEditUI.find('.enableCurrency');$.each(baseCurrency,function(key,val){if($(val).is(':checked')){var baseCurrencyRow=$(val).closest('tr');0==parseFloat(baseCurrencyRow.find('.convertedPrice').val())&&baseCurrencyRow.find('.currencyReset').trigger('click');}else $(val).closest('tr').find('.convertedPrice').val('');});},registerEventForUnitPrice:function registerEventForUnitPrice(){var thisInstance=this,unitPrice=this.getUnitPrice();unitPrice.on('change',function(){thisInstance.triggerForBaseCurrencyCalc();});},registerRecordPreSaveEvent:function registerRecordPreSaveEvent(form){var thisInstance=this;'undefined'==typeof form&&(form=this.getForm()),form.on(Vtiger_Edit_Js.recordPreSave,function(e){var multiCurrencyContent=$('#moreCurrenciesContainer').find('.currencyContent'),unitPrice=thisInstance.getUnitPrice();1>multiCurrencyContent.length&&0<unitPrice.length?(e.preventDefault(),thisInstance.getMoreCurrenciesUI().done(function(){thisInstance.preSaveConfigOfForm(form),form.submit();})):0<multiCurrencyContent.length&&thisInstance.preSaveConfigOfForm(form);});},preSaveConfigOfForm:function preSaveConfigOfForm(form){var unitPrice=this.getUnitPrice();if(0<unitPrice.length){var unitPriceValue=unitPrice.val(),baseCurrencyName=form.find('[name="base_currency"]').val();form.find('[name="'+baseCurrencyName+'"]').val(unitPriceValue),form.find('#requstedUnitPrice').attr('name',baseCurrencyName).val(unitPriceValue);}},saveCurrencies:function saveCurrencies(){var errorMessage,params,thisInstance=this,form=$('#currencyContainer'),editViewForm=thisInstance.getForm(),modalContainer=$('#'+Window.lastModalId),enabledBaseCurrency=modalContainer.find('.enableCurrency').filter(':checked');if(1>enabledBaseCurrency.length)return errorMessage=app.vtranslate('JS_PLEASE_SELECT_BASE_CURRENCY_FOR_PRODUCT'),params={text:errorMessage,type:'error'},Vtiger_Helper_Js.showMessage(params),void form.removeData('submit');enabledBaseCurrency.attr('checked','checked'),modalContainer.find('.enableCurrency').filter(':not(:checked)').removeAttr('checked');var selectedBaseCurrency=modalContainer.find('.baseCurrency').filter(':checked');if(1>selectedBaseCurrency.length)return errorMessage=app.vtranslate('JS_PLEASE_ENABLE_BASE_CURRENCY_FOR_PRODUCT'),params={text:errorMessage,type:'error'},Vtiger_Helper_Js.showMessage(params),void form.removeData('submit');selectedBaseCurrency.attr('checked','checked'),modalContainer.find('.baseCurrency').filter(':not(:checked)').removeAttr('checked');var parentElem=selectedBaseCurrency.closest('tr'),convertedPrice=$('.convertedPrice',parentElem).val();thisInstance.baseCurrencyName=parentElem.data('currencyId'),thisInstance.baseCurrency=convertedPrice,thisInstance.getUnitPrice().val(thisInstance.baseCurrency),$('input[name="base_currency"]',editViewForm).val(thisInstance.baseCurrencyName);var savedValuesOfMultiCurrency=modalContainer.find('.currencyContent').html(),moreCurrenciesContainer=$('#moreCurrenciesContainer');moreCurrenciesContainer.find('.currencyContent').html(savedValuesOfMultiCurrency),modalContainer.find('input[name^=curname]').each(function(index,element){var dataValue=$(element).val(),dataId=$(element).attr('id');moreCurrenciesContainer.find('.currencyContent').find('#'+dataId).val(dataValue);}),app.hideModalWindow();},registerEventForUsageunit:function registerEventForUsageunit(){this.checkUsageUnit(),$('select[name="usageunit"]').on('change',this.checkUsageUnit);},checkUsageUnit:function checkUsageUnit(){var selectUsageunit=$('select[name="usageunit"]'),inputQtyPerUnit=$('input[name="qty_per_unit"]'),value=selectUsageunit.val();'pack'===value?inputQtyPerUnit.prop('disabled',!1):inputQtyPerUnit.prop('disabled',!0);},registerEvents:function registerEvents(){this._super(),this.registerEventForMoreCurrencies(),this.registerEventForTaxes(),this.registerEventForUnitPrice(),this.registerRecordPreSaveEvent(),this.registerEventForUsageunit();}});
//# sourceMappingURL=Edit.min.js.map
