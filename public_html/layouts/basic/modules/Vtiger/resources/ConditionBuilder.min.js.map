{"version":3,"file":"ConditionBuilder.min.js","sources":["ConditionBuilder.js"],"sourcesContent":["/* {[The file is published on the basis of YetiForce Public License 3.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */\n'use strict';\n\nclass Vtiger_ConditionBuilder_Js {\n\t/**\n\t * Constructor\n\t * @param {jQuery} container\n\t */\n\tconstructor(container, sourceModuleName, onChange) {\n\t\tthis.container = container;\n\t\tthis.sourceModuleName = sourceModuleName;\n\t\tif (onChange) {\n\t\t\tthis.onChange = onChange;\n\t\t} else {\n\t\t\tthis.onChange = () => {};\n\t\t}\n\t}\n\n\t/**\n\t * Register change value event\n\t *\n\t * @param   {jQuery}  container\n\t */\n\tregisterChangeValueEvent(container) {\n\t\tcontainer.find('.js-condition-builder-value').on('change', e => {\n\t\t\tthis.onChange(this);\n\t\t});\n\t}\n\n\t/**\n\t * Register events when change conditions\n\t * @param {jQuery} container\n\t */\n\tregisterChangeConditions(container) {\n\t\tlet self = this;\n\t\tcontainer.find('.js-conditions-fields, .js-conditions-operator').on('change', function(e) {\n\t\t\tlet progress = $.progressIndicator({\n\t\t\t\tposition: 'html',\n\t\t\t\tblockInfo: {\n\t\t\t\t\tenabled: true\n\t\t\t\t}\n\t\t\t});\n\t\t\tlet currentTarget = $(e.currentTarget);\n\t\t\tlet requestParams = {};\n\t\t\tif (currentTarget.hasClass('js-conditions-fields')) {\n\t\t\t\trequestParams = {\n\t\t\t\t\tmodule: app.getModuleName(),\n\t\t\t\t\tparent: app.getParentModuleName(),\n\t\t\t\t\tview: 'ConditionBuilder',\n\t\t\t\t\tsourceModuleName: self.sourceModuleName,\n\t\t\t\t\tfieldname: currentTarget.val()\n\t\t\t\t};\n\t\t\t} else {\n\t\t\t\trequestParams = {\n\t\t\t\t\tmodule: app.getModuleName(),\n\t\t\t\t\tparent: app.getParentModuleName(),\n\t\t\t\t\tview: 'ConditionBuilder',\n\t\t\t\t\tsourceModuleName: self.sourceModuleName,\n\t\t\t\t\tfieldname: container.find('.js-conditions-fields').val(),\n\t\t\t\t\toperator: currentTarget.val()\n\t\t\t\t};\n\t\t\t}\n\t\t\tAppConnector.request(requestParams).done(function(data) {\n\t\t\t\tprogress.progressIndicator({ mode: 'hide' });\n\t\t\t\tcontainer.html($(data).html());\n\t\t\t\tself.registerChangeConditions(container);\n\t\t\t\tself.registerField(container);\n\t\t\t\tself.registerChangeValueEvent(container);\n\t\t\t\tself.onChange(self);\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * register field types related events\n\t * @param {jQuery} container\n\t */\n\tregisterField(container) {\n\t\tApp.Fields.Picklist.showSelect2ElementView(container.find('select.select2'));\n\t\tApp.Fields.Date.register(container, true, {}, 'js-date-field');\n\t\tApp.Fields.Date.registerRange(container.find('.js-date-range-field'), { ranges: false });\n\t\tApp.Fields.DateTime.register(container.find('.js-datetime-range-field'));\n\t\tapp.registerEventForClockPicker($(container.find('.clockPicker')));\n\t}\n\n\t/**\n\t * Register events to add condition\n\t */\n\tregisterAddCondition() {\n\t\tlet self = this;\n\t\tthis.container.on('click', '.js-condition-add', function(e) {\n\t\t\tlet progress = $.progressIndicator({\n\t\t\t\tposition: 'html',\n\t\t\t\tblockInfo: {\n\t\t\t\t\tenabled: true\n\t\t\t\t}\n\t\t\t});\n\t\t\tlet container = $(this)\n\t\t\t\t.closest('.js-condition-builder-group-container')\n\t\t\t\t.find('> .js-condition-builder-conditions-container');\n\t\t\tAppConnector.request({\n\t\t\t\tmodule: app.getModuleName(),\n\t\t\t\tparent: app.getParentModuleName(),\n\t\t\t\tview: 'ConditionBuilder',\n\t\t\t\tsourceModuleName: self.sourceModuleName\n\t\t\t}).done(function(data) {\n\t\t\t\tprogress.progressIndicator({ mode: 'hide' });\n\t\t\t\tdata = $(data);\n\t\t\t\tApp.Fields.Picklist.showSelect2ElementView(data.find('select.select2'));\n\t\t\t\tself.registerChangeConditions(data);\n\t\t\t\tself.registerChangeValueEvent(data);\n\t\t\t\tcontainer.append(data);\n\t\t\t\tself.onChange(self);\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * Register events to add group\n\t */\n\tregisterAddGroup() {\n\t\tthis.container.on('click', '.js-group-add', e => {\n\t\t\tlet template = this.container.find('.js-condition-builder-group-template').clone();\n\t\t\ttemplate.removeClass('hide');\n\t\t\t$(e.target)\n\t\t\t\t.closest('.js-condition-builder-group-container')\n\t\t\t\t.find('> .js-condition-builder-conditions-container')\n\t\t\t\t.append(template.html());\n\t\t\tthis.onChange(this);\n\t\t});\n\t}\n\n\t/**\n\t * Register events to remove group\n\t */\n\tregisterDeleteGroup() {\n\t\tthis.container.on('click', '.js-group-delete', e => {\n\t\t\t$(e.target)\n\t\t\t\t.closest('.js-condition-builder-group-container')\n\t\t\t\t.remove();\n\t\t\tthis.onChange(this);\n\t\t});\n\t}\n\n\t/**\n\t * Register events to remove condition\n\t */\n\tregisterDeleteCondition() {\n\t\tthis.container.on('click', '.js-condition-delete', e => {\n\t\t\t$(e.target)\n\t\t\t\t.closest('.js-condition-builder-conditions-row')\n\t\t\t\t.remove();\n\t\t\tthis.onChange(this);\n\t\t});\n\t}\n\n\t/**\n\t * Block submit on press enter key\n\t */\n\tregisterDisableSubmitOnEnter() {\n\t\tthis.container.find('.js-condition-builder-value').keydown(function(e) {\n\t\t\tif (e.keyCode === 13) {\n\t\t\t\te.preventDefault();\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Read conditions in group\n\t * @param {jQuery} container\n\t * @returns {object}\n\t */\n\treadCondition(container) {\n\t\tlet self = this;\n\t\tlet condition = container.find('> .js-condition-switch .js-condition-switch-value').hasClass('active')\n\t\t\t? 'AND'\n\t\t\t: 'OR';\n\t\tlet arr = {};\n\t\tarr['condition'] = condition;\n\t\tlet rules = [];\n\t\tcontainer.find('> .js-condition-builder-conditions-container >').each(function() {\n\t\t\tlet element = $(this);\n\t\t\tif (element.hasClass('js-condition-builder-conditions-row')) {\n\t\t\t\trules.push({\n\t\t\t\t\tfieldname: element.find('.js-conditions-fields').val(),\n\t\t\t\t\toperator: element.find('.js-conditions-operator').val(),\n\t\t\t\t\tvalue: element.find('.js-condition-builder-value').val()\n\t\t\t\t});\n\t\t\t} else if (element.hasClass('js-condition-builder-group-container')) {\n\t\t\t\trules.push(self.readCondition(element));\n\t\t\t}\n\t\t});\n\t\tarr['rules'] = rules;\n\t\treturn arr;\n\t}\n\n\t/**\n\t * Returns conditions\n\t */\n\tgetConditions() {\n\t\treturn this.readCondition(this.container.find('> .js-condition-builder-group-container'));\n\t}\n\n\t/**\n\t * Main function to regsiter events\n\t */\n\tregisterEvents() {\n\t\tlet self = this;\n\t\tthis.registerAddCondition();\n\t\tthis.registerAddGroup();\n\t\tthis.registerDeleteGroup();\n\t\tthis.registerDeleteCondition();\n\t\tthis.registerDisableSubmitOnEnter();\n\t\tthis.container.find('.js-condition-builder-conditions-row').each(function() {\n\t\t\tself.registerChangeConditions($(this));\n\t\t\tself.registerField($(this));\n\t\t});\n\t}\n}\n"],"names":["Vtiger_ConditionBuilder_Js","container","sourceModuleName","onChange","find","on","_this","self","this","e","progress","$","progressIndicator","currentTarget","requestParams","hasClass","app","getModuleName","getParentModuleName","val","request","done","data","mode","html","registerChangeConditions","registerField","registerChangeValueEvent","Fields","Picklist","showSelect2ElementView","Date","register","registerRange","ranges","DateTime","registerEventForClockPicker","closest","append","template","_this2","clone","removeClass","target","remove","_this3","_this4","keydown","keyCode","preventDefault","condition","arr","rules","each","element","push","readCondition","registerAddCondition","registerAddGroup","registerDeleteGroup","registerDeleteCondition","registerDisableSubmitOnEnter"],"mappings":"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"}