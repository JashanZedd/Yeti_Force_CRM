{"version":3,"file":"ConditionBuilder.min.js","sources":["ConditionBuilder.js"],"sourcesContent":["/* {[The file is published on the basis of YetiForce Public License 3.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */\n'use strict';\n\nclass Vtiger_ConditionBuilder_Js {\n\t/**\n\t * Constructor\n\t * @param {jQuery} container\n\t */\n\tconstructor(container, sourceModuleName, onChange) {\n\t\tthis.container = container;\n\t\tthis.sourceModuleName = sourceModuleName;\n\t\tif (onChange) {\n\t\t\tthis.onChange = onChange;\n\t\t} else {\n\t\t\tthis.onChange = () => {};\n\t\t}\n\t}\n\n\t/**\n\t * Register change value event\n\t *\n\t * @param   {jQuery}  container\n\t */\n\tregisterChangeValueEvent(container) {\n\t\tcontainer.find('.js-condition-builder-value').on('change', e => {\n\t\t\tthis.onChange(this);\n\t\t});\n\t}\n\n\t/**\n\t * Register events when change conditions\n\t * @param {jQuery} container\n\t */\n\tregisterChangeConditions(container) {\n\t\tlet self = this;\n\t\tcontainer.find('.js-conditions-fields, .js-conditions-operator').on('change', function(e) {\n\t\t\tlet progress = $.progressIndicator({\n\t\t\t\tposition: 'html',\n\t\t\t\tblockInfo: {\n\t\t\t\t\tenabled: true\n\t\t\t\t}\n\t\t\t});\n\t\t\tlet currentTarget = $(e.currentTarget);\n\t\t\tlet requestParams = {};\n\t\t\tif (currentTarget.hasClass('js-conditions-fields')) {\n\t\t\t\trequestParams = {\n\t\t\t\t\tmodule: app.getModuleName(),\n\t\t\t\t\tparent: app.getParentModuleName(),\n\t\t\t\t\tview: 'ConditionBuilder',\n\t\t\t\t\tsourceModuleName: self.sourceModuleName,\n\t\t\t\t\tfieldname: currentTarget.val()\n\t\t\t\t};\n\t\t\t} else {\n\t\t\t\trequestParams = {\n\t\t\t\t\tmodule: app.getModuleName(),\n\t\t\t\t\tparent: app.getParentModuleName(),\n\t\t\t\t\tview: 'ConditionBuilder',\n\t\t\t\t\tsourceModuleName: self.sourceModuleName,\n\t\t\t\t\tfieldname: container.find('.js-conditions-fields').val(),\n\t\t\t\t\toperator: currentTarget.val()\n\t\t\t\t};\n\t\t\t}\n\t\t\tAppConnector.request(requestParams).done(function(data) {\n\t\t\t\tprogress.progressIndicator({ mode: 'hide' });\n\t\t\t\tcontainer.html($(data).html());\n\t\t\t\tself.registerChangeConditions(container);\n\t\t\t\tself.registerField(container);\n\t\t\t\tself.registerChangeValueEvent(container);\n\t\t\t\tself.onChange(self);\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * register field types related events\n\t * @param {jQuery} container\n\t */\n\tregisterField(container) {\n\t\tApp.Fields.Picklist.showSelect2ElementView(container.find('select.select2'));\n\t\tApp.Fields.Date.register(container, true, {}, 'js-date-field');\n\t\tApp.Fields.Date.registerRange(container.find('.js-date-range-field'), { ranges: false });\n\t\tApp.Fields.DateTime.register(container.find('.js-datetime-range-field'));\n\t\tapp.registerEventForClockPicker($(container.find('.clockPicker')));\n\t}\n\n\t/**\n\t * Register events to add condition\n\t */\n\tregisterAddCondition() {\n\t\tlet self = this;\n\t\tthis.container.on('click', '.js-condition-add', function(e) {\n\t\t\tlet progress = $.progressIndicator({\n\t\t\t\tposition: 'html',\n\t\t\t\tblockInfo: {\n\t\t\t\t\tenabled: true\n\t\t\t\t}\n\t\t\t});\n\t\t\tlet container = $(this)\n\t\t\t\t.closest('.js-condition-builder-group-container')\n\t\t\t\t.find('> .js-condition-builder-conditions-container');\n\t\t\tAppConnector.request({\n\t\t\t\tmodule: app.getModuleName(),\n\t\t\t\tparent: app.getParentModuleName(),\n\t\t\t\tview: 'ConditionBuilder',\n\t\t\t\tsourceModuleName: self.sourceModuleName\n\t\t\t}).done(function(data) {\n\t\t\t\tprogress.progressIndicator({ mode: 'hide' });\n\t\t\t\tdata = $(data);\n\t\t\t\tApp.Fields.Picklist.showSelect2ElementView(data.find('select.select2'));\n\t\t\t\tself.registerChangeConditions(data);\n\t\t\t\tself.registerChangeValueEvent(data);\n\t\t\t\tcontainer.append(data);\n\t\t\t\tself.onChange(self);\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * Register events to add group\n\t */\n\tregisterAddGroup() {\n\t\tthis.container.on('click', '.js-group-add', e => {\n\t\t\tlet template = this.container.find('.js-condition-builder-group-template').clone();\n\t\t\ttemplate.removeClass('hide');\n\t\t\t$(e.target)\n\t\t\t\t.closest('.js-condition-builder-group-container')\n\t\t\t\t.find('> .js-condition-builder-conditions-container')\n\t\t\t\t.append(template.html());\n\t\t\tthis.onChange(this);\n\t\t});\n\t}\n\n\t/**\n\t * Register events to remove group\n\t */\n\tregisterDeleteGroup() {\n\t\tthis.container.on('click', '.js-group-delete', e => {\n\t\t\t$(e.target)\n\t\t\t\t.closest('.js-condition-builder-group-container')\n\t\t\t\t.remove();\n\t\t\tthis.onChange(this);\n\t\t});\n\t}\n\n\t/**\n\t * Register events to remove condition\n\t */\n\tregisterDeleteCondition() {\n\t\tthis.container.on('click', '.js-condition-delete', e => {\n\t\t\t$(e.target)\n\t\t\t\t.closest('.js-condition-builder-conditions-row')\n\t\t\t\t.remove();\n\t\t\tthis.onChange(this);\n\t\t});\n\t}\n\n\t/**\n\t * Block submit on press enter key\n\t */\n\tregisterDisableSubmitOnEnter() {\n\t\tthis.container.find('.js-condition-builder-value').keydown(function(e) {\n\t\t\tif (e.keyCode === 13) {\n\t\t\t\te.preventDefault();\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Read conditions in group\n\t * @param {jQuery} container\n\t * @returns {object}\n\t */\n\treadCondition(container) {\n\t\tlet self = this;\n\t\tlet condition = container.find('> .js-condition-switch .js-condition-switch-value').hasClass('active')\n\t\t\t? 'AND'\n\t\t\t: 'OR';\n\t\tlet arr = {};\n\t\tarr['condition'] = condition;\n\t\tlet rules = [];\n\t\tcontainer.find('> .js-condition-builder-conditions-container >').each(function() {\n\t\t\tlet element = $(this);\n\t\t\tif (element.hasClass('js-condition-builder-conditions-row')) {\n\t\t\t\trules.push({\n\t\t\t\t\tfieldname: element.find('.js-conditions-fields').val(),\n\t\t\t\t\toperator: element.find('.js-conditions-operator').val(),\n\t\t\t\t\tvalue: element.find('.js-condition-builder-value').val()\n\t\t\t\t});\n\t\t\t} else if (element.hasClass('js-condition-builder-group-container')) {\n\t\t\t\trules.push(self.readCondition(element));\n\t\t\t}\n\t\t});\n\t\tarr['rules'] = rules;\n\t\treturn arr;\n\t}\n\n\t/**\n\t * Returns conditions\n\t */\n\tgetConditions() {\n\t\treturn this.readCondition(this.container.find('> .js-condition-builder-group-container'));\n\t}\n\n\t/**\n\t * Main function to regsiter events\n\t */\n\tregisterEvents() {\n\t\tlet self = this;\n\t\tthis.registerAddCondition();\n\t\tthis.registerAddGroup();\n\t\tthis.registerDeleteGroup();\n\t\tthis.registerDeleteCondition();\n\t\tthis.registerDisableSubmitOnEnter();\n\t\tthis.container.find('.js-condition-builder-conditions-row').each(function() {\n\t\t\tself.registerChangeConditions($(this));\n\t\t\tself.registerField($(this));\n\t\t});\n\t}\n}\n"],"names":["Vtiger_ConditionBuilder_Js","container","sourceModuleName","onChange","find","on","self","e","progress","$","progressIndicator","currentTarget","requestParams","hasClass","app","getModuleName","getParentModuleName","val","request","done","data","mode","html","registerChangeConditions","registerField","registerChangeValueEvent","Fields","Picklist","showSelect2ElementView","Date","register","registerRange","ranges","DateTime","registerEventForClockPicker","closest","append","template","clone","removeClass","target","remove","keydown","keyCode","preventDefault","condition","arr","rules","each","element","push","readCondition","registerAddCondition","registerAddGroup","registerDeleteGroup","registerDeleteCondition","registerDisableSubmitOnEnter"],"mappings":"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"}