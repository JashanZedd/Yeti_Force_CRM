"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};jQuery.Class("Vtiger_Detail_Js",{detailInstance:!1,getInstance:function(){if(0==Vtiger_Detail_Js.detailInstance){var moduleClassName=app.getModuleName()+"_"+app.getViewName()+"_Js",instance=void 0;instance=void 0!==window[moduleClassName]?new window[moduleClassName]:new Vtiger_Detail_Js,Vtiger_Detail_Js.detailInstance=instance}return Vtiger_Detail_Js.detailInstance},triggerDetailViewAction:function(detailActionUrl,callBackFunction){var detailInstance=Vtiger_Detail_Js.getInstance(),selectedIds=[];selectedIds.push(detailInstance.getRecordId());var actionParams={type:"POST",url:detailActionUrl,dataType:"html",data:{selected_ids:JSON.stringify(selectedIds)}};AppConnector.request(actionParams).done((function(data){data&&(app.showModalWindow(data,{"text-align":"left"}),"function"==typeof callBackFunction&&callBackFunction(data))})).fail((function(error,err){}))},triggerSendSms:function(detailActionUrl,module){Vtiger_Detail_Js.triggerDetailViewAction(detailActionUrl)},triggerTransferOwnership:function(massActionUrl){var thisInstance=this;thisInstance.getRelatedModulesContainer=!1;var actionParams={type:"POST",url:massActionUrl,dataType:"html",data:{}};AppConnector.request(actionParams).done((function(data){if(data){var callback=function(data){app.validationEngineOptions.onValidationComplete=function(form,valid){return valid&&"changeOwner"==form.attr("name")&&thisInstance.transferOwnershipSave(form),!1},jQuery("#changeOwner").validationEngine(app.validationEngineOptions)};app.showModalWindow(data,(function(data){var selectElement=thisInstance.getRelatedModuleContainer();App.Fields.Picklist.changeSelectElementView(selectElement,"select2"),callback()}))}}))},transferOwnershipSave:function(form){var transferOwner=jQuery("#transferOwnerId").val(),relatedModules=jQuery("#related_modules").val(),recordId=jQuery("#recordId").val(),params={module:app.getModuleName(),action:"TransferOwnership",record:recordId,transferOwnerId:transferOwner,related_modules:relatedModules};AppConnector.request(params).done((function(data){if(data.success){app.hideModalWindow();var params={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_RECORDS_TRANSFERRED_SUCCESSFULLY"),type:"info"},oldvalue=jQuery(".assigned_user_id").val(),element=jQuery(".assigned_user_id ");element.find('option[value="'+oldvalue+'"]').removeAttr("selected"),element.find('option[value="'+transferOwner+'"]').attr("selected","selected"),element.trigger("liszt:updated");var Fieldname=element.find('option[value="'+transferOwner+'"]').data("picklistvalue");element.closest(".row-fluid").find(".value").html('<a href="index.php?module=Users&amp;parent=Settings&amp;view=Detail&amp;record='+transferOwner+'">'+Fieldname+"</a>"),Vtiger_Helper_Js.showPnotify(params)}}))},getRelatedModuleContainer:function(){return 0==this.getRelatedModulesContainer&&(this.getRelatedModulesContainer=jQuery("#related_modules")),this.getRelatedModulesContainer},reloadRelatedList:function(){var detailInstance=Vtiger_Detail_Js.getInstance(),params={};jQuery('[name="currentPageNum"]').length>0&&(params.page=jQuery('[name="currentPageNum"]').val()),detailInstance.loadRelatedList(params)},showWorkflowTriggerView:function(instance){$(instance).popover("hide");var detailInstance=Vtiger_Detail_Js.getInstance(),callback=function(data){var treeInstance=data.find("#treeWorkflowContents");treeInstance.jstree({core:{data:JSON.parse(data.find(".js-tree-workflow-data").val()),themes:{name:"proton",responsive:!0,icons:!1}},checkbox:{three_state:!1},plugins:["search","category"]}),data.find('[type="submit"]').on("click",(function(){var tasks={},selected=treeInstance.jstree("getCategory",!0);$.each(selected,(function(index,treeElement){"record"===treeElement.attr&&(tasks[treeElement.record_id]=[])})),$.each(selected,(function(index,treeElement){void 0!==tasks[treeElement.parent]&&"task"===treeElement.attr&&tasks[treeElement.parent].push(treeElement.record_id)})),0===Object.keys(tasks).length?Vtiger_Helper_Js.showPnotify({title:app.vtranslate("JS_INFORMATION"),text:app.vtranslate("JS_NOT_SELECTED_WORKFLOW_TRIGGER"),type:"error"}):(Vtiger_Helper_Js.showPnotify({title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_STARTED_PERFORM_WORKFLOW"),type:"info"}),AppConnector.request({module:app.getModuleName(),action:"Workflow",mode:"execute",user:data.find('[name="user"]').val(),record:detailInstance.getRecordId(),tasks:JSON.stringify(tasks)}).done((function(){Vtiger_Helper_Js.showPnotify({title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_COMPLETED_PERFORM_WORKFLOW"),type:"success"}),app.hideModalWindow(),detailInstance.loadWidgets()})).fail((function(){Vtiger_Helper_Js.showPnotify({title:app.vtranslate("JS_ERROR"),text:app.vtranslate("JS_ERROR_DURING_TRIGGER_OF_WORKFLOW"),type:"error"}),app.hideModalWindow()})))}))};AppConnector.request({module:app.getModuleName(),view:"WorkflowTrigger",record:detailInstance.getRecordId()}).done((function(data){data&&app.showModalWindow(data,"",callback)}))}},{targetPicklistChange:!1,targetPicklist:!1,detailViewContentHolder:!1,detailViewForm:!1,detailViewDetailsTabLabel:"LBL_RECORD_DETAILS",detailViewSummaryTabLabel:"LBL_RECORD_SUMMARY",detailViewRecentCommentsTabLabel:"ModComments",detailViewRecentActivitiesTabLabel:"Activities",detailViewRecentUpdatesTabLabel:"LBL_UPDATES",detailViewRecentDocumentsTabLabel:"Documents",fieldUpdatedEvent:"Vtiger.Field.Updated",updatedFields:["company","designation","title"],fieldPreSave:"Vtiger.Field.PreSave",tempData:[],referenceFieldNames:{Calendar:{Accounts:"link",Leads:"link",Vendors:"link",OSSEmployees:"link",Contacts:"linkextend",Campaigns:"process",HelpDesk:"process",Projects:"process",ServiceContracts:"process"},OutsourcedProducts:{Leads:"parent_id",Accounts:"parent_id",Contacts:"parent_id"},Assets:{Accounts:"parent_id",Contacts:"parent_id"},OSSOutsourcedServices:{Leads:"parent_id",Accounts:"parent_id",Contacts:"parent_id"},OSSSoldServices:{Accounts:"parent_id",Contacts:"parent_id"}},init:function(){},loadWidgetsEvents:function(){var thisInstance=this;app.event.on("DetailView.Widget.AfterLoad",(function(e,widgetContent,relatedModuleName,instance){"Calendar"===relatedModuleName&&thisInstance.reloadWidgetActivitesStats(widgetContent.closest(".activityWidgetContainer")),"ModComments"===relatedModuleName&&thisInstance.registerCommentEventsInDetail(widgetContent.closest(".updatesWidgetContainer")),widgetContent.find('[name="relatedModule"]').length&&thisInstance.registerShowSummary(widgetContent),"OSSMailView"===relatedModuleName&&(Vtiger_Index_Js.registerMailButtons(widgetContent),widgetContent.find(".showMailModal").on("click",(function(e){var progressIndicatorElement=jQuery.progressIndicator();app.showModalWindow("",$(e.currentTarget).data("url")+"&noloadlibs=1",(function(data){Vtiger_Index_Js.registerMailButtons(data),progressIndicatorElement.progressIndicator({mode:"hide"})}))}))),thisInstance.registerEmailEvents(widgetContent),"DetailView"===relatedModuleName&&thisInstance.registerBlockStatusCheckOnLoad()}))},loadWidgets:function(){var thisInstance=this;jQuery('[class^="widgetContainer_"]').each((function(index,widgetContainerELement){var widgetContainer=jQuery(widgetContainerELement);thisInstance.loadWidget(widgetContainer)})),thisInstance.registerRelatedModulesRecordCount()},loadWidget:function(widgetContainer,params){var thisInstance=this,contentContainer=$(".js-detail-widget-content",widgetContainer),relatedModuleName=void 0;if(this.registerFilterForAddingModuleRelatedRecordFromSummaryWidget(widgetContainer),relatedModuleName=widgetContainer.find('[name="relatedModule"]').length?widgetContainer.find('[name="relatedModule"]').val():widgetContainer.data("name"),void 0===params){var urlParams=widgetContainer.data("url");if(null==urlParams)return;var queryParameters=urlParams.split("&"),keyValueMap={},index=void 0;for(index=0;index<queryParameters.length;index++){var queryParamComponents=queryParameters[index].split("=");keyValueMap[queryParamComponents[0]]=queryParamComponents[1]}params=keyValueMap}var aDeferred=$.Deferred();return contentContainer.progressIndicator({}),AppConnector.request({type:"POST",async:!1,dataType:"html",data:params}).done((function(data){if(contentContainer.progressIndicator({mode:"hide"}),contentContainer.html(data),App.Fields.Picklist.showSelect2ElementView(widgetContainer.find(".select2")),app.registerModal(contentContainer),relatedModuleName){var relatedController=Vtiger_RelatedList_Js.getInstance(thisInstance.getRecordId(),app.getModuleName(),thisInstance.getSelectedTab(),relatedModuleName);relatedController.setRelatedContainer(contentContainer),relatedController.registerRelatedEvents(),thisInstance.widgetRelatedRecordView(widgetContainer,!0)}app.event.trigger("DetailView.Widget.AfterLoad",contentContainer,relatedModuleName,thisInstance),aDeferred.resolve(params)})).fail((function(){contentContainer.progressIndicator({mode:"hide"}),aDeferred.reject()})),aDeferred.promise()},widgetRelatedRecordView:function(container,load){var cacheKey=this.getRecordId()+"_"+container.data("id"),relatedRecordCacheID=app.moduleCacheGet(cacheKey);null!==relatedRecordCacheID&&(container.find(".js-carousel-item[data-id = '"+relatedRecordCacheID+"']").length&&(container.find(".js-carousel-item.active").removeClass("active"),container.find(".js-carousel-item[data-id = '"+relatedRecordCacheID+"']").addClass("active")));var controlBox=container.find(".control-widget"),prev=controlBox.find(".prev"),next=controlBox.find(".next"),active=container.find(".js-carousel-item.active");container.find(".js-carousel-item").length<=1||!active.next().length?next.addClass("disabled"):next.removeClass("disabled"),container.find(".js-carousel-item").length<=1||!active.prev().length?prev.addClass("disabled"):prev.removeClass("disabled"),load&&(next.on("click",(function(){if(!$(this).hasClass("disabled")){var active=container.find(".js-carousel-item.active");active.removeClass("active");var nextElement=active.next();nextElement.addClass("active"),nextElement.next().length||next.addClass("disabled"),active.prev()&&prev.removeClass("disabled"),app.moduleCacheSet(cacheKey,nextElement.data("id"))}})),prev.on("click",(function(){if(!$(this).hasClass("disabled")){var active=container.find(".js-carousel-item.active");active.removeClass("active");var prevElement=active.prev();prevElement.addClass("active"),prevElement.prev().length||prev.addClass("disabled"),active.next()&&next.removeClass("disabled"),app.moduleCacheSet(cacheKey,prevElement.data("id"))}})))},loadContents:function(url,data){var thisInstance=this,aDeferred=jQuery.Deferred(),detailContentsHolder=this.getContentHolder(),params=url;return void 0!==data&&((params={}).url=url,params.data=data),AppConnector.requestPjax(params).done((function(responseData){detailContentsHolder.html(responseData),responseData=detailContentsHolder.html(),thisInstance.registerBlockStatusCheckOnLoad(),App.Fields.Picklist.changeSelectElementView(detailContentsHolder),App.Fields.Date.register(detailContentsHolder),thisInstance.getForm().validationEngine(),app.event.trigger("DetailView.LoadContents.AfterLoad",responseData),aDeferred.resolve(responseData)})),aDeferred.promise()},getUpdateFieldsArray:function(){return this.updatedFields},getTabByLabel:function(tabLabel){var tabs=this.getTabs(),targetTab=!1;return tabs.each((function(index,element){var tab=jQuery(element);if(tab.data("labelKey")==tabLabel)return targetTab=tab,!1})),targetTab},getTabByModule:function(moduleName){var relationId=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",tabs=this.getTabs(),targetTab=!1;return tabs.each((function(index,element){var tab=jQuery(element);if(tab.data("reference")==moduleName&&(!relationId||relationId&&relationId==tab.data("relation-id")))return targetTab=tab,!1})),targetTab},selectModuleTab:function(){var moduleTab=this.getTabContainer().find("li.module-tab");this.deSelectAllrelatedTabs(),this.markTabAsSelected(moduleTab)},deSelectAllrelatedTabs:function(){this.getTabs().removeClass("active")},markTabAsSelected:function(tabElement){tabElement.addClass("active"),$('.related .dropdown [data-reference="'+tabElement.data("reference")+'"][data-relation-id="'+tabElement.data("relation-id")+'"]').addClass("active")},reloadTabContent:function(){this.getSelectedTab().trigger("click")},getSelectedTab:function(){return this.getTabContainer().find(".js-detail-tab.active:not(.d-none)")},getTabContainer:function(){return jQuery("div.related")},getTabs:function(){var topTabs=this.getTabContainer().find("li.baseLink:not(.d-none)");return this.getTabContainer().find("li:not(.baseLink)").each((function(n,e){var currentTarget=jQuery(this),iteration=currentTarget.data("iteration"),className=currentTarget.hasClass("mainNav")?"mainNav":"relatedNav";null!=iteration&&topTabs.filter("."+className+'[data-iteration="'+iteration+'"]').length<1&&topTabs.push(currentTarget.get(0))})),topTabs},getContentHolder:function(){return 0==this.detailViewContentHolder&&(this.detailViewContentHolder=jQuery("div.details div.contents")),this.detailViewContentHolder},getForm:function(){return 0==this.detailViewForm&&(this.detailViewForm=jQuery("#detailView")),this.detailViewForm},getRecordId:function(){return app.getRecordId()},getRelatedModuleName:function(){if(1==jQuery(".relatedModuleName",this.getContentHolder()).length)return jQuery(".relatedModuleName",this.getContentHolder()).val()},saveFieldValues:function(fieldDetailList){var aDeferred=jQuery.Deferred(),recordId=this.getRecordId(),data={};void 0!==fieldDetailList&&(data=fieldDetailList),data.record=recordId,data.module=app.getModuleName(),data.action="SaveAjax";var params={};return params.data=data,params.async=!1,params.dataType="json",AppConnector.request(params).done((function(reponseData){aDeferred.resolve(reponseData)})).fail((function(jqXHR,textStatus,errorThrown){aDeferred.reject(jqXHR,textStatus,errorThrown)})),aDeferred.promise()},getRelatedListCurrentPageNum:function(){return jQuery('input[name="currentPageNum"]',this.getContentHolder()).val()},removeCommentBlockIfExists:function(){$(".js-add-comment-block",$(".js-comments-body",this.getContentHolder())).remove()},getCommentThread:function(url){var aDeferred=jQuery.Deferred();return AppConnector.request(url).done((function(data){aDeferred.resolve(data)})).fail((function(error,err){})),aDeferred.promise()},saveCommentAjax:function(element,commentMode,commentContentValue,editCommentReason,commentId,parentCommentId,aDeferred){var thisInstance=this,progressIndicatorElement=jQuery.progressIndicator({}),commentInfoBlock=element.closest(".js-comment-single"),relatedTo=commentInfoBlock.find(".related_to").val();relatedTo||(relatedTo=thisInstance.getRecordId());var postData={commentcontent:commentContentValue.replace(/\/|br|/gi,""),related_to:relatedTo,module:"ModComments"};"edit"==commentMode?(postData.record=commentId,postData.reasontoedit=editCommentReason,postData.parent_comments=parentCommentId,postData.mode="edit",postData.action="Save"):"add"==commentMode&&(postData.parent_comments=commentId,postData.action="SaveAjax"),AppConnector.request(postData).done((function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),"add"==commentMode&&thisInstance.addRelationBetweenRecords("ModComments",data.result.id,thisInstance.getTabByLabel(thisInstance.detailViewRecentCommentsTabLabel)),app.event.trigger("DetailView.SaveComment.AfterAjax",commentInfoBlock,postData,data),aDeferred.resolve(data)})).fail((function(textStatus,errorThrown){progressIndicatorElement.progressIndicator({mode:"hide"}),element.removeAttr("disabled"),aDeferred.reject(textStatus,errorThrown)}))},saveComment:function(e){var aDeferred=jQuery.Deferred(),currentTarget=jQuery(e.currentTarget),commentMode=currentTarget.data("mode"),closestCommentBlock=currentTarget.closest(".js-add-comment-block"),commentContent=closestCommentBlock.find(".js-comment-content"),commentContentValue=commentContent.html(),errorMsg=void 0,editCommentReason=void 0;if(""===commentContentValue)return errorMsg=app.vtranslate("JS_LBL_COMMENT_VALUE_CANT_BE_EMPTY"),commentContent.validationEngine("showPrompt",errorMsg,"error","bottomLeft",!0),aDeferred.reject(errorMsg),aDeferred.promise();"edit"===commentMode&&(editCommentReason=closestCommentBlock.find('[name="reasonToEdit"]').val());var element=jQuery(e.currentTarget),commentInfoHeader=closestCommentBlock.closest(".js-comment-details").find(".js-comment-info-header"),commentId=commentInfoHeader.data("commentid"),parentCommentId=commentInfoHeader.data("parentcommentid");return this.saveCommentAjax(element,commentMode,commentContentValue,editCommentReason,commentId,parentCommentId,aDeferred),aDeferred.promise()},getCommentUI:function(commentId){var aDeferred=jQuery.Deferred(),postData={view:"DetailAjax",module:"ModComments",record:commentId};return AppConnector.request(postData).done((function(data){aDeferred.resolve(data)})).fail((function(error,err){})),aDeferred.promise()},getCommentBlock:function(){var clonedCommentBlock=jQuery(".basicAddCommentBlock",this.getContentHolder()).clone(!0,!0).removeClass("basicAddCommentBlock d-none").addClass("js-add-comment-block");return clonedCommentBlock.find(".commentcontenthidden").removeClass("commentcontenthidden").addClass("js-comment-content"),clonedCommentBlock},getEditCommentBlock:function(){var clonedCommentBlock=jQuery(".basicEditCommentBlock",this.getContentHolder()).clone(!0,!0).removeClass("basicEditCommentBlock d-none").addClass("js-add-comment-block");return clonedCommentBlock.find(".commentcontenthidden").removeClass("commentcontenthidden").addClass("js-comment-content"),new App.Fields.Text.Completions(clonedCommentBlock.find(".js-completions"),{emojiPanel:!1}),clonedCommentBlock},registerSendSmsSubmitEvent:function(){var thisInstance=this;jQuery("body").on("submit","#massSave",(function(e){var form=jQuery(e.currentTarget);if(form.find("#message").html().length>160){var params={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("LBL_SMS_MAX_CHARACTERS_ALLOWED"),type:"error"};return Vtiger_Helper_Js.showPnotify(params),!1}form.find(":submit").attr("disabled","disabled"),thisInstance.SendSmsSave(form),e.preventDefault()}))},SendSmsSave:function(form){var progressInstance=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),SendSmsUrl=form.serializeFormData();AppConnector.request(SendSmsUrl).done((function(data){app.hideModalWindow(),progressInstance.progressIndicator({mode:"hide"})})).fail((function(error,err){}))},registerNameAjaxEditEvent:function(){var thisInstance=this,detailContentsHolder=thisInstance.getContentHolder();detailContentsHolder.on(thisInstance.fieldUpdatedEvent,".nameField",(function(e,params){var form=thisInstance.getForm(),nameFields=form.data("nameFields"),recordLabel="";for(var index in nameFields){0!=index&&(recordLabel+=" ");var nameFieldName=nameFields[index];recordLabel+=form.find('[name="'+nameFieldName+'"]').val()}detailContentsHolder.closest(".contentsDiv").find(".recordLabel").text(recordLabel)}))},updateHeaderNameFields:function(){var detailContentsHolder=this.getContentHolder(),form=this.getForm(),nameFields=form.data("nameFields"),recordLabelElement=detailContentsHolder.closest(".contentsDiv").find(".recordLabel"),title="";for(var index in nameFields){var nameFieldName=nameFields[index],nameField=form.find('[name="'+nameFieldName+'"]');if(nameField.length>0){var recordLabel=nameField.val();title+=recordLabel+" ",recordLabelElement.find('[class="'+nameFieldName+'"]').text(recordLabel)}}var salutatioField=recordLabelElement.find(".salutation");salutatioField.length>0&&(title=salutatioField.text()+title);recordLabelElement.attr("title",title)},registerAjaxEditEvent:function(){var thisInstance=this;thisInstance.getContentHolder().on(thisInstance.fieldUpdatedEvent,"input,select,textarea",(function(e){thisInstance.updateHeaderValues(jQuery(e.currentTarget))}))},updateHeaderValues:function(currentElement){if(currentElement.hasClass("nameField"))return this.updateHeaderNameFields(),!0;var name=currentElement.attr("name"),updatedFields=this.getUpdateFieldsArray(),detailContentsHolder=this.getContentHolder();if("-1"!=jQuery.inArray(name,updatedFields)){var recordLabel=currentElement.val();detailContentsHolder.closest(".contentsDiv").find("."+name+"_label").text(recordLabel)}},registerEmailFieldClickEvent:function(){this.getContentHolder().on("click",".emailField",(function(e){e.stopPropagation()}))},registerPhoneFieldClickEvent:function(){this.getContentHolder().on("click",".phoneField",(function(e){e.stopPropagation()}))},registerUrlFieldClickEvent:function(){this.getContentHolder().on("click",".urlField",(function(e){e.stopPropagation()}))},registerRelatedRowClickEvent:function(){this.getContentHolder().on("click",".listViewEntries",(function(e){var targetElement=jQuery(e.target,jQuery(e.currentTarget));if(!(targetElement.is("td:first-child")&&targetElement.children('input[type="checkbox"]').length>0||jQuery(e.target).is('input[type="checkbox"]'))){var recordUrl=jQuery(e.currentTarget).data("recordurl");void 0!==recordUrl&&(window.location.href=recordUrl)}}))},loadRelatedList:function(params){var aDeferred=jQuery.Deferred();return null==params&&(params={}),Vtiger_RelatedList_Js.getInstance(this.getRecordId(),app.getModuleName(),this.getSelectedTab(),this.getRelatedModuleName()).loadRelatedList(params).done((function(data){aDeferred.resolve(data)}),(function(textStatus,errorThrown){aDeferred.reject(textStatus,errorThrown)})),aDeferred.promise()},registerEventForRelatedList:function(){var thisInstance=this,detailContentsHolder=this.getContentHolder(),relatedModuleName=thisInstance.getRelatedModuleName();if(relatedModuleName){var relatedController=Vtiger_RelatedList_Js.getInstance(thisInstance.getRecordId(),app.getModuleName(),thisInstance.getSelectedTab(),relatedModuleName);relatedController.setRelatedContainer(detailContentsHolder),relatedController.registerRelatedEvents()}detailContentsHolder.find(".detailViewBlockLink").each((function(n,block){var blockContent=(block=$(block)).find(".blockContent");blockContent.is(":visible")&&AppConnector.request({type:"GET",dataType:"html",data:block.data("url")}).done((function(response){blockContent.html(response);var relatedController=Vtiger_RelatedList_Js.getInstance(thisInstance.getRecordId(),app.getModuleName(),thisInstance.getSelectedTab(),block.data("reference"));relatedController.setRelatedContainer(blockContent),relatedController.registerRelatedEvents()}))})),detailContentsHolder.find(".detailViewBlockLink .blockHeader").on("click",(function(e){var target=$(e.target);if(target.is("input")||target.is("button")||target.parents().is("button")||target.hasClass("js-stop-propagation")||target.parents().hasClass("js-stop-propagation"))return!1;var block=$(this).closest(".js-toggle-panel"),blockContent=block.find(".blockContent"),isEmpty=blockContent.is(":empty");blockContent.is(":visible")||(blockContent.progressIndicator(),AppConnector.request({type:"GET",dataType:"html",data:block.data("url")}).done((function(response){blockContent.html(response);var relatedController=Vtiger_RelatedList_Js.getInstance(thisInstance.getRecordId(),app.getModuleName(),thisInstance.getSelectedTab(),block.data("reference"));relatedController.setRelatedContainer(blockContent),isEmpty?relatedController.registerRelatedEvents():relatedController.registerPostLoadEvents()})))}))},registerBlockAnimationEvent:function(){var thisInstance=this;this.getContentHolder().find(".blockHeader").on("click",(function(e){var target=$(e.target);if(target.is("input")||target.is("button")||target.parents().is("button")||target.hasClass("js-stop-propagation")||target.parents().hasClass("js-stop-propagation"))return!1;var currentTarget=$(this).find(".js-block-toggle").not(".d-none"),blockId=currentTarget.data("id"),closestBlock=currentTarget.closest(".js-toggle-panel"),bodyContents=closestBlock.find(".blockContent"),data=currentTarget.data(),module=app.getModuleName();"show"===data.mode?(bodyContents.addClass("d-none"),app.cacheSet(module+"."+blockId,0),currentTarget.addClass("d-none"),closestBlock.find('[data-mode="hide"]').removeClass("d-none")):(bodyContents.removeClass("d-none"),app.cacheSet(module+"."+blockId,1),currentTarget.addClass("d-none"),closestBlock.find('[data-mode="show"]').removeClass("d-none")),app.event.trigger("DetailView.js-block-toggle.PostLoad",bodyContents,data,thisInstance)}))},registerBlockStatusCheckOnLoad:function(){var blocks=this.getContentHolder().find(".js-toggle-panel"),module=app.getModuleName();blocks.each((function(index,block){var currentBlock=jQuery(block),dynamicAttr=currentBlock.attr("data-dynamic");if("undefined"!==(void 0===dynamicAttr?"undefined":_typeof(dynamicAttr))&&!1!==dynamicAttr){var headerAnimationElement=currentBlock.find(".js-block-toggle").not(".d-none"),bodyContents=currentBlock.closest(".js-toggle-panel").find(".blockContent"),blockId=headerAnimationElement.data("id"),cacheKey=module+"."+blockId,value=app.cacheGet(cacheKey,null);null!=value&&(1==value?(headerAnimationElement.addClass("d-none"),currentBlock.find("[data-mode='show']").removeClass("d-none"),bodyContents.removeClass("d-none")):(headerAnimationElement.addClass("d-none"),currentBlock.find("[data-mode='hide']").removeClass("d-none"),bodyContents.addClass("d-none")))}}))},ajaxEditHandling:function(currentTdElement){var thisInstance=this,readRecord=$(".setReadRecord"),detailViewValue=$(".value",currentTdElement),editElement=$(".edit",currentTdElement),actionElement=$(".js-detail-quick-edit",currentTdElement),fieldElement=$(".fieldname",editElement);readRecord.prop("disabled",!0),$(fieldElement).each((function(index,element){var fieldName=$(element).val(),elementTarget=$(element),elementName=-1!=$.inArray(elementTarget.data("type"),["taxes","sharedOwner","multipicklist","multiListFields","multiDomain","mailScannerFields","mailScannerActions"])?fieldName+"[]":fieldName,fieldElement=$('[name="'+elementName+'"]:not([type="hidden"])',editElement);if("disabled"!=fieldElement.attr("disabled")&&!(editElement.length<=0||editElement.is(":visible"))){fieldElement.attr("data-inputmask")&&fieldElement.inputmask(),detailViewValue.addClass("d-none"),actionElement.addClass("d-none"),editElement.removeClass("d-none").children().filter('input[type!="hidden"]input[type!="image"],select').filter(":first").focus();editElement.on("clickoutside",(function(e){thisInstance.registerNameAjaxEditEvent();var element=$(e.target);if(!($(e.currentTarget).find(".dateTimePickerField").length&&(element.closest(".drp-calendar").length||element.hasClass("drp-calendar"))||element.closest(".fieldValue").is(currentTdElement)||element.hasClass("select2-selection__choice__remove")||element.closest(".select2-container--open").length||element.parents(".clockpicker-popover").length)){currentTdElement.removeAttr("tabindex"),currentTdElement.removeClass("is-edit-active");var previousValue=elementTarget.data("prevValue"),ajaxEditNewValue=elementTarget.closest(".edit").find('[name="'+elementTarget.val()+'"]').val(),fieldInfo=Vtiger_Field_Js.getInstance(fieldElement.data("fieldinfo")),dateTimeField=[],dateTime=!1;if(2==editElement.find("[data-fieldinfo]").length&&editElement.find("[data-fieldinfo]").each((function(){var field={name:$(this).attr("name"),type:$(this).data("fieldinfo").type};"datetime"==field.type&&(dateTime=!0),dateTimeField.push(field)})),fieldElement.is("input:checkbox")&&(ajaxEditNewValue=fieldElement.is(":checked")?"1":"0",fieldElement=fieldElement.filter('[type="checkbox"]')),fieldElement.validationEngine("validate"))fieldElement.attr("data-inputmask")&&fieldElement.inputmask();else if(fieldElement.validationEngine("hide"),toStr(previousValue)===toStr(ajaxEditNewValue))editElement.addClass("d-none"),detailViewValue.removeClass("d-none"),actionElement.removeClass("d-none"),readRecord.prop("disabled",!1),editElement.off("clickoutside");else{var preFieldSaveEvent=jQuery.Event(thisInstance.fieldPreSave),fieldNameValueMap={};if(fieldElement.trigger(preFieldSaveEvent,{fieldValue:ajaxEditNewValue,recordId:thisInstance.getRecordId()}),preFieldSaveEvent.isDefaultPrevented())return void readRecord.prop("disabled",!1);currentTdElement.progressIndicator(),editElement.addClass("d-none"),fieldNameValueMap.value=ajaxEditNewValue,fieldNameValueMap.field=fieldName,fieldNameValueMap=thisInstance.getCustomFieldNameValueMap(fieldNameValueMap),thisInstance.saveFieldValues(fieldNameValueMap).done((function(response){if(editElement.off("clickoutside"),readRecord.prop("disabled",!1),currentTdElement.progressIndicator({mode:"hide"}),detailViewValue.removeClass("d-none"),actionElement.removeClass("d-none"),response.success){var postSaveRecordDetails=response.result,displayValue=postSaveRecordDetails[fieldName].display_value,prevDisplayValue=postSaveRecordDetails[fieldName].prev_display_value;if(dateTimeField.length&&dateTime&&(displayValue=postSaveRecordDetails[dateTimeField[0].name].display_value+" "+postSaveRecordDetails[dateTimeField[1].name].display_value),detailViewValue.html(displayValue),Vtiger_Helper_Js.showPnotify({title:app.vtranslate("JS_SAVE_NOTIFY_OK"),text:"<b>"+fieldInfo.data.label+"</b><br><b>"+app.vtranslate("JS_SAVED_FROM")+"</b>: "+prevDisplayValue+"<br> <b>"+app.vtranslate("JS_SAVED_TO")+"</b>: "+displayValue,type:"info",textTrusted:!0}),!1===postSaveRecordDetails.isViewable){var urlObject=app.convertUrlToObject(window.location.href);window!==window.parent?window.parent.location.href="index.php?module="+urlObject.module+"&view=ListPreview":window.location.href="index.php?module="+urlObject.module+"&view=List"}else!1===postSaveRecordDetails.isEditable&&($.progressIndicator({position:"html",blockInfo:{enabled:!0}}),window!==window.parent?window.location.href=window.location.href.replace("view=Detail","view=DetailPreview"):window.location.reload());fieldElement.trigger(thisInstance.fieldUpdatedEvent,{old:previousValue,new:ajaxEditNewValue}),ajaxEditNewValue=void 0===ajaxEditNewValue?"":ajaxEditNewValue,elementTarget.data("prevValue",ajaxEditNewValue),fieldElement.data("selectedValue",ajaxEditNewValue),thisInstance.targetPicklistChange&&($(".js-widget-general-info",thisInstance.getForm()).length>0?thisInstance.targetPicklist.find(".js-detail-quick-edit").trigger("click"):thisInstance.targetPicklist.trigger("click"),thisInstance.targetPicklistChange=!1,thisInstance.targetPicklist=!1);var selectedTabElement=thisInstance.getSelectedTab();if(selectedTabElement.data("linkKey")==thisInstance.detailViewSummaryTabLabel){var detailContentsHolder=thisInstance.getContentHolder();thisInstance.reloadTabContent(),thisInstance.registerSummaryViewContainerEvents(detailContentsHolder),thisInstance.registerEventForPicklistDependencySetup(thisInstance.getForm()),thisInstance.registerEventForRelatedList()}else selectedTabElement.data("linkKey")==thisInstance.detailViewDetailsTabLabel&&thisInstance.registerEventForPicklistDependencySetup(thisInstance.getForm());thisInstance.updateRecordsPDFTemplateBtn(thisInstance.getForm())}})).fail((function(jqXHR,textStatus,errorThrown){editElement.addClass("d-none"),detailViewValue.removeClass("d-none"),actionElement.removeClass("d-none"),editElement.off("clickoutside"),readRecord.prop("disabled",!1),currentTdElement.progressIndicator({mode:"hide"}),Vtiger_Helper_Js.showPnotify({type:"error",title:app.vtranslate("JS_SAVE_NOTIFY_FAIL"),text:textStatus})}))}}function toStr(v){return null==v?"":v+""}}))}}))},triggerDisplayTypeEvent:function(){var widthType=app.cacheGet("widthType","narrowWidthType");widthType&&jQuery("#detailView").find("td").addClass(widthType)},addElementsToQuickCreateForCreatingRelation:function(container,customParams){jQuery('<input type="hidden" name="relationOperation" value="true" >').appendTo(container),jQuery.each(customParams,(function(index,value){jQuery('<input type="hidden" name="'+index+'" value="'+value+'" >').appendTo(container)}))},registerEventForActivityWidget:function(){var thisInstance=this;jQuery(".createActivity").on("click",(function(e){var recordId=thisInstance.getRecordId(),module=app.getModuleName(),element=jQuery(e.currentTarget),customParams={};if(customParams.sourceModule=module,customParams.sourceRecord=recordId,""!=module&&void 0!==thisInstance.referenceFieldNames.Calendar&&void 0!==thisInstance.referenceFieldNames.Calendar[module]){var relField=thisInstance.referenceFieldNames.Calendar[module];customParams[relField]=recordId}var fullFormUrl=element.data("url"),QuickCreateParams={callbackPostShown:function(data){thisInstance.addElementsToQuickCreateForCreatingRelation(data,customParams);var taskGoToFullFormButton=data.find('[class^="CalendarQuikcCreateContents"]').find(".js-full-editlink"),eventsGoToFullFormButton=data.find('[class^="EventsQuikcCreateContents"]').find(".js-full-editlink"),taskFullFormUrl=taskGoToFullFormButton.data("url")+"&"+fullFormUrl,eventsFullFormUrl=eventsGoToFullFormButton.data("url")+"&"+fullFormUrl;taskGoToFullFormButton.data("url",taskFullFormUrl),eventsGoToFullFormButton.data("url",eventsFullFormUrl)},callbackFunction:function(){var widgetContainer=element.closest(".js-detail-widget"),params={type:"GET",dataType:"html",data:widgetContainer.find(".widgetContentBlock").data("url")};AppConnector.request(params).done((function(data){var activitiesWidget=widgetContainer.find(".js-detail-widget-content");activitiesWidget.html(data),App.Fields.Picklist.changeSelectElementView(activitiesWidget),thisInstance.loadWidget($('.widgetContentBlock[data-type="Updates"]')),thisInstance.loadWidget($('.widgetContentBlock[data-name="Calendar"]'))}))}};QuickCreateParams.data=Object.assign({},customParams),QuickCreateParams.noCache=!1,Vtiger_Header_Js.getInstance().quickCreateModule("Calendar",QuickCreateParams)}))},getEndDate:function(startDate){var dateTab=startDate.split("-"),date=new Date(dateTab[0],dateTab[1],dateTab[2]),newDate=new Date;return newDate.setDate(date.getDate()+2),app.getStringDate(newDate)},getSingleEventType:function(modDay,id,type){var dateStartEl=jQuery('[name="date_start"]'),dateStartVal=jQuery(dateStartEl).val(),dateStartFormat=jQuery(dateStartEl).data("date-format"),validDateFromat=Vtiger_Helper_Js.convertToDateString(dateStartVal,dateStartFormat,modDay,type),map=jQuery.extend({},["#b6a996,black"]),params={module:"Calendar",action:"Feed",start:validDateFromat,end:this.getEndDate(validDateFromat),type:type,mapping:map};AppConnector.request(params).done((function(events){var testDate=Vtiger_Helper_Js.convertToDateString(dateStartVal,dateStartFormat,modDay);if(!jQuery.isEmptyObject(events))if("Task"===events[0].activitytype)for(var ev in events)events[ev].start.indexOf(testDate)>-1&&jQuery("#"+id+" .table").append('<tr><td><a target="_blank" href="'+events[ev].url+'">'+events[ev].title+"</a></td></tr>");else for(var i=0;i<events[0].length;i++)events[0][i].start.indexOf(testDate)>-1&&jQuery("#"+id+" .table").append('<tr><td><a target="_blank" href="'+events[0][i].url+'">'+events[0][i].title+"</a></td></tr>")}))},registerFilterForAddingModuleRelatedRecordFromSummaryWidget:function(container){var thisInstance=this;container.find(".createRecordFromFilter").on("click",(function(e){var currentElement=jQuery(e.currentTarget),referenceModuleName=currentElement.closest(".js-detail-widget").data("moduleName"),quickcreateUrl=currentElement.data("url"),parentId=thisInstance.getRecordId(),quickCreateParams={},relatedField=currentElement.data("prf"),autoCompleteFields=currentElement.data("acf"),moduleName=currentElement.closest(".js-detail-widget-header").find('[name="relatedModule"]').val(),relatedParams={};void 0!==relatedField&&(relatedParams[relatedField]=parentId),void 0!==autoCompleteFields&&$.each(autoCompleteFields,(function(index,value){relatedParams[index]=value})),Object.keys(relatedParams).length>0&&(quickCreateParams.data=relatedParams),quickCreateParams.noCache=!0,quickCreateParams.callbackFunction=function(data){thisInstance.postSummaryWidgetAddRecord(data,currentElement),"ProjectTask"==referenceModuleName&&thisInstance.loadModuleSummary()};var progress=jQuery.progressIndicator({blockInfo:{enabled:!0}}),headerInstance=void 0;(headerInstance=window!==window.parent?window.parent.Vtiger_Header_Js.getInstance():Vtiger_Header_Js.getInstance()).getQuickCreateForm(quickcreateUrl,moduleName,quickCreateParams).done((function(data){headerInstance.handleQuickCreateData(data,quickCreateParams),progress.progressIndicator({mode:"hide"})}))})),container.find("button.selectRelation").on("click",(function(e){var summaryWidgetContainer=jQuery(e.currentTarget).closest(".js-detail-widget"),referenceModuleName=summaryWidgetContainer.data("moduleName"),restrictionsField=$(this).data("rf"),params={module:referenceModuleName,src_module:app.getModuleName(),src_record:thisInstance.getRecordId(),multi_select:!0,relationId:summaryWidgetContainer.data("relationId")};restrictionsField&&Object.keys(restrictionsField).length>0&&(params.search_key=restrictionsField.key,params.search_value=restrictionsField.name),app.showRecordsList(params,(function(modal,instance){instance.setSelectEvent((function(responseData){thisInstance.addRelationBetweenRecords(referenceModuleName,Object.keys(responseData)).done((function(data){thisInstance.loadWidget(summaryWidgetContainer.find(".widgetContentBlock"))}))}))}))}))},registerAddingInventoryRecords:function(){jQuery(".createInventoryRecordFromFilter").on("click",(function(e){var currentElement=jQuery(e.currentTarget),createUrl=currentElement.data("url"),autoCompleteFields=currentElement.data("acf"),addidtionalParams="";void 0!==autoCompleteFields&&$.each(autoCompleteFields,(function(index,value){addidtionalParams="&"+index+"="+value,createUrl=createUrl.concat(addidtionalParams)})),window.location.href=createUrl}))},registerEmailEvent:function(){this.getContentHolder().find(".resetRelationsEmail").on("click",(function(e){Vtiger_Helper_Js.showConfirmationBox({message:app.vtranslate("JS_EMAIL_RESET_RELATIONS_CONFIRMATION")}).done((function(data){AppConnector.request({module:"OSSMailView",action:"Relation",moduleName:app.getModuleName(),record:app.getRecordId()}).done((function(d){Vtiger_Helper_Js.showMessage({text:d.result})}))}))}))},getFiltersDataAndLoad:function(e,params){var data=this.getFiltersData(e,params);this.loadWidget(data.container,data.params)},getFiltersData:function(e,params){if(e.currentTarget)var currentElement=jQuery(e.currentTarget);else currentElement=e;var summaryWidgetContainer=currentElement.closest(".js-detail-widget"),widget=summaryWidgetContainer.find(".widgetContentBlock"),url="&"+widget.data("url"),urlParams={};url.replace(/[?&]+([^=&]+)=([^&]*)/gi,(function(m,key,value){urlParams[key]=value}));var urlNewParams=[];return summaryWidgetContainer.find(".js-detail-widget .js-switch, .js-detail-widget-header .js-filter_field").each((function(n,item){var value="",element=jQuery(item),name=element.data("urlparams");if("radio"==element.attr("type"))element.prop("checked")&&(value=void 0!==element.data("on-val")?element.data("on-val"):element.data("off-val"));else{var selectedFilter=element.find("option:selected").val(),fieldlable=element.data("fieldlable"),filter=element.data("filter");if(selectedFilter==fieldlable)return;value=[[filter,"e",selectedFilter]]}name&&value&&(name in urlNewParams?urlNewParams[name].push(value):urlNewParams[name]=[value])})),null!=params&&$.extend(urlNewParams,params),{container:$(widget),params:$.extend(urlParams,urlNewParams)}},registerChangeFilterForWidget:function(){var thisInstance=this;jQuery(".js-switch").on("change",(function(e,state){$(e.currentTarget).closest(".js-switch__btn").addClass("active").siblings().removeClass("active"),thisInstance.getFiltersDataAndLoad(e)})),jQuery(".js-filter_field").on("select2:select",(function(e,state){thisInstance.getFiltersDataAndLoad(e)}))},registerChangeSwitchForWidget:function(summaryViewContainer){var thisInstance=this;summaryViewContainer.find(".activityWidgetContainer").on("change",".js-switch",(function(e){var currentElement=jQuery(e.currentTarget),summaryWidgetContainer=currentElement.closest(".js-detail-widget"),widget=summaryWidgetContainer.find(".widgetContentBlock"),url=widget.data("url");url=url.replace("&type=current","").replace("&type=history",""),url+="&type=",void 0!==currentElement.data("on-val")?(summaryWidgetContainer.find(".ativitiesPagination").removeClass("d-none"),url=(url+="current").replace("&sortorder=DESC","&sortorder=ASC")):void 0!==currentElement.data("off-val")&&(summaryWidgetContainer.find(".ativitiesPagination").addClass("d-none"),url=(url+="history").replace("&sortorder=ASC","&sortorder=DESC")),widget.data("url",url),thisInstance.loadWidget($(widget))}))},registerSummaryViewContainerEvents:function(summaryViewContainer){var thisInstance=this;this.registerEventForActivityWidget(),this.registerChangeFilterForWidget(),this.registerChangeSwitchForWidget(summaryViewContainer),this.registerAddingInventoryRecords(),this.registerEmailEvent(),summaryViewContainer.off("click").on("click",".row .js-detail-quick-edit",(function(e){var currentTarget=jQuery(e.currentTarget);currentTarget.addClass("d-none");var currentTdElement=currentTarget.closest(".fieldValue");thisInstance.ajaxEditHandling(currentTdElement)})),summaryViewContainer.on(thisInstance.fieldUpdatedEvent,".js-widget-general-info",(function(){var updatesWidget=summaryViewContainer.find("[data-type='Updates']"),params=void 0;updatesWidget.length&&(params=thisInstance.getFiltersData(updatesWidget),updatesWidget.find(".btnChangesReviewedOn").parent().remove(),thisInstance.loadWidget(updatesWidget,params.params))})),summaryViewContainer.on("click",".editDefaultStatus",(function(e){var currentTarget=jQuery(e.currentTarget);currentTarget.popover("hide");var url=currentTarget.data("url");if(url)if(currentTarget.hasClass("showEdit")){var headerInstance=Vtiger_Header_Js.getInstance();window!==window.parent&&(headerInstance=window.parent.Vtiger_Header_Js.getInstance()),headerInstance.getQuickCreateForm(url,"Calendar",{noCache:!0}).done((function(data){headerInstance.handleQuickCreateData(data,{callbackFunction:function(){var widget=currentTarget.closest(".widgetContentBlock");if(widget.length){thisInstance.loadWidget(widget);var updatesWidget=thisInstance.getContentHolder().find("[data-type='Updates']");updatesWidget.length>0&&thisInstance.loadWidget(updatesWidget)}else thisInstance.loadRelatedList();thisInstance.registerRelatedModulesRecordCount()}})}))}else app.showModalWindow(null,url)})),summaryViewContainer.on("click",".editDescription",(function(e){var currentTarget=jQuery(e.currentTarget),currentDiv=currentTarget.closest(".activityDescription"),editElement=currentDiv.find(".edit"),detailViewElement=currentDiv.find(".value"),descriptionText=currentDiv.find(".js-description-text"),descriptionEmpty=currentDiv.find(".js-no-description"),saveButton=currentDiv.find(".js-save-description"),closeButton=currentDiv.find(".js-close-description"),activityButtonContainer=currentDiv.find(".js-activity-buttons__container"),fieldnameElement=jQuery(".fieldname",editElement),fieldName=fieldnameElement.val(),fieldElement=jQuery('[name="'+fieldName+'"]',editElement),closeDescription=function(){fieldElement.val(fieldnameElement.data("prevValue")),editElement.add(activityButtonContainer).addClass("d-none"),detailViewElement.removeClass("d-none"),currentTarget.show()};currentTarget.hide(),detailViewElement.addClass("d-none"),activityButtonContainer.removeClass("d-none"),editElement.removeClass("d-none").show(),saveButton.off("click").one("click",(function callbackFunction(){var previousValue=fieldnameElement.data("prevValue"),ajaxEditNewValue=fieldElement.val(),ajaxEditNewLable=fieldElement.val(),activityDiv=currentDiv.closest(".activityEntries"),activityId=activityDiv.find(".activityId").val(),moduleName=activityDiv.find(".activityModule").val(),activityType=activityDiv.find(".activityType").val();if(previousValue!=ajaxEditNewValue)return currentDiv.progressIndicator(),editElement.add(activityButtonContainer).addClass("d-none"),new Promise((function(resolve,reject){resolve(fieldElement.validationEngine("validate"))})).then((function(errorExists){errorExists?Vtiger_Helper_Js.addClickOutSideEvent(currentDiv,callbackFunction):(ajaxEditNewValue=fieldElement.val(),AppConnector.request({action:"SaveAjax",record:activityId,field:fieldName,value:ajaxEditNewValue,module:moduleName,activitytype:activityType}).done((function(){currentDiv.progressIndicator({mode:"hide"}),detailViewElement.removeClass("d-none"),currentTarget.show(),descriptionText.html(ajaxEditNewLable),fieldnameElement.data("prevValue",ajaxEditNewValue),""===ajaxEditNewValue?descriptionEmpty.removeClass("d-none"):descriptionEmpty.addClass("d-none")})))}));closeDescription()})),closeButton.off("click").one("click",closeDescription)})),jQuery(".changeDetailViewMode").on("click",(function(e){thisInstance.getTabs().filter('[data-link-key="'+thisInstance.detailViewDetailsTabLabel+'"]:not(.d-none)').trigger("click")})),jQuery(".createRecord").on("click",(function(e){var currentElement=jQuery(e.currentTarget),referenceModuleName=currentElement.closest(".js-detail-widget").find(".js-detail-widget-header").find('[name="relatedModule"]').val(),recordId=thisInstance.getRecordId(),module=app.getModuleName(),customParams={};if(customParams.sourceModule=module,customParams.sourceRecord=recordId,""!=module&&""!=referenceModuleName&&void 0!==thisInstance.referenceFieldNames[referenceModuleName]&&void 0!==thisInstance.referenceFieldNames[referenceModuleName][module]){var fieldName=thisInstance.referenceFieldNames[referenceModuleName][module];customParams[fieldName]=recordId}var QuickCreateParams={callbackFunction:function(data){thisInstance.postSummaryWidgetAddRecord(data,currentElement)},goToFullFormcallback:function(data){thisInstance.addElementsToQuickCreateForCreatingRelation(data,customParams)}};QuickCreateParams.data=customParams,QuickCreateParams.noCache=!1,Vtiger_Header_Js.getInstance().quickCreateModule(referenceModuleName,QuickCreateParams)})),this.registerFastEditingFiels()},addRelationBetweenRecords:function(relatedModule,relatedModuleRecordId,selectedTabElement){var aDeferred=jQuery.Deferred(),thisInstance=this;return null==selectedTabElement&&(selectedTabElement=thisInstance.getSelectedTab()),Vtiger_RelatedList_Js.getInstance(thisInstance.getRecordId(),app.getModuleName(),selectedTabElement,relatedModule).addRelations(relatedModuleRecordId).done((function(data){var updatesWidget=thisInstance.getContentHolder().find("[data-type='Updates']");if(updatesWidget.length>0){var params=thisInstance.getFiltersData(updatesWidget);updatesWidget.find(".btnChangesReviewedOn").parent().remove(),thisInstance.loadWidget(updatesWidget,params.params)}aDeferred.resolve(data)})).fail((function(textStatus,errorThrown){aDeferred.reject(textStatus,errorThrown)})),aDeferred.promise()},postSummaryWidgetAddRecord:function(data,currentElement){var thisInstance=this,summaryWidgetContainer=currentElement.closest(".js-detail-widget"),referenceModuleName=summaryWidgetContainer.find(".js-detail-widget-header").find('[name="relatedModule"]').val(),idList=[];idList.push(data.result._recordId),this.addRelationBetweenRecords(referenceModuleName,idList).done((function(data){thisInstance.loadWidget(summaryWidgetContainer.find('[class^="widgetContainer_"]'))}))},registerChangeEventForModulesList:function(){jQuery("#tagSearchModulesList").on("change",(function(e){var modulesSelectElement=jQuery(e.currentTarget);if("all"==modulesSelectElement.val())jQuery('[name="tagSearchModuleResults"]').removeClass("d-none");else{jQuery('[name="tagSearchModuleResults"]').removeClass("d-none");var selectedOptionValue=modulesSelectElement.val();jQuery('[name="tagSearchModuleResults"]').filter(":not(#"+selectedOptionValue+")").addClass("d-none")}}))},registerEventForRelatedTabClick:function(){var thisInstance=this,detailContentsHolder=thisInstance.getContentHolder(),detailContainer=detailContentsHolder.closest("div.detailViewInfo");jQuery(".related",detailContainer).on("click","li:not(.spaceRelatedList)",(function(e,urlAttributes){var tabElement=jQuery(e.currentTarget);if(!tabElement.hasClass("dropdown")){var element=jQuery("<div></div>");element.progressIndicator({position:"html",blockInfo:{enabled:!0,elementToBlock:detailContainer}});var url=tabElement.data("url");if(void 0!==urlAttributes){var callBack=urlAttributes.callback;delete urlAttributes.callback}thisInstance.loadContents(url,urlAttributes).done((function(data){thisInstance.deSelectAllrelatedTabs(),thisInstance.markTabAsSelected(tabElement),Vtiger_Helper_Js.showHorizontalTopScrollBar(),element.progressIndicator({mode:"hide"}),thisInstance.registerHelpInfo(),app.registerModal(detailContentsHolder),"function"==typeof callBack&&callBack(data),tabElement.data("linkKey")==thisInstance.detailViewSummaryTabLabel&&thisInstance.loadWidgets(),thisInstance.registerBasicEvents(),app.notifyPostAjaxReady(),app.event.trigger("DetailView.Tab.AfterLoad",data,thisInstance)})).fail((function(){element.progressIndicator({mode:"hide"})}))}}))},registerEventForPicklistDependencySetup:function(container){var thisInstance=this,picklistDependcyElemnt=jQuery('[name="picklistDependency"]',container);if(!(picklistDependcyElemnt.length<=0)){var picklistDependencyMapping=JSON.parse(picklistDependcyElemnt.val()),sourcePicklists=Object.keys(picklistDependencyMapping);if(!(sourcePicklists.length<=0)){for(var sourcePickListNames=[],i=0;i<sourcePicklists.length;i++)sourcePickListNames.push('[name="'+sourcePicklists[i]+'"]');sourcePickListNames=sourcePickListNames.join(",");var sourcePickListElements=container.find(sourcePickListNames);sourcePickListElements.on("change",(function(e){var currentElement=jQuery(e.currentTarget),sourcePicklistname=currentElement.attr("name"),configuredDependencyObject=picklistDependencyMapping[sourcePicklistname],targetObjectForSelectedSourceValue=configuredDependencyObject[currentElement.val()],picklistmap=configuredDependencyObject.__DEFAULT__;void 0===targetObjectForSelectedSourceValue&&(targetObjectForSelectedSourceValue=picklistmap),jQuery.each(picklistmap,(function(targetPickListName,targetPickListValues){var targetPickListMap=targetObjectForSelectedSourceValue[targetPickListName];void 0===targetPickListMap&&(targetPickListMap=targetPickListValues);var targetPickList=jQuery('[name="'+targetPickListName+'"]',container);if(!(targetPickList.length<=0)){var selectedValue=targetPickList.data("selectedValue");-1==jQuery.inArray(selectedValue,targetPickListMap)?(thisInstance.targetPicklistChange=!0,thisInstance.targetPicklist=targetPickList.closest("td")):(thisInstance.targetPicklistChange=!1,thisInstance.targetPicklist=!1);var listOfAvailableOptions=targetPickList.data("availableOptions");void 0===listOfAvailableOptions&&(listOfAvailableOptions=jQuery("option",targetPickList),targetPickList.data("available-options",listOfAvailableOptions));var targetOptions=new jQuery,optionSelector=[];optionSelector.push("");for(var i=0;i<targetPickListMap.length;i++)optionSelector.push(targetPickListMap[i]);jQuery.each(listOfAvailableOptions,(function(i,e){var picklistValue=jQuery(e).val();-1!=jQuery.inArray(picklistValue,optionSelector)&&(targetOptions=targetOptions.add(jQuery(e)))}));var targetPickListSelectedValue="";targetPickListSelectedValue=targetOptions.filter("[selected]").val(),1==targetPickListMap.length&&(targetPickListSelectedValue=targetPickListMap[0]),targetPickList.html(targetOptions).val(targetPickListSelectedValue).trigger("change")}}))})),sourcePickListElements.trigger("change")}}},getChildComments:function(commentId){var aDeferred=jQuery.Deferred(),url="module="+app.getModuleName()+"&view=Detail&record="+this.getRecordId()+"&mode=showChildComments&commentid="+commentId;return this.getCommentThread(url).done((function(data){aDeferred.resolve(data)})),aDeferred.promise()},getParentComments:function(commentId){var aDeferred=$.Deferred(),url="module="+app.getModuleName()+"&view=Detail&record="+this.getRecordId()+"&mode=showParentComments&commentid="+commentId;return this.getCommentThread(url).done((function(data){aDeferred.resolve(data)})),aDeferred.promise()},registerEventForTotalRecordsCount:function(){var thisInstance=this;this.getContentHolder().on("click",".totalNumberOfRecords",(function(e){var element=jQuery(e.currentTarget),totalNumberOfRecords=jQuery("#totalCount").val();if(element.addClass("d-none"),element.parent().progressIndicator({}),""==totalNumberOfRecords){var selectedTabElement=thisInstance.getSelectedTab(),relatedModuleName=thisInstance.getRelatedModuleName();Vtiger_RelatedList_Js.getInstance(thisInstance.getRecordId(),app.getModuleName(),selectedTabElement,relatedModuleName).getRelatedPageCount().done((function(){thisInstance.showPagingInfo()}))}else thisInstance.showPagingInfo();element.parent().progressIndicator({mode:"hide"})}))},showPagingInfo:function(){var totalNumberOfRecords=jQuery("#totalCount").val(),newPagingInfo=jQuery(".pageNumbersText").text()+" ("+totalNumberOfRecords+")";0!=parseInt(jQuery("#noOfEntries").val())?jQuery(".pageNumbersText").html(newPagingInfo):jQuery(".pageNumbersText").html("")},getCustomFieldNameValueMap:function(fieldNameValueMap){return fieldNameValueMap},registerSetReadRecord:function(detailContentsHolder){var thisInstance=this;detailContentsHolder.on("click",".setReadRecord",(function(e){jQuery(e.currentTarget).closest(".btn-group").addClass("d-none"),jQuery("#Accounts_detailView_fieldValue_was_read").find(".value").text(app.vtranslate("LBL_YES"));var params={module:app.getModuleName(),action:"SaveAjax",record:thisInstance.getRecordId(),field:"was_read",value:"on"};AppConnector.request(params).done((function(data){var params={text:app.vtranslate("JS_SET_READ_RECORD"),title:app.vtranslate("System"),type:"info"};Vtiger_Helper_Js.showPnotify(params);var relatedTabKey=jQuery(".related li.active");relatedTabKey.data("linkKey")!=thisInstance.detailViewSummaryTabLabel&&relatedTabKey.data("linkKey")!=thisInstance.detailViewDetailsTabLabel||thisInstance.reloadTabContent()}))}))},registerFastEditingFiels:function(){var thisInstance=this;jQuery(".summaryWidgetFastEditing select").on("change",(function(e){var fieldElement=jQuery(e.currentTarget),fieldContainer=fieldElement.closest(".editField"),progressIndicatorElement=jQuery.progressIndicator({message:app.vtranslate("JS_SAVE_LOADER_INFO"),position:"summaryWidgetFastEditing",blockInfo:{enabled:!0}}),fieldName=fieldContainer.data("fieldname");fieldName=fieldName.replace("q_","");var fieldValue=fieldElement.val();if(fieldElement.validationEngine("validate"))fieldContainer.progressIndicator({mode:"hide"});else{var preFieldSaveEvent=jQuery.Event(thisInstance.fieldPreSave);fieldElement.trigger(preFieldSaveEvent,{fieldValue:fieldValue,recordId:thisInstance.getRecordId()});var fieldNameValueMap={};fieldNameValueMap.value=fieldValue,fieldNameValueMap.field=fieldName,fieldNameValueMap=thisInstance.getCustomFieldNameValueMap(fieldNameValueMap),thisInstance.saveFieldValues(fieldNameValueMap),progressIndicatorElement.progressIndicator({mode:"hide"});var params={title:app.vtranslate("JS_SAVE_NOTIFY_OK"),type:"success"};Vtiger_Helper_Js.showPnotify(params),thisInstance.reloadTabContent()}}))},registerHelpInfo:function(){var form=this.getForm();app.showPopoverElementView(form.find(".js-help-info"))},registerRelatedModulesRecordCount:function(tabContainer){var moreList=$(".related .nav .dropdown-menu"),relationContainer=tabContainer;relationContainer&&void 0!==relationContainer.length||(relationContainer=$(".related .nav > .relatedNav, .related .nav > .mainNav, .detailViewBlockLink, .related .nav .dropdown-menu > .relatedNav")),relationContainer.each((function(n,item){var relationId=(item=$(item)).data("relationId"),relatedModule=item.data("reference");1===item.data("count")&&AppConnector.request({module:app.getModuleName(),action:"RelationAjax",record:app.getRecordId(),relatedModule:relatedModule,mode:"getRelatedListPageCount",relationId:relationId,tab_label:item.data("label-key")}).done((function(response){response.success&&(0===response.result.numberOfRecords&&(response.result.numberOfRecords=""),item.find(".count").text(response.result.numberOfRecords),moreList.find('[data-reference="${relatedModule}"][data-relation-id="${relationId}"] .count').text(response.result.numberOfRecords))}))}))},addComment:function(currentTarget,data){var self=this,mode=currentTarget.data("mode"),closestAddCommentBlock=currentTarget.closest(".js-add-comment-block"),commentTextAreaElement=closestAddCommentBlock.find(".js-comment-content"),commentInfoBlock=currentTarget.closest(".js-comment-single");if(commentTextAreaElement.html(""),"add"==mode){var commentId=data.result.id;self.getCommentUI(commentId).done((function(data){var commentBlock=closestAddCommentBlock.closest(".js-comment-details"),detailContentsHolder=self.getContentHolder();if($(".js-noCommentsMsgContainer",detailContentsHolder).remove(),commentBlock.length>0)if(closestAddCommentBlock.remove(),commentBlock.find("ul").length<=0){var newChildCommentCount=commentInfoBlock.find(".js-view-thread-block").data("data-child-comments-count")+1;commentInfoBlock.find(".js-child-comments-count").text(newChildCommentCount);var parentCommentId=commentInfoBlock.find(".js-comment-info-header").data("commentid");self.getChildComments(parentCommentId).done((function(responsedata){$(responsedata).appendTo(commentBlock),commentInfoBlock.find(".js-view-thread-block").hide(),commentInfoBlock.find(".hideThreadBlock").show()}))}else $('<li class="js-comment-details commentDetails">'+data+"</li>").appendTo(commentBlock.find(".js-comments-body"));else $('<li class="js-comment-details commentDetails">'+data+"</li>").prependTo(closestAddCommentBlock.closest(".contents").find(".commentsList"));commentInfoBlock.find(".js-comment-container").show(),app.event.trigger("DetailView.SaveComment.AfterLoad",commentInfoBlock,data)}))}else if("edit"==mode){var modifiedTime=commentInfoBlock.find(".js-comment-modified-time"),commentInfoContent=commentInfoBlock.find(".js-comment-info"),commentEditStatus=commentInfoBlock.find(".js-edited-status"),commentReason=commentInfoBlock.find(".js-edit-reason-span");commentInfoContent.html(data.result.commentcontent),commentReason.html(data.result.reasontoedit),modifiedTime.html(data.result.modifiedtime),modifiedTime.attr("title",data.result.modifiedtimetitle),commentEditStatus.hasClass("d-none")&&commentEditStatus.removeClass("d-none"),""!=data.result.reasontoedit&&commentInfoBlock.find(".js-edit-reason").removeClass("d-none"),commentInfoContent.show(),commentInfoBlock.find(".js-comment-container").show(),closestAddCommentBlock.remove(),app.event.trigger("DetailView.SaveComment.AfterUpdate",commentInfoBlock,data)}},registerCommentEvents:function(detailContentsHolder){var self=this;detailContentsHolder.on("click",".js-close-comment-block",(function(e){var commentInfoBlock=$(e.currentTarget.closest(".js-comment-single"));commentInfoBlock.find(".js-comment-container").show(),commentInfoBlock.find(".js-comment-info").show(),self.removeCommentBlockIfExists()})),detailContentsHolder.on("click",".js-reply-comment",(function(e){self.removeCommentBlockIfExists();var commentInfoBlock=$(e.currentTarget).closest(".js-comment-single");commentInfoBlock.find(".js-comment-container").hide(),self.getCommentBlock().appendTo(commentInfoBlock).show()})),detailContentsHolder.on("click",".js-edit-comment",(function(e){self.removeCommentBlockIfExists();var commentInfoBlock=$(e.currentTarget).closest(".js-comment-single"),commentInfoContent=commentInfoBlock.find(".js-comment-info"),editCommentBlock=self.getEditCommentBlock();editCommentBlock.find(".js-comment-content").html(commentInfoContent.html()),editCommentBlock.find(".js-reason-to-edit").html(commentInfoBlock.find(".js-edit-reason-span").text()),commentInfoContent.hide(),commentInfoBlock.find(".js-comment-container").hide(),editCommentBlock.appendTo(commentInfoBlock).show()})),detailContentsHolder.on("click",".js-detail-view-save-comment",(function(e){var element=$(e.currentTarget);element.is(":disabled")||self.saveComment(e).done((function(){self.registerRelatedModulesRecordCount(),self.loadWidget(detailContentsHolder.find("[data-type='Comments']")).done((function(){element.removeAttr("disabled")}))})).fail((function(error,err){element.removeAttr("disabled"),app.errorLog(error,err)}))})),detailContentsHolder.on("click",".js-save-comment",(function(e){var element=$(e.currentTarget);element.is(":disabled")||self.saveComment(e).done((function(data){self.registerRelatedModulesRecordCount(self.getTabByLabel(self.detailViewRecentCommentsTabLabel)),self.addComment(element,data),element.removeAttr("disabled")})).fail((function(error,err){element.removeAttr("disabled"),app.errorLog(error,err)}))})),detailContentsHolder.on("click",".js-more-recent-comments ",(function(){self.getTabByLabel(self.detailViewRecentCommentsTabLabel).trigger("click")})),detailContentsHolder.find(".js-detail-hierarchy-comments-btn").on("click",(function(e){if(!($(this).hasClass("active")&&detailContentsHolder.find(".js-detail-hierarchy-comments-btn.active").length<2)){var recentCommentsTab=self.getTabByLabel(self.detailViewRecentCommentsTabLabel),url=recentCommentsTab.data("url");url=url.replace(/&hierarchy=+([\w,]+)/,"");var hierarchy=[];$(this).hasClass("active")?$(this).removeClass("active"):$(this).addClass("active"),detailContentsHolder.find(".js-detail-hierarchy-comments-btn.active").each((function(){hierarchy.push($(this).find(".js-detail-hierarchy-comments").val())})),0!==hierarchy.length&&(url+="&hierarchy="+hierarchy.join(",")),recentCommentsTab.data("url",url),recentCommentsTab.trigger("click")}})),detailContentsHolder.on("keypress",".js-comment-search",(function(e){13===e.which&&self.submitSearchForm(detailContentsHolder)})),detailContentsHolder.on("click",".js-search-icon",(function(e){self.submitSearchForm(detailContentsHolder)}))},submitSearchForm:function(detailContentsHolder){var searchTextDom=detailContentsHolder.find(".js-comment-search"),widgetContainer=searchTextDom.closest('[data-name="ModComments"]'),progressIndicatorElement=$.progressIndicator();if("widget"!==searchTextDom.data("container")||searchTextDom.val()){var hierarchy=[],limit="",isWidget=!1;"widget"===searchTextDom.data("container")?(limit=widgetContainer.data("limit"),isWidget=!0,widgetContainer.find(".js-hierarchy-comments:checked").each((function(){hierarchy.push($(this).val())}))):detailContentsHolder.find(".js-detail-hierarchy-comments:checked").each((function(){hierarchy.push($(this).val())})),AppConnector.request({module:app.getModuleName(),view:"Detail",mode:"showSearchComments",hierarchy:hierarchy.join(","),limit:limit,record:app.getRecordId(),search_key:searchTextDom.val(),is_widget:isWidget}).done((function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),searchTextDom.val()?detailContentsHolder.find(".js-comments-body").html(data):detailContentsHolder.html(data)}))}else{var request=widgetContainer.data("url");AppConnector.request(request).done((function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),detailContentsHolder.find(".js-comments-container").html(data)}))}},registerCommentEventsInDetail:function(widgetContainer){new App.Fields.Text.Completions($(".js-completions").eq(0),{emojiPanel:!1}),widgetContainer.on("change",".js-hierarchy-comments",(function(e){var hierarchy=[];widgetContainer.find(".js-hierarchy-comments").each((function(){$(this).is(":checked")&&hierarchy.push($(this).val())}));var progressIndicatorElement=$.progressIndicator();AppConnector.request({module:app.getModuleName(),view:"Detail",mode:"showRecentComments",hierarchy:hierarchy.join(","),record:app.getRecordId(),limit:widgetContainer.find(".widgetContentBlock").data("limit")}).done((function(data){progressIndicatorElement.progressIndicator({mode:"hide"});var widgetDataContainer=widgetContainer.find(".js-detail-widget-content");widgetDataContainer.html(data),App.Fields.Picklist.showSelect2ElementView(widgetDataContainer.find(".select2"))}))}))},registerMailPreviewWidget:function(container){var self=this;container.on("click",".showMailBody",(function(e){var row=$(e.currentTarget).closest(".row"),mailBody=row.find(".mailBody"),mailTeaser=row.find(".mailTeaser");mailBody.toggleClass("d-none"),mailTeaser.toggleClass("d-none")})),container.find('[name="mail-type"]').on("change",(function(e){self.loadMailPreviewWidget(container)})),container.find('[name="mailFilter"]').on("change",(function(e){self.loadMailPreviewWidget(container)})),container.on("click",".showMailsModal",(function(e){var url=$(e.currentTarget).data("url");url+="&type="+container.find('[name="mail-type"]').val(),container.find('[name="mailFilter"]').length>0&&(url+="&mailFilter="+container.find('[name="mailFilter"]').val());var progressIndicatorElement=jQuery.progressIndicator();app.showModalWindow("",url,(function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),self.registerMailPreviewWidget(data),Vtiger_Index_Js.registerMailButtons(data),data.find(".expandAllMails").click()}))})),container.find(".expandAllMails").on("click",(function(e){container.find(".mailBody").removeClass("d-none"),container.find(".mailTeaser").addClass("d-none"),container.find(".showMailBody .js-toggle-icon").removeClass("fa-caret-down").addClass("fa-caret-up")})),container.find(".collapseAllMails").on("click",(function(e){container.find(".mailBody").addClass("d-none"),container.find(".mailTeaser").removeClass("d-none"),container.find(".showMailBody .js-toggle-icon").removeClass("fa-caret-up").addClass("fa-caret-down")}))},loadMailPreviewWidget:function(widgetContent){var thisInstance=this,widgetDataContainer=widgetContent.find(".js-detail-widget-content"),recordId=$("#recordId").val(),progress=widgetDataContainer.progressIndicator(),params={module:"OSSMailView",view:"Widget"};params.smodule=$("#module").val(),params.srecord=recordId,params.mode="showEmailsList",params.type=$('[name="mail-type"]').val(),params.mailFilter=$('[name="mailFilter"]').val(),AppConnector.request(params).done((function(data){widgetDataContainer.html(data),app.event.trigger("DetailView.Widget.AfterLoad",widgetDataContainer,params.module,thisInstance),progress.progressIndicator({mode:"hide"})}))},registerEmailEvents:function(detailContentsHolder){Vtiger_Index_Js.registerMailButtons(detailContentsHolder)},registerMapsEvents:function(container){container.find("#coordinates").length&&(new OpenStreetMap_Map_Js).registerDetailView(container)},registerSocialMediaEvents:function(container){container.find(".tpl-Detail-SocialMedia").length},registerShowSummary:function(container){container.on("click",".showSummaryRelRecord",(function(e){var id=$(e.currentTarget).data("id"),summaryView=container.find(".summaryRelRecordView"+id);container.find(".listViewEntriesTable").css("display","none"),summaryView.show()})),container.on("click",".hideSummaryRelRecordView",(function(e){var summaryView=container.find(".summaryRelRecordView");container.find(".listViewEntriesTable").css("display","table"),summaryView.hide()}))},showProgressConfirmation:function(element,picklistName){var self=this,picklistValue=$(element).data("picklistValue");Vtiger_Helper_Js.showConfirmationBox({title:$(element).data("picklistLabel"),message:app.vtranslate("JS_CHANGE_VALUE_CONFIRMATION")}).done((function(){var progressIndicatorElement=$.progressIndicator();self.saveFieldValues({value:picklistValue,field:picklistName}).done((function(){progressIndicatorElement.progressIndicator({mode:"hide"}),window.location.reload()})).fail((function(error,err){progressIndicatorElement.progressIndicator({mode:"hide"}),app.errorLog(error,err)}))}))},registerProgress:function(){var self=this;$(".js-header-progress-bar").each((function(index,element){var picklistName=$(element).data("picklistName");$(element).find(".js-access").on("click",(function(e){self.showProgressConfirmation(e.currentTarget,picklistName)}))}))},loadChat:function(){if($("#ChatRecordRoomVue",this.detailViewContentHolder).length){var chatContainer=this.detailViewContentHolder.find(".js-chat-container");chatContainer.height($(document).height()-chatContainer.offset().top-$(".js-footer").outerHeight()-10),window.ChatRecordRoomVueComponent.mount({el:"#ChatRecordRoomVue"})}},registerChat:function(){var _this=this;void 0!==window.ChatRecordRoomVueComponent&&(this.loadChat(),app.event.on("DetailView.Tab.AfterLoad",(function(e,data,instance){instance.detailViewContentHolder.ready((function(){_this.loadChat()}))})))},registerBasicEvents:function(){var thisInstance=this,detailContentsHolder=thisInstance.getContentHolder(),selectedTabElement=thisInstance.getSelectedTab();"ModComments"===this.getSelectedTab().data("labelKey")&&new App.Fields.Text.Completions(detailContentsHolder.find(".js-completions"),{emojiPanel:!1}),thisInstance.registerSummaryViewContainerEvents(detailContentsHolder),thisInstance.registerCommentEvents(detailContentsHolder),thisInstance.registerEmailEvents(detailContentsHolder),thisInstance.registerMapsEvents(detailContentsHolder),thisInstance.registerSocialMediaEvents(detailContentsHolder),thisInstance.registerSubProducts(detailContentsHolder),thisInstance.registerCollapsiblePanels(detailContentsHolder),App.Fields.Date.register(detailContentsHolder),App.Fields.DateTime.register(detailContentsHolder),App.Fields.MultiImage.register(detailContentsHolder),app.registerEventForClockPicker(),App.Fields.Picklist.showSelect2ElementView(detailContentsHolder.find("select.select2")),new App.Fields.Text.Editor(detailContentsHolder,{toolbar:"Min"}),detailContentsHolder.on("click","#detailViewNextRecordButton",(function(e){var url=selectedTabElement.data("url"),currentPageNum=thisInstance.getRelatedListCurrentPageNum(),nextPageUrl=url+"&page="+(parseInt(currentPageNum)+1);thisInstance.loadContents(nextPageUrl)})),detailContentsHolder.on("click","#detailViewPreviousRecordButton",(function(e){var url=selectedTabElement.data("url"),currentPageNum=thisInstance.getRelatedListCurrentPageNum(),nextPageUrl=url+"&page="+(parseInt(currentPageNum)-1);thisInstance.loadContents(nextPageUrl)})),detailContentsHolder.on("click","div.detailViewTable div.fieldValue:not(.is-edit-active)",(function(e){var target=$(e.target);if(!target.closest("a").hasClass("btnNoFastEdit")&&!target.hasClass("btnNoFastEdit")){var currentTdElement=jQuery(e.currentTarget);currentTdElement.addClass("is-edit-active"),thisInstance.ajaxEditHandling(currentTdElement)}})),detailContentsHolder.on("click","div.recordDetails span.squeezedWell",(function(e){var relatedLabel=jQuery(e.currentTarget).data("reference");jQuery('.detailViewInfo .related .nav > li[data-reference="'+relatedLabel+'"]').trigger("click")})),detailContentsHolder.on("click",".relatedPopup",(function(e){return(new Vtiger_Edit_Js).showRecordsList(e),!1})),detailContentsHolder.on("click",".viewThread",(function(e){var currentTarget=jQuery(e.currentTarget),currentTargetParent=currentTarget.parent(),commentActionsBlock=currentTarget.closest(".js-comment-actions"),ulElements=currentTarget.closest(".js-comment-details").find("ul");if(ulElements.length>0)return ulElements.show(),commentActionsBlock.find(".hideThreadBlock").show(),void currentTargetParent.hide();var commentId=currentTarget.closest(".js-comment-div").find(".js-comment-info-header").data("commentid");thisInstance.getChildComments(commentId).done((function(data){jQuery(data).appendTo(jQuery(e.currentTarget).closest(".js-comment-details")),commentActionsBlock.find(".hideThreadBlock").show(),currentTargetParent.hide()}))})),detailContentsHolder.on("click",".js-view-parent-thread",(function(e){var currentTarget=jQuery(e.currentTarget),currentTargetParent=currentTarget.parent(),commentId=currentTarget.closest(".js-comment-div").find(".js-comment-info-header").data("commentid");thisInstance.getParentComments(commentId).done((function(data){$(e.currentTarget.closest(".js-comment-details")).html(data),currentTarget.closest(".js-comment-actions").find(".hideThreadBlock").show(),currentTargetParent.hide()}))})),detailContentsHolder.on("click",".js-fab__btn",(function(e){$(e.currentTarget).closest(".js-fab__container").toggleClass("q-fab--opened")})),detailContentsHolder.find(".js-fab__container").on("clickoutside",(function(e){$(e.currentTarget).removeClass("q-fab--opened")})),detailContentsHolder.on("click",".hideThread",(function(e){var currentTarget=jQuery(e.currentTarget),currentTargetParent=currentTarget.parent(),commentActionsBlock=currentTarget.closest(".js-comment-actions");currentTarget.closest(".js-comment-details").find("ul").hide(),currentTargetParent.hide(),commentActionsBlock.find(".js-view-thread-block").show()})),detailContentsHolder.on("click",".detailViewThread",(function(e){var recentCommentsTab=thisInstance.getTabByLabel(thisInstance.detailViewRecentCommentsTabLabel),commentId=jQuery(e.currentTarget).closest(".js-comment-single").find(".js-comment-info-header").data("commentid");recentCommentsTab.trigger("click",{commentid:commentId,callback:function(data){window.location.href=window.location.href+"#"+commentId}})})),detailContentsHolder.on("click",".moreRecentRecords",(function(e){e.preventDefault();var recentCommentsTab=thisInstance.getTabByModule($(this).data("label-key"),$(this).data("relation-id"));if(recentCommentsTab.length)recentCommentsTab.trigger("click");else{var currentTarget=$(e.currentTarget),container=currentTarget.closest("[class^='widgetContainer_']");if(container.length){var page=container.find('[name="page"]:last').val(),url=container.data("url");currentTarget.prop("disabled",!0),url=url.replace("&page=1","&page="+ ++page),AppConnector.request(url).done((function(data){var dataObj=$(data),containerTable=container.find(".js-detail-widget-content table");currentTarget.prop("disabled",!1).addClass("d-none"),container.find('[name="page"]:last').val(dataObj.find('[name="page"]').val()),containerTable.length?(containerTable.append(dataObj.find("tbody tr")),dataObj.find(".moreRecentRecords").length&&currentTarget.removeClass("d-none")):container.find(".js-detail-widget-content").append(dataObj)}))}}})),detailContentsHolder.on("change",".relatedHistoryTypes",(function(e){var widgetContent=jQuery(this).closest(".widgetContentBlock").find(".widgetContent"),progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0,elementToBlock:widgetContent}});AppConnector.request({module:app.getModuleName(),view:"Detail",record:app.getRecordId(),mode:"showRecentRelation",page:1,limit:widgetContent.find(".js-relatedHistoryPageLimit").val(),type:$(e.currentTarget).val()}).done((function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),widgetContent.find("#relatedHistoryCurrentPage").remove(),widgetContent.find("#moreRelatedUpdates").remove(),widgetContent.html(data),Vtiger_Index_Js.registerMailButtons(widgetContent)}))})),detailContentsHolder.on("click",".moreProductsService",(function(){jQuery('.related .mainNav[data-reference="ProductsAndServices"]:not(.d-none)').trigger("click")})),detailContentsHolder.on("click",".moreRelatedUpdates",(function(){var widgetContainer=jQuery(this).closest(".widgetContentBlock"),widgetContent=widgetContainer.find(".widgetContent"),progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0,elementToBlock:widgetContent}}),currentPage=widgetContent.find("#relatedHistoryCurrentPage").val(),nextPage=parseInt(currentPage)+1,types=widgetContainer.find(".relatedHistoryTypes").val(),pageLimit=widgetContent.find("#relatedHistoryPageLimit").val();AppConnector.request({module:app.getModuleName(),view:"Detail",record:app.getRecordId(),mode:"showRecentRelation",page:nextPage,limit:pageLimit,type:types}).done((function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),widgetContent.find("#relatedHistoryCurrentPage").remove(),widgetContent.find("#moreRelatedUpdates").remove(),widgetContent.find("#relatedUpdates").append(data)}))})),detailContentsHolder.on("click",".moreRecentUpdates",(function(e){var container=$(e.currentTarget).closest(".recentActivitiesContainer"),newChange=container.find("#newChange").val(),nextPage=parseInt(container.find("#updatesCurrentPage").val())+1,url=void 0;if(container.closest(".js-detail-widget").length)url=thisInstance.getFiltersData(e,{page:nextPage,tab_label:"LBL_UPDATES",newChange:newChange},container.find("#updates")).params;else if(-1===(url=(url=thisInstance.getTabByLabel(thisInstance.detailViewRecentUpdatesTabLabel).data("url")).replace("&page=1","&page="+nextPage)+"&skipHeader=true&newChange="+newChange).indexOf("&whereCondition")){var switchBtn=jQuery(".active .js-switch--recentActivities");url+="&whereCondition="+(void 0===switchBtn.data("on-val")?switchBtn.data("off-val"):switchBtn.data("on-val"))}AppConnector.request(url).done((function(data){var dataContainer=jQuery(data);container.find("#newChange").val(dataContainer.find("#newChange").val()),container.find("#updatesCurrentPage").val(dataContainer.find("#updatesCurrentPage").val()),container.find(".js-more-link").html(dataContainer.find(".js-more-link").html()),container.find("#updates ul").append(dataContainer.find("#updates ul").html()),app.event.trigger("DetailView.UpdatesWidget.AddMore",data,thisInstance)}))})),detailContentsHolder.on("click",".btnChangesReviewedOn",(function(e){var progressInstance=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),url="index.php?module=ModTracker&action=ChangesReviewedOn&record="+app.getRecordId();AppConnector.request(url).done((function(data){if(progressInstance.progressIndicator({mode:"hide"}),jQuery(e.currentTarget).parent().remove(),thisInstance.getTabByLabel(thisInstance.detailViewRecentUpdatesTabLabel).find(".count.badge").text(""),selectedTabElement.data("labelKey")==thisInstance.detailViewRecentUpdatesTabLabel)thisInstance.reloadTabContent();else if(selectedTabElement.data("linkKey")==thisInstance.detailViewSummaryTabLabel){var updatesWidget=detailContentsHolder.find("[data-type='Updates']");if(updatesWidget.length>0){var params=thisInstance.getFiltersData(updatesWidget);thisInstance.loadWidget(updatesWidget,params.params)}}}))})),detailContentsHolder.on("click",".moreRecentDocuments",(function(){thisInstance.getTabByLabel(thisInstance.detailViewRecentDocumentsTabLabel).trigger("click")})),detailContentsHolder.on("click",".moreRecentActivities",(function(e){var currentTarget=$(e.currentTarget);currentTarget.prop("disabled",!0);var container=currentTarget.closest(".activityWidgetContainer"),page=container.find(".currentPage").val();page++;var url=container.find(".widgetContentBlock").data("url");url=url.replace("&page=1","&page="+page),url+="&totalCount="+container.find(".totaltActivities").val(),AppConnector.request(url).done((function(data){currentTarget.prop("disabled",!1),currentTarget.addClass("d-none");var currentPage=container.find(".currentPage").val();container.find(".currentPage").remove(),container.find(".countActivities").remove(),container.find(".js-detail-widget-content").append(data),container.find(".countActivities").val(parseInt(container.find(".countActivities").val())+currentPage*parseInt(container.find(".pageLimit").val())),thisInstance.reloadWidgetActivitesStats(container)}))})),detailContentsHolder.on("click",".widgetFullscreen",(function(e){var url=$(e.currentTarget).closest(".widgetContentBlock").data("url");url=url.replace("&view=Detail&","&view=WidgetFullscreen&");var progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}});app.showModalWindow(null,"index.php?"+url,(function(modal){progressIndicatorElement.progressIndicator({mode:"hide"})}))})),thisInstance.registerEventForRelatedList(),thisInstance.registerBlockAnimationEvent(),thisInstance.registerMailPreviewWidget(detailContentsHolder.find('.widgetContentBlock[data-type="EmailList"]')),thisInstance.registerMailPreviewWidget(detailContentsHolder.find('.widgetContentBlock[data-type="HistoryRelation"]')),detailContentsHolder.find(".js-switch--recentActivities").off().on("change",(function(e){var currentTarget=jQuery(e.currentTarget),tabElement=thisInstance.getTabByLabel(thisInstance.detailViewRecentUpdatesTabLabel),variableName=currentTarget.data("urlparams"),valueOn=$(this).data("on-val"),valueOff=$(this).data("off-val"),url=tabElement.data("url");url=url.replace("&"+variableName+"="+valueOn,"").replace("&"+variableName+"="+valueOff,""),void 0!==currentTarget.data("on-val")?url+="&"+variableName+"="+valueOn:void 0!==currentTarget.data("off-val")&&(url+="&"+variableName+"="+valueOff),tabElement.data("url",url),tabElement.trigger("click")})),app.registerIframeEvents(detailContentsHolder)},reloadWidgetActivitesStats:function(container){var countElement=container.find(".countActivities"),totalElement=container.find(".totaltActivities");if(!countElement.length||!totalElement.length)return!1;var stats=" ("+countElement.val()+"/"+totalElement.val()+")",switchBtn=container.find(".active .js-switch"),switchBtnParent=switchBtn.parent(),text=switchBtn.data("basic-text")+stats;switchBtnParent.removeTextNode(),switchBtnParent.append(text)},refreshCommentContainer:function(commentId){var commentContainer=$(".commentsBody"),params={module:app.getModuleName(),view:"Detail",record:this.getRecordId(),mode:"showThreadComments",commentid:commentId},progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0,elementToBlock:commentContainer}});AppConnector.request(params).done((function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),commentContainer.html(data)}))},updateRecordsPDFTemplateBtn:function(form){var btnToolbar=$(".js-btn-toolbar .js-pdf");btnToolbar.length&&AppConnector.request({data:{module:app.getModuleName(),action:"PDF",mode:"hasValidTemplate",record:app.getRecordId(),view:app.getViewName()},dataType:"json"}).done((function(data){!1===data.result.valid?btnToolbar.addClass("d-none"):btnToolbar.removeClass("d-none")})).fail((function(data,err){app.errorLog(data,err)}))},updateWindowHeight:function(currentHeight,frame){frame.height(currentHeight)},loadSubProducts:function(parentRow){var thisInstance=this,subProrductParams={module:"Products",action:"SubProducts",record:parentRow.data("product-id")};AppConnector.request(subProrductParams).done((function(data){var responseData=data.result;thisInstance.addSubProducts(parentRow,responseData)}))},addSubProducts:function(parentRow,responseData){var subProductsContainer=$(".js-subproducts-container ul",parentRow);for(var id in responseData){var productText=$("<li>").text(responseData[id]);subProductsContainer.append(productText)}},registerSubProducts:function(container){var thisInstance=this;container.find(".inventoryItems .js-inventory-row").each((function(index){thisInstance.loadSubProducts($(this),!1)}))},registerCollapsiblePanels:function(detailViewContainer){var _this2=this,panels=detailViewContainer.find(".js-detail-widget-collapse"),storageName="yf-"+app.getModuleName()+"-detail-widgets";if(Quasar.plugins.LocalStorage.has(storageName))this.setPanels({panels:panels,storageName:storageName});else{panels.collapse("show");var panelsStorage={};panels.each((function(i,item){panelsStorage[item.dataset.storageId]="shown"})),Quasar.plugins.LocalStorage.set(storageName,panelsStorage)}panels.on("hidden.bs.collapse shown.bs.collapse",(function(e){_this2.updatePanelsStorage({id:e.target.dataset.storageKey,type:e.type,storageName:storageName})})),panels.on("hide.bs.collapse show.bs.collapse",(function(e){$(e.currentTarget).siblings(".js-detail-widget-header").toggleClass("collapsed")}))},setPanels:function(_ref){var panels=_ref.panels,storageName=_ref.storageName,panelsStorage=Quasar.plugins.LocalStorage.getItem(storageName);panels.each((function(i,item){"shown"!==panelsStorage[item.dataset.storageKey]&&void 0!==panelsStorage[item.dataset.storageKey]||($(item).collapse("show"),$(item).siblings(".js-detail-widget-header").toggleClass("collapsed"))}))},updatePanelsStorage:function(_ref2){var id=_ref2.id,type=_ref2.type,storageName=_ref2.storageName,panelsStorage=Quasar.plugins.LocalStorage.getItem(storageName);panelsStorage[id]=type,Quasar.plugins.LocalStorage.set(storageName,panelsStorage)},registerEvents:function(){this.registerHelpInfo(),this.registerSendSmsSubmitEvent(),this.registerAjaxEditEvent(),this.registerRelatedRowClickEvent(),this.registerBlockStatusCheckOnLoad(),this.registerEmailFieldClickEvent(),this.registerPhoneFieldClickEvent(),this.registerEventForRelatedTabClick(),Vtiger_Helper_Js.showHorizontalTopScrollBar(),this.registerUrlFieldClickEvent();var detailViewContainer=jQuery("div.detailViewContainer");detailViewContainer.length<=0||(this.registerSetReadRecord(detailViewContainer),this.registerEventForPicklistDependencySetup(this.getForm()),this.getForm().validationEngine(app.validationEngineOptionsForRecord),this.loadWidgetsEvents(),this.loadWidgets(),this.registerBasicEvents(),this.registerEventForTotalRecordsCount(),this.registerProgress(),this.registerChat(detailViewContainer))}});
//# sourceMappingURL=Detail.min.js.map
