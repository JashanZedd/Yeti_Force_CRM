
"use strict";
var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) {
  return typeof obj;
} : function (obj) {
  return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj;
};
jQuery.Class("Vtiger_Detail_Js",{detailInstance:!1,getInstance:function(){if(0==Vtiger_Detail_Js.detailInstance){let e,t=app.getModuleName()+"_"+app.getViewName()+"_Js";e=void 0!==window[t]?new window[t]:new Vtiger_Detail_Js,Vtiger_Detail_Js.detailInstance=e}return Vtiger_Detail_Js.detailInstance},triggerDetailViewAction:function(e,t){var a=Vtiger_Detail_Js.getInstance(),n=[];n.push(a.getRecordId());var i={type:"POST",url:e,dataType:"html",data:{selected_ids:JSON.stringify(n)}};AppConnector.request(i).done(function(e){e&&(app.showModalWindow(e,{"text-align":"left"}),"function"==typeof t&&t(e))}).fail(function(e,t){})},triggerSendSms:function(e,t){Vtiger_Detail_Js.triggerDetailViewAction(e)},triggerTransferOwnership:function(e){var t=this;t.getRelatedModulesContainer=!1;var a={type:"POST",url:e,dataType:"html",data:{}};AppConnector.request(a).done(function(e){if(e){var a=function(e){app.validationEngineOptions.onValidationComplete=function(e,a){return a&&"changeOwner"==e.attr("name")&&t.transferOwnershipSave(e),!1},jQuery("#changeOwner").validationEngine(app.validationEngineOptions)};app.showModalWindow(e,function(e){var n=t.getRelatedModuleContainer();App.Fields.Picklist.changeSelectElementView(n,"select2"),a()})}})},transferOwnershipSave:function(e){var t=jQuery("#transferOwnerId").val(),a=jQuery("#related_modules").val(),n=jQuery("#recordId").val(),i={module:app.getModuleName(),action:"TransferOwnership",record:n,transferOwnerId:t,related_modules:a};AppConnector.request(i).done(function(e){if(e.success){app.hideModalWindow();var a={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_RECORDS_TRANSFERRED_SUCCESSFULLY"),type:"info"},n=jQuery(".assigned_user_id").val(),i=jQuery(".assigned_user_id ");i.find('option[value="'+n+'"]').removeAttr("selected"),i.find('option[value="'+t+'"]').attr("selected","selected"),i.trigger("liszt:updated");var r=i.find('option[value="'+t+'"]').data("picklistvalue");i.closest(".row-fluid").find(".value").html('<a href="index.php?module=Users&amp;parent=Settings&amp;view=Detail&amp;record='+t+'">'+r+"</a>"),Vtiger_Helper_Js.showPnotify(a)}})},getRelatedModuleContainer:function(){return 0==this.getRelatedModulesContainer&&(this.getRelatedModulesContainer=jQuery("#related_modules")),this.getRelatedModulesContainer},reloadRelatedList:function(){var e=Vtiger_Detail_Js.getInstance(),t={};jQuery('[name="currentPageNum"]').length>0&&(t.page=jQuery('[name="currentPageNum"]').val()),e.loadRelatedList(t)},showWorkflowTriggerView:function(e){$(e).popover("hide");const t=Vtiger_Detail_Js.getInstance(),a=function(e){e.find('[type="submit"]').on("click",function(){let a=[];e.find('input[type="checkbox"]:checked').each(function(){a.push($(this).val())}),0===a.length?Vtiger_Helper_Js.showPnotify({title:app.vtranslate("JS_INFORMATION"),text:app.vtranslate("JS_NOT_SELECTED_WORKFLOW_TRIGGER"),type:"error"}):(Vtiger_Helper_Js.showPnotify({title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_STARTED_PERFORM_WORKFLOW"),type:"info"}),AppConnector.request({module:app.getModuleName(),action:"Workflow",mode:"execute",user:e.find('[name="user"]').val(),record:t.getRecordId(),ids:a}).done(function(){Vtiger_Helper_Js.showPnotify({title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_COMPLETED_PERFORM_WORKFLOW"),type:"success"}),app.hideModalWindow(),t.loadWidgets()}).fail(function(){Vtiger_Helper_Js.showPnotify({title:app.vtranslate("JS_ERROR"),text:app.vtranslate("JS_ERROR_DURING_TRIGGER_OF_WORKFLOW"),type:"error"}),app.hideModalWindow()}))})};AppConnector.request({module:app.getModuleName(),view:"WorkflowTrigger",record:t.getRecordId()}).done(function(e){e&&app.showModalWindow(e,"",a)})}},{targetPicklistChange:!1,targetPicklist:!1,detailViewContentHolder:!1,detailViewForm:!1,detailViewDetailsTabLabel:"LBL_RECORD_DETAILS",detailViewSummaryTabLabel:"LBL_RECORD_SUMMARY",detailViewRecentCommentsTabLabel:"ModComments",detailViewRecentActivitiesTabLabel:"Activities",detailViewRecentUpdatesTabLabel:"LBL_UPDATES",detailViewRecentDocumentsTabLabel:"Documents",fieldUpdatedEvent:"Vtiger.Field.Updated",updatedFields:["company","designation","title"],fieldPreSave:"Vtiger.Field.PreSave",tempData:[],referenceFieldNames:{Calendar:{Accounts:"link",Leads:"link",Vendors:"link",OSSEmployees:"link",Contacts:"linkextend",Campaigns:"process",HelpDesk:"process",Projects:"process",ServiceContracts:"process"},OutsourcedProducts:{Leads:"parent_id",Accounts:"parent_id",Contacts:"parent_id"},Assets:{Accounts:"parent_id",Contacts:"parent_id"},OSSOutsourcedServices:{Leads:"parent_id",Accounts:"parent_id",Contacts:"parent_id"},OSSSoldServices:{Accounts:"parent_id",Contacts:"parent_id"}},init:function(){},loadWidgetsEvents:function(){const e=this;app.event.on("DetailView.Widget.AfterLoad",function(t,a,n,i){"Calendar"===n&&e.reloadWidgetActivitesStats(a.closest(".activityWidgetContainer")),"ModComments"===n&&e.registerCommentEventsInDetail(a.closest(".updatesWidgetContainer")),a.find('[name="relatedModule"]').length&&e.registerShowSummary(a),"OSSMailView"===n&&(Vtiger_Index_Js.registerMailButtons(a),a.find(".showMailModal").on("click",function(e){let t=jQuery.progressIndicator();app.showModalWindow("",$(e.currentTarget).data("url")+"&noloadlibs=1",function(e){Vtiger_Index_Js.registerMailButtons(e),t.progressIndicator({mode:"hide"})})})),e.registerEmailEvents(a),"DetailView"===n&&e.registerBlockStatusCheckOnLoad()})},loadWidgets:function(){var e=this;jQuery('[class^="widgetContainer_"]').each(function(t,a){var n=jQuery(a);e.loadWidget(n)}),e.registerRelatedModulesRecordCount()},loadWidget:function(e,t){const a=this,n=$(".js-detail-widget-content",e);let i;if(i=e.find('[name="relatedModule"]').length?e.find('[name="relatedModule"]').val():e.data("name"),void 0===t){let a=e.data("url");if(null==a)return;let n,i=a.split("&"),r={};for(n=0;n<i.length;n++){let e=i[n].split("=");r[e[0]]=e[1]}t=r}let r=$.Deferred();return n.progressIndicator({}),AppConnector.request({type:"POST",async:!1,dataType:"html",data:t}).done(function(o){if(n.progressIndicator({mode:"hide"}),n.html(o),App.Fields.Picklist.showSelect2ElementView(e.find(".select2")),app.registerModal(n),app.registerMoreContent(n.find("button.moreBtn")),i){let t=Vtiger_RelatedList_Js.getInstance(a.getRecordId(),app.getModuleName(),a.getSelectedTab(),i);t.setRelatedContainer(n),t.registerRelatedEvents(),a.widgetRelatedRecordView(e,!0)}app.event.trigger("DetailView.Widget.AfterLoad",n,i,a),r.resolve(t)}).fail(function(){n.progressIndicator({mode:"hide"}),r.reject()}),r.promise()},widgetRelatedRecordView:function(e,t){var a=this.getRecordId()+"_"+e.data("id"),n=app.moduleCacheGet(a);null!==n&&(e.find(".js-carousel-item[data-id = '"+n+"']").length&&(e.find(".js-carousel-item.active").removeClass("active"),e.find(".js-carousel-item[data-id = '"+n+"']").addClass("active")));var i=e.find(".control-widget"),r=i.find(".prev"),o=i.find(".next"),d=e.find(".js-carousel-item.active");e.find(".js-carousel-item").length<=1||!d.next().length?o.addClass("disabled"):o.removeClass("disabled"),e.find(".js-carousel-item").length<=1||!d.prev().length?r.addClass("disabled"):r.removeClass("disabled"),t&&(o.on("click",function(){if(!$(this).hasClass("disabled")){var t=e.find(".js-carousel-item.active");t.removeClass("active");var n=t.next();n.addClass("active"),n.next().length||o.addClass("disabled"),t.prev()&&r.removeClass("disabled"),app.moduleCacheSet(a,n.data("id"))}}),r.on("click",function(){if(!$(this).hasClass("disabled")){var t=e.find(".js-carousel-item.active");t.removeClass("active");var n=t.prev();n.addClass("active"),n.prev().length||r.addClass("disabled"),t.next()&&o.removeClass("disabled"),app.moduleCacheSet(a,n.data("id"))}}))},loadCommentsWidget:function(){},loadContents:function(e,t){var a=this,n=jQuery.Deferred(),i=this.getContentHolder(),r=e;return void 0!==t&&((r={}).url=e,r.data=t),AppConnector.requestPjax(r).done(function(e){i.html(e),e=i.html(),a.registerBlockStatusCheckOnLoad(),App.Fields.Picklist.changeSelectElementView(i),App.Fields.Date.register(i),a.getForm().validationEngine(),app.event.trigger("DetailView.LoadContents.AfterLoad",e),n.resolve(e)}),n.promise()},getUpdatefFieldsArray:function(){return this.updatedFields},getTabByLabel:function(e){var t=this.getTabs(),a=!1;return t.each(function(t,n){var i=jQuery(n);if(i.data("labelKey")==e)return a=i,!1}),a},getTabByModule:function(e){var t=this.getTabs(),a=!1;return t.each(function(t,n){var i=jQuery(n);if(i.data("reference")==e)return a=i,!1}),a},selectModuleTab:function(){var e=this.getTabContainer().find("li.module-tab");this.deSelectAllrelatedTabs(),this.markTabAsSelected(e)},deSelectAllrelatedTabs:function(){this.getTabs().removeClass("active")},markTabAsSelected:function(e){e.addClass("active"),jQuery('.related .dropdown [data-reference="'+e.data("reference")+'"]').addClass("active")},reloadTabContent:function(){this.getSelectedTab().trigger("click")},getSelectedTab:function(){return this.getTabContainer().find(".nav li.active:not(.d-none)")},getTabContainer:function(){return jQuery("div.related")},getTabs:function(){var e=this.getTabContainer().find("li.baseLink:not(.d-none)");return this.getTabContainer().find("li:not(.baseLink)").each(function(t,a){var n=jQuery(this),i=n.data("iteration"),r=n.hasClass("mainNav")?"mainNav":"relatedNav";null!=i&&e.filter("."+r+'[data-iteration="'+i+'"]').length<1&&e.push(n.get(0))}),e},getContentHolder:function(){return 0==this.detailViewContentHolder&&(this.detailViewContentHolder=jQuery("div.details div.contents")),this.detailViewContentHolder},getForm:function(){return 0==this.detailViewForm&&(this.detailViewForm=jQuery("#detailView")),this.detailViewForm},getRecordId:function(){return app.getRecordId()},getRelatedModuleName:function(){if(1==jQuery(".relatedModuleName",this.getContentHolder()).length)return jQuery(".relatedModuleName",this.getContentHolder()).val()},saveFieldValues:function(e){var t=jQuery.Deferred(),a=this.getRecordId(),n={};void 0!==e&&(n=e),n.record=a,n.module=app.getModuleName(),n.action="SaveAjax";var i={};return i.data=n,i.async=!1,i.dataType="json",AppConnector.request(i).done(function(e){t.resolve(e)}),t.promise()},getRelatedListCurrentPageNum:function(){return jQuery('input[name="currentPageNum"]',this.getContentHolder()).val()},removeCommentBlockIfExists:function(){var e=this.getContentHolder(),t=jQuery(".commentsBody",e);jQuery(".addCommentBlock",t).remove()},getCommentThread:function(e){var t=jQuery.Deferred();return AppConnector.request(e).done(function(e){t.resolve(e)}).fail(function(e,t){}),t.promise()},saveCommentAjax:function(e,t,a,n,i,r,o){var d=this,l=jQuery.progressIndicator({}),s=e.closest(".singleComment"),c=s.find(".related_to").val();c||(c=d.getRecordId());var u={commentcontent:a,related_to:c,module:"ModComments"};"edit"==t?(u.record=i,u.reasontoedit=n,u.parent_comments=r,u.mode="edit",u.action="Save"):"add"==t&&(u.parent_comments=i,u.action="SaveAjax"),AppConnector.request(u).done(function(e){l.progressIndicator({mode:"hide"}),"add"==t&&d.addRelationBetweenRecords("ModComments",e.result.id,d.getTabByLabel(d.detailViewRecentCommentsTabLabel)),app.event.trigger("DetailView.SaveComment.AfterAjax",s,u,e),o.resolve(e)}).fail(function(t,a){l.progressIndicator({mode:"hide"}),e.removeAttr("disabled"),o.reject(t,a)})},saveComment:function(e){var t,a=jQuery.Deferred(),n=jQuery(e.currentTarget),i=n.data("mode"),r=n.closest(".addCommentBlock"),o=r.find(".commentcontent"),d=o.val();if(""==d)return t=app.vtranslate("JS_LBL_COMMENT_VALUE_CANT_BE_EMPTY"),o.validationEngine("showPrompt",t,"error","bottomLeft",!0),a.reject(t),a.promise();if("edit"==i)var l=r.find('[name="reasonToEdit"]').val();var s=jQuery(e.currentTarget),c=r.closest(".commentDetails").find(".commentInfoHeader"),u=c.data("commentid"),g=c.data("parentcommentid");return this.saveCommentAjax(s,i,d,l,u,g,a),a.promise()},getCommentUI:function(e){var t=jQuery.Deferred(),a={view:"DetailAjax",module:"ModComments",record:e};return AppConnector.request(a).done(function(e){t.resolve(e)}).fail(function(e,t){}),t.promise()},getCommentBlock:function(){var e=this.getContentHolder(),t=jQuery(".basicAddCommentBlock",e).clone(!0,!0).removeClass("basicAddCommentBlock d-none").addClass("addCommentBlock");return t.find(".commentcontenthidden").removeClass("commentcontenthidden").addClass("commentcontent"),t},getEditCommentBlock:function(){var e=this.getContentHolder(),t=jQuery(".basicEditCommentBlock",e).clone(!0,!0).removeClass("basicEditCommentBlock d-none").addClass("addCommentBlock");return t.find(".commentcontenthidden").removeClass("commentcontenthidden").addClass("commentcontent"),t},registerSendSmsSubmitEvent:function(){var e=this;jQuery("body").on("submit","#massSave",function(t){var a=jQuery(t.currentTarget);if(a.find("#message").val().length>160){var n={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("LBL_SMS_MAX_CHARACTERS_ALLOWED"),type:"error"};return Vtiger_Helper_Js.showPnotify(n),!1}a.find(":submit").attr("disabled","disabled"),e.SendSmsSave(a),t.preventDefault()})},SendSmsSave:function(e){var t=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),a=e.serializeFormData();AppConnector.request(a).done(function(e){app.hideModalWindow(),t.progressIndicator({mode:"hide"})}).fail(function(e,t){})},registerNameAjaxEditEvent:function(){var e=this,t=e.getContentHolder();t.on(e.fieldUpdatedEvent,".nameField",function(a,n){var i=e.getForm(),r=i.data("nameFields"),o="";for(var d in r){0!=d&&(o+=" ");var l=r[d];o+=i.find('[name="'+l+'"]').val()}t.closest(".contentsDiv").find(".recordLabel").text(o)})},updateHeaderNameFields:function(){var e=this.getContentHolder(),t=this.getForm(),a=t.data("nameFields"),n=e.closest(".contentsDiv").find(".recordLabel"),i="";for(var r in a){var o=a[r],d=t.find('[name="'+o+'"]');if(d.length>0){var l=d.val();i+=l+" ",n.find('[class="'+o+'"]').text(l)}}var s=n.find(".salutation");s.length>0&&(i=s.text()+i);n.attr("title",i)},registerAjaxEditEvent:function(){var e=this;e.getContentHolder().on(e.fieldUpdatedEvent,"input,select,textarea",function(t){e.updateHeaderValues(jQuery(t.currentTarget))})},updateHeaderValues:function(e){if(e.hasClass("nameField"))return this.updateHeaderNameFields(),!0;var t=e.attr("name"),a=this.getUpdatefFieldsArray(),n=this.getContentHolder();if("-1"!=jQuery.inArray(t,a)){var i=e.val();n.closest(".contentsDiv").find("."+t+"_label").text(i)}},registerEmailFieldClickEvent:function(){this.getContentHolder().on("click",".emailField",function(e){e.stopPropagation()})},registerPhoneFieldClickEvent:function(){this.getContentHolder().on("click",".phoneField",function(e){e.stopPropagation()})},registerUrlFieldClickEvent:function(){this.getContentHolder().on("click",".urlField",function(e){e.stopPropagation()})},registerRelatedRowClickEvent:function(){this.getContentHolder().on("click",".listViewEntries",function(e){var t=jQuery(e.target,jQuery(e.currentTarget));if(!(t.is("td:first-child")&&t.children('input[type="checkbox"]').length>0||jQuery(e.target).is('input[type="checkbox"]'))){var a=jQuery(e.currentTarget).data("recordurl");void 0!==a&&(window.location.href=a)}})},loadRelatedList:function(e){var t=jQuery.Deferred();return null==e&&(e={}),Vtiger_RelatedList_Js.getInstance(this.getRecordId(),app.getModuleName(),this.getSelectedTab(),this.getRelatedModuleName()).loadRelatedList(e).done(function(e){t.resolve(e)},function(e,a){t.reject(e,a)}),t.promise()},registerEventForRelatedList:function(){var e=this,t=this.getContentHolder(),a=e.getRelatedModuleName();if(a){var n=Vtiger_RelatedList_Js.getInstance(e.getRecordId(),app.getModuleName(),e.getSelectedTab(),a);n.setRelatedContainer(t),n.registerRelatedEvents()}t.find(".detailViewBlockLink").each(function(t,a){var n=(a=$(a)).find(".blockContent");n.is(":visible")&&AppConnector.request({type:"GET",dataType:"html",data:a.data("url")}).done(function(t){n.html(t);var i=Vtiger_RelatedList_Js.getInstance(e.getRecordId(),app.getModuleName(),e.getSelectedTab(),a.data("reference"));i.setRelatedContainer(n),i.registerRelatedEvents()})}),t.find(".detailViewBlockLink .blockHeader").on("click",function(t){const a=$(t.target);if(a.is("input")||a.is("button")||a.parents().is("button")||a.hasClass("js-stop-propagation")||a.parents().hasClass("js-stop-propagation"))return!1;const n=$(this).closest(".js-toggle-panel"),i=n.find(".blockContent"),r=i.is(":empty");i.is(":visible")||(i.progressIndicator(),AppConnector.request({type:"GET",dataType:"html",data:n.data("url")}).done(function(t){i.html(t);const a=Vtiger_RelatedList_Js.getInstance(e.getRecordId(),app.getModuleName(),e.getSelectedTab(),n.data("reference"));a.setRelatedContainer(i),r?a.registerRelatedEvents():a.registerPostLoadEvents()}))})},registerBlockAnimationEvent:function(){var e=this;this.getContentHolder().find(".blockHeader").on("click",function(t){const a=$(t.target);if(a.is("input")||a.is("button")||a.parents().is("button")||a.hasClass("js-stop-propagation")||a.parents().hasClass("js-stop-propagation"))return!1;var n=$(this).find(".js-block-toggle").not(".d-none"),i=n.data("id"),r=n.closest(".js-toggle-panel"),o=r.find(".blockContent"),d=n.data(),l=app.getModuleName();"show"===d.mode?(o.addClass("d-none"),app.cacheSet(l+"."+i,0),n.addClass("d-none"),r.find('[data-mode="hide"]').removeClass("d-none")):(o.removeClass("d-none"),app.cacheSet(l+"."+i,1),n.addClass("d-none"),r.find('[data-mode="show"]').removeClass("d-none")),app.event.trigger("DetailView.js-block-toggle.PostLoad",o,d,e)})},registerBlockStatusCheckOnLoad:function(){let e=this.getContentHolder().find(".js-toggle-panel"),t=app.getModuleName();e.each(function(e,a){let n=jQuery(a),i=n.attr("data-dynamic");if(void 0!==i&&!1!==i){let e=n.find(".js-block-toggle").not(".d-none"),a=n.closest(".js-toggle-panel").find(".blockContent"),i=e.data("id"),r=t+"."+i,o=app.cacheGet(r,null);null!=o&&(1==o?(e.addClass("d-none"),n.find("[data-mode='show']").removeClass("d-none"),a.removeClass("d-none")):(e.addClass("d-none"),n.find("[data-mode='hide']").removeClass("d-none"),a.addClass("d-none")))}})},ajaxEditHandling:function(e){var t=this,a=jQuery(".setReadRecord");a.prop("disabled",!0);var n=jQuery(".value",e),i=jQuery(".edit",e),r=jQuery(".js-detail-quick-edit",e),o=jQuery(".fieldname",i);jQuery(o).each(function(o,d){var l=jQuery(d).val(),s=jQuery(d),c=-1!=jQuery.inArray(s.data("type"),["taxes","sharedOwner","multipicklist"])?l+"[]":l,u=jQuery('[name="'+c+'"]',i);if("disabled"!=u.attr("disabled")&&!(i.length<=0||i.is(":visible"))){u.attr("data-inputmask")&&u.inputmask(),n.addClass("d-none"),r.addClass("d-none"),i.removeClass("d-none").children().filter('input[type!="hidden"]input[type!="image"],select').filter(":first").focus();i.on("clickoutside",function(o){if(t.registerNameAjaxEditEvent(),!jQuery(o.target).closest(".fieldValue").is(e)){e.removeAttr("tabindex");var d=s.data("prevValue"),g=t.getForm().serializeFormData(),m=g[l]?g[l]:g[c],p=m,f=Vtiger_Field_Js.getInstance(u.data("fieldinfo")),v=[],h=!1;if(2==i.find("[data-fieldinfo]").length&&i.find("[data-fieldinfo]").each(function(){var e={name:jQuery(this).attr("name"),type:jQuery(this).data("fieldinfo").type};"datetime"==e.type&&(h=!0),v.push(e)}),u.is("input:checkbox")&&(m=u.is(":checked")?"1":"0",u=u.filter('[type="checkbox"]')),u.validationEngine("validate"))u.attr("data-inputmask")&&u.inputmask();else if(u.validationEngine("hide"),toStr(d)===toStr(m))i.addClass("d-none"),n.removeClass("d-none"),r.removeClass("d-none"),a.prop("disabled",!1),i.off("clickoutside");else{var C=jQuery.Event(t.fieldPreSave);if(u.trigger(C,{fieldValue:p,recordId:t.getRecordId()}),C.isDefaultPrevented())return void a.prop("disabled",!1);e.progressIndicator(),i.addClass("d-none");var y={};y.value=p,y.field=l,y=t.getCustomFieldNameValueMap(y),t.saveFieldValues(y).done(function(i){if(a.prop("disabled",!1),e.progressIndicator({mode:"hide"}),n.removeClass("d-none"),r.removeClass("d-none"),!i.success)return;const o=i.result;let c=o[l].display_value,g=o[l].prev_display_value;v.length&&h&&(c=o[v[0].name].display_value+" "+o[v[1].name].display_value),n.html(c),Vtiger_Helper_Js.showPnotify({title:app.vtranslate("JS_SAVE_NOTIFY_OK"),text:"<b>"+f.data.label+"</b><br><b>"+app.vtranslate("JS_SAVED_FROM")+"</b>: "+g+"<br> <b>"+app.vtranslate("JS_SAVED_TO")+"</b>: "+c,type:"info",textTrusted:!0}),!1===o.isEditable&&(jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),window!==window.parent?window.location.href=window.location.href.replace("view=Detail","view=DetailPreview"):window.location.reload()),u.trigger(t.fieldUpdatedEvent,{old:d,new:p}),s.data("prevValue",m),u.data("selectedValue",m),t.targetPicklistChange&&(jQuery(".js-widget-general-info",t.getForm()).length>0?t.targetPicklist.find(".js-detail-quick-edit").trigger("click"):t.targetPicklist.trigger("click"),t.targetPicklistChange=!1,t.targetPicklist=!1);var C=t.getSelectedTab();if(C.data("linkKey")==t.detailViewSummaryTabLabel){var y=t.getContentHolder();t.reloadTabContent(),t.registerSummaryViewContainerEvents(y),t.registerEventForPicklistDependencySetup(t.getForm()),t.registerEventForRelatedList()}else C.data("linkKey")==t.detailViewDetailsTabLabel&&t.registerEventForPicklistDependencySetup(t.getForm());t.updateRecordsPDFTemplateBtn(t.getForm())}).fail(function(t){i.addClass("d-none"),n.removeClass("d-none"),r.removeClass("d-none"),i.off("clickoutside"),a.prop("disabled",!1),e.progressIndicator({mode:"hide"})})}}function toStr(e){return null==e?"":e+""}})}})},triggerDisplayTypeEvent:function(){var e=app.cacheGet("widthType","narrowWidthType");e&&jQuery("#detailView").find("td").addClass(e)},addElementsToQuickCreateForCreatingRelation:function(e,t){jQuery('<input type="hidden" name="relationOperation" value="true" >').appendTo(e),jQuery.each(t,function(t,a){jQuery('<input type="hidden" name="'+t+'" value="'+a+'" >').appendTo(e)})},registerEventForActivityWidget:function(){var e=this;jQuery(".createActivity").on("click",function(t){var a=e.getRecordId(),n=app.getModuleName(),i=jQuery(t.currentTarget);let r={};if(r.sourceModule=n,r.sourceRecord=a,""!=n&&void 0!==e.referenceFieldNames.Calendar&&void 0!==e.referenceFieldNames.Calendar[n]){var o=e.referenceFieldNames.Calendar[n];r[o]=a}var d=i.data("url");let l={callbackPostShown:function(t){e.addElementsToQuickCreateForCreatingRelation(t,r);var a=t.find('[class^="CalendarQuikcCreateContents"]').find(".js-full-editlink"),n=t.find('[class^="EventsQuikcCreateContents"]').find(".js-full-editlink"),i=a.data("url")+"&"+d,o=n.data("url")+"&"+d;a.data("url",i),n.data("url",o)},callbackFunction:function(){var t=i.closest(".js-detail-widget"),a={type:"GET",dataType:"html",data:t.find(".widgetContentBlock").data("url")};AppConnector.request(a).done(function(e){var a=t.find(".js-detail-widget-content");a.html(e),App.Fields.Picklist.changeSelectElementView(a)}),e.loadWidgets()}};l.data=Object.assign({},r),l.noCache=!1,Vtiger_Header_Js.getInstance().quickCreateModule("Calendar",l)})},getEndDate:function(e){var t=e.split("-"),a=new Date(t[0],t[1],t[2]),n=new Date;return n.setDate(a.getDate()+2),app.getStringDate(n)},getSingleEventType:function(e,t,a){var n=jQuery('[name="date_start"]'),i=jQuery(n).val(),r=jQuery(n).data("date-format"),o=Vtiger_Helper_Js.convertToDateString(i,r,e,a),d=jQuery.extend({},["#b6a996,black"]),l={module:"Calendar",action:"Feed",start:o,end:this.getEndDate(o),type:a,mapping:d};AppConnector.request(l).done(function(a){var n=Vtiger_Helper_Js.convertToDateString(i,r,e);if(!jQuery.isEmptyObject(a))if("Task"===a[0].activitytype)for(var o in a)a[o].start.indexOf(n)>-1&&jQuery("#"+t+" .table").append('<tr><td><a target="_blank" href="'+a[o].url+'">'+a[o].title+"</a></td></tr>");else for(var d=0;d<a[0].length;d++)a[0][d].start.indexOf(n)>-1&&jQuery("#"+t+" .table").append('<tr><td><a target="_blank" href="'+a[0][d].url+'">'+a[0][d].title+"</a></td></tr>")})},registerFilterForAddingModuleRelatedRecordFromSummaryWidget:function(){var e=this;jQuery(".createRecordFromFilter").on("click",function(t){var a=jQuery(t.currentTarget),n=a.closest(".js-detail-widget").find(".js-detail-widget-content").find('[name="relatedModule"]').val(),i=a.data("url"),r=e.getRecordId(),o={},d=a.data("prf"),l=a.data("acf"),s=a.closest(".js-detail-widget-header").find('[name="relatedModule"]').val(),c={};void 0!==d&&(c[d]=r),void 0!==l&&$.each(l,function(e,t){c[e]=t}),Object.keys(c).length>0&&(o.data=c),o.noCache=!0,o.callbackFunction=function(t){e.postSummaryWidgetAddRecord(t,a),"ProjectTask"==n&&e.loadModuleSummary()};var u=jQuery.progressIndicator();let g;(g=window!==window.parent?window.parent.Vtiger_Header_Js.getInstance():Vtiger_Header_Js.getInstance()).getQuickCreateForm(i,s,o).done(function(e){g.handleQuickCreateData(e,o),u.progressIndicator({mode:"hide"})})}),$(".js-detail-widget button.selectRelation").on("click",function(t){let a=jQuery(t.currentTarget).closest(".js-detail-widget"),n=a.find('.js-detail-widget-content [name="relatedModule"]').val(),i=$(this).data("rf"),r={module:n,src_module:app.getModuleName(),src_record:e.getRecordId(),multi_select:!0};i&&Object.keys(i).length>0&&(r.search_key=i.key,r.search_value=i.name),app.showRecordsList(r,(t,i)=>{i.setSelectEvent(t=>{e.addRelationBetweenRecords(n,Object.keys(t)).done(function(t){e.loadWidget(a.find(".widgetContentBlock"))})})})})},registerAddingInventoryRecords:function(){jQuery(".createInventoryRecordFromFilter").on("click",function(e){var t=jQuery(e.currentTarget),a=t.data("url"),n=t.data("acf"),i="";void 0!==n&&$.each(n,function(e,t){i="&"+e+"="+t,a=a.concat(i)}),window.location.href=a})},registerEmailEvent:function(){this.getContentHolder().find(".resetRelationsEmail").on("click",function(e){Vtiger_Helper_Js.showConfirmationBox({message:app.vtranslate("JS_EMAIL_RESET_RELATIONS_CONFIRMATION")}).done(function(e){AppConnector.request({module:"OSSMailView",action:"Relation",moduleName:app.getModuleName(),record:app.getRecordId()}).done(function(e){Vtiger_Helper_Js.showMessage({text:e.result})})})})},getFiltersDataAndLoad:function(e,t){var a=this.getFiltersData(e,t);this.loadWidget(a.container,a.params)},getFiltersData:function(e,t){if(e.currentTarget)var a=jQuery(e.currentTarget);else a=e;var n=a.closest(".js-detail-widget"),i=n.find(".widgetContentBlock"),r="&"+i.data("url"),o={};r.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(e,t,a){o[t]=a});var d=[];return n.find(".js-detail-widget-header .js-switch, .js-detail-widget-header .js-filter_field").each(function(e,t){var a="",n=jQuery(t),i=n.data("urlparams");if("radio"==n.attr("type"))n.prop("checked")&&(a=void 0!==n.data("on-val")?n.data("on-val"):n.data("off-val"));else{var r=n.find("option:selected").val(),o=n.data("fieldlable"),l=n.data("filter");if(r==o)return;a=[[l,"e",r]]}i&&a&&(i in d?d[i].push(a):d[i]=[a])}),null!=t&&$.extend(d,t),{container:$(i),params:$.extend(o,d)}},registerChangeFilterForWidget:function(){var e=this;jQuery(".js-switch").on("change",function(t,a){e.getFiltersDataAndLoad(t)}),jQuery(".js-filter_field").on("select2:select",function(t,a){e.getFiltersDataAndLoad(t)})},registerChangeSwitchForWidget:function(e){var t=this;e.find(".activityWidgetContainer").on("change",".js-switch",function(e){var a=jQuery(e.currentTarget),n=a.closest(".js-detail-widget"),i=n.find(".widgetContentBlock"),r=i.data("url");r=r.replace("&type=current","").replace("&type=history",""),r+="&type=",void 0!==a.data("on-val")?(n.find(".ativitiesPagination").removeClass("d-none"),r=(r+="current").replace("&sortorder=DESC","&sortorder=ASC")):void 0!==a.data("off-val")&&(n.find(".ativitiesPagination").addClass("d-none"),r=(r+="history").replace("&sortorder=ASC","&sortorder=DESC")),i.data("url",r),t.loadWidget($(i))})},registerSummaryViewContainerEvents:function(e){var t=this;this.registerEventForActivityWidget(),this.registerChangeFilterForWidget(),this.registerChangeSwitchForWidget(e),this.registerFilterForAddingModuleRelatedRecordFromSummaryWidget(),this.registerAddingInventoryRecords(),this.registerEmailEvent(),e.off("click").on("click",".row .js-detail-quick-edit",function(e){var a=jQuery(e.currentTarget);a.addClass("d-none");var n=a.closest(".fieldValue");t.ajaxEditHandling(n)}),e.on(t.fieldUpdatedEvent,".js-widget-general-info",function(){let a,n=e.find("[data-type='Updates']");n.length&&(a=t.getFiltersData(n),n.find(".btnChangesReviewedOn").parent().remove(),t.loadWidget(n,a.params))}),e.on("click",".editDefaultStatus",function(e){var a=jQuery(e.currentTarget);a.popover("hide");var n=a.data("url");if(n)if(a.hasClass("showEdit")){var i=Vtiger_Header_Js.getInstance();i.getQuickCreateForm(n,"Calendar",{noCache:!0}).done(e=>{i.handleQuickCreateData(e,{callbackFunction:()=>{let e=a.closest(".widgetContentBlock");if(e.length){t.loadWidget(e);let a=t.getContentHolder().find("[data-type='Updates']");a.length>0&&t.loadWidget(a)}else t.loadRelatedList();t.registerRelatedModulesRecordCount()}})})}else app.showModalWindow(null,n)}),e.on("click",".editDescription",function(e){var t=jQuery(e.currentTarget),a=t.closest(".activityDescription"),n=a.find(".edit"),i=a.find(".value");t.hide(),i.addClass("d-none"),n.removeClass("d-none").show();var r=jQuery(".fieldname",n),o=r.val(),d=jQuery('[name="'+o+'"]',n),l=function(){var e=r.data("prevValue"),s=d.val(),c=d.val(),u=a.closest(".activityEntries"),g=u.find(".activityId").val(),m=u.find(".activityModule").val(),p=u.find(".activityType").val();if(e==s)n.addClass("d-none"),i.removeClass("d-none"),t.show();else{if(d.validationEngine("validate"))return void Vtiger_Helper_Js.addClickOutSideEvent(a,l);a.progressIndicator(),n.addClass("d-none"),AppConnector.request({action:"SaveAjax",record:g,field:o,value:s,module:m,activitytype:p}).done(function(e){a.progressIndicator({mode:"hide"}),i.removeClass("d-none"),t.show(),i.html(c),r.data("prevValue",s)})}};d.focus(),a.one("focusout",l)}),jQuery(".changeDetailViewMode").on("click",function(e){t.getTabs().filter('[data-link-key="'+t.detailViewDetailsTabLabel+'"]:not(.d-none)').trigger("click")}),jQuery(".createRecord").on("click",function(e){var a=jQuery(e.currentTarget),n=a.closest(".js-detail-widget").find(".js-detail-widget-header").find('[name="relatedModule"]').val(),i=t.getRecordId(),r=app.getModuleName(),o={};if(o.sourceModule=r,o.sourceRecord=i,""!=r&&""!=n&&void 0!==t.referenceFieldNames[n]&&void 0!==t.referenceFieldNames[n][r]){var d=t.referenceFieldNames[n][r];o[d]=i}var l={callbackFunction:function(e){t.postSummaryWidgetAddRecord(e,a)},goToFullFormcallback:function(e){t.addElementsToQuickCreateForCreatingRelation(e,o)}};l.data=o,l.noCache=!1,Vtiger_Header_Js.getInstance().quickCreateModule(n,l)}),this.registerFastEditingFiels()},addRelationBetweenRecords:function(e,t,a){var n=jQuery.Deferred(),i=this;return null==a&&(a=i.getSelectedTab()),Vtiger_RelatedList_Js.getInstance(i.getRecordId(),app.getModuleName(),a,e).addRelations(t).done(function(e){var t=i.getContentHolder().find("[data-type='Updates']");if(t.length>0){var a=i.getFiltersData(t);t.find(".btnChangesReviewedOn").parent().remove(),i.loadWidget(t,a.params)}n.resolve(e)}).fail(function(e,t){n.reject(e,t)}),n.promise()},postSummaryWidgetAddRecord:function(e,t){var a=this,n=t.closest(".js-detail-widget"),i=n.find(".js-detail-widget-header").find('[name="relatedModule"]').val(),r=[];r.push(e.result._recordId),this.addRelationBetweenRecords(i,r).done(function(e){a.loadWidget(n.find('[class^="widgetContainer_"]'))})},registerChangeEventForModulesList:function(){jQuery("#tagSearchModulesList").on("change",function(e){var t=jQuery(e.currentTarget);if("all"==t.val())jQuery('[name="tagSearchModuleResults"]').removeClass("d-none");else{jQuery('[name="tagSearchModuleResults"]').removeClass("d-none");var a=t.val();jQuery('[name="tagSearchModuleResults"]').filter(":not(#"+a+")").addClass("d-none")}})},registerEventForRelatedTabClick:function(){var e=this,t=e.getContentHolder(),a=t.closest("div.detailViewInfo");jQuery(".related",a).on("click","li:not(.spaceRelatedList)",function(n,i){var r=jQuery(n.currentTarget);if(!r.hasClass("dropdown")){var o=jQuery("<div></div>");o.progressIndicator({position:"html",blockInfo:{enabled:!0,elementToBlock:a}});var d=r.data("url");if(void 0!==i){var l=i.callback;delete i.callback}e.loadContents(d,i).done(function(a){e.deSelectAllrelatedTabs(),e.markTabAsSelected(r),Vtiger_Helper_Js.showHorizontalTopScrollBar(),o.progressIndicator({mode:"hide"}),e.registerHelpInfo(),app.registerModal(t),app.registerMoreContent(t.find("button.moreBtn")),"function"==typeof l&&l(a),r.data("linkKey")==e.detailViewSummaryTabLabel&&e.loadWidgets(),e.registerBasicEvents(),app.notifyPostAjaxReady(),app.event.trigger("DetailView.Tab.AfterLoad",a,e)}).fail(function(){o.progressIndicator({mode:"hide"})})}})},registerEventForPicklistDependencySetup:function(e){var t=this,a=jQuery('[name="picklistDependency"]',e);if(!(a.length<=0)){var n=JSON.parse(a.val()),i=Object.keys(n);if(!(i.length<=0)){for(var r=[],o=0;o<i.length;o++)r.push('[name="'+i[o]+'"]');r=r.join(",");var d=e.find(r);d.on("change",function(a){var i=jQuery(a.currentTarget),r=i.attr("name"),o=n[r],d=o[i.val()],l=o.__DEFAULT__;void 0===d&&(d=l),jQuery.each(l,function(a,n){var i=d[a];void 0===i&&(i=n);var r=jQuery('[name="'+a+'"]',e);if(!(r.length<=0)){var o=r.data("selectedValue");-1==jQuery.inArray(o,i)?(t.targetPicklistChange=!0,t.targetPicklist=r.closest("td")):(t.targetPicklistChange=!1,t.targetPicklist=!1);var l=r.data("availableOptions");void 0===l&&(l=jQuery("option",r),r.data("available-options",l));var s=new jQuery,c=[];c.push("");for(var u=0;u<i.length;u++)c.push(i[u]);jQuery.each(l,function(e,t){var a=jQuery(t).val();-1!=jQuery.inArray(a,c)&&(s=s.add(jQuery(t)))});var g="";g=s.filter("[selected]").val(),1==i.length&&(g=i[0]),r.html(s).val(g).trigger("change")}})}),d.trigger("change")}}},getChildComments:function(e){var t=jQuery.Deferred(),a="module="+app.getModuleName()+"&view=Detail&record="+this.getRecordId()+"&mode=showChildComments&commentid="+e;return this.getCommentThread(a).done(function(e){t.resolve(e)}),t.promise()},getParentComments(e){let t=jQuery.Deferred(),a="module="+app.getModuleName()+"&view=Detail&record="+this.getRecordId()+"&mode=showParentComments&commentid="+e;return this.getCommentThread(a).done(function(e){t.resolve(e)}),t.promise()},registerEventForTotalRecordsCount:function(){var e=this;this.getContentHolder().on("click",".totalNumberOfRecords",function(t){var a=jQuery(t.currentTarget),n=jQuery("#totalCount").val();if(a.addClass("d-none"),a.parent().progressIndicator({}),""==n){var i=e.getSelectedTab(),r=e.getRelatedModuleName();Vtiger_RelatedList_Js.getInstance(e.getRecordId(),app.getModuleName(),i,r).getRelatedPageCount().done(function(){e.showPagingInfo()})}else e.showPagingInfo();a.parent().progressIndicator({mode:"hide"})})},showPagingInfo:function(){var e=jQuery("#totalCount").val(),t=jQuery(".pageNumbersText").text()+" ("+e+")";0!=parseInt(jQuery("#noOfEntries").val())?jQuery(".pageNumbersText").html(t):jQuery(".pageNumbersText").html("")},getCustomFieldNameValueMap:function(e){return e},registerSetReadRecord:function(e){var t=this;e.on("click",".setReadRecord",function(e){jQuery(e.currentTarget).closest(".btn-group").addClass("d-none"),jQuery("#Accounts_detailView_fieldValue_was_read").find(".value").text(app.vtranslate("LBL_YES"));var a={module:app.getModuleName(),action:"SaveAjax",record:t.getRecordId(),field:"was_read",value:"on"};AppConnector.request(a).done(function(e){var a={text:app.vtranslate("JS_SET_READ_RECORD"),title:app.vtranslate("System"),type:"info"};Vtiger_Helper_Js.showPnotify(a);var n=jQuery(".related li.active");n.data("linkKey")!=t.detailViewSummaryTabLabel&&n.data("linkKey")!=t.detailViewDetailsTabLabel||t.reloadTabContent()})})},registerFastEditingFiels:function(){var e=this;jQuery(".summaryWidgetFastEditing select").on("change",function(t){var a=jQuery(t.currentTarget),n=a.closest(".editField"),i=jQuery.progressIndicator({message:app.vtranslate("JS_SAVE_LOADER_INFO"),position:"summaryWidgetFastEditing",blockInfo:{enabled:!0}}),r=n.data("fieldname");r=r.replace("q_","");var o=a.val();if(a.validationEngine("validate"))n.progressIndicator({mode:"hide"});else{var d=jQuery.Event(e.fieldPreSave);a.trigger(d,{fieldValue:o,recordId:e.getRecordId()});var l={};l.value=o,l.field=r,l=e.getCustomFieldNameValueMap(l),e.saveFieldValues(l),i.progressIndicator({mode:"hide"});var s={title:app.vtranslate("JS_SAVE_NOTIFY_OK"),type:"success"};Vtiger_Helper_Js.showPnotify(s),e.reloadTabContent()}})},registerHelpInfo:function(){var e=this.getForm();app.showPopoverElementView(e.find(".js-help-info"))},registerRelatedModulesRecordCount:function(e){var t=$(".related .nav .dropdown-menu"),a=e;a&&void 0!==a.length||(a=$(".related .nav > .relatedNav, .related .nav > .mainNav, .detailViewBlockLink, .related .nav .dropdown-menu > .relatedNav")),a.each(function(e,a){"1"==(a=$(a)).data("count")&&AppConnector.request({module:app.getModuleName(),action:"RelationAjax",record:app.getRecordId(),relatedModule:a.data("reference"),mode:"getRelatedListPageCount",tab_label:a.data("label-key")}).done(function(e){e.success&&(0===e.result.numberOfRecords&&(e.result.numberOfRecords=""),a.find(".count").text(e.result.numberOfRecords),t.find('[data-reference="'+a.data("reference")+'"] .count').text(e.result.numberOfRecords))})})},addComment:function(e,t){const a=this;let n=e.data("mode"),i=e.closest(".addCommentBlock"),r=i.find(".commentcontent"),o=e.closest(".js-comment-single");if(r.val(""),"add"==n){let e=t.result.id;a.getCommentUI(e).done(function(e){let t=i.closest(".js-commentDetails"),n=a.getContentHolder();if($(".js-noCommentsMsgContainer",n).remove(),t.length>0){if(i.remove(),t.find("ul").length<=0){let e=o.find(".js-viewThreadBlock").data("childCommentsCount")+1;o.find(".childCommentsCount").text(e);let n=o.find(".js-commentInfoHeader").data("commentid");a.getChildComments(n).done(function(e){$(e).appendTo(t),o.find(".js-viewThreadBlock").hide(),o.find(".hideThreadBlock").show()})}else $('<ul class="liStyleNone"><li class="js-commentDetails commentDetails">'+e+"</li></ul>").appendTo(t)}else $('<ul class="liStyleNone"><li class="js-commentDetails commentDetails">'+e+"</li></ul>").prependTo(i.closest(".contents").find(".commentsList"));o.find(".js-comment-container").show(),app.event.trigger("DetailView.SaveComment.AfterLoad",o,e)})}else if("edit"==n){let e=o.find(".js-commentModifiedTime"),a=o.find(".js-comment-info"),n=o.find(".js-editStatus"),r=o.find(".js-editReasonSpan");a.html(t.result.commentcontent),r.html(t.result.reasontoedit),e.html(t.result.modifiedtime),e.attr("title",t.result.modifiedtimetitle),n.hasClass("d-none")&&n.removeClass("d-none"),""!=t.result.reasontoedit&&o.find(".js-editReason").removeClass("d-none"),a.show(),o.find(".js-comment-container").show(),i.remove(),app.event.trigger("DetailView.SaveComment.AfterUpdate",o,t)}},registerCommentEvents(e){const t=this;e.on("click",".addCommentBtn",function(e){t.removeCommentBlockIfExists(),t.getCommentBlock().appendTo(".commentBlock")}),e.on("click",".closeCommentBlock",function(e){let a=jQuery(e.currentTarget.closest(".js-comment-single"));a.find(".js-comment-container").show(),a.find(".commentInfoContent").show(),t.removeCommentBlockIfExists()}),e.on("click",".js-replyComment",function(e){t.removeCommentBlockIfExists();let a=$(e.currentTarget).closest(".js-comment-single");a.find(".js-comment-container").hide(),t.getCommentBlock().appendTo(a).show()}),e.on("click",".js-edit-comment",function(e){t.removeCommentBlockIfExists();let a=$(e.currentTarget).closest(".js-comment-single"),n=a.find(".commentInfoContent"),i=t.getEditCommentBlock();i.find(".commentcontent").val(n.text()),i.find(".js-reasonToEdit").val(a.find(".js-editReasonSpan").text()),n.hide(),a.find(".js-comment-container").hide(),i.appendTo(a).show()}),e.on("click",".detailViewSaveComment",function(a){let n=$(a.currentTarget);n.is(":disabled")||t.saveComment(a).done(function(){t.registerRelatedModulesRecordCount(),t.loadWidget(e.find("[data-type='Comments']")).done(function(){n.removeAttr("disabled")})}).fail(function(e,t){n.removeAttr("disabled"),app.errorLog(e,t)})}),e.on("click",".js-saveComment",function(e){let a=$(e.currentTarget);a.is(":disabled")||t.saveComment(e).done(function(e){t.registerRelatedModulesRecordCount(t.getTabByLabel(t.detailViewRecentCommentsTabLabel)),t.addComment(a,e),a.removeAttr("disabled")}).fail(function(e,t){a.removeAttr("disabled"),app.errorLog(e,t)})}),e.on("click",".js-moreRecentComments",function(){t.getTabByLabel(t.detailViewRecentCommentsTabLabel).trigger("click")}),e.on("change",".js-detailHierarchyComments",function(e){let a=t.getTabByLabel(t.detailViewRecentCommentsTabLabel),n=a.data("url");n=n.replace(/&hierarchy=+([\w,]+)/,""),$(this).val()&&(n+="&hierarchy="+$(this).val()),a.data("url",n),a.trigger("click")}),e.on("keypress",".js-commentSearch",function(a){13===a.which&&t.submitSearchForm(e)}),e.on("click",".js-searchIcon",function(a){t.submitSearchForm(e)})},submitSearchForm(e){let t=e.find(".js-commentSearch"),a=t.closest('[data-name="ModComments"]'),n=$.progressIndicator();if("widget"!==t.data("container")||t.val()){let i=e.find(".js-detailHierarchyComments:checked").val(),r="",o=!1;"widget"===t.data("container")&&(i=e.find(".js-hierarchyComments:checked").val(),r=a.data("limit"),o=!0),AppConnector.request({module:app.getModuleName(),view:"Detail",mode:"showSearchComments",hierarchy:i,limit:r,record:app.getRecordId(),search_key:t.val(),is_widget:o}).done(function(a){n.progressIndicator({mode:"hide"}),t.val()?e.find(".js-commentsBody").html(a):e.html(a)})}else{let t=a.data("url");AppConnector.request(t).done(function(t){n.progressIndicator({mode:"hide"}),e.find(".js-commentContainer").html(t)})}},registerCommentEventsInDetail(e){e.on("change",".js-hierarchyComments",function(t){let a=$.progressIndicator();AppConnector.request({module:app.getModuleName(),view:"Detail",mode:"showRecentComments",hierarchy:$(this).val(),record:app.getRecordId()}).done(function(t){a.progressIndicator({mode:"hide"});let n=e.find(".js-detail-widget-content");n.html(t),App.Fields.Picklist.showSelect2ElementView(n.find(".select2"))})})},registerMailPreviewWidget:function(e){var t=this;e.on("click",".showMailBody",function(e){var t=$(e.currentTarget).closest(".row"),a=t.find(".mailBody"),n=t.find(".mailTeaser"),i=$(e.currentTarget).find("[data-fa-i2svg]");a.hasClass("d-none")?(a.removeClass("d-none"),n.addClass("d-none"),i.removeClass("fa-caret-down").addClass("fa-caret-up")):(a.addClass("d-none"),n.removeClass("d-none"),i.removeClass("fa-caret-up").addClass("fa-caret-down"))}),e.find('[name="mail-type"]').on("change",function(a){t.loadMailPreviewWidget(e)}),e.find('[name="mailFilter"]').on("change",function(a){t.loadMailPreviewWidget(e)}),e.on("click",".showMailsModal",function(a){var n=$(a.currentTarget).data("url");n+="&type="+e.find('[name="mail-type"]').val(),e.find('[name="mailFilter"]').length>0&&(n+="&mailFilter="+e.find('[name="mailFilter"]').val());var i=jQuery.progressIndicator();app.showModalWindow("",n,function(e){i.progressIndicator({mode:"hide"}),t.registerMailPreviewWidget(e),Vtiger_Index_Js.registerMailButtons(e),e.find(".expandAllMails").click()})}),e.find(".expandAllMails").on("click",function(t){e.find(".mailBody").removeClass("d-none"),e.find(".mailTeaser").addClass("d-none"),e.find(".showMailBody [data-fa-i2svg]").removeClass("fa-caret-down").addClass("fa-caret-up")}),e.find(".collapseAllMails").on("click",function(t){e.find(".mailBody").addClass("d-none"),e.find(".mailTeaser").removeClass("d-none"),e.find(".showMailBody [data-fa-i2svg]").removeClass("fa-caret-up").addClass("fa-caret-down")})},loadMailPreviewWidget:function(e){var t=this,a=e.find(".js-detail-widget-content"),n=$("#recordId").val(),i=a.progressIndicator(),r={module:"OSSMailView",view:"Widget"};r.smodule=$("#module").val(),r.srecord=n,r.mode="showEmailsList",r.type=$('[name="mail-type"]').val(),r.mailFilter=$('[name="mailFilter"]').val(),AppConnector.request(r).done(function(e){a.html(e),app.event.trigger("DetailView.Widget.AfterLoad",a,r.module,t),i.progressIndicator({mode:"hide"})})},registerEmailEvents:function(e){Vtiger_Index_Js.registerMailButtons(e)},registerMapsEvents:function(e){e.find("#coordinates").length&&(new OpenStreetMap_Map_Js).registerDetailView(e)},registerSocialMediaEvents(e){e.find(".tpl-Detail-SocialMedia").length},registerShowSummary:function(e){e.on("click",".showSummaryRelRecord",function(t){var a=$(t.currentTarget).data("id"),n=e.find(".summaryRelRecordView"+a);e.find(".listViewEntriesTable").css("display","none"),n.show()}),e.on("click",".hideSummaryRelRecordView",function(t){var a=e.find(".summaryRelRecordView");e.find(".listViewEntriesTable").css("display","table"),a.hide()})},showProgressConfirmation(e,t){const a=this;let n=$(e).data("picklistValue");Vtiger_Helper_Js.showConfirmationBox({title:n,message:app.vtranslate("JS_CHANGE_VALUE_CONFIRMATION")}).done(()=>{const e=$.progressIndicator();a.saveFieldValues({value:n,field:t}).done(()=>{e.progressIndicator({mode:"hide"}),window.location.reload()}).fail(function(t,a){e.progressIndicator({mode:"hide"}),app.errorLog(t,a)})})},registerProgress(){const e=this;$(".js-header-progress-bar").each((t,a)=>{let n=$(a).data("picklistName");$(a).find(".js-access").on("click",t=>{e.showProgressConfirmation(t.currentTarget,n)})})},registerBasicEvents:function(){var e=this,t=e.getContentHolder(),a=e.getSelectedTab();"undefined"!=typeof Chat_JS&&("LBL_CHAT"===this.getSelectedTab().data("labelKey")?Chat_JS.getInstance(t,"detail").registerBaseEvents():Chat_JS.getInstance(t,"detail").unregisterEvents()),e.registerSummaryViewContainerEvents(t),e.registerCommentEvents(t),e.registerEmailEvents(t),e.registerMapsEvents(t),e.registerSocialMediaEvents(t),App.Fields.Date.register(t),App.Fields.DateTime.register(t),App.Fields.MultiImage.register(t),app.registerEventForClockPicker(),App.Fields.Picklist.showSelect2ElementView(t.find("select.select2")),t.on("click","#detailViewNextRecordButton",function(t){var n=a.data("url"),i=e.getRelatedListCurrentPageNum(),r=n+"&page="+(parseInt(i)+1);e.loadContents(r)}),t.on("click","#detailViewPreviousRecordButton",function(t){var n=a.data("url"),i=e.getRelatedListCurrentPageNum(),r=n+"&page="+(parseInt(i)-1);e.loadContents(r)}),t.on("click","div.detailViewTable div.fieldValue",function(t){if(!jQuery(t.target).closest("a").hasClass("btnNoFastEdit")){var a=jQuery(t.currentTarget);e.ajaxEditHandling(a)}}),t.on("click","div.recordDetails span.squeezedWell",function(e){var t=jQuery(e.currentTarget).data("reference");jQuery('.detailViewInfo .related .nav > li[data-reference="'+t+'"]').trigger("click")}),t.on("click",".relatedPopup",function(e){return(new Vtiger_Edit_Js).showRecordsList(e),!1}),t.on("click",".viewThread",function(t){let a=jQuery(t.currentTarget),n=a.parent(),i=a.closest(".commentActions"),r=a.closest(".js-commentDetails").find("ul");if(r.length>0)return r.show(),i.find(".hideThreadBlock").show(),void n.hide();var o=a.closest(".commentDiv").find(".js-commentInfoHeader").data("commentid");e.getChildComments(o).done(function(e){jQuery(e).appendTo(jQuery(t.currentTarget).closest(".js-commentDetails")),i.find(".hideThreadBlock").show(),n.hide()})}),t.on("click",".js-viewParentThread",function(t){let a=jQuery(t.currentTarget),n=a.parent(),i=a.closest(".commentDiv").find(".js-commentInfoHeader").data("commentid");e.getParentComments(i).done(function(e){jQuery(t.currentTarget.closest(".js-commentDetails")).html(e),a.closest(".commentActions").find(".hideThreadBlock").show(),n.hide()})}),t.on("click",".hideThread",function(e){var t=jQuery(e.currentTarget),a=t.parent(),n=t.closest(".commentActions");t.closest(".js-commentDetails").find("ul").hide(),a.hide(),n.find(".viewThreadBlock").show()}),t.on("click",".detailViewThread",function(t){var a=e.getTabByLabel(e.detailViewRecentCommentsTabLabel),n=jQuery(t.currentTarget).closest(".singleComment").find(".commentInfoHeader").data("commentid");a.trigger("click",{commentid:n,callback:function(e){window.location.href=window.location.href+"#"+n}})}),t.on("click",".moreRecentRecords",function(t){t.preventDefault(),e.getTabByModule($(this).data("label-key")).trigger("click")}),t.on("change",".relatedHistoryTypes",function(e){let t=jQuery(this).closest(".widgetContentBlock").find(".widgetContent"),a=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0,elementToBlock:t}});AppConnector.request({module:app.getModuleName(),view:"Detail",record:app.getRecordId(),mode:"showRecentRelation",page:1,limit:t.find(".js-relatedHistoryPageLimit").val(),type:$(e.currentTarget).val()}).done(function(e){a.progressIndicator({mode:"hide"}),t.find("#relatedHistoryCurrentPage").remove(),t.find("#moreRelatedUpdates").remove(),t.html(e),Vtiger_Index_Js.registerMailButtons(t)})}),t.on("click",".moreProductsService",function(){jQuery('.related .mainNav[data-reference="ProductsAndServices"]:not(.d-none)').trigger("click")}),t.on("click",".moreRelatedUpdates",function(){var e=jQuery(this).closest(".widgetContentBlock"),t=e.find(".widgetContent"),a=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0,elementToBlock:t}}),n=t.find("#relatedHistoryCurrentPage").val(),i=parseInt(n)+1,r=e.find(".relatedHistoryTypes").val(),o=t.find("#relatedHistoryPageLimit").val();AppConnector.request({module:app.getModuleName(),view:"Detail",record:app.getRecordId(),mode:"showRecentRelation",page:i,limit:o,type:r}).done(function(e){a.progressIndicator({mode:"hide"}),t.find("#relatedHistoryCurrentPage").remove(),t.find("#moreRelatedUpdates").remove(),t.find("#relatedUpdates").append(e)})}),t.on("click",".moreRecentUpdates",function(t){const a=$(t.currentTarget).closest(".recentActivitiesContainer");let n,i=a.find("#newChange").val(),r=parseInt(a.find("#updatesCurrentPage").val())+1;if(a.closest(".js-detail-widget").length){n=e.getFiltersData(t,{page:r,tab_label:"LBL_UPDATES",newChange:i},a.find("#updates")).params}else if(-1===(n=(n=e.getTabByLabel(e.detailViewRecentUpdatesTabLabel).data("url")).replace("&page=1","&page="+r)+"&skipHeader=true&newChange="+i).indexOf("&whereCondition")){let e=jQuery(".active .js-switch--recentActivities");n+="&whereCondition="+(void 0===e.data("on-val")?e.data("off-val"):e.data("on-val"))}AppConnector.request(n).done(function(t){let n=jQuery(t);a.find("#newChange").val(n.find("#newChange").val()),a.find("#updatesCurrentPage").val(n.find("#updatesCurrentPage").val()),a.find(".js-more-link").html(n.find(".js-more-link").html()),a.find("#updates ul").append(n.find("#updates ul").html()),app.registerMoreContent(a.find("button.moreBtn")),app.event.trigger("DetailView.UpdatesWidget.AddMore",t,e)})}),t.on("click",".btnChangesReviewedOn",function(n){var i=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),r="index.php?module=ModTracker&action=ChangesReviewedOn&record="+app.getRecordId();AppConnector.request(r).done(function(r){if(i.progressIndicator({mode:"hide"}),jQuery(n.currentTarget).parent().remove(),e.getTabByLabel(e.detailViewRecentUpdatesTabLabel).find(".count.badge").text(""),a.data("labelKey")==e.detailViewRecentUpdatesTabLabel)e.reloadTabContent();else if(a.data("linkKey")==e.detailViewSummaryTabLabel){var o=t.find("[data-type='Updates']");if(o.length>0){var d=e.getFiltersData(o);e.loadWidget(o,d.params)}}})}),t.on("click",".moreRecentDocuments",function(){e.getTabByLabel(e.detailViewRecentDocumentsTabLabel).trigger("click")}),t.on("click",".moreRecentActivities",function(t){var a=$(t.currentTarget);a.prop("disabled",!0);var n=a.closest(".activityWidgetContainer"),i=n.find(".currentPage").val();i++;var r=n.find(".widgetContentBlock").data("url");r=r.replace("&page=1","&page="+i),r+="&totalCount="+n.find(".totaltActivities").val(),AppConnector.request(r).done(function(t){a.prop("disabled",!1),a.addClass("d-none");var i=n.find(".currentPage").val();n.find(".currentPage").remove(),n.find(".countActivities").remove(),n.find(".js-detail-widget-content").append(t),n.find(".countActivities").val(parseInt(n.find(".countActivities").val())+i*parseInt(n.find(".pageLimit").val())),e.reloadWidgetActivitesStats(n)})}),t.on("click",".widgetFullscreen",function(e){var t=$(e.currentTarget).closest(".widgetContentBlock").data("url");t=t.replace("&view=Detail&","&view=WidgetFullscreen&");var a=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}});app.showModalWindow(null,"index.php?"+t,function(e){a.progressIndicator({mode:"hide"})})}),e.registerEventForRelatedList(),e.registerBlockAnimationEvent(),e.registerMailPreviewWidget(t.find('.widgetContentBlock[data-type="EmailList"]')),e.registerMailPreviewWidget(t.find('.widgetContentBlock[data-type="HistoryRelation"]')),t.find(".js-switch--recentActivities").off().on("change",function(t){const a=jQuery(t.currentTarget),n=e.getTabByLabel(e.detailViewRecentUpdatesTabLabel),i=a.data("urlparams"),r=$(this).data("on-val"),o=$(this).data("off-val");let d=n.data("url");d=d.replace("&"+i+"="+r,"").replace("&"+i+"="+o,""),void 0!==a.data("on-val")?d+="&"+i+"="+r:void 0!==a.data("off-val")&&(d+="&"+i+"="+o),n.data("url",d),n.trigger("click")})},reloadWidgetActivitesStats:function(e){var t=e.find(".countActivities"),a=e.find(".totaltActivities");if(!t.length||!a.length)return!1;var n=" ("+t.val()+"/"+a.val()+")",i=e.find(".active .js-switch"),r=i.parent(),o=i.data("basic-text")+n;r.removeTextNode(),r.append(o)},refreshCommentContainer:function(e){var t=$(".commentsBody"),a={module:app.getModuleName(),view:"Detail",record:this.getRecordId(),mode:"showThreadComments",commentid:e},n=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0,elementToBlock:t}});AppConnector.request(a).done(function(e){n.progressIndicator({mode:"hide"}),t.html(e)})},updateRecordsPDFTemplateBtn:function(e){AppConnector.request({data:{module:app.getModuleName(),action:"PDF",mode:"hasValidTemplate",record:app.getRecordId(),view:app.getViewName()},dataType:"json"}).done(function(e){let t,a=jQuery(".detailViewToolbar .btn-toolbar");if(!1===e.result.valid)(t=a.find('.btn-group:eq(1) [href*="showPdfModal"]')).length&&t.remove();else{let e=a.find(".btn-group:eq(1)");0===(t=a.find('.btn-group:eq(1) [href*="showPdfModal"]')).length&&e.append('<a class="btn btn-default js-popover-tooltip" href=\'javascript:Vtiger_Header_Js.getInstance().showPdfModal("index.php?module='+app.getModuleName()+"&view=PDF&fromview=Detail&record="+app.getRecordId()+'");\' data-content="'+app.vtranslate("LBL_EXPORT_PDF")+'" data-original-title="" title=""><span class="fas fa-file-excel icon-in-button"></span></a>')}}).fail(function(e,t){app.errorLog(e,t)})},updateWindowHeight:function(e,t){t.height(e)},registerEvents:function(){this.registerHelpInfo(),this.registerSendSmsSubmitEvent(),this.registerAjaxEditEvent(),this.registerRelatedRowClickEvent(),this.registerBlockStatusCheckOnLoad(),this.registerEmailFieldClickEvent(),this.registerPhoneFieldClickEvent(),this.registerEventForRelatedTabClick(),Vtiger_Helper_Js.showHorizontalTopScrollBar(),this.registerUrlFieldClickEvent();var e=jQuery("div.detailViewContainer");e.length<=0||(this.registerSetReadRecord(e),this.registerEventForPicklistDependencySetup(this.getForm()),this.getForm().validationEngine(app.validationEngineOptionsForRecord),this.loadWidgetsEvents(),this.loadWidgets(),this.registerBasicEvents(),this.registerEventForTotalRecordsCount(),this.registerProgress())}});
//# sourceMappingURL=Detail.min.js.map