"use strict";Vtiger_BasicSearch_Js("Vtiger_AdvanceSearch_Js",{cache:{}},{elementContainer:!1,advanceFilter:!1,filterValidationRegistered:!1,filterForm:!1,parentContainer:!1,getContainer:function(){return this.elementContainer},setContainer:function(container){return this.elementContainer=container,this},getParentContainer:function(){return this.parentContainer},setParentContainer:function(container){return this.setMainContainer(container),this.parentContainer=container,this},getFilterForm:function(){return $('form[name="advanceFilterForm"]',this.getContainer())},getAdvanceSearch:function(){var aDeferred=$.Deferred(),searchModule=this.getSearchModule();if(searchModule in Vtiger_AdvanceSearch_Js.cache)return aDeferred.resolve(Vtiger_AdvanceSearch_Js.cache[searchModule]),aDeferred.promise();var searchableModulesParams={module:app.getModuleName(),searchModule:searchModule,view:"BasicAjax",mode:"showAdvancedSearch"};app.getParentModuleName()&&(searchableModulesParams.parent=app.getParentModuleName());var progressInstance=$.progressIndicator();return AppConnector.request(searchableModulesParams).done((function(data){progressInstance.hide(),Vtiger_AdvanceSearch_Js.cache[searchModule]=data,aDeferred.resolve(data)})).fail((function(error,err){aDeferred.reject(error)})),aDeferred.promise()},initiateSearch:function(){var aDeferred=$.Deferred(),thisInstance=this,postLoad=function(uiData){thisInstance.setContainer($("#advanceSearchContainer")),thisInstance.filterValidationRegistered=!1,thisInstance.registerEvents(),thisInstance.advanceFilter=new Vtiger_ConditionBuilder_Js(thisInstance.getContainer().find(".js-condition-builder"),thisInstance.getSearchModule()),thisInstance.advanceFilter.registerEvents(),aDeferred.resolve()};return thisInstance.getAdvanceSearch().done((function(data){var params={};params.data=data,params.cb=postLoad,app.hideModalWindow(),app.showModalWindow(params)})).fail((function(error){aDeferred.reject()})),aDeferred.promise()},search:function(){var conditionValues=this.advanceFilter.getConditions(),module=this.getSearchModule();return this._search({module:app.getModuleName(),searchModule:module,advfilterlist:JSON.stringify(conditionValues)})},showSearchResults:function(data){var aDeferred=$.Deferred(),jQhtml=$('<div class="row"><span class="col-md-4 searchHolder"></span><span class="col-md-8 filterHolder marginLeftZero d-none"></span></div>');$(".searchHolder",jQhtml).html(data),data=jQhtml;var params={};return params.data=data,params.cb=function(data){aDeferred.resolve(data)},app.showModalWindow(params),aDeferred.promise()},saveFilter:function(params){var aDeferred=$.Deferred();return params.source_module=this.getSearchModule(),params.status=1,params.advfilterlist=JSON.stringify(this.advanceFilter.getConditions()),params.module="CustomView",params.action="Save",AppConnector.request(params).done((function(data){if(!data.success){var params={title:app.vtranslate("JS_MESSAGE"),text:data.error.message,type:"error"};Vtiger_Helper_Js.showPnotify(params)}aDeferred.resolve(data)})),aDeferred.promise()},saveAndViewFilter:function(params){this.saveFilter(params).done((function(response){var url=response.result.listviewurl;window.location.href=url}),(function(error){}))},isSearchAndFilterComponentsShown:function(){var modalData=$("#"+Window.lastModalId);return!($(".filterHolder",modalData).find("#advanceSearchContainer").length<=0)},performSearch:function(){var thisInstance=this,isSearchResultsAndFilterShown=this.isSearchAndFilterComponentsShown();this.search().done((function(data){thisInstance.setContainer(thisInstance.getContainer().detach()),thisInstance.showSearchResults(data).done((function(modalBlock){thisInstance.registerShowFiler(),isSearchResultsAndFilterShown&&thisInstance.showFilter()}))}))},showFilter:function(){var thisInstance=this;app.hideModalWindow((function(){app.showModalWindow(thisInstance.getContainer())}))},performValidation:function(){var thisInstance=this;this.formValidationDeferred=$.Deferred();var controlForm=this.getFilterForm();return this.filterValidationRegistered||(this.filterValidationRegistered=!0,controlForm.validationEngine({onValidationComplete:function(form,status){status?thisInstance.formValidationDeferred.resolve():thisInstance.formValidationDeferred.reject()}})),controlForm.submit(),this.formValidationDeferred.promise()},registerShowFiler:function(){var thisInstance=this;$("#showFilter").on("click",(function(e){thisInstance.showFilter()}))},registerEvents:function(){var thisInstance=this;this.getContainer().on("change","#searchModuleList",(function(e){var selectedModuleName=$(e.currentTarget).val();thisInstance.setSearchModule(selectedModuleName),thisInstance.initiateSearch()})),$("#advanceSearchButton").on("click",(function(e){thisInstance.getSearchModule().length<=0?app.getChosenElementFromSelect($("#searchModuleList")).validationEngine("showPrompt",app.vtranslate("JS_SELECT_MODULE"),"error","topRight",!0):thisInstance.performValidation().done((function(){thisInstance.performSearch()})).fail((function(){}))})),$("#advanceIntiateSave").on("click",(function(e){var currentElement=$(e.currentTarget);currentElement.addClass("d-none");var actionsContainer=currentElement.closest(".actions");$(".js-name-filter",actionsContainer).removeClass("d-none").focus(),$("#advanceSave").removeClass("d-none")})),$("#advanceSave").on("click",(function(e){var actionsContainer=$(e.currentTarget).closest(".actions"),filterNameField=$('input[name="viewname"]',actionsContainer),value=filterNameField.val();value.length<=0?filterNameField.validationEngine("showPrompt",app.vtranslate("JS_REQUIRED_FIELD"),"error","topRight",!0):thisInstance.getSearchModule().length<=0?app.getChosenElementFromSelect($("#searchModuleList")).validationEngine("showPrompt",app.vtranslate("JS_SELECT_MODULE"),"error","topRight",!0):thisInstance.performValidation().done((function(){var params={};params.viewname=value,thisInstance.saveAndViewFilter(params)}))})),this.getFilterForm().on("submit",(function(e){e.preventDefault()})),this.setSearchModule($("#searchModuleList").val())}});
//# sourceMappingURL=AdvanceSearch.min.js.map
