"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};$.Class("Vtiger_Edit_Js",{referenceSelectionEvent:"Vtiger.Reference.Selection",referenceDeSelectionEvent:"Vtiger.Reference.DeSelection",recordPreSave:"Vtiger.Record.PreSave",editInstance:!1,inventoryController:!1,getInstanceByModuleName:function(moduleName){void 0===moduleName&&(moduleName=app.getModuleName());var parentModule=app.getParentModuleName(),moduleClassName=void 0,fallbackClassName=void 0,instance=void 0;return"Settings"===parentModule?(moduleClassName=parentModule+"_"+moduleName+"_Edit_Js",void 0===window[moduleClassName]&&(moduleClassName=moduleName+"_Edit_Js"),fallbackClassName=parentModule+"_Vtiger_Edit_Js",void 0===window[fallbackClassName]&&(fallbackClassName="Vtiger_Edit_Js")):(moduleClassName=moduleName+"_Edit_Js",fallbackClassName="Vtiger_Edit_Js"),(instance=void 0!==window[moduleClassName]?new window[moduleClassName]:new window[fallbackClassName]).moduleName=moduleName,instance},getInstance:function(){if(0==Vtiger_Edit_Js.editInstance){var instance=Vtiger_Edit_Js.getInstanceByModuleName();return Vtiger_Edit_Js.editInstance=instance,instance}return Vtiger_Edit_Js.editInstance}},{formElement:!1,relationOperation:"",moduleName:app.getModuleName(),getForm:function(){return 0==this.formElement&&this.setForm($("#EditView")),this.formElement},setForm:function(element){return this.formElement=element,this},getRecordsListParams:function(container){var sourceModule=app.getModuleName(),popupReferenceModule=$('input[name="popupReferenceModule"]',container).val(),sourceFieldElement=$('input[class="sourceField"]',container),sourceField=sourceFieldElement.attr("name"),sourceRecordElement=$('input[name="record"]'),sourceRecordId="";sourceRecordElement.length>0&&(sourceRecordId=sourceRecordElement.val());var isMultiple=!1;1==sourceFieldElement.data("multiple")&&(isMultiple=!0);var filterFields={},formElement=container.closest("form"),mappingRelatedField=formElement.find('input[name="mappingRelatedField"]').val(),mappingRelatedModule=mappingRelatedField?JSON.parse(mappingRelatedField):[];null!=mappingRelatedModule[sourceField]&&null!=mappingRelatedModule[sourceField][popupReferenceModule]&&$.each(mappingRelatedModule[sourceField][popupReferenceModule],(function(index,value){var mapFieldElement=formElement.find('[name="'+index+'"]');mapFieldElement.length&&""!=mapFieldElement.val()&&(filterFields[index]=mapFieldElement.val())}));var params={module:popupReferenceModule,src_module:sourceModule,src_field:sourceField,src_record:sourceRecordId,filterFields:filterFields};return $.each(["link","process"],(function(index,value){var fieldElement=formElement.find('[name="'+value+'"]');fieldElement.length&&""!=fieldElement.val()&&0!=fieldElement.val()&&(params[value]=fieldElement.val())})),isMultiple&&(params.multi_select=!0),params},showRecordsList:function(e){var _this=this,parentElem=$(e.target).closest(".fieldValue");parentElem.length<=0&&(parentElem=$(e.target).closest("td"));var params=this.getRecordsListParams(parentElem);app.showRecordsList(params,(function(modal,instance){instance.setSelectEvent((function(data){_this.setReferenceFieldValue(parentElem,data)}))}))},setReferenceFieldValue:function(container,params){var thisInstance=this,sourceFieldElement=container.find("input.sourceField"),sourceField=sourceFieldElement.attr("name"),fieldElement=container.find('input[name="'+sourceField+'"]'),sourceFieldDisplay=sourceField+"_display",fieldDisplayElement=container.find('input[name="'+sourceFieldDisplay+'"]'),popupReferenceModule=container.find('input[name="popupReferenceModule"]').val(),selectedName=params.name,id=params.id;if(container.find(".clearReferenceSelection").trigger("click"),fieldElement.val(id),fieldDisplayElement.val(app.decodeHTML(selectedName)).attr("readonly",!0),fieldElement.trigger(Vtiger_Edit_Js.referenceSelectionEvent,{module:popupReferenceModule,record:id,selectedName:selectedName}),fieldDisplayElement.validationEngine("closePrompt",fieldDisplayElement),"inventory"==sourceFieldElement.data("type"))return params;var formElement=container.closest("form"),mappingRelatedField=this.getMappingRelatedField(sourceField,popupReferenceModule,formElement);if(void 0!==mappingRelatedField){var _params={module:popupReferenceModule,record:id};app.getRecordDetails(_params).done((function(data){var response=_params.data=data.result.data;app.event.trigger("EditView.SelectReference",_params,formElement),$.each(mappingRelatedField,(function(key,value){if(0!=response[value[0]]&&!thisInstance.getMappingValuesFromUrl(key)){var mapFieldElement=formElement.find('[name="'+key+'"]'),fieldinfo=mapFieldElement.data("fieldinfo");if("date"===data.result.type[value[0]]||"datetime"===data.result.type[value[0]])mapFieldElement.val(data.result.displayData[value[0]]);else if("multipicklist"===data.result.type[value[0]]){var mapFieldElementMultiselect=formElement.find('[name="'+key+'[]"]');if(mapFieldElementMultiselect.length>0){var multipleAttr=mapFieldElement.attr("multiple"),splitValues=response[value[0]].split(" |##| ");void 0!==(void 0===multipleAttr?"undefined":_typeof(multipleAttr))&&!1!==multipleAttr&&splitValues.length>0&&mapFieldElementMultiselect.val(splitValues).trigger("change")}}else if(mapFieldElement.is("select")){if(mapFieldElement.find('option[value="'+response[value[0]]+'"]').length)mapFieldElement.val(response[value[0]]).trigger("change");else if(mapFieldElement.data("fieldinfo").picklistvalues.hasOwnProperty(response[value[0]])){var newOption=new Option(response[value[0]],response[value[0]],!0,!0);mapFieldElement.append(newOption).trigger("change")}}else 0==mapFieldElement.length?$("<input type='hidden'/>").attr("name",key).attr("value",response[value[0]]).appendTo(formElement):mapFieldElement.val(response[value[0]]);var mapFieldDisplayElement=formElement.find('input[name="'+key+'_display"]');if(mapFieldDisplayElement.length>0&&(mapFieldDisplayElement.val(data.result.displayData[value[0]]).attr("readonly",!0),"reference"===fieldinfo.type)){var referenceModulesList=mapFieldElement.closest(".fieldValue").find(".referenceModulesList");referenceModulesList.length>0&&value[1]&&referenceModulesList.val(value[1]).trigger("change"),thisInstance.setReferenceFieldValue(mapFieldDisplayElement.closest(".fieldValue"),{name:data.result.displayData[value[0]],id:response[value[0]]})}}}))}))}},getRelationOperation:function(){if(""===this.relationOperation){var relationOperation=$('[name="relationOperation"]');relationOperation.length?this.relationOperation=relationOperation.val():this.relationOperation=!1}return this.relationOperation},getMappingValuesFromUrl:function(key){return!!this.getRelationOperation()&&app.getUrlVar(key)},proceedRegisterEvents:function(){return $(".recordEditView").length>0},registerClearTreeSelectionEvent:function(container){var thisInstance=this;container.find(".clearTreeSelection").on("click",(function(e){thisInstance.clearFieldValue($(e.currentTarget)),e.preventDefault()}))},registerTreeAutoCompleteFields:function(container){container.find("input.treeAutoComplete").autocomplete({delay:"600",minLength:"3",source:function(request,response){var inputElement=$(this.element[0]),searchValue=request.term.toLowerCase(),parentElem=inputElement.closest(".fieldValue"),allValues=$('input[class="sourceField"]',parentElem).data("fieldinfo").picklistvalues,reponseDataList=[];for(var id in allValues)allValues[id].toLowerCase().indexOf(searchValue)>=0&&reponseDataList.push({label:allValues[id],value:id,id:id});reponseDataList.length<=0&&($(inputElement).val(""),reponseDataList.push({label:app.vtranslate("JS_NO_RESULTS_FOUND"),type:"no results"})),response(reponseDataList)},select:function(event,ui){var selectedItemData=ui.item;if(void 0!==selectedItemData.type&&"no results"==selectedItemData.type)return!1;selectedItemData.name=selectedItemData.value;var parentElem=$(this).closest(".fieldValue"),sourceField=parentElem.find('input[class="sourceField"]'),sourceFieldDisplay=sourceField.attr("name")+"_display",fieldDisplayElement=$('input[name="'+sourceFieldDisplay+'"]',parentElem);return sourceField.val(selectedItemData.id),this.value=selectedItemData.label,fieldDisplayElement.attr("readonly",!0),!1},change:function(event,ui){},open:function(event,ui){$(this).data("ui-autocomplete").menu.element.css("z-index","100001")}})},referenceModulePopupRegisterEvent:function(container){var _this2=this;container.on("click",".relatedPopup",(function(e){_this2.showRecordsList(e)}));var moduleList=container.find(".referenceModulesList");App.Fields.Picklist.showSelect2ElementView(container.find(".referenceModulesList:visible")),moduleList.on("change",(function(e){var element=$(e.currentTarget),parentElem=element.closest(".fieldValue"),popupReferenceModule=element.val(),referenceModuleElement=$('input[name="popupReferenceModule"]',parentElem),prevSelectedReferenceModule=referenceModuleElement.val();referenceModuleElement.val(popupReferenceModule),prevSelectedReferenceModule!=popupReferenceModule&&parentElem.find(".clearReferenceSelection").trigger("click")}))},getReferencedModuleName:function(parenElement){return $('input[name="popupReferenceModule"]',parenElement).val()},searchModuleNames:function(params){var aDeferred=$.Deferred();return void 0===params.module&&(params.module=app.getModuleName()),void 0===params.action&&(params.action="BasicAjax"),AppConnector.request(params).done((function(data){aDeferred.resolve(data)})).fail((function(error){aDeferred.reject()})),aDeferred.promise()},getReferenceSearchParams:function(element){var tdElement=$(element).closest(".fieldValue"),params={},searchModule=this.getReferencedModuleName(tdElement);return params.search_module=searchModule,params},registerAutoCompleteFields:function(container){var thisInstance=this;container.find("input.autoComplete").autocomplete({delay:"600",minLength:"3",source:function(request,response){var inputElement=$(this.element[0]),searchValue=request.term,params=thisInstance.getReferenceSearchParams(inputElement);params.search_value=searchValue,thisInstance.searchModuleNames(params).done((function(data){var reponseDataList=[],serverDataFormat=data.result;for(var id in serverDataFormat.length<=0&&($(inputElement).val(""),serverDataFormat=new Array({label:app.vtranslate("JS_NO_RESULTS_FOUND"),type:"no results"})),serverDataFormat){var responseData=serverDataFormat[id];reponseDataList.push(responseData)}response(reponseDataList),app.event.trigger("EditView.AfterSearch",{field:inputElement,params:params})}))},select:function(event,ui){var selectedItemData=ui.item;if(void 0!==selectedItemData.type&&"no results"==selectedItemData.type)return!1;selectedItemData.name=selectedItemData.value;var tdElement=$(this).closest(".fieldValue");thisInstance.setReferenceFieldValue(tdElement,selectedItemData)},change:function(event,ui){var element=$(this);null==element.attr("readonly")&&element.closest(".fieldValue").find(".clearReferenceSelection").trigger("click")},open:function(event,ui){$(this).data("ui-autocomplete").menu.element.css("z-index","100001")}})},registerClearReferenceSelectionEvent:function(container){var thisInstance=this;container.on("click",".clearReferenceSelection",(function(e){var element=$(e.currentTarget);thisInstance.clearFieldValue(element),element.closest(".fieldValue").find(".sourceField").trigger(Vtiger_Edit_Js.referenceDeSelectionEvent),e.preventDefault()}))},clearFieldValue:function(element){var thisInstance=this,fieldValueContener=element.closest(".fieldValue"),fieldNameElement=fieldValueContener.find(".sourceField"),fieldName=fieldNameElement.attr("name"),referenceModule=fieldValueContener.find('input[name="popupReferenceModule"]').val(),formElement=fieldValueContener.closest("form");fieldNameElement.val(""),fieldValueContener.find("#"+fieldName+"_display").removeAttr("readonly").val(""),app.event.trigger("EditView.ClearField",{fieldName:fieldName,referenceModule:referenceModule});var mappingRelatedField=this.getMappingRelatedField(fieldName,referenceModule,formElement);$.each(mappingRelatedField,(function(key,value){var mapFieldElement=formElement.find('[name="'+key+'"]');mapFieldElement.is("select")?mapFieldElement.val(mapFieldElement.find("option:first").val()).trigger("change"):mapFieldElement.val("");var mapFieldDisplayElement=formElement.find('input[name="'+key+'_display"]');if(mapFieldDisplayElement.length>0){mapFieldDisplayElement.val("").attr("readonly",!1);var referenceModulesList=formElement.find("#"+thisInstance.moduleName+"_editView_fieldName_"+key+"_dropDown");referenceModulesList.length>0&&value[1]&&referenceModulesList.val(referenceModulesList.find("option:first").val()).trigger("change")}}))},registerPreventingEnterSubmitEvent:function(container){container.on("keypress",(function(e){var currentElement=$(e.target);13!=e.which||currentElement.is("textarea")||e.preventDefault()}))},registerTimeFields:function(container){app.registerEventForClockPicker(),App.Fields.Date.register(container),App.Fields.DateTime.register(container)},referenceCreateHandler:function(container){var thisInstance=this,params={callbackFunction:function(data){thisInstance.setReferenceFieldValue(container,{name:data.result._recordLabel,id:data.result._recordId})}};if("Edit"===app.getViewName()&&!app.getRecordId()){var formData=this.getForm().serializeFormData();for(var i in formData)formData[i]&&-1==$.inArray(i,["_csrf","action"])||delete formData[i];params.data={},params.data.sourceRecordData=formData}var referenceModuleName=this.getReferencedModuleName(container);Vtiger_Header_Js.getInstance().quickCreateModule(referenceModuleName,params)},registerReferenceCreate:function(container){var thisInstance=this;container.on("click",".createReferenceRecord",(function(e){var controlElementDiv=$(e.currentTarget).closest(".fieldValue");thisInstance.referenceCreateHandler(controlElementDiv)}))},addressFieldsMapping:["buildingnumber","localnumber","addresslevel1","addresslevel2","addresslevel3","addresslevel4","addresslevel5","addresslevel6","addresslevel7","addresslevel8","pobox"],addressFieldsMappingBlockID:{LBL_ADDRESS_INFORMATION:"a",LBL_ADDRESS_MAILING_INFORMATION:"b",LBL_ADDRESS_DELIVERY_INFORMATION:"c"},addressFieldsData:!1,registerEventForCopyAddress:function(){var thisInstance=this,account_id=!1,contact_id=!1,lead_id=!1,vendor_id=!1;$("#EditView .js-toggle-panel:not(.inventoryHeader):not(.inventoryItems) .fieldValue, #EditView .js-toggle-panel:not(.inventoryHeader):not(.inventoryItems) .fieldLabel").each((function(index){var block=$(this),referenceModulesList=!1,relatedField=block.find('[name="popupReferenceModule"]').val();"Accounts"==relatedField&&(account_id=block.find(".sourceField").attr("name")),"Contacts"==relatedField&&(contact_id=block.find(".sourceField").attr("name")),"Leads"==relatedField&&(lead_id=block.find(".sourceField").attr("name")),"Vendors"==relatedField&&(vendor_id=block.find(".sourceField").attr("name")),(referenceModulesList=block.find(".referenceModulesList")).length>0&&$.each(referenceModulesList.find("option"),(function(key,data){"Accounts"==data.value&&(account_id=block.find(".sourceField").attr("name")),"Contacts"==data.value&&(contact_id=block.find(".sourceField").attr("name")),"Leads"==data.value&&(lead_id=block.find(".sourceField").attr("name")),"Vendors"==data.value&&(vendor_id=block.find(".sourceField").attr("name"))}))})),0==account_id?$(".copyAddressFromAccount").addClass("d-none"):$(".copyAddressFromAccount").on("click",(function(e){var element=$(this),block=element.closest(".js-toggle-panel"),from=element.data("label"),to=block.data("label"),recordRelativeAccountId=$('[name="'+account_id+'"]').val();if(""==recordRelativeAccountId||"0"==recordRelativeAccountId)Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_PLEASE_SELECT_AN_ACCOUNT_TO_COPY_ADDRESS"));else{var data={record:recordRelativeAccountId,selectedName:$("#"+account_id+"_display").val(),module:"Accounts"};thisInstance.copyAddressDetails(from,to,data,element.closest(".js-toggle-panel")),element.attr("checked","checked")}})),0==contact_id?$(".copyAddressFromContact").addClass("d-none"):$(".copyAddressFromContact").on("click",(function(e){var element=$(this),block=element.closest(".js-toggle-panel"),from=element.data("label"),to=block.data("label"),recordRelativeAccountId=$('[name="'+contact_id+'"]').val();if(""==recordRelativeAccountId||"0"==recordRelativeAccountId)Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_PLEASE_SELECT_AN_CONTACT_TO_COPY_ADDRESS"));else{var data={record:recordRelativeAccountId,selectedName:$("#"+contact_id+"_display").val(),module:"Contacts"};thisInstance.copyAddressDetails(from,to,data,element.closest(".js-toggle-panel")),element.attr("checked","checked")}})),0==lead_id?$(".copyAddressFromLead").addClass("d-none"):$(".copyAddressFromLead").on("click",(function(e){var element=$(this),block=element.closest(".js-toggle-panel"),from=element.data("label"),to=block.data("label"),recordRelativeAccountId=$('[name="'+lead_id+'"]').val();if(""==recordRelativeAccountId||"0"==recordRelativeAccountId)Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_PLEASE_SELECT_AN_LEAD_TO_COPY_ADDRESS"));else{var data={record:recordRelativeAccountId,selectedName:$("#"+lead_id+"_display").val(),module:"Leads"};thisInstance.copyAddressDetails(from,to,data,element.closest(".js-toggle-panel")),element.attr("checked","checked")}})),0==vendor_id?$(".copyAddressFromVendor").addClass("d-none"):$(".copyAddressFromVendor").on("click",(function(e){var element=$(this),block=element.closest(".js-toggle-panel"),from=element.data("label"),to=block.data("label"),recordRelativeAccountId=$('[name="'+vendor_id+'"]').val();if(""==recordRelativeAccountId||"0"==recordRelativeAccountId)Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_PLEASE_SELECT_AN_VENDOR_TO_COPY_ADDRESS"));else{var data={record:recordRelativeAccountId,selectedName:$("#"+vendor_id+"_display").val(),module:"Vendors"};thisInstance.copyAddressDetails(from,to,data,element.closest(".js-toggle-panel")),element.attr("checked","checked")}})),$("#EditView .js-toggle-panel").each((function(index){var hideCopyAddressLabel=!0;$(this).find(".adressAction button").each((function(index){0==$(this).hasClass("d-none")&&(hideCopyAddressLabel=!1)})),hideCopyAddressLabel&&$(this).find(".copyAddressLabel").addClass("d-none")})),$(".copyAddressFromMain").on("click",(function(e){var element=$(this),block=element.closest(".js-toggle-panel"),from=element.data("label"),to=block.data("label");thisInstance.copyAddress(from,to,!1,!1)})),$(".copyAddressFromMailing").on("click",(function(e){var element=$(this),block=element.closest(".js-toggle-panel"),from=element.data("label"),to=block.data("label");thisInstance.copyAddress(from,to,!1,!1)})),$(".copyAddressFromDelivery").on("click",(function(e){var element=$(this),block=element.closest(".js-toggle-panel"),from=element.data("label"),to=block.data("label");thisInstance.copyAddress(from,to,!1,!1)}))},copyAddressDetails:function(from,to,data,container){var thisInstance=this,sourceModule=data.module;app.getRecordDetails(data).done((function(data){var response=data.result;thisInstance.addressFieldsData=response,thisInstance.copyAddress(from,to,!0,sourceModule)}))},copyAddress:function(fromLabel,toLabel,relatedRecord,sourceModule){var formElement=this.getForm(),status=!1,addressMapping=this.addressFieldsMapping,BlockIds=this.addressFieldsMappingBlockID,from=BlockIds[fromLabel];!1!==relatedRecord&&!1!==sourceModule||(from=BlockIds[fromLabel]);var to=BlockIds[toLabel],key=void 0,fromElement=void 0,fromElementLabel=void 0,nameElementFrom=void 0,nameElementTo=void 0;for(key in addressMapping){nameElementFrom=addressMapping[key]+from,nameElementTo=addressMapping[key]+to,relatedRecord?(fromElement=this.addressFieldsData.data[nameElementFrom],fromElementLabel=this.addressFieldsData.displayData[nameElementFrom]):(fromElement=formElement.find('[name="'+nameElementFrom+'"]').val(),fromElementLabel=formElement.find('[name="'+nameElementFrom+'_display"]').val());var toElement=formElement.find('[name="'+nameElementTo+'"]'),toElementLable=formElement.find('[name="'+nameElementTo+'_display"]');""!==fromElement&&"0"!==fromElement&&void 0!==fromElement?(toElementLable.length>0&&toElementLable.attr("readonly",!0),status=!0,toElement.val(fromElement),toElementLable.val(fromElementLabel),toElement.is("[data-select2-id]")&&(toElement.val()!==fromElement&&toElement.val(""),toElement.trigger("change"))):toElement.attr("readonly",!1)}if(!1===status){var errorMsg=void 0;errorMsg="Accounts"===sourceModule?"JS_SELECTED_ACCOUNT_DOES_NOT_HAVE_AN_ADDRESS":"Contacts"===sourceModule?"JS_SELECTED_CONTACT_DOES_NOT_HAVE_AN_ADDRESS":"JS_DOES_NOT_HAVE_AN_ADDRESS",Vtiger_Helper_Js.showPnotify(app.vtranslate(errorMsg))}},registerReferenceSelectionEvent:function(container){var thisInstance=this;container.find("input[name*='addresslevel']").on(Vtiger_Edit_Js.referenceSelectionEvent,(function(e,data){var blockContainer=$(e.currentTarget).closest(".js-toggle-panel");thisInstance.copyAddressDetailsRef(data,blockContainer)}))},copyAddressDetailsRef:function(data,container){var thisInstance=this;app.getRecordDetails(data).done((function(data){var response=data.result;thisInstance.mapAddressDetails(response,container)})).fail((function(error,err){}))},mapAddressDetails:function(result,container){for(var key in result)-1!=key.indexOf("addresslevel")&&(0!=container.find('[name="'+key+'"]').length&&(container.find('[name="'+key+'"]').val(result.data[key]),container.find('[name="'+key+'"]').attr("readonly",!0),container.find('[name="'+key+'_display"]').val(result.displayData[key]),container.find('[name="'+key+'_display"]').attr("readonly",!0)),0!=container.find('[name="'+key+'a"]').length&&0==container.find('[name="'+key+'a"]').val()&&0!=result.data[key]&&(container.find('[name="'+key+'a"]').val(result.data[key]),container.find('[name="'+key+'a"]').attr("readonly",!0),container.find('[name="'+key+'a_display"]').val(result.displayData[key]),container.find('[name="'+key+'a_display"]').attr("readonly",!0)),0!=container.find('[name="'+key+'b"]').length&&0==container.find('[name="'+key+'b"]').val()&&0!=result.data[key]&&(container.find('[name="'+key+'b"]').val(result.data[key]),container.find('[name="'+key+'b"]').attr("readonly",!0),container.find('[name="'+key+'b_display"]').val(result.displayData[key]),container.find('[name="'+key+'b_display"]').attr("readonly",!0)),0!=container.find('[name="'+key+'c"]').length&&0==container.find('[name="'+key+'c"]').val()&&0!=result.data[key]&&(container.find('[name="'+key+'c"]').val(result.data[key]),container.find('[name="'+key+'c"]').attr("readonly",!0),container.find('[name="'+key+'c_display"]').val(result.displayData[key]),container.find('[name="'+key+'c_display"]').attr("readonly",!0)))},registerMaskFields:function(container){container.find("[data-inputmask]").inputmask()},triggerDisplayTypeEvent:function(){var widthType=app.cacheGet("widthType","narrowWidthType");widthType&&$("#EditView").find(".fieldValue,.fieldLabel").addClass(widthType)},registerSubmitEvent:function(){var editViewForm=this.getForm();editViewForm.on("submit",(function(e){if(void 0!==editViewForm.data("submit"))return!1;if(document.progressLoader=$.progressIndicator({message:app.vtranslate("JS_SAVE_LOADER_INFO"),position:"html",blockInfo:{enabled:!0}}),editViewForm.find(".js-toggle-panel").find(".js-block-content").removeClass("d-none"),editViewForm.validationEngine("validate")){editViewForm.data("submit","true");var recordPreSaveEvent=$.Event(Vtiger_Edit_Js.recordPreSave);editViewForm.trigger(recordPreSaveEvent,{value:"edit"}),recordPreSaveEvent.isDefaultPrevented()&&(document.progressLoader.progressIndicator({mode:"hide"}),editViewForm.removeData("submit"),e.preventDefault())}else document.progressLoader.progressIndicator({mode:"hide"}),editViewForm.removeData("submit"),app.formAlignmentAfterValidation(editViewForm)}))},registerRecordPreSaveEventEvent:function(form){form.on(Vtiger_Edit_Js.recordPreSave,(function(e,data){}))},registerEventForPicklistDependencySetup:function(container){var picklistDependcyElemnt=$('[name="picklistDependency"]',container);if(!(picklistDependcyElemnt.length<=0)){var picklistDependencyMapping=JSON.parse(picklistDependcyElemnt.val()),sourcePicklists=Object.keys(picklistDependencyMapping);if(!(sourcePicklists.length<=0)){var sourcePickListNames=[],i=void 0;for(i=0;i<sourcePicklists.length;i++)sourcePickListNames.push('[name="'+sourcePicklists[i]+'"]');sourcePickListNames=sourcePickListNames.join(",");var sourcePickListElements=container.find(sourcePickListNames);sourcePickListElements.on("change",(function(e){var currentElement=$(e.currentTarget),configuredDependencyObject=picklistDependencyMapping[currentElement.attr("name")],targetObjectForSelectedSourceValue=configuredDependencyObject[currentElement.val()],picklistmap=configuredDependencyObject.__DEFAULT__;void 0===targetObjectForSelectedSourceValue&&(targetObjectForSelectedSourceValue=picklistmap),$.each(picklistmap,(function(targetPickListName,targetPickListValues){var targetPickListMap=targetObjectForSelectedSourceValue[targetPickListName];void 0===targetPickListMap&&(targetPickListMap=targetPickListValues);var targetPickList=$('[name="'+targetPickListName+'"]',container);if(!(targetPickList.length<=0)){var listOfAvailableOptions=targetPickList.data("availableOptions");void 0===listOfAvailableOptions&&(listOfAvailableOptions=$("option",targetPickList),targetPickList.data("available-options",listOfAvailableOptions));var targetOptions=new $,optionSelector=[];for(optionSelector.push(""),i=0;i<targetPickListMap.length;i++)optionSelector.push(targetPickListMap[i]);$.each(listOfAvailableOptions,(function(i,e){-1!==$.inArray($(e).val(),optionSelector)&&(targetOptions=targetOptions.add($(e)))})),targetPickList.html(targetOptions).val(targetOptions.filter("[selected]").val()).trigger("change")}}))})),sourcePickListElements.trigger("change")}}},registerLeavePageWithoutSubmit:function(form){if("undefined"!=typeof CKEDITOR&&void 0!==CKEDITOR.instances&&Object.keys(CKEDITOR.instances).length)CKEDITOR.on("instanceReady",(function(e){var initialFormData=form.serialize();window.onbeforeunload=function(e){if(initialFormData!=form.serialize()&&"true"!=form.data("submit"))return app.vtranslate("JS_CHANGES_WILL_BE_LOST")}}));else{var initialFormData=form.serialize();window.onbeforeunload=function(e){if(initialFormData!=form.serialize()&&"true"!=form.data("submit"))return app.vtranslate("JS_CHANGES_WILL_BE_LOST")}}},stretchCKEditor:function(){var row=$(".js-editor").parents(".fieldRow"),td=$(".js-editor").parent();$(row).find(".fieldLabel").remove(),$(td).removeClass("col-md-10"),$(td).addClass("col-md-12")},registerEventForEditor:function(){var form=this.getForm(),thisInstance=this;$.each(form.find(".js-editor"),(function(key,data){thisInstance.loadEditorElement($(data))}))},loadEditorElement:function(noteContentElement){var customConfig={};noteContentElement.hasClass("js-editor--basic")&&(customConfig.toolbar="Min"),noteContentElement.data("height")&&(customConfig.height=noteContentElement.data("height")),new App.Fields.Text.Editor(noteContentElement,customConfig)},registerHelpInfo:function(){var form=this.getForm();app.showPopoverElementView(form.find(".js-help-info"))},registerBlockAnimationEvent:function(){this.getForm().on("click",".blockHeader",(function(e){var target=$(e.target);if(target.is("input")||target.is("button")||target.parents().is("button")||target.hasClass("js-stop-propagation")||target.parents().hasClass("js-stop-propagation"))return!1;var currentTarget=$(e.currentTarget).find(".js-block-toggle").not(".d-none"),blockId=currentTarget.data("id"),closestBlock=currentTarget.closest(".js-toggle-panel"),bodyContents=closestBlock.find(".blockContent"),data=currentTarget.data(),module=app.getModuleName();"show"==data.mode?(bodyContents.addClass("d-none"),app.cacheSet(module+"."+blockId,0),currentTarget.addClass("d-none"),closestBlock.find('[data-mode="hide"]').removeClass("d-none")):(bodyContents.removeClass("d-none"),app.cacheSet(module+"."+blockId,1),currentTarget.addClass("d-none"),closestBlock.find("[data-mode='show']").removeClass("d-none"))}))},registerBlockStatusCheckOnLoad:function(){var blocks=this.getForm().find(".js-toggle-panel"),module=app.getModuleName();blocks.each((function(index,block){var currentBlock=$(block),dynamicAttr=currentBlock.attr("data-dynamic");if("undefined"!==(void 0===dynamicAttr?"undefined":_typeof(dynamicAttr))&&!1!==dynamicAttr){var headerAnimationElement=currentBlock.find(".js-block-toggle").not(".d-none"),bodyContents=currentBlock.find(".blockContent"),blockId=headerAnimationElement.data("id"),cacheKey=module+"."+blockId,value=app.cacheGet(cacheKey,null);null!=value&&(1==value?(headerAnimationElement.addClass("d-none"),currentBlock.find("[data-mode='show']").removeClass("d-none"),bodyContents.removeClass("d-none")):(headerAnimationElement.addClass("d-none"),currentBlock.find("[data-mode='hide']").removeClass("d-none"),bodyContents.addClass("d-none")))}}))},registerAutoloadAddress:function(){this.getForm().find(".js-search-address").each((function(index,item){var search=$(item),container=search.closest(".js-block-content"),input=search.find(".js-autoload-address");input.autocomplete({source:function(request,response){AppConnector.request({module:app.getModuleName(),action:"Fields",mode:"findAddress",type:search.find(".js-select-operator").val(),value:request.term}).done((function(requestData){!1===requestData.result?Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_ERROR")):requestData.result.length?response(requestData.result):response([{label:app.vtranslate("JS_NO_RESULTS_FOUND"),value:""}])})).fail((function(textStatus,errorThrown,jqXHR){Vtiger_Helper_Js.showPnotify({text:jqXHR.responseJSON.error.message,type:"error",animation:"show"}),response([{label:app.vtranslate("JS_NO_RESULTS_FOUND"),value:""}])}))},minLength:input.data("min"),select:function(event,ui){$.each(ui.item.address,(function(index,value){var field=container.find(".fieldValue [name^="+index+"]");field.length&&value?("object"!==(void 0===value?"undefined":_typeof(value))&&(value=[value]),$.each(value,(function(index,v){var select=!1,element=!1;"SELECT"===field.prop("tagName")?"object"===(void 0===v?"undefined":_typeof(v))?$.each(v,(function(index,x){element=field.find("option[data-"+index+"='"+x+"']"),x&&element.length&&(select=element.val())})):(element=field.find("option:contains("+v+")"),v&&element.length&&(select=element.val()),element=field.find('option[value="'+v+'"]'),v&&element.length&&(select=element.val())):select=v,select&&field.val(select).change()}))):field.val("").change()})),ui.item.value=input.val()}})}))},setEnabledFields:function(element){var fieldValue=element.closest(".fieldValue"),fieldName=fieldValue.find("input.sourceField").attr("name"),fieldDisplay=fieldValue.find("#"+fieldName+"_display");fieldValue.find("button").removeAttr("disabled"),""==fieldDisplay.val()&&fieldValue.find("input").removeAttr("readonly"),fieldValue.find(".referenceModulesListGroup").removeClass("d-none");var placeholder=fieldDisplay.attr("placeholderDisabled");fieldDisplay.removeAttr("placeholderDisabled"),fieldDisplay.attr("placeholder",placeholder),fieldValue.find(".referenceModulesList").attr("required","required")},setDisabledFields:function(element){var fieldValue=element.closest(".fieldValue"),fieldName=fieldValue.find("input.sourceField").attr("name"),fieldDisplay=fieldValue.find("#"+fieldName+"_display");fieldValue.find("input").attr("readonly","readonly"),fieldValue.find("button").attr("disabled","disabled"),fieldValue.find(".referenceModulesListGroup").addClass("d-none");var placeholder=fieldDisplay.attr("placeholder");fieldDisplay.removeAttr("placeholder"),fieldDisplay.attr("placeholderDisabled",placeholder),fieldValue.find(".referenceModulesList").removeAttr("required")},getMappingRelatedField:function(sourceField,sourceFieldModule,container){var mappingRelatedField=container.find('input[name="mappingRelatedField"]').val(),mappingRelatedModule=mappingRelatedField?JSON.parse(mappingRelatedField):[];return void 0!==mappingRelatedModule[sourceField]&&void 0!==mappingRelatedModule[sourceField][sourceFieldModule]?mappingRelatedModule[sourceField][sourceFieldModule]:[]},registerValidationsFields:function(container){var params=app.validationEngineOptionsForRecord;container.validationEngine(params)},checkReferencesField:function(container,clear){var thisInstance=this,activeProcess=!1,activeSubProcess=!1;if(!CONFIG.fieldsReferencesDependent)return!1;container.find('input[data-fieldtype="referenceLink"]').each((function(index,element){var t=!0;(element=$(element)).closest(".tab-pane").length>0&&(t=!1,element.closest(".tab-pane.active").length>0&&(t=!0));var referenceLink=element.val();t&&""!=referenceLink&&"0"!=referenceLink&&(activeProcess=!0)})),container.find('input[data-fieldtype="referenceProcess"]').each((function(index,element){element=$(element),activeProcess?thisInstance.setEnabledFields(element):(clear&&thisInstance.clearFieldValue(element),thisInstance.setDisabledFields(element));var t=!0;element.closest(".tab-pane").length>0&&(t=!1,element.closest(".tab-pane.active").length>0&&(t=!0));var referenceLink=element.val();t&&""!=referenceLink&&"0"!=referenceLink&&(activeSubProcess=!0)})),container.find('input[data-fieldtype="referenceSubProcess"]').each((function(index,element){var length=(element=$(element)).closest(".fieldValue").find('.referenceModulesList option[disabled!="disabled"]').length;activeSubProcess&&length>0?thisInstance.setEnabledFields(element):(clear&&thisInstance.clearFieldValue(element),thisInstance.setDisabledFields(element))}))},checkSubProcessModulesList:function(element){1!=element.find("option:selected").data("is-quickcreate")?element.closest(".fieldValue").find(".createReferenceRecord").addClass("d-none"):element.closest(".fieldValue").find(".createReferenceRecord").removeClass("d-none")},checkReferenceModulesList:function(container){var referenceProcess=container.find('input[data-fieldtype="referenceProcess"]').closest(".fieldValue").find('input[name="popupReferenceModule"]').val(),subProcessfieldElement=container.find('input[data-fieldtype="referenceSubProcess"]').closest(".fieldValue");Vtiger_Helper_Js.hideOptions(subProcessfieldElement.find(".referenceModulesList"),"parent",referenceProcess);var subProcessValue=subProcessfieldElement.find(".referenceModulesList").val();subProcessfieldElement.find('[name="popupReferenceModule"]').val(subProcessValue),this.checkSubProcessModulesList(subProcessfieldElement.find(".referenceModulesList"))},registerReferenceFields:function(container){var thisInstance=this;if(!CONFIG.fieldsReferencesDependent)return!1;thisInstance.checkReferenceModulesList(container),thisInstance.checkReferencesField(container,!1),container.find(".sourceField").on(Vtiger_Edit_Js.referenceSelectionEvent,(function(e,data){thisInstance.checkReferencesField(container,!0)})),container.find(".sourceField").on(Vtiger_Edit_Js.referenceDeSelectionEvent,(function(e){thisInstance.checkReferencesField(container,!0)})),container.find('input[data-fieldtype="referenceProcess"]').closest(".fieldValue").find(".referenceModulesList").on("change",(function(){thisInstance.checkReferenceModulesList(container)})),container.find('input[data-fieldtype="referenceSubProcess"]').closest(".fieldValue").find(".referenceModulesList").on("change",(function(e){thisInstance.checkSubProcessModulesList($(e.currentTarget))}))},registerFocusFirstField:function(container,afterTimeout){var _this3=this,elementToFocus=void 0,elementToFocusTabindex=void 0;void 0===afterTimeout&&container.closest(".js-modal-container").length?setTimeout((function(_){_this3.registerFocusFirstField(container,!0)}),500):(container.find(".fieldValue input.form-control:not([type=hidden],.dateField,.clockPicker), .fieldValue input[type=checkbox], .select2-selection.form-control").each((function(i,e){var element=$(e);if(!element.prop("readonly")&&!element.prop("disabled")){if("number"!==(element=element.get(0)).type&&"checkbox"!==element.type&&void 0!==element.value){var elemLen=element.value.length;element.selectionStart=elemLen,element.selectionEnd=elemLen}0!==i&&elementToFocus||(elementToFocus=element);var tabindex=$(element).attr("tabindex");if(tabindex>0&&void 0===elementToFocusTabindex)return void(elementToFocusTabindex=tabindex);tabindex>0&&tabindex<elementToFocusTabindex&&(elementToFocusTabindex=tabindex,elementToFocus=element)}})),elementToFocus&&elementToFocus.focus())},registerCopyValue:function(container){container.find(".fieldValue [data-copy-to-field]").on("change",(function(e){var element=$(e.currentTarget);container.find('[name="'+element.data("copyToField")+'"]').val(element.val())}))},registerMultiImageFields:function(container){return App.Fields.MultiImage.register(container)},registerInventoryController:function(container){"undefined"!=typeof Vtiger_Inventory_Js&&(this.inventoryController=Vtiger_Inventory_Js.getInventoryInstance(container))},registerBasicEvents:function(container){this.registerClearTreeSelectionEvent(container),this.registerTreeAutoCompleteFields(container),this.referenceModulePopupRegisterEvent(container),this.registerAutoCompleteFields(container),this.registerClearReferenceSelectionEvent(container),this.registerPreventingEnterSubmitEvent(container),this.registerTimeFields(container),this.registerEventForPicklistDependencySetup(container),this.registerRecordPreSaveEventEvent(container),this.registerReferenceSelectionEvent(container),this.registerMaskFields(container),this.registerHelpInfo(),this.registerReferenceFields(container),this.registerFocusFirstField(container),this.registerCopyValue(container),this.registerMultiImageFields(container),this.registerReferenceCreate(container),App.Fields.MultiEmail.register(container),App.Fields.MultiDependField.register(container),App.Fields.Tree.register(container),App.Fields.MultiCurrency.register(container)},registerEvents:function(){var editViewForm=this.getForm();this.proceedRegisterEvents()&&(this.registerInventoryController(editViewForm),this.registerBlockAnimationEvent(),this.registerBlockStatusCheckOnLoad(),this.registerEventForEditor(),this.stretchCKEditor(),this.registerBasicEvents(editViewForm),this.registerEventForCopyAddress(),this.registerSubmitEvent(),this.registerLeavePageWithoutSubmit(editViewForm),this.registerValidationsFields(editViewForm),this.registerAutoloadAddress(),editViewForm.find(".js-form-submit-btn").prop("disabled",!1))}});
//# sourceMappingURL=Edit.min.js.map
