"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};$.Class("Vtiger_Inventory_Js",{inventoryInstance:!1,getInventoryInstance:function(container){if(!1===this.inventoryInstance){var moduleClassName=container.find('[name="module"]').val()+"_Inventory_Js";void 0===window[moduleClassName]&&(moduleClassName="Vtiger_Inventory_Js"),void 0!==window[moduleClassName]&&(this.inventoryInstance=new window[moduleClassName],this.inventoryInstance.registerEvents(container))}return this.inventoryInstance}},{form:!1,inventoryContainer:!1,inventoryHeadContainer:!1,summaryTaxesContainer:!1,summaryDiscountContainer:!1,summaryCurrenciesContainer:!1,rowClass:"tr.inventoryRow",discountModalFields:["aggregationType","globalDiscount","groupCheckbox","groupDiscount","individualDiscount","individualDiscountType"],taxModalFields:["aggregationType","globalTax","groupCheckbox","groupTax","individualTax","regionalTax"],getForm:function(){return this.form},getInventoryItemsContainer:function(){return!1===this.inventoryContainer&&(this.inventoryContainer=$(".inventoryItems")),this.inventoryContainer},getInventoryHeadContainer:function(){return!1===this.inventoryHeadContainer&&(this.inventoryHeadContainer=$(".inventoryHeader")),this.inventoryHeadContainer},getInventorySummaryDiscountContainer:function(){return!1===this.summaryDiscountContainer&&(this.summaryDiscountContainer=$(".inventorySummaryDiscounts")),this.summaryDiscountContainer},getInventorySummaryTaxesContainer:function(){return!1===this.summaryTaxesContainer&&(this.summaryTaxesContainer=$(".inventorySummaryTaxes")),this.summaryTaxesContainer},getInventorySummaryCurrenciesContainer:function(){return!1===this.summaryCurrenciesContainer&&(this.summaryCurrenciesContainer=$(".inventorySummaryCurrencies")),this.summaryCurrenciesContainer},getNextLineItemRowNumber:function(){var $inventoryItemsNo=$("#inventoryItemsNo"),rowNumber=parseInt($inventoryItemsNo.val())+1;return $inventoryItemsNo.val(rowNumber),rowNumber},getAccountId:function(){var accountReferenceField=$("#accountReferenceField").val();return""!=accountReferenceField?$('[name="'+accountReferenceField+'"]').val():""},checkDeleteIcon:function(){this.getInventoryItemsContainer().find(this.rowClass).length>1?this.showLineItemsDeleteIcon():app.getMainParams("isRequiredInventory")&&this.hideLineItemsDeleteIcon()},showLineItemsDeleteIcon:function(){this.getInventoryItemsContainer().find(".deleteRow").removeClass("d-none")},hideLineItemsDeleteIcon:function(){this.getInventoryItemsContainer().find(".deleteRow").addClass("d-none")},getClosestRow:function(element){return element.closest(this.rowClass)},getBasicRow:function(){return this.getForm().find(".js-inventory-base-item").eq(0).clone(!0,!0)},isRecordSelected:function(element){return element.closest("tr").find(".recordLabel").validationEngine("validate")},getTaxModeSelectElement:function(row){return this.getInventoryHeadContainer().find("thead .js-taxmode").length>0?$(".js-taxmode"):!!row&&row.find(".js-taxmode")},isIndividualTaxMode:function(row){return"1"==this.getTaxModeSelectElement(row).find("option:selected").val()},isGroupTaxMode:function(){var taxTypeElement=this.getTaxModeSelectElement();if(taxTypeElement&&"0"==taxTypeElement.find("option:selected").val())return!0;return!1},showIndividualTax:function(row){var thisInstance=this,groupTax=thisInstance.getInventorySummaryTaxesContainer().find(".groupTax"),items=thisInstance.getInventoryItemsContainer(),newRow=$("#blackIthemTable").find("tbody");if(thisInstance.isIndividualTaxMode()){groupTax.addClass("d-none"),items.find(".changeTax").removeClass("d-none"),newRow.find(".changeTax").removeClass("d-none");var parentRow=thisInstance.getInventoryItemsContainer(),taxParam={aggregationType:"global"};parentRow.find(thisInstance.rowClass).each((function(){var thisItem=$(this);taxParam.globalTax=App.Fields.Double.formatToDb(thisItem.find(".js-tax").attr("data-default-tax")),thisInstance.setTaxParam(thisItem,taxParam)}))}else thisInstance.setTax(items,0),thisInstance.setTaxPercent(items,0),thisInstance.setTaxParam(items,[]),thisInstance.setDefaultGlobalTax(row),groupTax.removeClass("d-none"),items.find(".changeTax").addClass("d-none"),newRow.find(".changeTax").addClass("d-none");thisInstance.rowsCalculations()},setDefaultGlobalTax:function(row){var thisInstance=this,parentRow=thisInstance.getInventoryItemsContainer(),taxDefaultValue=thisInstance.getInventorySummaryTaxesContainer().find(".js-default-tax").data("tax-default-value");if(thisInstance.isGroupTaxMode()){if(taxDefaultValue){var taxParam={aggregationType:"global"};taxParam.globalTax=App.Fields.Double.formatToDisplay(taxDefaultValue),taxParam.individualTax="",thisInstance.setTaxParam($("#blackIthemTable"),taxParam),thisInstance.setTaxParam(parentRow,taxParam),parentRow.closest(".inventoryItems").data("taxParam",JSON.stringify(taxParam)),parentRow.find(thisInstance.rowClass).each((function(){thisInstance.quantityChangeActions($(this))}))}}else thisInstance.setTaxParam($("#blackIthemTable"),[]),parentRow.closest(".inventoryItems").data("taxParam",[])},getDiscountModeSelectElement:function(row){return this.getInventoryHeadContainer().find("thead .js-discountmode").length>0?$(".js-discountmode"):row.find(".js-discountmode")},isIndividualDiscountMode:function(row){return"1"==this.getDiscountModeSelectElement(row).find("option:selected").val()},showIndividualDiscount:function(row){var groupDiscount=this.getInventorySummaryDiscountContainer().find(".groupDiscount"),items=this.getInventoryItemsContainer(),newRow=$("#blackIthemTable").find("tbody");this.isIndividualDiscountMode(row)?(groupDiscount.addClass("d-none"),items.find(".changeDiscount").removeClass("d-none"),newRow.find(".changeDiscount").removeClass("d-none")):(groupDiscount.removeClass("d-none"),items.find(".changeDiscount").addClass("d-none"),newRow.find(".changeDiscount").addClass("d-none")),this.setDiscount(items,0),this.setDiscountParam(items,[]),this.rowsCalculations()},getCurrency:function(){return $(".js-currency",this.getInventoryHeadContainer()).find("option:selected").val()},getTax:function(row){var taxParams=row.find(".taxParam").val();if(""==taxParams||"[]"==taxParams||null==taxParams)return 0;taxParams=JSON.parse(taxParams);var aggregationType=$(".aggregationTypeTax").val(),valuePrices=this.getNetPrice(row),taxRate=0,types=taxParams.aggregationType;return"string"==typeof types&&(types=[types]),types&&types.forEach((function(entry){var taxValue=0;switch(entry){case"individual":taxValue=taxParams.individualTax;break;case"global":taxValue=taxParams.globalTax;break;case"group":taxValue=taxParams.groupTax;break;case"regional":taxValue=taxParams.regionalTax}taxRate+=valuePrices*(App.Fields.Double.formatToDb(taxValue)/100),"2"==aggregationType&&(valuePrices+=taxRate)})),taxRate},getTaxPercent:function(row){var taxParams=row.find(".taxParam").val();if(""==taxParams||"[]"==taxParams||null==taxParams)return 0;var taxPercent=(taxParams=JSON.parse(taxParams))[taxParams.aggregationType+"Tax"];return taxPercent||0},getTaxParams:function(row){var taxParams=row.find(".taxParam").val();return""!=taxParams&&"[]"!=taxParams&&null!=taxParams&&JSON.parse(taxParams)},getQuantityValue:function(row){return $(".qty",row).getNumberFromValue()},getUnitPriceValue:function(row){return $(".unitPrice",row).getNumberFromValue()},getDiscount:function(row){var discountParams=row.find(".discountParam").val(),aggregationType=$(".aggregationTypeDiscount").val();if(""==discountParams||"null"==discountParams||"[]"==discountParams||null==discountParams)return 0;discountParams=JSON.parse(discountParams);var valuePrices=this.getTotalPrice(row),discountRate=0,types=discountParams.aggregationType;return"string"==typeof types&&(types=[types]),types&&types.forEach((function(entry){var discountValue;if("individual"==entry){discountValue=discountParams.individualDiscount;var discountType=discountParams.individualDiscountType;discountRate+="percentage"==discountType?valuePrices*(discountValue/100):App.Fields.Double.formatToDb(discountValue)}"global"==entry&&(discountRate+=valuePrices*(App.Fields.Double.formatToDb(discountParams.globalDiscount)/100)),"group"==entry&&(discountRate+=valuePrices*(App.Fields.Double.formatToDb(discountParams.groupDiscount)/100)),"2"==aggregationType&&(valuePrices-=discountRate)})),discountRate},getNetPrice:function(row){return this.getTotalPrice(row)-this.getDiscount(row)},getTotalPrice:function(row){return this.getQuantityValue(row)*this.getUnitPriceValue(row)},getGrossPrice:function(row){return $(".grossPrice",row).getNumberFromValue()},getPurchase:function(row){var qty=this.getQuantityValue(row),element=$(".purchase",row),purchase=0;return element.length>0&&(purchase=App.Fields.Double.formatToDb(element.val())),purchase*qty},getSummaryGrossPrice:function(){var thisInstance=this,price=0;return this.getInventoryItemsContainer().find(thisInstance.rowClass).each((function(index){price+=thisInstance.getGrossPrice($(this))})),App.Fields.Double.formatToDb(price)},setCurrency:function(val){this.getInventoryHeadContainer().find(".js-currency").val(val).trigger("change")},setCurrencyParam:function(val){this.getInventoryHeadContainer().find(".js-currencyparam").val(val)},setDiscountMode:function(val){this.getInventoryHeadContainer().find(".js-discountmode").val(val).trigger("change")},setTaxMode:function(val){this.getInventoryHeadContainer().find(".js-taxmode").val(val).trigger("change")},setName:function(row,val,display){row.find(".js-name").val(val).trigger("change"),row.find(".js-name_display").val(display).attr("readonly","true").trigger("change")},setQuantity:function(row,val){row.find(".qty").val(val).trigger("change")},setUnit:function(row,val,display){row.find(".unit").val(val).trigger("change"),row.find(".unitText").text(display).trigger("change")},setSubUnit:function(row,val,display){row.find(".subunit").val(val),row.find(".subunitText").val(display)},setComment:function(row,val){row.parent().find("[numrowex="+row.attr("numrow")+"]").find(".comment").val(val).trigger("change")},setUnitPrice:function(row,val){return val=App.Fields.Double.formatToDisplay(val),row.find(".unitPrice").val(val).attr("title",val),this},setPurchase:function(row,val){return val=App.Fields.Double.formatToDisplay(val),row.find(".purchase").val(val),this},setNetPrice:function(row,val){val=App.Fields.Double.formatToDisplay(val),$(".netPriceText",row).text(val),$(".netPrice",row).val(val)},setGrossPrice:function(row,val){val=App.Fields.Double.formatToDisplay(val),$(".grossPriceText",row).text(val),$(".grossPrice",row).val(val)},setTotalPrice:function(row,val){val=App.Fields.Double.formatToDisplay(val),$(".totalPriceText",row).text(val),$(".totalPrice",row).val(val)},setMargin:function(row,val){val=App.Fields.Double.formatToDisplay(val),$(".margin",row).val(val)},setMarginP:function(row,val){val=App.Fields.Double.formatToDisplay(val),$(".marginp",row).val(val)},setDiscount:function(row,val){val=App.Fields.Double.formatToDisplay(val),$(".discount",row).val(val)},setDiscountParam:function(row,val){$(".discountParam",row).val(JSON.stringify(val))},setTax:function(row,val){val=App.Fields.Double.formatToDisplay(val),$(".tax",row).val(val)},setTaxPercent:function(row,val){val=App.Fields.Double.formatToDisplay(val),$(".js-tax-percent",row).val(val)},setTaxParam:function(row,val){$(".taxParam",row).val(JSON.stringify(val))},quantityChangeActions:function(row){this.rowCalculations(row),this.summaryCalculations()},rowCalculations:function(row){this.calculateTotalPrice(row),this.calculateDiscounts(row),this.calculateNetPrice(row),this.calculateTaxes(row),this.calculateGrossPrice(row),this.calculateMargin(row)},rowsCalculations:function(){var thisInstance=this;this.getInventoryItemsContainer().find(thisInstance.rowClass).each((function(index){thisInstance.quantityChangeActions($(this))})),thisInstance.calculateItemNumbers()},calculateDiscounts:function(row){this.setDiscount(row,this.getDiscount(row))},calculateTaxes:function(row){this.setTax(row,this.getTax(row)),this.setTaxPercent(row,this.getTaxPercent(row))},summaryCalculations:function(){var thisInstance=this;thisInstance.getInventoryItemsContainer().find("tfoot .wisableTd").each((function(index){thisInstance.calculatSummary($(this),$(this).data("sumfield"))})),thisInstance.calculatDiscountSummary(),thisInstance.calculatTaxSummary(),thisInstance.calculatCurrenciesSummary(),thisInstance.calculatMarginPSummary()},calculatSummary:function(element,field){var sum=0;this.getInventoryItemsContainer().find(this.rowClass).each((function(index){var element=$(this).find("."+field);element.length>0&&(sum+=App.Fields.Double.formatToDb(element.val()))})),element.text(App.Fields.Double.formatToDisplay(sum))},calculatMarginPSummary:function(){var sumRow=this.getInventoryItemsContainer().find("tfoot"),sumPrice=(sumRow.find('[data-sumfield="netPrice"]').length>0?sumRow.find('[data-sumfield="netPrice"]'):sumRow.find('[data-sumfield="totalPrice"]')).getNumberFromText(),purchase=0,marginp=0;this.getInventoryItemsContainer().find(this.rowClass).each((function(index){var qty=$(this).find(".qty").getNumberFromValue(),purchasePrice=$(this).find(".purchase").getNumberFromValue();qty>0&&purchasePrice>0&&(purchase+=qty*purchasePrice)})),0!==purchase&&0!==sumPrice&&(marginp=(sumPrice-purchase)/sumPrice*100),sumRow.find('[data-sumfield="marginP"]').text(App.Fields.Double.formatToDisplay(marginp)+"%")},calculatDiscountSummary:function(){var discount=this.getAllDiscount();this.getInventorySummaryDiscountContainer().find("input").val(App.Fields.Double.formatToDisplay(discount))},getAllDiscount:function(){var thisInstance=this,discount=0;return this.getInventoryItemsContainer().find(thisInstance.rowClass).each((function(index){var row=$(this);discount+=thisInstance.getDiscount(row)})),discount},calculatCurrenciesSummary:function(){var container=this.getInventorySummaryCurrenciesContainer(),selected=$(".js-currency option:selected",this.getInventoryHeadContainer()),base=$('.js-currency option[data-base-currency="1"]',this.getInventoryHeadContainer()),conversionRate=selected.data("conversionRate"),baseConversionRate=base.data("conversionRate");if(conversionRate!=baseConversionRate){conversionRate=parseFloat(baseConversionRate)/parseFloat(conversionRate),container.removeClass("d-none");var taxs=this.getAllTaxs(),sum=0;container.find(".js-panel__body").html(""),$.each(taxs,(function(index,value){if(null!=value){value*=conversionRate;var row=container.find(".d-none .form-group").clone();row.find(".percent").text(index+"%"),row.find("input").val(App.Fields.Double.formatToDisplay(value)),row.appendTo(container.find(".js-panel__body")),sum+=value}})),container.find(".js-panel__footer input").val(App.Fields.Double.formatToDisplay(sum))}else container.addClass("d-none")},calculatTaxSummary:function(){var taxs=this.getAllTaxs(),container=this.getInventorySummaryTaxesContainer();container.find(".js-panel__body").html("");var sum=0;for(var index in taxs){var row=container.find(".d-none .form-group").clone();row.find(".percent").text(App.Fields.Double.formatToDisplay(App.Fields.Double.formatToDb(index))+"%"),row.find("input").val(App.Fields.Double.formatToDisplay(taxs[index])),row.appendTo(container.find(".js-panel__body")),sum+=taxs[index]}container.find(".js-panel__footer input").val(App.Fields.Double.formatToDisplay(sum))},getAllTaxs:function(){var thisInstance=this,tax=[],typeSummary=$(".aggregationTypeTax").val();return this.getInventoryItemsContainer().find(thisInstance.rowClass).each((function(index){var row=$(this),netPrice=thisInstance.getNetPrice(row),params=row.find(".taxParam").val();if(""!=params&&"[]"!=params&&null!=params){var param=JSON.parse(params);"string"==typeof param.aggregationType&&(param.aggregationType=[param.aggregationType]),param.aggregationType&&$.each(param.aggregationType,(function(index,name){var precent=param[name+="Tax"],old=0;null!=tax[precent]&&(old=parseFloat(tax[precent]));var taxRate=netPrice*(App.Fields.Double.formatToDb(precent)/100);tax[precent]=old+taxRate,"2"==typeSummary&&(netPrice+=taxRate)}))}})),tax},calculateNetPrice:function(row){this.setNetPrice(row,this.getNetPrice(row))},calculateGrossPrice:function(row){var netPrice=this.getNetPrice(row);(this.isIndividualTaxMode(row)||this.isGroupTaxMode(row))&&(netPrice+=this.getTax(row)),this.setGrossPrice(row,netPrice)},calculateTotalPrice:function(row){this.setTotalPrice(row,this.getTotalPrice(row))},calculateMargin:function(row){var netPrice;netPrice=$(".netPrice",row).length?this.getNetPrice(row):this.getTotalPrice(row)-this.getDiscount(row);var purchase=this.getPurchase(row),margin=netPrice-purchase;this.setMargin(row,margin);var marginp="0";0!==purchase&&(marginp=margin/purchase*100),this.setMarginP(row,marginp)},calculateDiscount:function(row,modal){var netPriceBeforeDiscount=App.Fields.Double.formatToDb(modal.find(".valueTotalPrice").text()),valuePrices=netPriceBeforeDiscount,globalDiscount=0,groupDiscount=0,individualDiscount=0,discountsType=modal.find(".discountsType").val();if("0"==discountsType||"1"==discountsType){if(modal.find(".js-active .globalDiscount").length>0&&(globalDiscount=App.Fields.Double.formatToDb(modal.find(".js-active .globalDiscount").val())),modal.find(".js-active .individualDiscountType").length>0){var individualTypeDiscount=modal.find(".js-active .individualDiscountType:checked").val(),value=App.Fields.Double.formatToDb(modal.find(".js-active .individualDiscountValue").val());individualDiscount="percentage"==individualTypeDiscount?netPriceBeforeDiscount*(value/100):value}modal.find(".js-active .groupCheckbox").length>0&&1==modal.find(".js-active .groupCheckbox").prop("checked")&&(groupDiscount=netPriceBeforeDiscount*((groupDiscount=App.Fields.Double.formatToDb(modal.find(".groupValue").val()))/100)),valuePrices*=(100-globalDiscount)/100,valuePrices-=individualDiscount,valuePrices-=groupDiscount}else"2"==discountsType&&modal.find(".js-active").each((function(index){var panel=$(this);if(panel.find(".globalDiscount").length>0){var globalDiscount=App.Fields.Double.formatToDb(panel.find(".globalDiscount").val());valuePrices*=(100-globalDiscount)/100}else if(panel.find(".groupCheckbox").length>0&&1==panel.find(".groupCheckbox").prop("checked")){var groupDiscount=App.Fields.Double.formatToDb(panel.find(".groupValue").val());valuePrices*=(100-groupDiscount)/100}else if(panel.find(".individualDiscountType").length>0){var value=App.Fields.Double.formatToDb(panel.find(".individualDiscountValue").val());"percentage"==panel.find('.individualDiscountType[name="individualDiscountType"]:checked').val()?valuePrices*=(100-value)/100:valuePrices-=value}}));modal.find(".valuePrices").text(App.Fields.Double.formatToDisplay(valuePrices)),modal.find(".valueDiscount").text(App.Fields.Double.formatToDisplay(netPriceBeforeDiscount-valuePrices))},calculateTax:function(row,modal){var netPriceWithoutTax=App.Fields.Double.formatToDb(modal.find(".valueNetPrice").text()),valuePrices=netPriceWithoutTax,globalTax=0,groupTax=0,regionalTax=0,individualTax=0,taxType=modal.find(".taxsType").val();if("0"==taxType||"1"==taxType){if(modal.find(".js-active .globalTax").length>0&&(globalTax=App.Fields.Double.formatToDb(modal.find(".js-active .globalTax").val())),modal.find(".js-active .individualTaxValue").length>0)individualTax=App.Fields.Double.formatToDb(modal.find(".js-active .individualTaxValue").val())/100*valuePrices;modal.find(".js-active .groupTax").length>0&&(groupTax=netPriceWithoutTax*((groupTax=App.Fields.Double.formatToDb(modal.find(".groupTax").val()))/100)),modal.find(".js-active .regionalTax").length>0&&(regionalTax=netPriceWithoutTax*((regionalTax=App.Fields.Double.formatToDb(modal.find(".regionalTax").val()))/100)),valuePrices*=(100+globalTax)/100,valuePrices+=individualTax,valuePrices+=groupTax,valuePrices+=regionalTax}else"2"==taxType&&modal.find(".js-active").each((function(index){var panel=$(this);if(panel.find(".globalTax").length>0){var globalTax=App.Fields.Double.formatToDb(panel.find(".globalTax").val());valuePrices*=(100+globalTax)/100}else if(panel.find(".groupTax").length>0){var groupTax=App.Fields.Double.formatToDb(panel.find(".groupTax").val());valuePrices*=(100+groupTax)/100}else if(panel.find(".regionalTax").length>0){var regionalTax=App.Fields.Double.formatToDb(panel.find(".regionalTax").val());valuePrices*=(100+regionalTax)/100}else if(panel.find(".individualTaxValue").length>0){var value=App.Fields.Double.formatToDb(panel.find(".individualTaxValue").val());valuePrices*=(value+100)/100}}));if(netPriceWithoutTax){var taxValue=(valuePrices-netPriceWithoutTax)/netPriceWithoutTax*100;modal.find(".js-tax-value").text(App.Fields.Double.formatToDisplay(taxValue))}modal.find(".valuePrices").text(App.Fields.Double.formatToDisplay(valuePrices)),modal.find(".valueTax").text(App.Fields.Double.formatToDisplay(valuePrices-netPriceWithoutTax))},updateRowSequence:function(){this.getInventoryItemsContainer().find(this.rowClass).each((function(index){$(this).find(".sequence").val(index+1)}))},registerInventorySaveData:function(){var thisInstance=this;thisInstance.form.on(Vtiger_Edit_Js.recordPreSave,(function(e,data){if(thisInstance.syncHeaderData(),!thisInstance.checkLimits(thisInstance.form))return!1;thisInstance.form.find("#blackIthemTable").find("[name]").removeAttr("name")}))},syncHeaderData:function(){var header=this.getInventoryHeadContainer();this.getInventoryItemsContainer().find(".js-sync").each((function(){var element=$(this);element.val(header.find(".js-"+element.data("syncId")).val())}))},pricebooksModalHandler:function(element){var thisInstance=this,lineItemRow=element.closest(this.rowClass),rowName=lineItemRow.find(".rowName");app.showRecordsList({module:"PriceBooks",src_module:$('[name="popupReferenceModule"]',rowName).val(),src_record:$(".sourceField",rowName).val(),src_field:$('[name="popupReferenceModule"]',rowName).data("field"),currency_id:thisInstance.getCurrency()||CONFIG.defaultCurrencyId},(function(modal,instance){instance.setSelectEvent((function(responseData){AppConnector.request({module:"PriceBooks",action:"ProductListPrice",record:responseData.id,src_record:$(".sourceField",rowName).val()}).done((function(data){data.result?(thisInstance.setUnitPrice(lineItemRow,data.result),thisInstance.quantityChangeActions(lineItemRow)):app.errorLog("Incorrect data",responseData)}))}))}))},subProductsCashe:[],loadSubProducts:function(parentRow,indicator){var thisInstance=this,recordId=$("input.sourceField",parentRow).val(),recordModule=parentRow.find('.rowName input[name="popupReferenceModule"]').val();if(thisInstance.removeSubProducts(parentRow),"0"==recordId||""==recordId||$.inArray(recordModule,["Products","Services"])<0)return!1;if(thisInstance.subProductsCashe[recordId])return thisInstance.addSubProducts(parentRow,thisInstance.subProductsCashe[recordId]),!1;var subProrductParams={module:"Products",action:"SubProducts",record:recordId};if(indicator)var progressInstace=$.progressIndicator();AppConnector.request(subProrductParams).done((function(data){var responseData=data.result;thisInstance.subProductsCashe[recordId]=responseData,thisInstance.addSubProducts(parentRow,responseData),progressInstace&&progressInstace.hide()})).fail((function(error,err){progressInstace&&progressInstace.hide()}))},removeSubProducts:function(parentRow){$(".subProductsContainer ul",parentRow).find("li").remove()},addSubProducts:function(parentRow,responseData){var subProductsContainer=$(".subProductsContainer ul",parentRow);for(var id in responseData){var priductText=$("<li>").text(responseData[id]);subProductsContainer.append(priductText)}},mapResultsToFields:function(referenceModule,parentRow,responseData){var unit=void 0,taxParam=[],isGroupTax=this.isGroupTaxMode();for(var id in responseData){var recordData=responseData[id],description=recordData.description,unitPriceValues=recordData.unitPriceValues,unitPriceValuesJson=JSON.stringify(unitPriceValues);if(isGroupTax){var parameters=parentRow.closest(".inventoryItems").data("taxParam");parameters&&(taxParam=JSON.parse(parameters))}else recordData.taxes&&((taxParam={aggregationType:recordData.taxes.type})[recordData.taxes.type+"Tax"]=recordData.taxes.value);for(var field in recordData.taxes&&parentRow.find(".js-tax").attr("data-default-tax",App.Fields.Double.formatToDisplay(recordData.taxes.value)),this.setPurchase(parentRow,recordData.purchase),this.setTaxParam(parentRow,taxParam),this.setTax(parentRow,0),this.setTaxPercent(parentRow,0),recordData.autoFields)parentRow.find("input."+field).val(recordData.autoFields[field]),recordData.autoFields[field+"Text"]&&parentRow.find("."+field+"Text").text(recordData.autoFields[field+"Text"]);void 0!==recordData.price&&this.setUnitPrice(parentRow,recordData.price),void 0!==unitPriceValuesJson&&$("input.unitPrice",parentRow).attr("list-info",unitPriceValuesJson);var commentElement=$("textarea.commentTextarea",parentRow.next()),editorInstance=CKEDITOR.instances[commentElement.attr("id")];editorInstance?editorInstance.setData(description):commentElement.val(description),void 0!==recordData.autoFields.unit&&(unit=recordData.autoFields.unit),this.triggerQtyParam(unit,recordData.qtyPerUnit,parentRow)}"Products"===referenceModule&&this.loadSubProducts(parentRow,!0),this.quantityChangeActions(parentRow)},triggerQtyParam:function(unit,perUnit,parentRow){var validationEngine=void 0;switch(unit){default:$(".qtyParamInfo",parentRow).addClass("d-none"),validationEngine="validate[required,funcCall[Vtiger_NumberUserFormat_Validator_Js.invokeValidation]]";break;case"pack":$(".qtyParamInfo",parentRow).removeClass("d-none").removeClass("active"),$(".qtyParamInfo",parentRow).attr("data-content",perUnit),validationEngine="validate[required,funcCall[Vtiger_WholeNumber_Validator_Js.invokeValidation]]";break;case"pcs":$(".qtyParamInfo",parentRow).addClass("d-none"),validationEngine="validate[required,funcCall[Vtiger_WholeNumber_Validator_Js.invokeValidation]]"}$("input.qty",parentRow).attr("data-validation-engine",validationEngine)},saveDiscountsParameters:function(parentRow,modal){var info={},typeName="aggregationType",panels=modal.find('[name="'+typeName+'"]:checked');info[typeName]=[],panels.each((function(i){var type=$(this).val(),container=$(this).closest(".js-panel");panels.length>1?info[typeName].push(type):info[typeName]=type,container.find('[name="'+type+'Discount"]').each((function(){var param=type+"Discount",element=$(this);if("global"===type)info[param]=element.val();else if("group"===type&&element.closest(".input-group").find(".groupCheckbox").prop("checked"))info[param]=App.Fields.Double.formatToDb(element.val());else if("individual"===type){var name="individualDiscountType";info[name]=container.find('[name="'+name+'"]:checked').val(),info[param]=App.Fields.Double.formatToDb(element.val())}}))})),this.setDiscountParam($("#blackIthemTable"),info),this.setDiscountParam(parentRow,info)},saveTaxsParameters:function(parentRow,modal){var info={},extend=["aggregationType","groupCheckbox","individualTaxType"];$.each(this.taxModalFields,(function(index,param){$.inArray(param,extend)>=0?modal.find('[name="'+param+'"]:checked').length>1?(info[param]=[],modal.find('[name="'+param+'"]:checked').each((function(index){info[param].push($(this).val())}))):info[param]=modal.find('[name="'+param+'"]:checked').val():info[param]=App.Fields.Double.formatToDb(modal.find('[name="'+param+'"]').val())})),parentRow.data("taxParam",JSON.stringify(info)),this.setTaxParam(parentRow,info),this.setTaxParam($("#blackIthemTable"),info)},showExpandedRow:function(row){var inventoryRowExpanded=this.getInventoryItemsContainer().find('[numrowex="'+row.attr("numrow")+'"]');row.find(".toggleVisibility").data("status","1"),inventoryRowExpanded.removeClass("d-none");var listInstance=Vtiger_Edit_Js.getInstance();$.each(inventoryRowExpanded.find(".js-editor"),(function(key,data){listInstance.loadEditorElement($(data))}))},hideExpandedRow:function(row){var inventoryRowExpanded=this.getInventoryItemsContainer().find('[numrowex="'+row.attr("numrow")+'"]');row.find(".toggleVisibility").data("status","0"),inventoryRowExpanded.addClass("d-none"),$.each(inventoryRowExpanded.find(".js-editor"),(function(key,data){var editorInstance=CKEDITOR.instances[$(data).attr("id")];editorInstance&&editorInstance.destroy()}))},initDiscountsParameters:function(parentRow,modal){var parameters=parentRow.find(".discountParam").val();""!=parameters&&null!=parameters&&(parameters=JSON.parse(parameters),$.each(this.discountModalFields,(function(index,param){var parameter=parameters[param],field=modal.find('[name="'+param+'"]');if("checkbox"==field.attr("type")||"radio"==field.attr("type")){if("groupCheckbox"===param&&void 0!==parameters.groupDiscount)return field.prop("checked",!0),!0;var array=parameter;$.isArray(array)||(array=[array]),$.each(array,(function(index,arrayValue){var value=field.filter('[value="'+arrayValue+'"]').prop("checked",!0);"aggregationType"==param&&(value.closest(".js-panel").find(".js-panel__body").removeClass("d-none"),value.closest(".js-panel").addClass("js-active"))}))}else"SELECT"==field.prop("tagName")?field.find('option[value="'+parameter+'"]').prop("selected","selected").change():field.prop("readonly")||field.val(parameter)})),this.calculateDiscount(parentRow,modal))},initTaxParameters:function(parentRow,modal){var parameters=void 0;(parameters=parentRow.data("taxParam")?parentRow.data("taxParam"):parentRow.find(".taxParam").val())&&(parameters=JSON.parse(parameters.toString()),$.each(this.taxModalFields,(function(index,param){var parameter=parameters[param],field=modal.find('[name="'+param+'"]');if("checkbox"===field.attr("type")||"radio"===field.attr("type")){var array=parameter,value=void 0;$.isArray(array)||(array=[array]),$.each(array,(function(index,arrayValue){value=field.filter('[value="'+arrayValue+'"]').prop("checked",!0),"aggregationType"===param&&(value.closest(".js-panel").find(".js-panel__body").removeClass("d-none"),value.closest(".js-panel").addClass("js-active"))}))}else if("SELECT"===field.prop("tagName"))field.find('option[value="'+parameter+'"]').prop("selected","selected").change();else{var input=modal.find('[name="'+param+'"]');input.val(parameter),"individualTax"===param&&input.formatNumber()}})),this.calculateTax(parentRow,modal))},limitEnableSave:!1,checkLimits:function(){var account=this.getAccountId(),limit=parseInt(app.getMainParams("inventoryLimit")),response=!0;if(""==account||this.limitEnableSave||!limit)return response;var params={};params.data={module:app.getModuleName(),action:"Inventory",mode:"checkLimits",record:account,currency:this.getCurrency(),price:this.getSummaryGrossPrice()},params.async=!1,params.dataType="json";var progressInstace=$.progressIndicator();return AppConnector.request(params).done((function(data){progressInstace.hide(),0==data.result.status&&(app.showModalWindow(data.result.html,(function(data){})),response=!1)})).fail((function(error,err){progressInstace.hide()})),response},currencyChangeActions:function(select,option){option.data("baseCurrency")!==select.val()?this.showCurrencyChangeModal(select,option):(this.currencyConvertValues(select,option),select.data("oldValue",select.val()))},showCurrencyChangeModal:function(select,option){var thisInstance=this;if(1!=thisInstance.lockCurrencyChange){thisInstance.lockCurrencyChange=!0;var block=select.closest("th"),modal=block.find(".modelContainer").clone();app.showModalWindow(modal,(function(data){var modal=$(data),currencyParam=JSON.parse(block.find(".js-currencyparam").val());if(0!=currencyParam){if(void 0===currencyParam[option.val()]){currencyParam[option.val()]={value:1,date:""}}modal.find(".currencyName").text(option.text()),modal.find(".currencyRate").val(currencyParam[option.val()].value),modal.find(".currencyDate").text(currencyParam[option.val()].date)}modal.on("click",'button[type="submit"]',(function(e){var rate=modal.find(".currencyRate").val(),value=App.Fields.Double.formatToDb(rate),conversionRate=1/App.Fields.Double.formatToDb(rate);option.data("conversionRate",conversionRate),currencyParam[option.val()]={date:option.data("conversionDate"),value:value.toString(),conversion:conversionRate.toString()},block.find(".js-currencyparam").val(JSON.stringify(currencyParam)),thisInstance.currencyConvertValues(select,option),select.data("oldValue",select.val()),app.hideModalWindow(),thisInstance.lockCurrencyChange=!1})).one("hidden.bs.modal",(function(){select.val(select.data("oldValue")).change(),thisInstance.lockCurrencyChange=!1}))}))}},currencyConvertValues:function(select,selected){var thisInstance=this,previous=select.find('option[value="'+select.data("oldValue")+'"]'),conversionRate=selected.data("conversionRate"),prevConversionRate=previous.data("conversionRate");conversionRate=parseFloat(conversionRate)/parseFloat(prevConversionRate),this.getInventoryItemsContainer().find(thisInstance.rowClass).each((function(index){var row=$(this);thisInstance.setUnitPrice(row,App.Fields.Double.formatToDb(thisInstance.getUnitPriceValue(row)*conversionRate)),thisInstance.setDiscount(row,App.Fields.Double.formatToDb(thisInstance.getDiscount(row)*conversionRate)),thisInstance.setTax(row,App.Fields.Double.formatToDb(thisInstance.getTax(row)*conversionRate)),thisInstance.quantityChangeActions(row)}))},setRowData:function(row,rowData){this.setName(row,rowData.name,rowData.info.name),this.setQuantity(row,rowData.qty),this.setUnit(row,rowData.info.autoFields.unit,rowData.info.autoFields.unitText),void 0!==rowData.info.autoFields&&void 0!==rowData.info.autoFields.subunit&&this.setSubUnit(row,rowData.info.autoFields.subunit,rowData.info.autoFields.subunitText),this.setComment(row,rowData.comment1),this.setUnitPrice(row,rowData.price),this.setNetPrice(row,rowData.net),this.setGrossPrice(row,rowData.gross),this.setTotalPrice(row,rowData.total);var discountParam=rowData.discountparam||null;this.setDiscountParam(row,JSON.parse(discountParam)),this.setDiscount(row,rowData.discount),this.setTaxParam(row,JSON.parse(rowData.taxparam)),this.setTax(row,rowData.tax),this.setTaxPercent(row,rowData.tax_percent)},addItem:function(module,baseTableId){var rowData=arguments.length>2&&void 0!==arguments[2]&&arguments[2],items=this.getInventoryItemsContainer(),newRow=this.getBasicRow(),sequenceNumber=this.getNextLineItemRowNumber(),replaced=newRow.html().replace(/\_NUM_/g,sequenceNumber),moduleLbls=newRow.data("moduleLbls");newRow.html(replaced),(newRow=newRow.children().appendTo(items.find(".js-inventory-items-body"))).find('.rowName input[name="popupReferenceModule"]').val(module).data("field",baseTableId),newRow.find(".js-module-icon").removeClass().addClass("userIcon-"+module),newRow.find(".rowName span.input-group-text").attr("data-content",moduleLbls[module]),newRow.find(".colPicklistField select").each((function(index,select){(select=$(select)).find("option").each((function(index,option){(option=$(option)).data("module")!==module&&option.remove()}))})),this.initItem(newRow),Vtiger_Edit_Js.getInstance().registerAutoCompleteFields(newRow),rowData&&(this.setRowData(newRow,rowData),this.quantityChangeActions(newRow))},registerAddItem:function(){var thisInstance=this;thisInstance.getInventoryHeadContainer().find(".js-inv-add-item").on("click",(function(e){var btn=$(this);thisInstance.addItem(btn.data("module"),btn.data("field"))}))},registerSortableItems:function(){var thisInstance=this,items=thisInstance.getInventoryItemsContainer();items.sortable({handle:".dragHandle",items:thisInstance.rowClass,revert:!0,tolerance:"pointer",placeholder:"ui-state-highlight",helper:function(e,ui){return ui.children().each((function(index,element){(element=$(element)).width(element.width())})),ui},start:function(event,ui){items.find(thisInstance.rowClass).each((function(index,element){var row=$(element);thisInstance.hideExpandedRow(row)})),ui.item.startPos=ui.item.index()},stop:function(event,ui){var numrow=$(ui.item).attr("numrow"),child=items.find(".numRow"+numrow).remove().clone();items.find('[numrow="'+numrow+'"]').after(child),ui.item.startPos<ui.item.index()&&(child=items.find(".numRow"+numrow).next().remove().clone(),items.find('[numrow="'+numrow+'"]').before(child)),thisInstance.updateRowSequence()}})},registerShowHideExpanded:function(){var thisInstance=this;thisInstance.form.on("click",".toggleVisibility",(function(e){var element=$(e.currentTarget),row=thisInstance.getClosestRow(element);0==element.data("status")?thisInstance.showExpandedRow(row):thisInstance.hideExpandedRow(row)}))},registerPriceBookModal:function(container){var thisInstance=this;container.find(".js-price-book-modal").on("click",(function(e){var element=$(e.currentTarget);1!=thisInstance.isRecordSelected(element)&&thisInstance.pricebooksModalHandler(element)}))},registerRowChangeEvent:function(container){var _this=this;container.on("focusout",".qty",(function(e){var element=$(e.currentTarget);element.formatNumber(),_this.quantityChangeActions(_this.getClosestRow(element))})),container.on("focusout",".unitPrice",(function(e){var element=$(e.currentTarget);element.formatNumber(),_this.quantityChangeActions(_this.getClosestRow(element))})),container.on("focusout",".purchase",(function(e){var element=$(e.currentTarget);element.formatNumber(),_this.quantityChangeActions(_this.getClosestRow(element))}));var headContainer=this.getInventoryHeadContainer();headContainer.on("change",".js-taxmode",(function(e){var element=$(e.currentTarget);_this.showIndividualTax(_this.getClosestRow(element)),_this.rowsCalculations()})),headContainer.on("change",".js-discountmode",(function(e){var element=$(e.currentTarget);_this.showIndividualDiscount(_this.getClosestRow(element)),_this.rowsCalculations()}))},registerSubProducts:function(){var thisInstance=this;thisInstance.form.find(".inventoryItems "+thisInstance.rowClass).each((function(index){thisInstance.loadSubProducts($(this),!1)}))},registerClearReferenceSelection:function(){var _this2=this;this.form.on("click",".clearReferenceSelection",(function(e){var referenceGroup=$(e.currentTarget).closest("div.referenceGroup");if(referenceGroup.length)referenceGroup.find('input[id$="_display"]').val("").removeAttr("readonly");else{var row=_this2.getClosestRow($(e.currentTarget));_this2.removeSubProducts(row),row.find(".unitPrice,.tax,.discount,.margin,.purchase,.js-tax-percent").val(App.Fields.Double.formatToDisplay(0)),row.find(".qty").val(1),row.find("textarea,.valueVal").val(""),row.find(".valueText").text(""),row.find(".qtyParamInfo").addClass("d-none"),row.find(".recordLabel").val("").removeAttr("readonly"),_this2.isGroupTaxMode()||_this2.setTaxParam(row,[]),_this2.quantityChangeActions(row)}}))},registerDeleteLineItemEvent:function(container){var thisInstance=this;container.on("click",".deleteRow",(function(e){var num=thisInstance.getClosestRow($(e.currentTarget)).attr("numrow");thisInstance.getInventoryItemsContainer().find('[numrow="'+num+'"], [numrowex="'+num+'"]').remove(),thisInstance.checkDeleteIcon(),thisInstance.rowsCalculations(),0===thisInstance.getInventoryItemsContainer().find(".inventoryRow").length&&$("#inventoryItemsNo").val(0),thisInstance.updateRowSequence()}))},registerChangeDiscount:function(){var thisInstance=this;thisInstance.form.on("click",".changeDiscount",(function(e){var parentRow,element=$(e.currentTarget),params={module:app.getModuleName(),view:"Inventory",mode:"showDiscounts",currency:thisInstance.getCurrency(),relatedRecord:thisInstance.getAccountId()};element.hasClass("groupDiscount")?(0!=(parentRow=thisInstance.getInventoryItemsContainer()).find("tfoot .colTotalPrice").length?params.totalPrice=App.Fields.Double.formatToDb(parentRow.find("tfoot .colTotalPrice").text()):params.totalPrice=0,params.discountType=1):(parentRow=element.closest(thisInstance.rowClass),params.totalPrice=thisInstance.getTotalPrice(parentRow),params.discountType=0);var progressInstace=$.progressIndicator();AppConnector.request(params).done((function(data){app.showModalWindow(data,(function(data){thisInstance.initDiscountsParameters(parentRow,$(data)),thisInstance.registerChangeDiscountModal(data,parentRow,params)})),progressInstace.hide()})).fail((function(error,err){progressInstace.hide()}))}))},registerChangeDiscountModal:function(modal,parentRow,params){var thisInstance=this;modal.on("change",".individualDiscountType",(function(e){var element=$(e.currentTarget);modal.find(".individualDiscountContainer .input-group-text").text(element.data("symbol"))})),modal.on("change",'.activeCheckbox[name="aggregationType"]',(function(e){var element=$(e.currentTarget);"checkbox"==element.attr("type")&&this.checked?(element.closest(".js-panel").find(".js-panel__body").removeClass("d-none"),element.closest(".js-panel").addClass("js-active")):"radio"==element.attr("type")?(modal.find(".js-panel").removeClass("js-active"),modal.find(".js-panel .js-panel__body").addClass("d-none"),element.closest(".js-panel").find(".js-panel__body").removeClass("d-none"),element.closest(".js-panel").addClass("js-active")):(element.closest(".js-panel").find(".js-panel__body").addClass("d-none"),element.closest(".js-panel").removeClass("js-active"))})),modal.on("change",".activeCheckbox, .globalDiscount,.individualDiscountValue,.individualDiscountType,.groupCheckbox",(function(e){thisInstance.calculateDiscount(parentRow,modal)})),modal.on("click",".saveDiscount",(function(e){if(thisInstance.saveDiscountsParameters(parentRow,modal),0==params.discountType)thisInstance.setDiscount(parentRow,App.Fields.Double.formatToDb(modal.find(".valueDiscount").text())),thisInstance.quantityChangeActions(parentRow);else{var rate=App.Fields.Double.formatToDb(modal.find(".valueDiscount").text())/App.Fields.Double.formatToDb(modal.find(".valueTotalPrice").text());parentRow.find(thisInstance.rowClass).each((function(index){thisInstance.setDiscount($(this),thisInstance.getTotalPrice($(this))*rate),thisInstance.quantityChangeActions($(this))}))}app.hideModalWindow()}))},registerChangeTax:function(){var thisInstance=this;thisInstance.form.on("click",".changeTax",(function(e){var parentRow,element=$(e.currentTarget),params={module:app.getModuleName(),view:"Inventory",mode:"showTaxes",currency:thisInstance.getCurrency(),sourceRecord:app.getRecordId()};if(element.hasClass("groupTax")){var totalPrice=0;(parentRow=thisInstance.getInventoryItemsContainer()).find("tfoot .colNetPrice").length>0?totalPrice=parentRow.find("tfoot .colNetPrice").text():parentRow.find("tfoot .colTotalPrice ").length>0&&(totalPrice=parentRow.find("tfoot .colTotalPrice ").text()),params.totalPrice=App.Fields.Double.formatToDb(totalPrice),params.taxType=1}else{var sourceRecord=(parentRow=element.closest(thisInstance.rowClass)).find(".rowName .sourceField").val();params.totalPrice=thisInstance.getNetPrice(parentRow),params.taxType=0,sourceRecord&&(params.record=sourceRecord),params.recordModule=parentRow.find('.rowName [name="popupReferenceModule"]').val()}var progressInstace=$.progressIndicator();AppConnector.request(params).done((function(data){app.showModalWindow(data,(function(data){thisInstance.initTaxParameters(parentRow,$(data)),thisInstance.registerChangeTaxModal(data,parentRow,params)})),progressInstace.hide()})).fail((function(error,err){progressInstace.hide()}))}))},lockCurrencyChange:!1,registerChangeCurrency:function(){var _this3=this;this.getInventoryHeadContainer().on("change",".js-currency",(function(e){var element=$(e.currentTarget),symbol=element.find("option:selected").data("conversionSymbol");_this3.currencyChangeActions(element,element.find("option:selected")),_this3.form.find(".currencySymbol").text(symbol)}))},registerChangeTaxModal:function(modal,parentRow,params){var thisInstance=this;modal.on("change",".individualTaxType",(function(e){var element=$(e.currentTarget);modal.find(".individualTaxContainer .input-group-text").text(element.data("symbol"))})),modal.on("change",'.activeCheckbox[name="aggregationType"]',(function(e){var element=$(e.currentTarget);"checkbox"==element.attr("type")&&this.checked?(element.closest(".js-panel").find(".js-panel__body").removeClass("d-none"),element.closest(".js-panel").addClass("js-active")):"radio"==element.attr("type")?(modal.find(".js-panel").removeClass("js-active"),modal.find(".js-panel .js-panel__body").addClass("d-none"),element.closest(".js-panel").find(".js-panel__body").removeClass("d-none"),element.closest(".js-panel").addClass("js-active")):(element.closest(".js-panel").find(".js-panel__body").addClass("d-none"),element.closest(".js-panel").removeClass("js-active"))})),modal.on("change",".activeCheckbox, .globalTax, .individualTaxValue, .groupTax, .regionalTax",(function(e){thisInstance.calculateTax(parentRow,modal)})),modal.on("click",".saveTaxs",(function(e){if(thisInstance.saveTaxsParameters(parentRow,modal),"0"==params.taxType)thisInstance.setTax(parentRow,App.Fields.Double.formatToDb(modal.find(".valueTax").text())),thisInstance.setTaxPercent(parentRow,App.Fields.Double.formatToDb(modal.find(".js-tax-value").text())),thisInstance.quantityChangeActions(parentRow);else{var rate=App.Fields.Double.formatToDb(modal.find(".valueTax").text())/App.Fields.Double.formatToDb(modal.find(".valueNetPrice").text());parentRow.find(thisInstance.rowClass).each((function(index){var totalPrice;$(".netPrice",$(this)).length>0?totalPrice=thisInstance.getNetPrice($(this)):$(".totalPrice",$(this)).length>0&&(totalPrice=thisInstance.getTotalPrice($(this))),thisInstance.setTax($(this),totalPrice*rate),thisInstance.setTaxPercent($(this),App.Fields.Double.formatToDb(modal.find(".js-tax-value").text())),thisInstance.quantityChangeActions($(this))}))}app.hideModalWindow()}))},registerRowAutoComplete:function(container){var thisInstance=this;container.find(".sourceField.js-name").on(Vtiger_Edit_Js.referenceSelectionEvent,(function(e,params){var record=params.record,element=$(e.currentTarget),parentRow=element.closest(thisInstance.rowClass),selectedModule=parentRow.find('.rowName [name="popupReferenceModule"]').val(),dataUrl="index.php?module="+app.getModuleName()+"&action=Inventory&mode=getDetails&record="+record+"&fieldname="+element.data("columnname");thisInstance.getCurrency()&&(dataUrl+="&currency_id="+thisInstance.getCurrency()),AppConnector.request(dataUrl).done((function(data){for(var id in data)if("object"==_typeof(data[id])){var recordData=data[id];thisInstance.mapResultsToFields(selectedModule,parentRow,recordData)}}))}))},calculateItemNumbers:function(){var items=this.getInventoryItemsContainer(),i=1;items.find(this.rowClass).each((function(index){$(this).find(".itemNumberText").text(i),i++}))},initItem:function(container){void 0===container&&(container=this.getInventoryItemsContainer()),this.registerDeleteLineItemEvent(container),this.registerPriceBookModal(container),this.registerRowChangeEvent(container),this.registerRowAutoComplete(container),this.checkDeleteIcon(),this.rowsCalculations(),this.updateRowSequence(),App.Fields.Picklist.showSelect2ElementView(container.find(".selectInv")),App.Fields.Date.register(container,!0,{},"dateFieldInv"),container.validationEngine("detach"),container.validationEngine(app.validationEngineOptions)},loadInventoryData:function(recordId,sourceModule){var _this4=this,success=arguments.length>2&&void 0!==arguments[2]&&arguments[2],fail=arguments.length>3&&void 0!==arguments[3]&&arguments[3],progressLoader=$.progressIndicator({blockInfo:{enabled:!0}});return new Promise((function(resolve,reject){AppConnector.request({module:sourceModule,action:"Inventory",mode:"getTableData",record:recordId}).done((function(response){var activeModules=[];_this4.getInventoryHeadContainer().find(".js-inv-add-item").each((function(index,addBtn){activeModules.push($(addBtn).data("module"))})),progressLoader.progressIndicator({mode:"hide"});var oldCurrencyChangeAction=_this4.currencyChangeActions;_this4.currencyChangeActions=function(select,option){this.currencyConvertValues(select,option),select.data("oldValue",select.val())};var first=response.result[Object.keys(response.result)[0]];_this4.setCurrencyParam(first.currencyparam),_this4.setCurrency(first.currency),_this4.setDiscountMode(first.discountmode),_this4.setTaxMode(first.taxmode),_this4.currencyChangeActions=oldCurrencyChangeAction,$.each(response.result,(function(index,row){-1!==activeModules.indexOf(row.moduleName)?_this4.addItem(row.moduleName,row.basetableid,row):Vtiger_Helper_Js.showMessage({type:"error",text:app.vtranslate("JS_INVENTORY_ITEM_MODULE_NOT_FOUND").replace("${sourceModule}",row.moduleName).replace("${position}",row.info.name)})})),_this4.summaryCalculations(),resolve(response.result),"function"==typeof success&&success(response.result)})).fail((function(error,err){progressLoader.progressIndicator({mode:"hide"}),reject(error,err),"function"==typeof fail&&fail(error,err)}))}))},registerEvents:function(container){this.form=container,this.registerInventorySaveData(),this.registerAddItem(),this.initItem(),this.registerSortableItems(),this.registerSubProducts(),this.registerChangeDiscount(),this.registerChangeTax(),this.registerClearReferenceSelection(),this.registerShowHideExpanded(),this.registerChangeCurrency(),this.setDefaultGlobalTax(container)}});
//# sourceMappingURL=Inventory.min.js.map
