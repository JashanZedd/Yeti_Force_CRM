{"version":3,"file":"AdvanceSearch.min.js","sources":["AdvanceSearch.js"],"sourcesContent":["/*+***********************************************************************************\n * The contents of this file are subject to the vtiger CRM Public License Version 1.0\n * (\"License\"); You may not use this file except in compliance with the License\n * The Original Code is:  vtiger CRM Open Source\n * The Initial Developer of the Original Code is vtiger.\n * Portions created by vtiger are Copyright (C) vtiger.\n * All Rights Reserved.\n * Contributor(s): YetiForce.com\n *************************************************************************************/\n'use strict';\n\nVtiger_BasicSearch_Js(\n\t'Vtiger_AdvanceSearch_Js',\n\t{\n\t\t//cache will store the search data\n\t\tcache: {}\n\t},\n\t{\n\t\t//container which will store the search elements\n\t\telementContainer: false,\n\t\t//instance which represents advance filter\n\t\tadvanceFilter: false,\n\t\t//states whether the validation is registred for filter elements\n\t\tfilterValidationRegistered: false,\n\t\t//contains the filter form element\n\t\tfilterForm: false,\n\t\t//container which will store the parent elements\n\t\tparentContainer: false,\n\t\t/**\n\t\t * Function which will give the container\n\t\t */\n\t\tgetContainer: function () {\n\t\t\treturn this.elementContainer;\n\t\t},\n\t\t/**\n\t\t *Function which is used to set the continaer\n\t\t *@params : container - element which represent the container\n\t\t *@return current instance\n\t\t */\n\t\tsetContainer: function (container) {\n\t\t\tthis.elementContainer = container;\n\t\t\treturn this;\n\t\t},\n\t\t/**\n\t\t * Function which will give the parent container\n\t\t */\n\t\tgetParentContainer: function () {\n\t\t\treturn this.parentContainer;\n\t\t},\n\t\t/**\n\t\t *Function which is used to set the continaer\n\t\t *@params : container - element which represent the container\n\t\t *@return current instance\n\t\t */\n\t\tsetParentContainer: function (container) {\n\t\t\tthis.setMainContainer(container);\n\t\t\tthis.parentContainer = container;\n\t\t\treturn this;\n\t\t},\n\t\tgetFilterForm: function () {\n\t\t\treturn $('form[name=\"advanceFilterForm\"]', this.getContainer());\n\t\t},\n\t\t/**\n\t\t * Function used to get the advance search ui\n\t\t * @return : deferred promise\n\t\t */\n\t\tgetAdvanceSearch: function () {\n\t\t\tvar aDeferred = $.Deferred();\n\t\t\tvar searchModule = this.getSearchModule();\n\t\t\t//Exists in the cache\n\t\t\tif (searchModule in Vtiger_AdvanceSearch_Js.cache) {\n\t\t\t\taDeferred.resolve(Vtiger_AdvanceSearch_Js.cache[searchModule]);\n\t\t\t\treturn aDeferred.promise();\n\t\t\t}\n\t\t\tvar searchableModulesParams = {\n\t\t\t\tmodule: app.getModuleName(),\n\t\t\t\tsearchModule: searchModule,\n\t\t\t\tview: 'BasicAjax',\n\t\t\t\tmode: 'showAdvancedSearch'\n\t\t\t};\n\t\t\tif (app.getParentModuleName()) {\n\t\t\t\tsearchableModulesParams.parent = app.getParentModuleName();\n\t\t\t}\n\t\t\tvar progressInstance = $.progressIndicator();\n\t\t\tAppConnector.request(searchableModulesParams)\n\t\t\t\t.done(function (data) {\n\t\t\t\t\tprogressInstance.hide();\n\t\t\t\t\t//add to cache\n\t\t\t\t\tVtiger_AdvanceSearch_Js.cache[searchModule] = data;\n\t\t\t\t\taDeferred.resolve(data);\n\t\t\t\t})\n\t\t\t\t.fail(function (error, err) {\n\t\t\t\t\taDeferred.reject(error);\n\t\t\t\t});\n\t\t\treturn aDeferred.promise();\n\t\t},\n\t\t/**\n\t\t * Function which intializes search\n\t\t */\n\t\tinitiateSearch: function () {\n\t\t\tvar aDeferred = $.Deferred();\n\t\t\tvar thisInstance = this;\n\t\t\tvar postLoad = function (uiData) {\n\t\t\t\tthisInstance.setContainer($('#advanceSearchContainer'));\n\t\t\t\tthisInstance.filterValidationRegistered = false;\n\t\t\t\tthisInstance.registerEvents();\n\t\t\t\tthisInstance.advanceFilter = new Vtiger_ConditionBuilder_Js(thisInstance.getContainer().find('.js-condition-builder'), thisInstance.getSearchModule());\n\t\t\t\tthisInstance.advanceFilter.registerEvents();\n\t\t\t\taDeferred.resolve();\n\t\t\t};\n\t\t\tthisInstance\n\t\t\t\t.getAdvanceSearch()\n\t\t\t\t.done(function (data) {\n\t\t\t\t\tvar params = {};\n\t\t\t\t\tparams.data = data;\n\t\t\t\t\tparams.cb = postLoad;\n\t\t\t\t\tapp.hideModalWindow();\n\t\t\t\t\tapp.showModalWindow(params);\n\t\t\t\t})\n\t\t\t\t.fail(function (error) {\n\t\t\t\t\taDeferred.reject();\n\t\t\t\t});\n\t\t\treturn aDeferred.promise();\n\t\t},\n\t\t/**\n\t\t * Function which invokes search\n\t\t */\n\t\tsearch: function () {\n\t\t\tvar conditionValues = this.advanceFilter.getConditions();\n\t\t\tvar module = this.getSearchModule();\n\t\t\treturn this._search({\n\t\t\t\tmodule: app.getModuleName(),\n\t\t\t\tsearchModule: module,\n\t\t\t\tadvfilterlist: JSON.stringify(conditionValues)\n\t\t\t});\n\t\t},\n\t\t/**\n\t\t * Function which shows search results in proper manner\n\t\t * @params : data to be shown\n\t\t */\n\t\tshowSearchResults: function (data) {\n\t\t\tvar aDeferred = $.Deferred();\n\t\t\tvar postLoad = function (data) {\n\t\t\t\t//app.showScrollBar($(data).find('.contents'));\n\t\t\t\taDeferred.resolve(data);\n\t\t\t};\n\t\t\tvar html =\n\t\t\t\t'<div class=\"row\">' +\n\t\t\t\t'<span class=\"col-md-4 searchHolder\"></span>' +\n\t\t\t\t'<span class=\"col-md-8 filterHolder marginLeftZero d-none\"></span>' +\n\t\t\t\t'</div>';\n\t\t\tvar jQhtml = $(html);\n\t\t\t$('.searchHolder', jQhtml).html(data);\n\n\t\t\tdata = jQhtml;\n\n\t\t\tvar params = {};\n\t\t\tparams.data = data;\n\t\t\tparams.cb = postLoad;\n\t\t\tapp.showModalWindow(params);\n\n\t\t\treturn aDeferred.promise();\n\t\t},\n\t\t/**\n\t\t * Function which will save the filter\n\t\t */\n\t\tsaveFilter: function (params) {\n\t\t\tvar aDeferred = $.Deferred();\n\t\t\tparams.source_module = this.getSearchModule();\n\t\t\tparams.status = 1;\n\t\t\tparams.advfilterlist = JSON.stringify(this.advanceFilter.getConditions());\n\t\t\tparams.module = 'CustomView';\n\t\t\tparams.action = 'Save';\n\t\t\tAppConnector.request(params).done(function (data) {\n\t\t\t\tif (!data.success) {\n\t\t\t\t\tvar params = {\n\t\t\t\t\t\ttitle: app.vtranslate('JS_MESSAGE'),\n\t\t\t\t\t\ttext: data.error.message,\n\t\t\t\t\t\ttype: 'error'\n\t\t\t\t\t};\n\t\t\t\t\tVtiger_Helper_Js.showPnotify(params);\n\t\t\t\t}\n\t\t\t\taDeferred.resolve(data);\n\t\t\t});\n\t\t\treturn aDeferred.promise();\n\t\t},\n\t\t/**\n\t\t * Function which will save the filter and show the list view of new custom view\n\t\t */\n\t\tsaveAndViewFilter: function (params) {\n\t\t\tthis.saveFilter(params).done(\n\t\t\t\tfunction (response) {\n\t\t\t\t\tvar url = response['result']['listviewurl'];\n\t\t\t\t\twindow.location.href = url;\n\t\t\t\t},\n\t\t\t\tfunction (error) { }\n\t\t\t);\n\t\t},\n\t\t/**\n\t\t * Function which specify whether the search component and filter component both are shown\n\t\t */\n\t\tisSearchAndFilterComponentsShown: function () {\n\t\t\tvar modalData = $('#' + Window.lastModalId);\n\t\t\tvar filterComponent = $('.filterHolder', modalData).find('#advanceSearchContainer');\n\t\t\tif (filterComponent.length <= 0) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\treturn true;\n\t\t},\n\t\t/**\n\t\t * Function which will perform search and other operaions\n\t\t */\n\t\tperformSearch: function () {\n\t\t\tvar thisInstance = this;\n\t\t\tvar isSearchResultsAndFilterShown = this.isSearchAndFilterComponentsShown();\n\t\t\tthis.search().done(function (data) {\n\t\t\t\tthisInstance.setContainer(thisInstance.getContainer().detach());\n\t\t\t\tthisInstance.showSearchResults(data).done(function (modalBlock) {\n\t\t\t\t\tthisInstance.registerShowFiler();\n\t\t\t\t\t//if the filter already shown , show again\n\t\t\t\t\tif (isSearchResultsAndFilterShown) {\n\t\t\t\t\t\tthisInstance.showFilter();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t},\n\t\t/**\n\t\t * Function which will show the advance filter next to search results\n\t\t */\n\t\tshowFilter: function () {\n\t\t\tvar thisInstance = this;\n\t\t\tvar callback = function () {\n\t\t\t\tapp.showModalWindow(thisInstance.getContainer());\n\t\t\t};\n\t\t\tapp.hideModalWindow(callback);\n\t\t},\n\t\t/**\n\t\t * Function which will perform the validation for the advance filter fields\n\t\t * @return : deferred promise - resolves if validation succeded if not failure\n\t\t */\n\t\tperformValidation: function () {\n\t\t\tvar thisInstance = this;\n\t\t\tthis.formValidationDeferred = $.Deferred();\n\t\t\tvar controlForm = this.getFilterForm();\n\n\t\t\tvar validationDone = function (form, status) {\n\t\t\t\tif (status) {\n\t\t\t\t\tthisInstance.formValidationDeferred.resolve();\n\t\t\t\t} else {\n\t\t\t\t\tthisInstance.formValidationDeferred.reject();\n\t\t\t\t}\n\t\t\t};\n\t\t\t//To perform validation registration only once\n\t\t\tif (!this.filterValidationRegistered) {\n\t\t\t\tthis.filterValidationRegistered = true;\n\t\t\t\tcontrolForm.validationEngine({\n\t\t\t\t\tonValidationComplete: validationDone\n\t\t\t\t});\n\t\t\t}\n\t\t\t//This will trigger the validation\n\t\t\tcontrolForm.submit();\n\t\t\treturn this.formValidationDeferred.promise();\n\t\t},\n\t\t/**\n\t\t * Function which will register the show filer invocation\n\t\t */\n\t\tregisterShowFiler: function () {\n\t\t\tvar thisInstance = this;\n\t\t\t$('#showFilter').on('click', function (e) {\n\t\t\t\tthisInstance.showFilter();\n\t\t\t});\n\t\t},\n\t\t/**\n\t\t * Function which will register events\n\t\t */\n\t\tregisterEvents: function () {\n\t\t\tvar thisInstance = this;\n\t\t\tvar container = this.getContainer();\n\n\t\t\tcontainer.on('change', '#searchModuleList', function (e) {\n\t\t\t\tvar selectElement = $(e.currentTarget);\n\t\t\t\tvar selectedModuleName = selectElement.val();\n\t\t\t\tthisInstance.setSearchModule(selectedModuleName);\n\t\t\t\tthisInstance.initiateSearch();\n\t\t\t});\n\n\t\t\t$('#advanceSearchButton').on('click', function (e) {\n\t\t\t\tvar searchModule = thisInstance.getSearchModule();\n\t\t\t\t//If no module is selected\n\t\t\t\tif (searchModule.length <= 0) {\n\t\t\t\t\tapp\n\t\t\t\t\t\t.getChosenElementFromSelect($('#searchModuleList'))\n\t\t\t\t\t\t.validationEngine('showPrompt', app.vtranslate('JS_SELECT_MODULE'), 'error', 'topRight', true);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tthisInstance\n\t\t\t\t\t.performValidation()\n\t\t\t\t\t.done(function () {\n\t\t\t\t\t\tthisInstance.performSearch();\n\t\t\t\t\t})\n\t\t\t\t\t.fail(function () { });\n\t\t\t});\n\n\t\t\t$('#advanceIntiateSave').on('click', function (e) {\n\t\t\t\tvar currentElement = $(e.currentTarget);\n\t\t\t\tcurrentElement.addClass('d-none');\n\t\t\t\tvar actionsContainer = currentElement.closest('.actions');\n\t\t\t\t$('.js-name-filter', actionsContainer)\n\t\t\t\t\t.removeClass('d-none')\n\t\t\t\t\t.focus();\n\t\t\t\t$('#advanceSave').removeClass('d-none');\n\t\t\t});\n\n\t\t\t$('#advanceSave').on('click', function (e) {\n\t\t\t\tvar actionsContainer = $(e.currentTarget).closest('.actions');\n\t\t\t\tvar filterNameField = $('input[name=\"viewname\"]', actionsContainer);\n\t\t\t\tvar value = filterNameField.val();\n\t\t\t\tif (value.length <= 0) {\n\t\t\t\t\tfilterNameField.validationEngine(\n\t\t\t\t\t\t'showPrompt',\n\t\t\t\t\t\tapp.vtranslate('JS_REQUIRED_FIELD'),\n\t\t\t\t\t\t'error',\n\t\t\t\t\t\t'topRight',\n\t\t\t\t\t\ttrue\n\t\t\t\t\t);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvar searchModule = thisInstance.getSearchModule();\n\t\t\t\t//If no module is selected\n\t\t\t\tif (searchModule.length <= 0) {\n\t\t\t\t\tapp\n\t\t\t\t\t\t.getChosenElementFromSelect($('#searchModuleList'))\n\t\t\t\t\t\t.validationEngine('showPrompt', app.vtranslate('JS_SELECT_MODULE'), 'error', 'topRight', true);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthisInstance.performValidation().done(function () {\n\t\t\t\t\tvar params = {};\n\t\t\t\t\tparams.viewname = value;\n\t\t\t\t\tthisInstance.saveAndViewFilter(params);\n\t\t\t\t});\n\t\t\t});\n\n\t\t\t//DO nothing on submit of filter form\n\t\t\tthis.getFilterForm().on('submit', function (e) {\n\t\t\t\te.preventDefault();\n\t\t\t});\n\n\t\t\t//To set the search module with the currently selected values.\n\t\t\tthis.setSearchModule($('#searchModuleList').val());\n\t\t}\n\t}\n);\n"],"names":["Vtiger_BasicSearch_Js","this","elementContainer","container","parentContainer","setMainContainer","$","getContainer","aDeferred","Deferred","searchModule","getSearchModule","Vtiger_AdvanceSearch_Js","cache","resolve","promise","searchableModulesParams","app","getModuleName","getParentModuleName","parent","progressInstance","progressIndicator","request","done","data","hide","fail","error","err","reject","thisInstance","postLoad","uiData","setContainer","filterValidationRegistered","registerEvents","advanceFilter","Vtiger_ConditionBuilder_Js","find","getAdvanceSearch","params","cb","hideModalWindow","showModalWindow","conditionValues","getConditions","module","_search","JSON","stringify","jQhtml","html","source_module","status","advfilterlist","action","success","vtranslate","message","showPnotify","saveFilter","response","url","location","href","modalData","Window","lastModalId","length","isSearchResultsAndFilterShown","isSearchAndFilterComponentsShown","search","detach","showSearchResults","modalBlock","registerShowFiler","showFilter","formValidationDeferred","controlForm","getFilterForm","validationEngine","form","submit","on","e","selectedModuleName","currentTarget","val","setSearchModule","initiateSearch","getChosenElementFromSelect","performValidation","performSearch","currentElement","addClass","actionsContainer","closest","removeClass","focus","filterNameField","value","viewname","saveAndViewFilter","preventDefault"],"mappings":"aAWAA,sBACC,0BACA,OAEQ,IAER,mBAEmB,iBAEH,8BAEa,cAEhB,mBAEK,eAIH,kBACNC,KAAKC,+BAOC,SAAUC,uBAClBD,iBAAmBC,UACjBF,yBAKY,kBACZA,KAAKG,oCAOO,SAAUD,uBACxBE,iBAAiBF,gBACjBC,gBAAkBD,UAChBF,oBAEO,kBACPK,EAAE,iCAAkCL,KAAKM,kCAM/B,eACbC,UAAYF,EAAEG,WACdC,aAAeT,KAAKU,qBAEpBD,gBAAgBE,wBAAwBC,uBACjCC,QAAQF,wBAAwBC,MAAMH,eACzCF,UAAUO,cAEdC,wBAA0B,QACrBC,IAAIC,6BACER,kBACR,iBACA,sBAEHO,IAAIE,gDACiBC,OAASH,IAAIE,2BAElCE,iBAAmBf,EAAEgB,wCACZC,QAAQP,yBACnBQ,MAAK,SAAUC,uBACEC,+BAEOb,MAAMH,cAAgBe,eACpCX,QAAQW,SAElBE,MAAK,SAAUC,MAAOC,eACZC,OAAOF,UAEZpB,UAAUO,0BAKF,eACXP,UAAYF,EAAEG,WACdsB,aAAe9B,KACf+B,SAAW,SAAUC,qBACXC,aAAa5B,EAAE,yCACf6B,4BAA6B,eAC7BC,8BACAC,cAAgB,IAAIC,2BAA2BP,aAAaxB,eAAegC,KAAK,yBAA0BR,aAAapB,gCACvH0B,cAAcD,2BACjBtB,+BAGT0B,mBACAhB,MAAK,SAAUC,UACXgB,OAAS,UACNhB,KAAOA,YACPiB,GAAKV,aACRW,sBACAC,gBAAgBH,WAEpBd,MAAK,SAAUC,iBACLE,YAELtB,UAAUO,kBAKV,eACH8B,gBAAkB5C,KAAKoC,cAAcS,gBACrCC,OAAS9C,KAAKU,yBACXV,KAAK+C,QAAQ,QACX/B,IAAIC,6BACE6B,qBACCE,KAAKC,UAAUL,sCAOb,SAAUpB,UACxBjB,UAAYF,EAAEG,WAUd0C,OAAS7C,EAJZ,yIAKC,gBAAiB6C,QAAQC,KAAK3B,WAEzB0B,WAEHV,OAAS,iBACNhB,KAAOA,YACPiB,GAhBQ,SAAUjB,gBAEdX,QAAQW,WAefmB,gBAAgBH,QAEbjC,UAAUO,sBAKN,SAAU0B,YACjBjC,UAAYF,EAAEG,yBACX4C,cAAgBpD,KAAKU,yBACrB2C,OAAS,SACTC,cAAgBN,KAAKC,UAAUjD,KAAKoC,cAAcS,wBAClDC,OAAS,oBACTS,OAAS,oBACHjC,QAAQkB,QAAQjB,MAAK,SAAUC,UACtCA,KAAKgC,QAAS,KACdhB,OAAS,OACLxB,IAAIyC,WAAW,mBAChBjC,KAAKG,MAAM+B,aACX,0BAEUC,YAAYnB,kBAEpB3B,QAAQW,SAEZjB,UAAUO,6BAKC,SAAU0B,aACvBoB,WAAWpB,QAAQjB,MACvB,SAAUsC,cACLC,IAAMD,SAAA,OAAA,mBACHE,SAASC,KAAOF,OAExB,SAAUnC,6CAMsB,eAC7BsC,UAAY5D,EAAE,IAAM6D,OAAOC,qBACT9D,EAAE,gBAAiB4D,WAAW3B,KAAK,2BACrC8B,QAAU,kBAQhB,eACVtC,aAAe9B,KACfqE,8BAAgCrE,KAAKsE,wCACpCC,SAAShD,MAAK,SAAUC,mBACfS,aAAaH,aAAaxB,eAAekE,uBACzCC,kBAAkBjD,MAAMD,MAAK,SAAUmD,yBACtCC,oBAETN,4CACUO,+BAQL,eACP9C,aAAe9B,SAIf0C,iBAHW,eACVC,gBAAgBb,aAAaxB,sCAQhB,eACdwB,aAAe9B,UACd6E,uBAAyBxE,EAAEG,eAC5BsE,YAAc9E,KAAK+E,uBAUlB/E,KAAKkC,kCACJA,4BAA6B,cACtB8C,iBAAiB,sBAVT,SAAUC,KAAM5B,QAChCA,oBACUwB,uBAAuBhE,uBAEvBgE,uBAAuBhD,yBAW1BqD,SACLlF,KAAK6E,uBAAuB/D,6BAKjB,eACdgB,aAAe9B,OACjB,eAAemF,GAAG,SAAS,SAAUC,gBACzBR,gCAMC,eACX9C,aAAe9B,KACHA,KAAKM,eAEX6E,GAAG,SAAU,qBAAqB,SAAUC,OAEjDC,mBADgBhF,EAAE+E,EAAEE,eACeC,mBAC1BC,gBAAgBH,iCAChBI,sBAGZ,wBAAwBN,GAAG,SAAS,SAAUC,GAC5BtD,aAAapB,kBAEf0D,QAAU,MAExBsB,2BAA2BrF,EAAE,sBAC7B2E,iBAAiB,aAAchE,IAAIyC,WAAW,oBAAqB,QAAS,YAAY,gBAIzFkC,oBACApE,MAAK,wBACQqE,mBAEblE,MAAK,oBAGN,uBAAuByD,GAAG,SAAS,SAAUC,OAC1CS,eAAiBxF,EAAE+E,EAAEE,8BACVQ,SAAS,cACpBC,iBAAmBF,eAAeG,QAAQ,cAC5C,kBAAmBD,kBACnBE,YAAY,UACZC,UACA,gBAAgBD,YAAY,eAG7B,gBAAgBd,GAAG,SAAS,SAAUC,OACnCW,iBAAmB1F,EAAE+E,EAAEE,eAAeU,QAAQ,YAC9CG,gBAAkB9F,EAAE,yBAA0B0F,kBAC9CK,MAAQD,gBAAgBZ,MACxBa,MAAMhC,QAAU,kBACHY,iBACf,aACAhE,IAAIyC,WAAW,qBACf,QACA,YACA,GAKiB3B,aAAapB,kBAEf0D,QAAU,MAExBsB,2BAA2BrF,EAAE,sBAC7B2E,iBAAiB,aAAchE,IAAIyC,WAAW,oBAAqB,QAAS,YAAY,gBAI9EkC,oBAAoBpE,MAAK,eACjCiB,OAAS,UACN6D,SAAWD,mBACLE,kBAAkB9D,mBAK5BuC,gBAAgBI,GAAG,UAAU,SAAUC,KACzCmB,yBAIEf,gBAAgBnF,EAAE,qBAAqBkF"}