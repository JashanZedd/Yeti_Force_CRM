'use strict';

/* {[The file is published on the basis of YetiForce Public License 3.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */

jQuery.Class('Vtiger_TreeCategory_Js', {}, {
	modalContainer: false,
	treeInstance: false,
	treeData: false,
	windowParent: app.getWindowParent(),
	getModalContainer: function getModalContainer() {
		if (this.modalContainer == false) {
			this.modalContainer = jQuery('#modalTreeCategoryModal');
		}
		return this.modalContainer;
	},
	getRecords: function getRecords(container) {
		if (this.treeData == false && container !== 'undefined') {
			var treeValues = container.find('#treePopupValues').val();
			this.treeData = JSON.parse(treeValues);
		}
		return this.treeData;
	},
	generateTree: function generateTree(container) {
		var thisInstance = this;
		if (thisInstance.treeInstance == false) {
			thisInstance.treeInstance = container.find('#treePopupContents');
			var plugins = ['search', 'category'];
			if (thisInstance.getRelationType() == '2') {
				plugins.push('checkbox');
			}
			if (thisInstance.getRelationType() == '1') {
				plugins.push('edit');
			}
			thisInstance.treeInstance.jstree($.extend(true, {
				core: {
					data: thisInstance.getRecords(),
					themes: {
						name: 'proton',
						responsive: true
					}
				},
				checkbox: {
					three_state: false
				},
				plugins: plugins
			}, thisInstance.treeInstance.data('params')));
		}
	},
	getRelationType: function getRelationType() {
		return this.getModalContainer().find('#relationType').val();
	},
	searching: function searching(text) {
		this.treeInstance.jstree(true).search(text);
	},
	registerSearchEvent: function registerSearchEvent() {
		var thisInstance = this;
		var valueSearch = $('#valueSearchTree');
		var btnSearch = $('#btnSearchTree');
		valueSearch.on('keypress', function (e) {
			if (e.which == 13) {
				thisInstance.searching(valueSearch.val());
			}
		});
		btnSearch.on('click', function () {
			thisInstance.searching(valueSearch.val());
		});
	},
	registerSaveRecords: function registerSaveRecords(container) {
		var thisInstance = this;
		var ord = [],
		    ocd = [];
		$.each(thisInstance.getRecords(), function (index, value) {
			if (value.state && value.state.selected && value.attr === 'record') {
				ord.push(value.record_id);
			}
			if (value.category && value.category.checked && value.attr !== 'record') {
				ocd.push(value.record_id);
			}
		});
		container.find('[name="saveButton"]').on('click', function (e) {
			var recordsToAdd = [],
			    categoryToAdd = [],
			    recordsToRemove = Object.assign([], ord),
			    categoryToRemove = Object.assign([], ocd);
			var saveButton = $(this);
			saveButton.attr('disabled', 'disabled');
			var cSelected = thisInstance.treeInstance.jstree('getCategory', true);
			$.each(cSelected, function (index, treeElement) {
				var value = treeElement.record_id;
				if (treeElement.attr === 'record') {
					if (jQuery.inArray(value, recordsToRemove) == -1) {
						recordsToAdd.push(value);
					} else {
						recordsToRemove.splice(recordsToRemove.indexOf(value), 1);
					}
				} else if (treeElement.attr !== 'record') {
					if (jQuery.inArray(value, categoryToRemove) == -1) {
						categoryToAdd.push(value);
					} else {
						categoryToRemove.splice(categoryToRemove.indexOf(value), 1);
					}
				}
			});
			var params = {
				module: thisInstance.windowParent.app.getModuleName(),
				action: 'RelationAjax',
				mode: 'updateRelation',
				recordsToAdd: recordsToAdd,
				recordsToRemove: recordsToRemove,
				categoryToAdd: categoryToAdd,
				categoryToRemove: categoryToRemove,
				src_record: thisInstance.windowParent.app.getRecordId(),
				related_module: container.find('#relatedModule').val()
			};
			if (recordsToAdd.length > 4) {
				bootbox.dialog({
					title: app.vtranslate('JS_INFORMATION'),
					message: app.vtranslate('JS_SAVE_SELECTED_ITEMS_ALERT').replace('__LENGTH__', recordsToAdd.length),
					buttons: {
						success: {
							label: app.vtranslate('JS_LBL_SAVE'),
							className: 'btn-success',
							callback: function callback() {
								thisInstance.saveRecordsEvent(params);
							}
						},
						danger: {
							label: app.vtranslate('JS_LBL_CANCEL'),
							className: 'btn-warning',
							callback: function callback() {
								saveButton.removeAttr('disabled');
							}
						}
					}
				});
			} else {
				thisInstance.saveRecordsEvent(params);
			}
		});
	},
	saveRecordsEvent: function saveRecordsEvent(params) {
		var self = this;
		AppConnector.request(params).done(function (res) {
			self.windowParent.Vtiger_Detail_Js.getInstance().reloadTabContent();
			app.hideModalWindow();
		});
	},
	registerCounterSelected: function registerCounterSelected() {
		var thisInstance = this;
		this.treeInstance.on('changed.jstree', function (e, data) {
			var counterSelected = 0;
			var html = '';
			$.each(thisInstance.treeInstance.jstree('get_selected', true), function (index, value) {
				var id = value.original.record_id.toString();
				if (id.indexOf('T')) {
					counterSelected++;
				}
			});
			html = app.vtranslate('JS_SELECTED_ELEMENTS') + ': ' + counterSelected;
			$('.counterSelected').text(html);
		});
	},
	registerEvents: function registerEvents() {
		var container = this.getModalContainer();
		this.getRecords(container);
		this.generateTree(container);
		this.registerSaveRecords(container);
		this.registerSearchEvent();
		this.registerCounterSelected();
	}
});
jQuery(function () {
	var instance = new Vtiger_TreeCategory_Js();
	instance.registerEvents();
});
//# sourceMappingURL=TreeCategoryModal.min.js.map
