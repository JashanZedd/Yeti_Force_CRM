'use strict';

jQuery.Class('Vtiger_TreeCategory_Js',{},{modalContainer:!1,treeInstance:!1,treeData:!1,windowParent:app.getWindowParent(),getModalContainer:function getModalContainer(){return !1==this.modalContainer&&(this.modalContainer=jQuery('#modalTreeCategoryModal')),this.modalContainer},getRecords:function getRecords(container){if(!1==this.treeData&&'undefined'!==container){var treeValues=container.find('#treePopupValues').val();this.treeData=JSON.parse(treeValues);}return this.treeData},generateTree:function generateTree(container){var thisInstance=this;if(!1==thisInstance.treeInstance){thisInstance.treeInstance=container.find('#treePopupContents');var plugins=['search'];thisInstance.isActiveCategory()&&plugins.push('category'),'2'==thisInstance.getRelationType()&&plugins.push('checkbox'),'1'==thisInstance.getRelationType()&&plugins.push('edit'),thisInstance.treeInstance.jstree($.extend(!0,{core:{data:thisInstance.getRecords(),themes:{name:'proton',responsive:!0}},checkbox:{three_state:!1},plugins:plugins},thisInstance.treeInstance.data('params')));}},isActiveCategory:function isActiveCategory(){return '1'==this.getModalContainer().find('#isActiveCategory').val()},getRelationType:function getRelationType(){return this.getModalContainer().find('#relationType').val()},searching:function searching(text){this.treeInstance.jstree(!0).search(text);},registerSearchEvent:function registerSearchEvent(){var thisInstance=this,valueSearch=$('#valueSearchTree'),btnSearch=$('#btnSearchTree');valueSearch.on('keypress',function(e){13==e.which&&thisInstance.searching(valueSearch.val());}),btnSearch.on('click',function(){thisInstance.searching(valueSearch.val());});},registerSaveRecords:function registerSaveRecords(container){var thisInstance=this,ord=[],ocd=[];$.each(thisInstance.getRecords(),function(index,value){value.state&&value.state.selected&&'record'==value.type&&ord.push(value.record_id),value.category&&value.category.checked&&ocd.push(value.record_id);}),container.find('[name="saveButton"]').on('click',function(){var rSelected=[],cSelected=[],recordsToAdd=[],recordsToRemove=[],categoryToAdd=[],categoryToRemove=[],saveButton=$(this);saveButton.attr('disabled','disabled'),$.each(thisInstance.treeInstance.jstree('get_selected',!0),function(index,value){-1==jQuery.inArray(value.original.record_id,ord)&&'record'==value.original.type&&recordsToAdd.push(value.original.record_id),rSelected.push(value.original.record_id);}),$.each(ord,function(index,value){-1==jQuery.inArray(value,rSelected)&&recordsToRemove.push(value);}),thisInstance.isActiveCategory()&&(cSelected=thisInstance.treeInstance.jstree('getCategory'),$.each(cSelected,function(index,value){-1==jQuery.inArray(value,ocd)&&categoryToAdd.push(value);}),$.each(ocd,function(index,value){-1==jQuery.inArray(value,cSelected)&&categoryToRemove.push(value);}));var params={module:thisInstance.windowParent.app.getModuleName(),action:'RelationAjax',mode:'updateRelation',recordsToAdd:recordsToAdd,recordsToRemove:recordsToRemove,categoryToAdd:categoryToAdd,categoryToRemove:categoryToRemove,src_record:thisInstance.windowParent.app.getRecordId(),related_module:container.find('#relatedModule').val()};4<recordsToAdd.length?bootbox.dialog({title:app.vtranslate('JS_INFORMATION'),message:app.vtranslate('JS_SAVE_SELECTED_ITEMS_ALERT').replace('__LENGTH__',recordsToAdd.length),buttons:{success:{label:app.vtranslate('JS_LBL_SAVE'),className:'btn-success',callback:function callback(){thisInstance.saveRecordsEvent(params);}},danger:{label:app.vtranslate('JS_LBL_CANCEL'),className:'btn-warning',callback:function callback(){saveButton.removeAttr('disabled');}}}}):thisInstance.saveRecordsEvent(params);});},saveRecordsEvent:function saveRecordsEvent(params){var self=this;AppConnector.request(params).done(function(){self.windowParent.Vtiger_Detail_Js.getInstance().reloadTabContent(),app.hideModalWindow();});},registerCounterSelected:function registerCounterSelected(){var thisInstance=this;this.treeInstance.on('changed.jstree',function(){var counterSelected=0,html='';$.each(thisInstance.treeInstance.jstree('get_selected',!0),function(index,value){var id=value.original.record_id.toString();id.indexOf('T')&&counterSelected++;}),html=app.vtranslate('JS_SELECTED_ELEMENTS')+': '+counterSelected,$('.counterSelected').text(html);});},registerEvents:function registerEvents(){var container=this.getModalContainer();this.getRecords(container),this.generateTree(container),this.registerSaveRecords(container),this.registerSearchEvent(),this.registerCounterSelected();}}),jQuery(function(){var instance=new Vtiger_TreeCategory_Js;instance.registerEvents();});
//# sourceMappingURL=TreeCategoryModal.min.js.map
