
jQuery.Class("Settings_WidgetsManagement_Js",{},{widgetWithFilterUsers:[],setWidgetWithFilterUsers:function(){var b=this;var a=jQuery('[name="filter_users"]').val();if(a){b.widgetWithFilterUsers=JSON.parse(a)}else{b.widgetWithFilterUsers=[]}},getAuthorization:function(){var b=this;var a=new Array();continer=jQuery("#moduleBlocks");continer.find(".editFieldsTable").each(function(){a.push(jQuery(this).data("code"))});return a},getAllFieldsInBlock:function(c){var b=this;var a=new Array();c.find(".blockFieldsList .editFieldsWidget").each(function(){a.push(jQuery(this).data("linkid").toString())});return a},registerAddBlockDashBoard:function(){var b=this;var a=jQuery("#layoutDashBoards");a.find(".addBlockDashBoard").click(function(g){var f=a.find(".addBlockDashBoardModal").clone(true,true);var d=b.getAuthorization();f.find("select.authorized option").each(function(){if(jQuery.inArray(jQuery(this).val(),d)!=-1){jQuery(this).remove()}});var c=function(h){app.changeSelectElementView(h.find("select"));var e=h.find(".addBlockDashBoardForm");var j=app.validationEngineOptions;var i=e.find('[name="authorized"]');j.onValidationComplete=function(m,l){if(l){if(i.val()){paramsForm=m.serializeFormData();paramsForm.action="addBlock";var n=[];n.authorized=i.val();n.label=i.find(":selected").text();b.save(paramsForm,"save").then(function(o){var p={};response=o.result;if(response.success){n.id=response.id;b.displayNewCustomBlock(n);app.hideModalWindow();p.text=app.vtranslate("JS_BLOCK_ADDED")}else{p.text=response.message;p.type="error"}Settings_Vtiger_Index_Js.showMessage(p)});return l}else{var k=app.vtranslate("JS_FIELD_EMPTY");i.prev("div").validationEngine("showPrompt",k,"error","bottomLeft",true);g.preventDefault();return}}};e.validationEngine(j);e.submit(function(k){k.preventDefault()})};app.showModalWindow(f,function(e){if(typeof c=="function"){c(e)}},{width:"1000px"})})},save:function(c,f){var b=this;var a=jQuery.Deferred();var d=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var e={};e.form=c;e.module=app.getModuleName();e.parent=app.getParentModuleName();e.sourceModule=jQuery("#selectedModuleName").val();e.action="SaveAjax";e.mode=f;AppConnector.request(e).then(function(g){d.progressIndicator({mode:"hide"});a.resolve(g)},function(g){d.progressIndicator({mode:"hide"});a.reject(g)});return a.promise()},displayNewCustomBlock:function(a){var d=this;var c=jQuery("#layoutDashBoards");var b=c.find(".newCustomBlockCopy").clone(true,true);b.data("block-id",a.id).find(".blockLabel span").append(jQuery("<strong>"+a.label+"</strong>"));b.find(".addCustomField").removeClass("hide").show();b.find(".specialWidget").data("block-id",a.id);c.find("#moduleBlocks").append(b.removeClass("newCustomBlockCopy hide").addClass("editFieldsTable block_"+a.id).data("code",a.authorized))},addClickOutSideEvent:function(b,a){b.one("clickoutside",a)},registerAddCustomFieldEvent:function(){var b=this;var a=jQuery("#layoutDashBoards");a.find(".addCustomField").click(function(g){var h=jQuery(g.currentTarget).closest(".editFieldsTable");var c=h.data("block-id");var j=a.find(".createFieldModal").clone(true,true);var i=b.getAllFieldsInBlock(h);var f=j.find("select.widgets");f.find("option").each(function(){if(jQuery.inArray(jQuery(this).val(),i)!=-1){jQuery(this).remove()}});if(jQuery.inArray(f.find(":first-child").data("name"),b.widgetWithFilterUsers)!=-1){j.find(".widgetFilter").removeClass("hide").find("select").removeAttr("disabled").show()}var d=function(l){app.changeSelectElementView(l.find("select"),"select2");var n=l.find(".widgetFilter");l.find("select.widgets").on("change",function(){if(jQuery.inArray(jQuery(this).find(":selected").data("name"),b.widgetWithFilterUsers)!=-1){n.removeClass("hide").find("select").prop("disabled",false)}else{n.addClass("hide").find("select").prop("disabled",true)}});var k=l.find(".createCustomFieldForm");k.attr("id","createFieldForm");var e=k.find('[name="widgets"]');var m=app.validationEngineOptions;m.onValidationComplete=function(q,p){if(p){if(e.val()){var r=q.find(":submit");r.attr("disabled","disabled");var s=q.find('[name="widgets"]');paramsForm=q.serializeFormData();paramsForm.action="addWidget";paramsForm.blockid=c;paramsForm.linkid=s.val();paramsForm.label=s.find(":selected").text();paramsForm.name=s.find(":selected").data("name");paramsForm.height=q.find('[name="height"]').val();paramsForm.width=q.find('[name="width"]').val();if(q.find('[name="isdefault"]').prop("checked")){paramsForm.isdefault=1}if(paramsForm.default_owner&&typeof paramsForm.owners_all=="undefined"){var o=app.vtranslate("JS_FIELD_EMPTY");q.find('select[name="owners_all"]').prev("div").validationEngine("showPrompt",o,"error","bottomLeft",true);r.removeAttr("disabled");g.preventDefault();return false}b.save(paramsForm,"save").then(function(w){var t=w.result;var x={};if(w.success){app.hideModalWindow();paramsForm.id=t.id;paramsForm.status=t.status;x.text=app.vtranslate("JS_WIDGET_ADDED");Settings_Vtiger_Index_Js.showMessage(x);b.showCustomField(paramsForm)}else{var v=w.error["message"];if(w.error["code"]!=513){var u=q.find('[name="fieldName"]')}else{var u=q.find('[name="fieldLabel"]')}u.validationEngine("showPrompt",v,"error","topLeft",true);r.removeAttr("disabled")}})}else{var o=app.vtranslate("JS_FIELD_EMPTY");e.prev("div").validationEngine("showPrompt",o,"error","topLeft",true);g.preventDefault();return}}return false};k.validationEngine(m)};app.showModalWindow(j,function(e){if(typeof d=="function"){d(e)}},{width:"1000px"})})},showCustomField:function(l){var j=this;var d=jQuery("#layoutDashBoards");var i=d.find(".block_"+l.blockid);var k=d.find(".newCustomFieldCopy").clone(true,true);var h=k.find("div.marginLeftZero.border1px");h.addClass("opacity editFieldsWidget").attr("data-field-id",l.id).attr("data-block-id",l.blockid).attr("data-linkid",l.linkid);h.find(".deleteCustomField, .saveFieldDetails").attr("data-field-id",l.id);h.find(".fieldLabel").html(l.label);if(!l.status){h.find('input[name="limit"]').closest("div").remove()}if(typeof l.default_owner!="undefined"){h.find(".widgetFilterAll").removeClass("hide").show()}var f=i.find(".blockFieldsList");var g=f.find("ul[name=sortable1]");var c=g.children().length;var e=f.find("ul[name=sortable2]");var b=e.children().length;if(c>b){e.append(k.removeClass("hide newCustomFieldCopy"))}else{g.append(k.removeClass("hide newCustomFieldCopy"))}var a=k.find("form.fieldDetailsForm");j.setFieldDetails(l,a)},setFieldDetails:function(a,e){var d=this;e.find(".modal-header").html(jQuery("<strong>"+a.label+'</strong><div class="pull-right"><a href="javascript:void(0)" class="cancel">X</a></div>'));if(a.isdefault){e.find('[name="isdefault"]').filter(":checkbox").attr("checked",true)}if(a.width){e.find('select[name="width"]').find("option").removeAttr("selected");e.find('select[name="width"]').find('option[value="'+a.width+'"]').attr("selected","selected")}if(a.height){e.find('select[name="height"]').find("option").removeAttr("selected");e.find('select[name="height"]').find('option[value="'+a.height+'"]').attr("selected","selected")}if(a.default_owner){e.find('select[name="default_owner"]').find("option").removeAttr("selected");e.find('select[name="default_owner"]').find('option[value="'+a.default_owner+'"]').attr("selected","selected")}if(a.owners_all){e.find('select[name="owners_all"]').find("option").removeAttr("selected");var f=a.owners_all;if(typeof(f)!="string"){for(var c=0;c<f.length;c++){var b=f[c].replace(/"/g,'\\"');e.find('select[name="owners_all"]').find('option[value="'+b+'"]').attr("selected","selected")}}else{e.find('select[name="owners_all"]').find('option[value="'+f+'"]').attr("selected","selected")}}},registerEditFieldDetailsClick:function(){var a=this;contents=jQuery("#layoutDashBoards");contents.find(".editFieldDetails").click(function(o){var d=jQuery(o.currentTarget);var f=d.closest("div.editFieldsWidget");f.removeClass("opacity");var k=f.find(".basicFieldOperations");var r=d.closest(".btn-group");r.find(".dropdown-menu").remove();var i=k.clone().removeClass("basicFieldOperations hide").addClass("dropdown-menu");r.append(i);var c=r.find(".dropdown-menu");var h=app.getvalidationEngineOptions(true);h.binded=false,h.onValidationComplete=function(s,e){if(e){paramsForm=s.serializeFormData();if(s.find('[name="isdefault"]').prop("checked")){paramsForm.isdefault=1}var u=s.find(".saveFieldDetails").data("field-id");paramsForm.action="saveDetails";paramsForm.id=u;if(paramsForm.default_owner&&typeof paramsForm.owners_all=="undefined"){var t={};t.type="error";t.text=app.vtranslate("JS_FILTERS_AVAILABLE")+": "+app.vtranslate("JS_FIELD_EMPTY");Settings_Vtiger_Index_Js.showMessage(t);o.preventDefault();return false}a.save(paramsForm,"save");a.registerSaveFieldDetailsEvent(s)}return false};c.find("form").validationEngine(h);var n=k.find('select[name="owners_all"]');if(n.length>0){users=c.find('select[name="owners_all"]');users.addClass("chzn-select");app.changeSelectElementView(users)}a.avoidDropDownClick(r);c.on("change",":checkbox",function(u){var t=jQuery(u.currentTarget);if(t.attr("readonly")=="readonly"){var s=jQuery(u.currentTarget).is(":checked");if(!s){jQuery(u.currentTarget).attr("checked","checked")}else{jQuery(u.currentTarget).removeAttr("checked")}u.preventDefault()}});var j=d.offset(),q=d.outerHeight(),g=i.outerHeight(),m=$(window).scrollTop()+document.documentElement.clientHeight,b=j.top+q,p=b+g<=m;if(!p){i.addClass("bottom-up")}else{i.removeClass("bottom-up")}var l=function(){f.addClass("opacity");i.remove()};a.addClickOutSideEvent(i,l);jQuery(".cancel").click(function(){l()})})},registerSaveFieldDetailsEvent:function(a){var i=this;var e=a.find(".saveFieldDetails");var h=e.data("field-id");var g=e.closest(".editFieldsTable");var d=g.data("block-id");e.closest(".btn-group").removeClass("open");var c=e.closest(".editFieldsWidget");c.addClass("opacity");var b=a.closest(".dropdown-menu");app.destroyChosenElement(a);a.find("select").each(function(){var l=jQuery(this).val();jQuery(this).find("option").removeAttr("selected");if(typeof(jQuery(this).attr("multiple"))=="undefined"){var j=l.replace(/"/g,'\\"');jQuery(this).find('[value="'+j+'"]').attr("selected","selected")}else{for(var k=0;k<l.length;k++){var j=l[k].replace(/"/g,'\\"');jQuery(this).find('[value="'+j+'"]').attr("selected","selected")}}});var f=a.closest(".editFieldsWidget").find(".basicFieldOperations");f.html(a);b.remove()},avoidDropDownClick:function(a){a.find(".dropdown-menu").click(function(b){b.stopPropagation()})},registerSpecialWidget:function(){var a=this;jQuery("#layoutDashBoards").find(".addNotebook").click(function(b){a.addNoteBookWidget(this,jQuery(this).data("url"))});jQuery("#layoutDashBoards").find(".addMiniList").click(function(b){a.addMiniListWidget(this,jQuery(this).data("url"))})},addNoteBookWidget:function(b,a){var c=this;b=jQuery(b);app.showModalWindow(null,"index.php?module=Home&view=AddNotePad",function(e){var d=jQuery("form",e);var f=app.validationEngineOptions;f.onValidationComplete=function(k,j){if(j){jQuery("[name='saveButton']",e).attr("disabled","disabled");var h=k.find('[name="notePadName"]').val();var n=k.find('[name="notePadContent"]').val();var l=0;var m=b.data("linkid");var g=b.data("block-id");var i={module:"Vtiger",action:"NoteBook",mode:"NoteBookCreate",notePadName:h,notePadContent:n,blockid:g,linkId:m,isdefault:l,width:4,height:3};AppConnector.request(i).then(function(p){if(p.result.success){var o=p.result.widgetId;app.hideModalWindow();i.id=o;i.label=h;f.text=app.vtranslate("JS_WIDGET_ADDED");Settings_Vtiger_Index_Js.showMessage(f);c.showCustomField(i)}})}return false};d.validationEngine(f)})},addMiniListWidget:function(c,b){var d=this;c=jQuery(c);app.showModalWindow(null,"index.php?module=Home&view=MiniListWizard&step=step1",function(i){var e=jQuery("form",i);var f=jQuery('select[name="module"]',i);var g=jQuery('select[name="filterid"]',i);var m=jQuery('select[name="fields"]',i);var l=app.showSelect2ElementView(f,{placeholder:app.vtranslate("JS_SELECT_MODULE")});var h=app.showSelect2ElementView(g,{placeholder:app.vtranslate("JS_PLEASE_SELECT_ATLEAST_ONE_OPTION")});var k=app.showSelect2ElementView(m,{placeholder:app.vtranslate("JS_PLEASE_SELECT_ATLEAST_ONE_OPTION"),closeOnSelect:true,maximumSelectionLength:6});var j=jQuery(".modal-footer",i);g.closest("tr").hide();m.closest("tr").hide();j.hide();l.change(function(){if(!l.val()){return}AppConnector.request({module:"Home",view:"MiniListWizard",step:"step2",selectedModule:l.val()}).then(function(n){g.empty().html(n).trigger("change");h.closest("tr").show()})});h.change(function(){if(!h.val()){return}AppConnector.request({module:"Home",view:"MiniListWizard",step:"step3",selectedModule:l.val(),filterid:h.val()}).then(function(n){m.empty().html(n).trigger("change");k.closest("tr").show()})});k.change(function(){if(!k.val()){j.hide()}else{j.show()}});e.submit(function(s){s.preventDefault();var q=l.val();var p=l.find(":selected").text();var r=h.val();var o=h.find(":selected").text();var n=[];k.select2("data").map(function(t){n.push(t.id)});a(q,p,r,o,n)})});function a(g,h,f,i,e){var k={module:g};if(typeof e!="object"){e=[e]}k.fields=e;var j={};j.data=JSON.stringify(k);j.action="addWidget";j.blockid=c.data("block-id");j.linkid=c.data("linkid");j.label=h+" - "+i;j.name="Mini List";j.filterid=f;j.isdefault=0;j.height=3;j.width=4;j.owners_all=["mine","all","users","groups"];j.default_owner="mine";d.save(j,"save").then(function(o){var l=o.result;var p={};if(o.success){app.hideModalWindow();j.id=l.id;j.status=l.status;p.text=app.vtranslate("JS_WIDGET_ADDED");Settings_Vtiger_Index_Js.showMessage(p);d.showCustomField(j)}else{var n=o.error["message"];if(o.error["code"]!=513){var m=form.find('[name="fieldName"]')}else{var m=form.find('[name="fieldLabel"]')}m.validationEngine("showPrompt",n,"error","topLeft",true)}})}},registerDeleteCustomFieldEvent:function(b){var a=this;if(typeof b=="undefined"){b=jQuery("#layoutDashBoards")}b.find("a.deleteCustomField").click(function(h){var g=jQuery(h.currentTarget);var c=g.data("field-id");var f={};f.action="removeWidget";f.id=c;var d=app.vtranslate("JS_LBL_ARE_YOU_SURE_YOU_WANT_TO_DELETE");Vtiger_Helper_Js.showConfirmationBox({message:d}).then(function(i){a.save(f,"delete").then(function(j){var k=g.closest("div.editFieldsWidget");var e=k.data("block-id");k.parent().fadeOut("slow").remove();var m=jQuery("#block_"+e);a.reArrangeBlockFields(m);var l={};l.text=app.vtranslate("JS_CUSTOM_FIELD_DELETED");Settings_Vtiger_Index_Js.showMessage(l)},function(e,j){})},function(e,i){})})},reArrangeBlockFields:function(e){var a=e.find("ul[name=sortable1]");var c=e.find("ul[name=sortable2]");if(a.children().length<c.children().length){var b=c.children(":last");a.append(b)}else{if(a.children().length>c.children().length+1){var d=a.children(":last");c.append(d)}}},registerDeleteCustomBlockEvent:function(){var c=this;var b=jQuery("#layoutDashBoards");var a=b.find(".editFieldsTable");b.on("click",".deleteCustomBlock",function(j){var i=jQuery(j.currentTarget);var h=i.closest("div.editFieldsTable");var f=h.data("block-id");var d={};d.blockid=f;d.action="removeBlock";var g=app.vtranslate("JS_LBL_ARE_YOU_SURE_YOU_WANT_TO_DELETE");Vtiger_Helper_Js.showConfirmationBox({message:g}).then(function(k){c.save(d,"delete").then(function(e){c.removeDeletedBlock(f,"delete");var l={};l.text=app.vtranslate("JS_CUSTOM_BLOCK_DELETED");Settings_Vtiger_Index_Js.showMessage(l)},function(e,l){})},function(e,k){})})},removeDeletedBlock:function(a){var b=jQuery("#layoutDashBoards");var c=b.find(".block_"+a);c.fadeOut("slow").remove()},registerModulesChangeEvent:function(){var b=this;var a=jQuery("#widgetsManagementEditorContainer");var c=a.closest(".contentsDiv");app.changeSelectElementView(a.find('[name="widgetsManagementEditorModules"]'),{dropdownCss:{"z-index":0}});a.on("change",'[name="widgetsManagementEditorModules"]',function(g){var f=jQuery(g.currentTarget);var d=f.val();b.getModuleLayoutEditor(d).then(function(e){c.html(e);b.registerEvents()})})},getModuleLayoutEditor:function(b){var c=this;var a=jQuery.Deferred();var d=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var e={};e.module=app.getModuleName();e.parent=app.getParentModuleName();e.view="Configuration";e.sourceModule=b;AppConnector.requestPjax(e).then(function(f){d.progressIndicator({mode:"hide"});a.resolve(f)},function(f){d.progressIndicator({mode:"hide"});a.reject()});return a.promise()},registerEvents:function(){var a=this;a.registerAddBlockDashBoard();a.registerAddCustomFieldEvent();a.registerEditFieldDetailsClick();a.registerSpecialWidget();a.registerDeleteCustomFieldEvent();a.registerDeleteCustomBlockEvent();a.registerModulesChangeEvent();a.setWidgetWithFilterUsers()}});jQuery(document).ready(function(){var a=new Settings_WidgetsManagement_Js();a.registerEvents()});