
jQuery.Class("Vtiger_AdvanceFilter_Js",{getInstance:function(b){var d=app.getModuleName();var c=d+"_AdvanceFilter_Js";var e="Vtiger_AdvanceFilter_Js";if(typeof window[c]!="undefined"){var a=new window[c](b)}else{a=new window[e](b)}return a}},{filterContainer:false,fieldTypeConditionMapping:false,conditonOperatorLabelMapping:false,dateConditionInfo:false,fieldModelInstance:false,validationSupportedFieldConditionMap:{email:["e","n"]},allConditionValidationNeededFieldList:["double","integer","currency"],validationForControlsRegistered:false,init:function(a){if(typeof a=="undefined"){a=jQuery(".filterContainer")}if(a.is(".filterContainer")){this.setFilterContainer(a)}else{this.setFilterContainer(jQuery(".filterContainer",a))}this.initialize()},getModuleName:function(){return"AdvanceFilter"},initialize:function(){this.registerEvents();this.initializeOperationMappingDetails();this.loadFieldSpecificUiForAll()},initializeOperationMappingDetails:function(){var a=this.getFilterContainer();this.fieldTypeConditionMapping=jQuery('input[name="advanceFilterOpsByFieldType"]',a).data("value");this.conditonOperatorLabelMapping=jQuery('input[name="advanceFilterOptions"]',a).data("value");this.dateConditionInfo=jQuery('[name="date_filters"]').data("value");return this},getFilterContainer:function(){return this.filterContainer},setFilterContainer:function(a){this.filterContainer=a;return this},getDateSpecificConditionInfo:function(){return this.dateConditionInfo},getConditionListFromType:function(a){var b=this.fieldTypeConditionMapping[a];if(a=="D"||a=="DT"){b=b.concat(this.getDateConditions(a))}return b},getDateConditions:function(a){if(a!="D"&&a!="DT"){return new Array()}var c=this.getFilterContainer();var b=this.getDateSpecificConditionInfo();return Object.keys(b)},getConditionLabel:function(a){if(a in this.conditonOperatorLabelMapping){return this.conditonOperatorLabelMapping[a]}if(a in this.getDateSpecificConditionInfo()){return this.getDateSpecificConditionInfo()[a]["label"]}return a},isEmptyFieldSelected:function(a){var b=a.find("option:selected");if(b.val()=="none"){return true}return false},getAddConditionElement:function(){var a=this.getFilterContainer();return jQuery(".addCondition button",a)},addNewCondition:function(d){var c=jQuery(".basic",d);var a=c.find(".conditionRow").clone(true,true);jQuery("select",a).addClass("chzn-select");var b=jQuery(".conditionList",d);b.append(a);app.changeSelectElementView(a);return this},addConditionHandler:function(c){var b=jQuery(c.currentTarget);var a=b.closest("div.conditionGroup");this.addNewCondition(a)},getFieldSpecificType:function(c){var a=c.data("fieldinfo");var b=a.type;if(b=="reference"){return"V"}return c.data("fieldtype")},loadConditions:function(c){var m=c.closest("div.conditionRow");var d=m.find('select[name="comparator"]');var b=d.val();var g=c.find("option:selected");var e=this.getFieldSpecificType(g);var f=this.getConditionListFromType(e);var k=g.data("field-name");var a=g.data("fieldinfo");if(typeof f=="undefined"){f={};f.none="None"}var l="";for(var j in f){if(jQuery.inArray(a.type,["owner","picklist","multipicklist"])!=-1&&jQuery.inArray(f[j],["s","ew","c","k"])!=-1){continue}if(f.hasOwnProperty(j)&&!(f[j]=="om"&&k!="assigned_user_id")){var i=f[j];var h=this.getConditionLabel(i);l+='<option value="'+i+'"';if(i==b){l+=' selected="selected" '}l+=">"+h+"</option>"}}d.empty().html(l).trigger("chosen:updated");return d},getFieldSpecificUi:function(a){var f=a.find("option:selected");var b=this.fieldModelInstance;if(b.getType().toLowerCase()=="boolean"){var e=a.closest(".conditionRow");var d=e.find('[data-value="value"]').val();var c='<select class="chzn-select" name="'+b.getName()+'">';c+='<option value="0"';if(d=="0"){c+=' selected="selected" '}c+=">"+app.vtranslate("JS_IS_DISABLED")+"</option>";c+='<option value="1"';if(d=="1"){c+=' selected="selected" '}c+=">"+app.vtranslate("JS_IS_ENABLED")+"</option>";c+="</select>";return jQuery(c)}else{return jQuery(b.getUiTypeSpecificHtml())}},loadFieldSpecificUi:function(b){var g=b.find("option:selected");var q=b.closest("div.conditionRow");var o=q.find(".fieldUiHolder");var e=q.find('select[name="comparator"]');var a=g.data("fieldinfo");var i="string";if(typeof a!="undefined"){i=a.type}var h=a.comparatorElementVal=e.val();if(i=="date"||i=="datetime"){a.dateSpecificConditions=this.getDateSpecificConditionInfo()}var c=this.getModuleName();var l=Vtiger_Field_Js.getInstance(a,c);this.fieldModelInstance=l;var k=this.getFieldSpecificUi(b);var n=l.getName();if(l.getType()=="multipicklist"){n=n+"[]"}if((l.getType()=="picklist"||l.getType()=="owner")&&k.is("select")&&(h=="e"||h=="n")){n=n+"[]"}if(k.find(".input-group-addon").length>0){k.find(".input-group").addClass("row");k.find(".input-group").addClass("row");k.find('input[type="text"]').css("width","100%");k.find('input[type="text"]').addClass("form-control")}else{k.filter('[name="'+n+'"]').addClass("form-control");k.find('[name="'+n+'"]').addClass("row form")}k.filter('[name="'+n+'"]').attr("data-value","value").removeAttr("data-validation-engine");k.find('[name="'+n+'"]').attr("data-value","value").removeAttr("data-validation-engine");if(l.getType()=="currency"){k.filter('[name="'+n+'"]').attr("data-decimal-seperator",a.decimal_seperator).attr("data-group-seperator",a.group_seperator);k.find('[name="'+n+'"]').attr("data-decimal-seperator",a.decimal_seperator).attr("data-group-seperator",a.group_seperator)}o.html(k);if(k.is("input.select2")){var p=k.data("tags");var f={tags:p,tokenSeparators:[","]};app.showSelect2ElementView(k,f)}else{if(k.is("select")){if(k.hasClass("chzn-select")){app.changeSelectElementView(k)}else{app.showSelect2ElementView(k)}}else{if(k.has("input.dateField").length>0){var j=k.find(".dateField").data("calendarType");if(j=="range"){var d={calendars:3,mode:"range",className:"rangeCalendar",onChange:function(r){k.find(".dateField").val(r.join(","))}};app.registerEventForDatePickerFields(k,false,d)}else{app.registerEventForDatePickerFields(k)}}else{if(k.has("input.timepicker-default").length>0){app.registerEventForTimeFields(k)}}}}this.addValidationToFieldIfNeeded(b);var m=["y","today","tomorrow","yesterday","ny","om"];if(m.indexOf(e.val())!=-1){o.hide()}else{o.show()}return this},loadFieldSpecificUiForAll:function(){var b=jQuery(".conditionList");var a=jQuery('select[name="columnname"]',b);jQuery.each(a,function(d,e){var c=jQuery(e);if(c.val()!="none"){c.trigger("change",{_intialize:true})}});return this},addValidationToFieldIfNeeded:function(e){var c=e.find("option:selected");var d=e.closest("div.conditionRow");var a=d.find('[data-value="value"]');var b=c.attr("data-validator");if(this.isFieldSupportsValidation(e)){a.addClass("validate[funcCall[Vtiger_Base_Validator_Js.invokeValidation]]").attr("data-validation-engine","validate[funcCall[Vtiger_Base_Validator_Js.invokeValidation]]").attr("data-fieldinfo",JSON.stringify(c.data("fieldinfo")));if(typeof b!="undefined"){a.attr("data-validator",b)}}else{a.removeClass("validate[funcCall[Vtiger_Base_Validator_Js.invokeValidation]]").removeAttr("data-validation-engine").removeAttr("data-fieldinfo")}return this},isFieldSupportsValidation:function(c){var f=c.find("option:selected");var b=this.fieldModelInstance;var e=b.getType();if(jQuery.inArray(e,this.allConditionValidationNeededFieldList)>=0){return true}var g=c.closest("div.conditionRow");var a=g.find('select[name="comparator"]');var d=a.find("option:selected");var h=a.val();if(e in this.validationSupportedFieldConditionMap){if(jQuery.inArray(h,this.validationSupportedFieldConditionMap[e])>=0){return true}}return false},getValues:function(){var d=this;var e=this.getFilterContainer();var b=new Array("columnname","comparator","value","column_condition");var a={};var c=0;var f=jQuery(".conditionGroup",e);f.each(function(g,j){var h=jQuery(j);a[g+1]={};var i=jQuery(".conditionList .conditionRow",h);a[g+1]["columns"]={};i.each(function(q,t){var p=jQuery(t);var k=jQuery('[name="columnname"]',p);var n=jQuery('[data-value="value"]',p);if(d.isEmptyFieldSelected(k)){return true}var o=k.find("option:selected").data("fieldinfo");var r=o.type;var A={};if(r=="owner"){for(var z in b){var v=b[z];if(v=="value"&&n.is("select")){var m=n.find("option:selected");var s=[];jQuery.each(m,function(B,C){s.push(jQuery.trim(jQuery(C).text()))});if(m.length==0){A[v]=""}else{A[v]=s.join(",")}}else{if(v=="value"&&n.is("input")){A[v]=n.val()}else{A[v]=jQuery('[name="'+v+'"]',p).val()}}}}else{if(r=="picklist"||r=="multipicklist"){for(var z in b){var v=b[z];if(v=="value"&&n.is("input")){var y=n.val();var u=n.data("picklistvalues");var x=y.split(",");var s=[];for(q=0;q<x.length;q++){if(typeof u[x[q]]!="undefined"){s.push(u[x[q]])}else{s.push(x[q])}}var l=s.join(",");A[v]=l}else{if(v=="value"&&n.is("select")&&r=="picklist"){var w=n.val();if(w==null){A[v]=w}else{A[v]=w.join(",")}}else{if(v=="value"&&n.is("select")&&r=="multipicklist"){var w=n.val();if(w==null){A[v]=w}else{A[v]=w.join(",")}}else{A[v]=jQuery('[name="'+v+'"]',p).val()}}}}}else{for(var z in b){var v=b[z];if(v=="value"){A[v]=n.val()}else{A[v]=jQuery('[name="'+v+'"]',p).val()}}}}if(p.is(":last-child")){A.column_condition=""}a[g+1]["columns"][c]=A;c++});if(h.find("div.groupCondition").length>0){a[g+1]["condition"]=f.find('div.groupCondition [name="condition"]').val()}});return a},deleteConditionHandler:function(b){var a=jQuery(b.currentTarget);var c=a.closest(".conditionRow");c.remove()},registerAddCondition:function(){var a=this;this.getAddConditionElement().on("click",function(b){a.addConditionHandler(b)})},registerFieldChange:function(){var b=this.getFilterContainer();var a=this;b.on("change",'select[name="columnname"]',function(g,f){var d=jQuery(g.currentTarget);if(typeof f=="undefined"||f._intialize!=true){var h=d.closest("div.conditionRow");var c=h.find('select[name="comparator"]');c.empty()}a.loadConditions(d);a.loadFieldSpecificUi(d)})},registerConditionChange:function(){var b=this.getFilterContainer();var a=this;b.on("change",'select[name="comparator"]',function(g){var d=jQuery(g.currentTarget);var h=d.closest("div.conditionRow");var c=h.find('select[name="columnname"]');var f=c.find("option:selected");a.loadFieldSpecificUi(c);a.addValidationToFieldIfNeeded(c)})},registerDeleteCondition:function(){var a=this;var b=this.getFilterContainer();b.on("click",".deleteCondition",function(c){a.deleteConditionHandler(c)})},registerEvents:function(){this.registerAddCondition();this.registerFieldChange();this.registerDeleteCondition();this.registerConditionChange()}});Vtiger_Field_Js("AdvanceFilter_Field_Js",{},{getUiTypeSpecificHtml:function(){var a=this.getUiTypeModel();return a.getUi()},getModuleName:function(){var a=app.getModuleName();var b=this.getType();if(b=="picklist"||b=="multipicklist"||b=="owner"||b=="date"||b=="datetime"){a="AdvanceFilter"}return a}});Vtiger_Picklist_Field_Js("AdvanceFilter_Picklist_Field_Js",{},{getUi:function(){var i=this.get("comparatorElementVal");if(i=="e"||i=="n"){var h='<select class="select2 row" multiple name="'+this.getName()+'[]">';var j=this.getPickListValues();var e=app.htmlDecode(this.getValue());var b=e.split(",");for(var g in j){h+='<option value="'+g+'" ';if(jQuery.inArray(g,b)!=-1){h+=" selected "}h+=">"+j[g]+"</option>"}h+="</select>";var c=jQuery(h);this.addValidationToElement(c);return c}else{var e=app.htmlDecode(this.getValue());var j=this.getPickListValues();var f=new Array();jQuery.map(j,function(m,l){f.push(m)});var d={};for(var k in j){var a=j[k];d[a]=k}var h='<input type="hidden" class="row select2" name="'+this.getName()+'">';var c=jQuery(h).val(e);c.data("tags",f).data("picklistvalues",d);this.addValidationToElement(c);return c}}});Vtiger_Multipicklist_Field_Js("AdvanceFilter_Multipicklist_Field_Js",{},{getUi:function(){var g=this.get("comparatorElementVal");if(g!="e"&&g!="n"){var d=app.htmlDecode(this.getValue());var h=this.getPickListValues();var e=new Array();jQuery.map(h,function(k,j){e.push(k)});var c={};for(var i in h){var a=h[i];c[a]=i}var f='<input type="hidden" class="row select2" name="'+this.getName()+'[]">';var b=jQuery(f).val(d);b.data("tags",e).data("picklistvalues",c);this.addValidationToElement(b);return b}else{return this._super()}}});Vtiger_Owner_Field_Js("AdvanceFilter_Owner_Field_Js",{},{getUi:function(){var g=this.get("comparatorElementVal");if(g=="e"||g=="n"){var f='<select class="select2 row" multiple name="'+this.getName()+'[]">';var i=this.getPickListValues();var c=app.htmlDecode(this.getValue());var a=c.split(",");for(var j in i){f+='<optgroup label="'+j+'">';var h=i[j];for(var e in h){f+='<option value="'+e+'" ';if(jQuery.inArray(jQuery.trim(h[e]),a)!=-1){f+=" selected "}f+=">"+h[e]+"</option>"}f+="</optgroup>"}f+="</select>";var b=jQuery(f);this.addValidationToElement(b);return b}else{var c=this.getValue();var i=this.getPickListValues();var d=new Array();jQuery.each(i,function(k,l){jQuery.each(l,function(m,n){d.push(jQuery.trim(n))})});var f='<input data-tags="'+d+'" type="hidden" class="row select2" name="'+this.getName()+'">';var b=jQuery(f).val(c);b.data("tags",d);this.addValidationToElement(b);return b}}});Vtiger_Date_Field_Js("AdvanceFilter_Date_Field_Js",{},{getUi:function(){var m=this.get("comparatorElementVal");var i=this.get("dateSpecificConditions");if(m=="bw"||m=="custom"){var g='<div class="date"><input class="dateField" data-calendar-type="range" name="'+this.getName()+'" data-date-format="'+this.getDateFormat()+'" type="text" ReadOnly="true" value="'+this.getValue()+'"></div>';var a=jQuery(g);var s=a.find(".dateField");if(s.val().indexOf(",")!==-1){var d=this.getValue().split(",");var p=d[0];var f=d[1];if(p.indexOf(" ")!==-1){var e=p.split(" ");p=e[0]}if(f.indexOf(" ")!==-1){var j=f.split(" ");f=j[0]}s.val(p+","+f)}else{var n=this.getValue().split(" ");var b=n[0];var q=n[0];if(b!=""&&q!=""){s.val(b+","+q)}}return this.addValidationToElement(a)}else{if(m in i){var k=i[m]["startdate"];var h=i[m]["enddate"];if(m=="today"||m=="tomorrow"||m=="yesterday"){var g='<input name="'+this.getName()+'" type="text" ReadOnly="true" value="'+k+'">'}else{var g='<input name="'+this.getName()+'" type="text" ReadOnly="true" value="'+k+","+h+'">'}return jQuery(g)}else{var o=this._super();var l=o.find(".dateField").val();var r=l.split(" ");if(r[1]=="00:00:00"){l=r[0]}else{if(m=="e"||m=="n"||m=="b"||m=="a"){var c=l.split(" ");l=c[0]}}o.find(".dateField").val(l);return o}}}});AdvanceFilter_Date_Field_Js("AdvanceFilter_Datetime_Field_Js",{},{});