
jQuery.Class("Vtiger_Edit_Js",{referenceSelectionEvent:"Vtiger.Reference.Selection",referenceDeSelectionEvent:"Vtiger.Reference.DeSelection",recordPreSave:"Vtiger.Record.PreSave",refrenceMultiSelectionEvent:"Vtiger.MultiReference.Selection",preReferencePopUpOpenEvent:"Vtiger.Referece.Popup.Pre",editInstance:false,SaveResultInstance:false,postReferenceSelectionEvent:"Vtiger.PostReference.Selection",getInstanceByModuleName:function(b){if(typeof b=="undefined"){b=app.getModuleName()}var e=app.getParentModuleName();if(e=="Settings"){var c=e+"_"+b+"_Edit_Js";if(typeof window[c]=="undefined"){c=b+"_Edit_Js"}var d=e+"_Vtiger_Edit_Js";if(typeof window[d]=="undefined"){d="Vtiger_Edit_Js"}}else{c=b+"_Edit_Js";d="Vtiger_Edit_Js"}if(typeof window[c]!="undefined"){var a=new window[c]()}else{var a=new window[d]()}return a},getInstance:function(){if(Vtiger_Edit_Js.editInstance==false){var a=Vtiger_Edit_Js.getInstanceByModuleName();Vtiger_Edit_Js.editInstance=a;return a}return Vtiger_Edit_Js.editInstance}},{addressDataOG:[],addressDataGM:[],formElement:false,relationOperation:"",getForm:function(){if(this.formElement==false){this.setForm(jQuery("#EditView"))}return this.formElement},setForm:function(a){this.formElement=a;return this},getPopUpParams:function(b){var e={};var g=app.getModuleName();var h=jQuery('input[name="popupReferenceModule"]',b).val();var d=jQuery('input[class="sourceField"]',b);var i=d.attr("name");var c=jQuery('input[name="record"]');var a="";if(c.length>0){a=c.val()}var f=false;if(d.data("multiple")==true){f=true}var e={module:h,src_module:g,src_field:i,src_record:a};if(f){e.multi_select=true}return e},openPopUp:function(h){var c=this;var a=jQuery(h.target).closest("td");var i=this.getPopUpParams(a);var f=false;if(i.multi_select){f=true}var g=jQuery('input[class="sourceField"]',a);var b=jQuery.Event(Vtiger_Edit_Js.preReferencePopUpOpenEvent);g.trigger(b);if(b.isDefaultPrevented()){return}var d=Vtiger_Popup_Js.getInstance();d.show(i,function(k){var j=JSON.parse(k);var e=new Array();for(var l in j){var k={name:j[l].name,id:l};e.push(k);if(!f){c.setReferenceFieldValue(a,k)}}if(f){g.trigger(Vtiger_Edit_Js.refrenceMultiSelectionEvent,{data:e})}g.trigger(Vtiger_Edit_Js.postReferenceSelectionEvent,{data:j})})},setReferenceFieldValue:function(a,d){var l=this;var k=a.find("input.sourceField").attr("name");var c=a.find('input[name="'+k+'"]');var f=k+"_display";var m=a.find('input[name="'+f+'"]');var h=a.find('input[name="popupReferenceModule"]').val();var e=d.name;var b=d.id;c.val(b);m.val(e).attr("readonly",true);c.trigger(Vtiger_Edit_Js.referenceSelectionEvent,{source_module:h,record:b,selectedName:e});m.validationEngine("closePrompt",m);var j=a.closest("form");var i=this.getMappingRelatedField(k,h,j);if(typeof i!=undefined){var g={source_module:h,record:b};this.getRecordDetails(g).then(function(o){var n=o.result["data"];$.each(i,function(s,t){if(n[t[0]]!=0&&!l.getMappingValuesFromUrl(s)){var q=j.find('input[name="'+s+'"]');if(q.length>0){q.val(n[t[0]])}var r=j.find('input[name="'+s+'_display"]');if(r.length>0){r.val(n[t[0]+"_label"]).attr("readonly",true);var p=j.find("#"+app.getModuleName()+"_editView_fieldName_"+s+"_dropDown");if(p.length>0){p.val(t[1]).trigger("chosen:updated")}l.setReferenceFieldValue(r.closest(".fieldValue"),{name:n[t[0]+"_label"],id:n[t[0]]})}}})})}},getRelationOperation:function(){if(this.relationOperation===""){var a=jQuery('[name="relationOperation"]');if(a.length){this.relationOperation=a.val()}else{this.relationOperation=false}}return this.relationOperation},getMappingValuesFromUrl:function(b){var a=this.getRelationOperation();if(a){return app.getUrlVar(b)}return false},proceedRegisterEvents:function(){if(jQuery(".recordEditView").length>0){return true}else{return false}},treePopupRegisterEvent:function(a){var b=this;a.on("click",".treePopup",function(c){b.openTreePopUp(c)})},registerClearTreeSelectionEvent:function(a){a.find(".clearTreeSelection").on("click",function(d){var c=jQuery(d.currentTarget);var b=c.closest("td");var g=b.find(".sourceField");var f=g.attr("name");g.val("");b.find("#"+f+"_display").removeAttr("readonly").val("");d.preventDefault()})},openTreePopUp:function(k){var l=this;var j=jQuery(k.target).closest("td");var d=jQuery(k.target).closest("form");var g={};var b=jQuery('input[name="module"]',d).val();var f=jQuery('input[class="sourceField"]',j);var h=f.attr("name")+"_display";var m=jQuery('input[name="'+h+'"]',j);var c=jQuery('input[name="record"]');var a="";if(c.length>0){a=c.val()}urlOrParams="module="+b+"&view=TreePopup&template="+f.data("treetemplate")+"&src_field="+f.attr("name")+"&src_record="+a;var i=Vtiger_Popup_Js.getInstance();i.show(urlOrParams,function(n){var e=JSON.parse(n);f.val("T"+e.id);m.val(e.name).attr("readonly",true)})},registerTreeAutoCompleteFields:function(a){var b=this;a.find("input.treeAutoComplete").autocomplete({delay:"600",minLength:"3",source:function(i,h){var m=jQuery(this.element[0]);var c=i.term;var j=m.closest("td");var g=jQuery('input[class="sourceField"]',j);var f=g.data("allvalues");var n=new Array();for(var e in f){var d=f[e][0];if(d.toLowerCase().indexOf(c)>=0){var l=f[e][1];var k="";if(l!=""){var k="("+f[l][0]+") "}k=k+d;n.push({label:k,value:d,id:e})}}if(n.length<=0){jQuery(m).val("");n.push({label:app.vtranslate("JS_NO_RESULTS_FOUND"),type:"no results"})}h(n)},select:function(i,j){var e=j.item;if(typeof e.type!="undefined"&&e.type=="no results"){return false}e.name=e.value;var f=jQuery(this);var h=f.closest("td");var g=h.find('input[class="sourceField"]');var c=g.attr("name")+"_display";var d=jQuery('input[name="'+c+'"]',h);g.val(e.id);d.val(e.label).attr("readonly",true)},change:function(d,e){var c=jQuery(this)},open:function(c,d){jQuery(this).data("autocomplete").menu.element.css("z-index","100001")}})},referenceModulePopupRegisterEvent:function(a){var b=this;a.on("click",".relatedPopup",function(c){b.openPopUp(c)});a.find(".referenceModulesList").chosen().change(function(g){var d=jQuery(g.currentTarget);var i=d.closest("td").next();var h=d.val();var f=jQuery('input[name="popupReferenceModule"]',i);var c=f.val();f.val(h);if(c!=h){i.find(".clearReferenceSelection").trigger("click")}})},getReferencedModuleName:function(a){return jQuery('input[name="popupReferenceModule"]',a).val()},searchModuleNames:function(b){var a=jQuery.Deferred();if(typeof b.module=="undefined"){b.module=app.getModuleName()}if(typeof b.action=="undefined"){b.action="BasicAjax"}if(b.search_module=="Products"||b.search_module=="Services"){b.potentialid=jQuery('[name="potentialid"]').val()}AppConnector.request(b).then(function(c){a.resolve(c)},function(c){a.reject()});return a.promise()},getReferenceSearchParams:function(b){var c=jQuery(b).closest("td");var d={};var a=this.getReferencedModuleName(c);d.search_module=a;return d},registerAutoCompleteFields:function(a){var b=this;a.find("input.autoComplete").autocomplete({delay:"600",minLength:"3",source:function(d,c){var f=jQuery(this.element[0]);var e=d.term;var g=b.getReferenceSearchParams(f);g.search_value=e;b.searchModuleNames(g).then(function(k){var i=new Array();var j=k.result;if(j.length<=0){jQuery(f).val("");j=new Array({label:app.vtranslate("JS_NO_RESULTS_FOUND"),type:"no results"})}for(var l in j){var h=j[l];i.push(h)}c(i)})},select:function(h,i){var c=i.item;if(typeof c.type!="undefined"&&c.type=="no results"){return false}c.name=c.value;var d=jQuery(this);var g=d.closest("td");b.setReferenceFieldValue(g,c);var f=g.find('input[class="sourceField"]').attr("name");var e=g.find('input[name="'+f+'"]');e.trigger(Vtiger_Edit_Js.postReferenceSelectionEvent,{data:c})},change:function(d,e){var c=jQuery(this);if(c.attr("readonly")==undefined){c.closest("td").find(".clearReferenceSelection").trigger("click")}},open:function(c,d){jQuery(this).data("ui-autocomplete").menu.element.css("z-index","100001")}})},registerClearReferenceSelectionEvent:function(a){a.find(".clearReferenceSelection").on("click",function(d){var c=jQuery(d.currentTarget);var b=c.closest("td");var g=b.find(".sourceField");var f=g.attr("name");g.val("");b.find('[name="'+f+'_display"]').removeAttr("readonly").val("");c.trigger(Vtiger_Edit_Js.referenceDeSelectionEvent);d.preventDefault()})},registerPreventingEnterSubmitEvent:function(a){a.on("keypress",function(c){var b=jQuery(c.target);if(c.which==13&&(!b.is("textarea"))){c.preventDefault()}})},getRecordDetails:function(c){var a=jQuery.Deferred();var b="index.php?module="+app.getModuleName()+"&action=GetData&record="+c.record+"&source_module="+c.source_module;AppConnector.request(b).then(function(d){if(d.success){a.resolve(d)}else{a.reject(d.message)}},function(d){a.reject()});return a.promise()},registerTimeFields:function(a){app.registerEventForTimeFields(a)},referenceCreateHandler:function(a){var c=this;var d=function(e){var f={};f.name=e.result._recordLabel;f.id=e.result._recordId;c.setReferenceFieldValue(a,f)};var b=this.getReferencedModuleName(a);Vtiger_Header_Js.getInstance().quickCreateModule(b,{callbackFunction:d})},registerReferenceCreate:function(a){var b=this;a.on("click",".createReferenceRecord",function(f){var d=jQuery(f.currentTarget);var c=d.closest("td");b.referenceCreateHandler(c)})},addressFieldsMapping:["buildingnumber","localnumber","addresslevel1","addresslevel2","addresslevel3","addresslevel4","addresslevel5","addresslevel6","addresslevel7","addresslevel8","pobox"],addressFieldsMappingBlockID:{LBL_ADDRESS_INFORMATION:"a",LBL_ADDRESS_MAILING_INFORMATION:"b",LBL_ADDRESS_DELIVERY_INFORMATION:"c"},addressFieldsData:false,registerEventForCopyAddress:function(){var d=this;var c=this.getForm();var b=false;var e=false;var f=false;var a=false;jQuery("#EditView table td").each(function(h){var g=false;var i=$(this).find('[name="popupReferenceModule"]').val();if(i=="Accounts"){b=$(this).find(".sourceField").attr("name")}if(i=="Contacts"){e=$(this).find(".sourceField").attr("name")}if(i=="Leads"){f=$(this).find(".sourceField").attr("name")}if(i=="Vendors"){a=$(this).find(".sourceField").attr("name")}g=$(this).find(".referenceModulesList");if(g.length>0){$.each(g.find("option"),function(j,k){if(k.value=="Accounts"){b=jQuery("#EditView table td").eq(h+1).find(".sourceField").attr("name")}if(k.value=="Contacts"){e=jQuery("#EditView table td").eq(h+1).find(".sourceField").attr("name")}if(k.value=="Leads"){f=jQuery("#EditView table td").eq(h+1).find(".sourceField").attr("name")}if(k.value=="Vendors"){a=jQuery("#EditView table td").eq(h+1).find(".sourceField").attr("name")}})}});if(b==false){jQuery(".copyAddressFromAccount").addClass("hide")}else{jQuery(".copyAddressFromAccount").on("click",function(j){var h=jQuery(this);var l=h.closest("table");var n=h.data("label");var m=l.data("label");var k=jQuery('[name="'+b+'"]').val();if(k==""||k=="0"){Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_PLEASE_SELECT_AN_ACCOUNT_TO_COPY_ADDRESS"))}else{var g=jQuery("#"+b+"_display").val();var i={record:k,selectedName:g,source_module:"Accounts"};d.copyAddressDetails(n,m,i,h.closest("table"));h.attr("checked","checked")}})}if(e==false){jQuery(".copyAddressFromContact").addClass("hide")}else{jQuery(".copyAddressFromContact").on("click",function(j){var h=jQuery(this);var l=h.closest("table");var n=h.data("label");var m=l.data("label");var k=jQuery('[name="'+e+'"]').val();if(k==""||k=="0"){Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_PLEASE_SELECT_AN_CONTACT_TO_COPY_ADDRESS"))}else{var g=jQuery("#"+e+"_display").val();var i={record:k,selectedName:g,source_module:"Contacts"};d.copyAddressDetails(n,m,i,h.closest("table"));h.attr("checked","checked")}})}if(f==false){jQuery(".copyAddressFromLead").addClass("hide")}else{jQuery(".copyAddressFromLead").on("click",function(j){var h=jQuery(this);var l=h.closest("table");var n=h.data("label");var m=l.data("label");var k=jQuery('[name="'+f+'"]').val();if(k==""||k=="0"){Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_PLEASE_SELECT_AN_LEAD_TO_COPY_ADDRESS"))}else{var g=jQuery("#"+f+"_display").val();var i={record:k,selectedName:g,source_module:"Leads"};d.copyAddressDetails(n,m,i,h.closest("table"));h.attr("checked","checked")}})}if(a==false){jQuery(".copyAddressFromVendor").addClass("hide")}else{jQuery(".copyAddressFromVendor").on("click",function(j){var h=jQuery(this);var l=h.closest("table");var n=h.data("label");var m=l.data("label");var k=jQuery('[name="'+a+'"]').val();if(k==""||k=="0"){Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_PLEASE_SELECT_AN_VENDOR_TO_COPY_ADDRESS"))}else{var g=jQuery("#"+a+"_display").val();var i={record:k,selectedName:g,source_module:"Vendors"};d.copyAddressDetails(n,m,i,h.closest("table"));h.attr("checked","checked")}})}if(e==false&&b==false&&f==false&&a==false){jQuery(".copyAddressLabel").addClass("hide")}jQuery(".copyAddressFromMain").on("click",function(h){var g=jQuery(this);var i=g.closest("table");var k=g.data("label");var j=i.data("label");d.copyAddress(k,j,false,false)});jQuery(".copyAddressFromMailing").on("click",function(h){var g=jQuery(this);var i=g.closest("table");var k=g.data("label");var j=i.data("label");d.copyAddress(k,j,false,false)});jQuery(".copyAddressFromDelivery").on("click",function(h){var g=jQuery(this);var i=g.closest("table");var k=g.data("label");var j=i.data("label");d.copyAddress(k,j,false,false)})},copyAddressDetails:function(h,g,f,b){var e=this;var a=f.source_module;var c=true;var d;e.getRecordDetails(f).then(function(j){var i=j.result;e.addressFieldsData=i.data;e.copyAddress(h,g,true,a)},function(i,j){})},copyAddress:function(p,f,o,e){var d=false;var i=this;var h=this.getForm();var a=this.addressFieldsMapping;var c=this.addressFieldsMappingBlockID;from=c[p];if(app.getModuleName()=="Quotes"||app.getModuleName()=="Invoice"){c={LBL_ADDRESS_INFORMATION:"a",LBL_ADDRESS_DELIVERY_INFORMATION:"b"}}if(o===false||e===false){from=c[p]}to=c[f];for(var k in a){var l=a[k]+from;var n=a[k]+to;if(o){var g=i.addressFieldsData[l];var m=i.addressFieldsData[l+"_label"]}else{var g=h.find('[name="'+l+'"]').val();var m=h.find('[name="'+l+'_display"]').val()}var b=h.find('[name="'+n+'"]');var j=h.find('[name="'+n+'_display"]');if(g!=""&&g!="0"&&g!=undefined){if(j.length>0){j.attr("readonly",true)}d=true;b.val(g);j.val(m)}else{b.attr("readonly",false)}}if(d==false){if(e=="Accounts"){errorMsg="JS_SELECTED_ACCOUNT_DOES_NOT_HAVE_AN_ADDRESS"}else{if(e=="Contacts"){errorMsg="JS_SELECTED_CONTACT_DOES_NOT_HAVE_AN_ADDRESS"}else{errorMsg="JS_DOES_NOT_HAVE_AN_ADDRESS"}}Vtiger_Helper_Js.showPnotify(app.vtranslate(errorMsg))}},registerReferenceSelectionEvent:function(a){var c=this;var b=a.find("input[name*='addresslevel']");b.on(Vtiger_Edit_Js.referenceSelectionEvent,function(g,f){var d=jQuery(g.currentTarget).closest(".blockContainer");c.copyAddressDetailsRef(f,d)})},copyAddressDetailsRef:function(c,a){var b=this;b.getRecordDetails(c).then(function(e){var d=e.result;b.mapAddressDetails(d.data,a)},function(d,e){})},mapAddressDetails:function(a,b){for(var c in a){if(c.indexOf("addresslevel")!=-1){if(b.find('[name="'+c+'"]').length!=0){b.find('[name="'+c+'"]').val(a[c]);b.find('[name="'+c+'"]').attr("readonly",true);b.find('[name="'+c+'_display"]').val(a[c+"_label"]);b.find('[name="'+c+'_display"]').attr("readonly",true)}if(b.find('[name="'+c+'a"]').length!=0&&b.find('[name="'+c+'a"]').val()==0&&a[c]!=0){b.find('[name="'+c+'a"]').val(a[c]);b.find('[name="'+c+'a"]').attr("readonly",true);b.find('[name="'+c+'a_display"]').val(a[c+"_label"]);b.find('[name="'+c+'a_display"]').attr("readonly",true)}if(b.find('[name="'+c+'b"]').length!=0&&b.find('[name="'+c+'b"]').val()==0&&a[c]!=0){b.find('[name="'+c+'b"]').val(a[c]);b.find('[name="'+c+'b"]').attr("readonly",true);b.find('[name="'+c+'b_display"]').val(a[c+"_label"]);b.find('[name="'+c+'b_display"]').attr("readonly",true)}if(b.find('[name="'+c+'c"]').length!=0&&b.find('[name="'+c+'c"]').val()==0&&a[c]!=0){b.find('[name="'+c+'c"]').val(a[c]);b.find('[name="'+c+'c"]').attr("readonly",true);b.find('[name="'+c+'c_display"]').val(a[c+"_label"]);b.find('[name="'+c+'c_display"]').attr("readonly",true)}}}},registerMaskFields:function(a){var b=this;a.find(":input").inputmask()},registerBasicEvents:function(a){this.treePopupRegisterEvent(a);this.registerClearTreeSelectionEvent(a);this.registerTreeAutoCompleteFields(a);this.referenceModulePopupRegisterEvent(a);this.registerAutoCompleteFields(a);this.registerClearReferenceSelectionEvent(a);this.registerPreventingEnterSubmitEvent(a);this.registerTimeFields(a);this.registerRecordAccessCheckEvent(a);this.registerEventForPicklistDependencySetup(a);this.registerRecordPreSaveEventEvent(a);this.registerReferenceSelectionEvent(a);this.registerMaskFields(a)},registerEventForImageDelete:function(){var b=this.getForm();var a=b.find('input[name="record"]').val();b.find(".imageDelete").on("click",function(k){var i=jQuery(k.currentTarget);var l=i.closest("td");var d=l.find('[name="imagename[]"]');var c=d.data("fieldinfo");var g=c.mandatory;var f=i.closest("div").find("img").data().imageId;i.closest("div").remove();var j=l.find('[name="existingImages"]');if(j.length<1&&g){b.validationEngine("detach");d.attr("data-validation-engine","validate[required,funcCall[Vtiger_Base_Validator_Js.invokeValidation]]");b.validationEngine("attach")}if(b.find("[name=imageid]").length!=0){var m=JSON.parse(b.find("[name=imageid]").val());m.push(f);b.find("[name=imageid]").val(JSON.stringify(m))}else{var h=[];h.push(f);b.append('<input type="hidden" name="imgDeleted" value="true" />');b.append('<input type="hidden" name="imageid" value="'+JSON.stringify(h)+'" />')}})},triggerDisplayTypeEvent:function(){var a=app.cacheGet("widthType","narrowWidthType");if(a){var b=jQuery("#EditView").find("td");b.addClass(a)}},registerSubmitEvent:function(){var a=this.getForm();a.submit(function(d){if(typeof a.data("submit")!="undefined"){return false}else{document.progressLoader=jQuery.progressIndicator({message:app.vtranslate("JS_SAVE_LOADER_INFO"),position:"html",blockInfo:{enabled:true}});var b=jQuery(d.currentTarget).find('[name="module"]').val();if(a.validationEngine("validate")){a.data("submit","true");var c=jQuery.Event(Vtiger_Edit_Js.recordPreSave);a.trigger(c,{value:"edit"});if(c.isDefaultPrevented()){document.progressLoader.progressIndicator({mode:"hide"});a.removeData("submit");d.preventDefault()}}else{document.progressLoader.progressIndicator({mode:"hide"});a.removeData("submit");app.formAlignmentAfterValidation(a)}}})},registerRecordPreSaveEventEvent:function(b){if(Vtiger_Edit_Js.SaveResultInstance==false){Vtiger_Edit_Js.SaveResultInstance=new SaveResult()}var a=this.getForm();var c=a.serializeFormData();if(Vtiger_Edit_Js.SaveResultInstance.recordValue==false){Vtiger_Edit_Js.SaveResultInstance.loadFormData(c)}b.on(Vtiger_Edit_Js.recordPreSave,function(f,d){if(Vtiger_Edit_Js.SaveResultInstance.checkData(b.serializeFormData(),b)==false){f.preventDefault()}})},registerRecordAccessCheckEvent:function(a){a.on(Vtiger_Edit_Js.recordPreSave,function(g,f){var d=jQuery('[name="assigned_user_id"]',a);if(d.data("recordaccessconfirmation")==true){return}else{if(d.data("recordaccessconfirmationprogress")!=true){var b=d.find("option:selected").data("recordaccess");if(b==false){var c=app.vtranslate("JS_NO_VIEW_PERMISSION_AFTER_SAVE");Vtiger_Helper_Js.showConfirmationBox({message:c}).then(function(h){d.data("recordaccessconfirmation",true);d.removeData("recordaccessconfirmationprogress");a.append('<input type="hidden" name="returnToList" value="true" />');a.submit()},function(e,h){d.removeData("recordaccessconfirmationprogress");g.preventDefault()});d.data("recordaccessconfirmationprogress",true)}else{return true}}}g.preventDefault()})},registerEventForPicklistDependencySetup:function(a){var c=jQuery('[name="picklistDependency"]',a);if(c.length<=0){return}var d=JSON.parse(c.val());var e=Object.keys(d);if(e.length<=0){return}var g=[];for(var b=0;b<e.length;b++){g.push('[name="'+e[b]+'"]')}g=g.join(",");var f=a.find(g);f.on("change",function(n){var l=jQuery(n.currentTarget);var k=l.attr("name");var j=d[k];var m=l.val();var i=j[m];var h=j.__DEFAULT__;if(typeof i=="undefined"){i=h}jQuery.each(h,function(u,w){var p=i[u];if(typeof p=="undefined"){p=w}var v=jQuery('[name="'+u+'"]',a);if(v.length<=0){return}var o=v.data("availableOptions");if(typeof o=="undefined"){o=jQuery("option",v);v.data("available-options",o)}var s=new jQuery();var q=[];q.push("");for(var t=0;t<p.length;t++){q.push(p[t])}jQuery.each(o,function(x,z){var y=jQuery(z).val();if(jQuery.inArray(y,q)!=-1){s=s.add(jQuery(z))}});var r="";var r=s.filter("[selected]").val();v.html(s).val(r).trigger("chosen:updated")})});f.trigger("change")},registerLeavePageWithoutSubmit:function(a){InitialFormData=a.serialize();window.onbeforeunload=function(b){if(InitialFormData!=a.serialize()&&a.data("submit")!="true"){return app.vtranslate("JS_CHANGES_WILL_BE_LOST")}}},stretchCKEditor:function(){var a=jQuery(".ckEditorSource").parents("tr");var b=jQuery(".ckEditorSource").parent();jQuery(a).find(".fieldLabel").remove();jQuery(b).removeClass("col-md-10");jQuery(b).addClass("col-md-12")},registerEventForCkEditor:function(){var b=this.getForm();var a=this;$.each(b.find(".ckEditorSource"),function(c,d){a.loadCkEditorElement(jQuery(d))})},loadCkEditorElement:function(c){var a={};if(c.is(":visible")){c.removeAttr("data-validation-engine");if(c.hasClass("ckEditorBasic")){a.toolbar="Basic"}if(c.hasClass("ckEditorSmall")){a.height="5em"}var b=new Vtiger_CkEditor_Js();b.loadCkEditor(c,a)}},registerHelpInfo:function(){var a=this.getForm();app.showPopoverElementView(a.find(".HelpInfoPopover"))},registerBlockAnimationEvent:function(){var a=this.getForm();a.on("click",".blockHeader",function(h){if(jQuery(h.target).is("input")||jQuery(h.target).is("button")||jQuery(h.target).parents().is("button")){return false}var c=jQuery(h.currentTarget).find(".blockToggle").not(".hide");var f=c.data("id");var i=c.closest(".blockContainer");var b=i.find("tbody");var g=c.data();var d=app.getModuleName();var j=function(){b.addClass("hide");app.cacheSet(d+"."+f,0)};var k=function(){b.removeClass("hide");app.cacheSet(d+"."+f,1)};if(g.mode=="show"){j();c.addClass("hide");i.find('[data-mode="hide"]').removeClass("hide")}else{k();c.addClass("hide");i.find("[data-mode='show']").removeClass("hide")}})},registerBlockStatusCheckOnLoad:function(){var b=this.getForm().find(".blockContainer");var a=app.getModuleName();b.each(function(d,j){var g=jQuery(j);var f=g.find(".blockToggle").not(".hide");var i=g.find("tbody");var c=f.data("id");var h=a+"."+c;var e=app.cacheGet(h,null);if(e!=null){if(e==1){f.addClass("hide");g.find("[data-mode='show']").removeClass("hide");i.removeClass("hide")}else{f.addClass("hide");g.find("[data-mode='hide']").removeClass("hide");i.addClass("hide")}}})},getDataFromOG:function(c,b){var a=this;if(b.opencage_data){return jQuery.ajax({url:b.opencage_data.geoCodeURL,data:{format:"json",q:c.term,pretty:"1",key:b.opencage_data.geoCodeKey},success:function(e,f,d){if(e.results.length){a.addressDataOG=jQuery.map(e.results,function(g){return{label:g.formatted,source:"opencage_geocoder",source_label:"OpenCage Geocoder",value:g.components.road,components:g.components}})}}})}return[]},getDataFromGM:function(c,b){var a=this;if(b.google_map_api){return jQuery.ajax({url:b.google_map_api.geoCodeURL,data:{address:c.term,key:b.google_map_api.geoCodeKey},success:function(e){if(0<e.results.length){var d=e.results[0].geometry.location;jQuery.ajax({url:b.google_map_api.geoCodeURL,data:{latlng:d.lat+","+d.lng,key:b.google_map_api.geoCodeKey},success:function(g,h,f){a.addressDataGM=jQuery.map(g.results,function(i){return{label:i.formatted_address,source:"google_geocoding",source_label:"Google Geocoding",value:i.formatted_address,components:a.mappingAddressDataFromGoogle(i.address_components)}})}})}}})}return[]},mappingAddressDataFromGoogle:function(b){var f={};for(var d in b){var c=b[d]["types"];if("route"===c[0]){f.road=b[d]["long_name"]}if("street_number"===c[0]){var a=b[d]["long_name"];if(a.indexOf("/">-1)){var e=a.split("/");f.house_number=e[0];f.local_number=e[1]}else{f.house_number=b[d]["long_name"]}}if("country"===c[0]&&"political"===c[1]){f.country=b[d]["long_name"]}if("administrative_area_level_1"===c[0]&&"political"===c[1]){f.state=b[d]["long_name"]}if("administrative_area_level_2"===c[0]&&"political"===c[1]){f.powiat=b[d]["long_name"]}if("sublocality_level_1"===c[0]&&"sublocality"===c[1]&&"political"===c[2]){f.region_city=b[d]["long_name"]}if("postal_code"===c[0]){f.postcode=b[d]["long_name"]}if("locality"===c[0]&&"political"===c[1]){f.city=b[d]["long_name"]}}return f},registerApiAddress:function(){var b=this;var c=jQuery('[name="apiAddress"]');var a=[];jQuery(c).each(function(e,f){var d=jQuery(f).data("api-name");var g={geoCodeURL:jQuery(f).data("url"),geoCodeKey:jQuery(f).val()};a[d]=g;a.minLookupLenght=jQuery(f).data("lenght");a.max_num=jQuery(f).data("max-num")});if(!a){return false}jQuery(".api_address_autocomplete").each(function(){jQuery(this).autocomplete({source:function(e,d){jQuery.when(b.getDataFromOG(e,a),b.getDataFromGM(e,a)).then(function(h,g){var f=b.addressDataOG.concat(b.addressDataGM);d(f.slice(0,a.max_num))}).fail(function(f){d([{label:app.vtranslate("An error has occurred. No results."),value:""}])})},minLength:a.minLookupLenght,select:function(f,g){for(var e in g.item.components){var d=b.addressFieldsMappingFromApi[e];jQuery(this).parents("table").find('[name^="'+d+'"]').val(g.item.components[e])}}}).data("ui-autocomplete")._renderItem=function(d,e){return jQuery("<li>").data("item.autocomplete",e).append('<a><img style="width: 24px; height: 24px;" class="alignMiddle" src="layouts/vlayout/skins/images/'+e.source+'.png" title="'+e.source_label+'" alt="'+e.source_label+'">'+e.label+"</a>").appendTo(d)}})},addressFieldsMappingFromApi:{house_number:"buildingnumber",local_number:"localnumber",country:"addresslevel1",state:"addresslevel2",powiat:"addresslevel3",county:"addresslevel4",city:"addresslevel5",region_city:"addresslevel6",postcode:"addresslevel7",road:"addresslevel8",village:"addresslevel5"},registerEvents:function(){var c=this.getForm();var a=this.proceedRegisterEvents();if(!a){return}this.registerHelpInfo();this.registerBlockAnimationEvent();this.registerBlockStatusCheckOnLoad();this.registerEventForCkEditor();this.stretchCKEditor();this.registerBasicEvents(this.getForm());this.registerEventForCopyAddress();this.registerEventForImageDelete();this.registerSubmitEvent();this.registerLeavePageWithoutSubmit(c);app.registerEventForDatePickerFields("#EditView");var b=app.validationEngineOptionsForRecord;b.onValidationComplete=function(i,d){if(d){var g=c.find(".ckEditorSource");if(g.length>0){var h=g.attr("id");var e=g.data("fieldinfo");var k=e.mandatory;var j=CKEDITOR.instances[h];if(jQuery.type(j)!=="undefined"&&jQuery.type(j.document)==="object"){var f=jQuery.trim(j.document.getBody().getText());if(k&&(f.length===0)){var m="cke_"+h;var l=app.vtranslate("JS_REQUIRED_FIELD");jQuery("#"+m).validationEngine("showPrompt",l,"error","topLeft",true);return false}else{return d}}}return d}return d};c.validationEngine(b);this.registerReferenceCreate(c);this.registerApiAddress()},getMappingRelatedField:function(e,a,b){var c=b.find('input[name="mappingRelatedField"]').val();var d=JSON.parse(c);if(typeof d[e]!="undefined"&&typeof d[e][a]!="undefined"){return d[e][a]}return[]}});