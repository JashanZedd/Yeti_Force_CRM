/* {[The file is published on the basis of YetiForce Public License that can be found in the following directory: licenses/License.html]} */

function ApiAddress(){this.registerChangeApi=function(){jQuery("#change_api").on("change",function(){var b=jQuery(this).val(),a=jQuery(this).parents("table");jQuery(a).find(".api_row").hide();if(b){jQuery(a).find("."+b).removeClass("hide");jQuery(a).find("."+b).show()}})},this.registerSave=function(){var a=this;jQuery(".save").on("click",function(){var b={};jQuery(this).parents("table:first").find(".api").each(function(){var d=jQuery(this).attr("name");if(jQuery(this).attr("type")=="checkbox"){b[d]=jQuery(this).prop("checked")?1:0}else{b[d]=jQuery(this).val()}});b.api_name=jQuery(this).parents("table").data("api-name");if(!a.registerValidate(b)){return false}b=jQuery.extend({},b);var c={};c.data={module:"ApiAddress",parent:"Settings",action:"SaveConfig",elements:b};c.async=false;c.dataType="json";AppConnector.request(c).then(function(f){var d=f.result;if(d.success){if(b.key){a.registerReload()}var e={text:d.message,type:"success"};Vtiger_Helper_Js.showPnotify(e)}else{var e={text:d.message,type:"error"};Vtiger_Helper_Js.showPnotify(e)}},function(f,d){var e={text:app.vtranslate("JS_ERROR"),type:"error"};Vtiger_Helper_Js.showPnotify(e)})})},this.registerRemoveConnection=function(){var a=this;jQuery(".delete").on("click",function(){var b={key:"0",nominatim:"0",api_name:jQuery(this).parents("table").data("api-name")};var c={};c.data={module:"ApiAddress",parent:"Settings",action:"SaveConfig",elements:b};c.async=false;c.dataType="json";AppConnector.request(c).then(function(f){var d=f.result;if(d.success){a.registerReload();var e={text:d.message,type:"success"};Vtiger_Helper_Js.showPnotify(e)}else{var e={text:d.message,type:"error"};Vtiger_Helper_Js.showPnotify(e)}},function(f,d){var e={text:app.vtranslate("JS_ERROR"),type:"error"};Vtiger_Helper_Js.showPnotify(e)})})},this.registerReload=function(){var b=this;var a=jQuery.progressIndicator({message:app.vtranslate("JS_LOADING_PLEASE_WAIT"),position:".contentsDiv",blockInfo:{enabled:true}});jQuery.get("index.php?module=ApiAddress&parent=Settings&view=Configuration",function(c){jQuery(".contentsDiv").html(c);app.showSelect2ElementView(jQuery(".contentsDiv").find("select.select2"));a.progressIndicator({mode:"hide"});b.registerEvents()})},this.registerValidate=function(d){var c=this;var a=true;for(var b in d){if(b=="min_lenght"||b=="result_num"){if(!c.registerValidatemin_lenght(d[b])){return false}}if(b=="key"){if(!c.registerValidatekey(d.key,d.api_name)){return false}}}return a},this.registerValidatemin_lenght=function(c){var b=/^\d+$/;if(!b.test(c)||(1==c||0==c)){var a={text:app.vtranslate("JS_WRONG_NUMBER"),type:"error"};Vtiger_Helper_Js.showPnotify(a);return false}return true},this.registerValidatekey=function(c,b){var a=true;if("opencage_data"==b){var d="https://api.opencagedata.com/geocode/v1/json?query=test&pretty=1&key="+c;jQuery.ajax({url:d,async:false,complete:function(f){if(f.status==403){var e={text:app.vtranslate("Invalid API key"),type:"error"};Vtiger_Helper_Js.showPnotify(e);a=false}}})}else{return true}return a},this.registerEvents=function(){var a=this;a.registerSave();a.registerRemoveConnection();a.registerChangeApi()}}jQuery(document).ready(function(){var a=new ApiAddress();a.registerEvents()});
