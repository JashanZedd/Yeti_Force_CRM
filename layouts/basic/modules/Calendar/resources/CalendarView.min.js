
jQuery.Class("Calendar_CalendarView_Js",{currentInstance:false,getInstanceByView:function(){var b=jQuery("#currentView").val();var d=b+"View";var c=b+"_"+d+"_Js";if(typeof window[c]!="undefined"){var a=new window[c]()}else{a=new Calendar_CalendarView_Js()}return a},registerSwitches:function(){var b=jQuery("#rightPanel .quickWidget");var a=b.find(".widgetContainer input.switchBtn");app.showBtnSwitch(a);b.find(".widgetContainer").each(function(){h=jQuery(this).height();if(h>250){jQuery(this).find("div:first").slimScroll({height:"250px"})}})},registerWidget:function(){var b=this.getInstanceByView();var a=jQuery("#rightPanel .quickWidget");a.find(".switchsParent").on("switchChange.bootstrapSwitch",function(c,d){element=jQuery(this).closest(".quickWidget");if(d){element.find(".widgetContainer input.switchBtn").bootstrapSwitch("state",true)}else{element.find(".widgetContainer input.switchBtn").bootstrapSwitch("state",false)}});a.find(".refreshCalendar").on("click",function(){b.loadCalendarData();return false})},registerColorField:function(b,a){var c={};c.dropdownCss={"z-index":0};c.formatSelection=function(f,d){var e=f.id;var i=b.find('option[value="'+e+'"]');d.addClass(a+"_"+e);var g="<div>"+i.text()+"</div>";return g};app.changeSelectElementView(b,"select2",c)},},{calendarView:false,calendarCreateView:false,weekDaysArray:{Sunday:0,Monday:1,Tuesday:2,Wednesday:3,Thursday:4,Friday:5,Saturday:6},registerCalendar:function(){var j=this;var k=jQuery("#eventLimit").val();if(k=="true"){k=true}else{if(k=="false"){k=false}else{k=parseInt(k)+1}}var b=jQuery("#weekView").val();var g=jQuery("#dayView").val();var a=jQuery("#activity_view").val();if(a=="Today"){a=g}else{if(a=="This Week"){a=b}else{a="month"}}var f=jQuery("#time_format").val();var c;if(f==24){f="H:mm";c="HH:mm"}else{f="h:mmt";c="hh:mm A"}var d=jQuery("#start_day").val();var i=j.weekDaysArray[d];var e=jQuery("#start_hour").val()+":00";j.getCalendarView().fullCalendar({header:{left:"month,"+b+","+g,center:"title today",right:"prev,next"},timeFormat:f,axisFormat:f,scrollTime:e,firstDay:i,defaultView:a,editable:true,slotMinutes:15,defaultEventMinutes:0,forceEventDuration:true,defaultTimedEventDuration:"01:00:00",eventLimit:k,selectable:true,selectHelper:true,views:{basic:{eventLimit:false,}},select:function(m,l){j.selectDays(m,l);j.getCalendarView().fullCalendar("unselect")},eventDrop:function(m,n,l){j.updateEvent(m,n,l)},eventResize:function(m,n,l){j.updateEvent(m,n,l)},eventRender:function(m,l){l.find(".fc-content").popover({trigger:"hover",delay:500,title:m.title,container:"body",html:true,template:'<div class="popover calendarPopover" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>',content:'<div><span class="glyphicon glyphicon-time" aria-hidden="true"></span> <label>'+app.vtranslate("JS_START_DATE")+"</label>: "+m.start.format("YYYY-MM-DD "+c)+'</div><div><span class="glyphicon glyphicon-time" aria-hidden="true"></span> <label>'+app.vtranslate("JS_END_DATE")+"</label>: "+m.end.format("YYYY-MM-DD "+c)+"</div>"+(m.lok?'<div><span class="glyphicon glyphicon-globe" aria-hidden="true"></span> <label>'+app.vtranslate("JS_LOCATION")+"</label>: "+m.lok+"</div>":"")+(m.pri?'<div><span class="glyphicon glyphicon-warning-sign" aria-hidden="true"></span> <label>'+app.vtranslate("JS_PRIORITY")+"</label>: "+app.vtranslate("JS_"+m.pri)+"</div>":"")+'<div><span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span> <label>'+app.vtranslate("JS_STATUS")+"</label>: "+app.vtranslate("JS_"+m.sta)+"</div>"+(m.accname?'<div><span class="calIcon modIcon_Accounts" aria-hidden="true"></span> <label>'+app.vtranslate("JS_ACCOUNTS")+"</label>: "+m.accname+"</div>":"")+(m.linkl?'<div><span class="calIcon calIcon modIcon_'+m.linkm+'" aria-hidden="true"></span> <label>'+app.vtranslate("JS_RELATION")+"</label>: "+m.linkl+"</div>":"")+(m.procl?'<div><span class="glyphicon calIcon modIcon_'+m.procm+'" aria-hidden="true"></span> <label>'+app.vtranslate("JS_PROCESS")+"</label>: "+m.procl+"</div>":"")+(m.state?'<div><span class="glyphicon glyphicon-star-empty" aria-hidden="true"></span> <label>'+app.vtranslate("JS_STATE")+"</label>: "+app.vtranslate(m.state)+"</div>":"")+'<div><span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span> <label>'+app.vtranslate("JS_VISIBILITY")+"</label>: "+app.vtranslate("JS_"+m.vis)+"</div>"+(m.smownerid?'<div><span class="glyphicon glyphicon-user" aria-hidden="true"></span> <label>'+app.vtranslate("JS_ASSIGNED_TO")+"</label>: "+m.smownerid+"</div>":"")});l.find(".fc-content, .fc-info").click(function(){var q=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var p=$(this).closest(".fc-event");var o="index.php?module=Calendar&view=ActivityStateModal&record="+p.data("id");var n=function(s){q.progressIndicator({mode:"hide"})};var r={url:o,cb:n,};app.showModalWindow(r)})},monthNames:[app.vtranslate("JS_JANUARY"),app.vtranslate("JS_FEBRUARY"),app.vtranslate("JS_MARCH"),app.vtranslate("JS_APRIL"),app.vtranslate("JS_MAY"),app.vtranslate("JS_JUNE"),app.vtranslate("JS_JULY"),app.vtranslate("JS_AUGUST"),app.vtranslate("JS_SEPTEMBER"),app.vtranslate("JS_OCTOBER"),app.vtranslate("JS_NOVEMBER"),app.vtranslate("JS_DECEMBER")],monthNamesShort:[app.vtranslate("JS_JAN"),app.vtranslate("JS_FEB"),app.vtranslate("JS_MAR"),app.vtranslate("JS_APR"),app.vtranslate("JS_MAY"),app.vtranslate("JS_JUN"),app.vtranslate("JS_JUL"),app.vtranslate("JS_AUG"),app.vtranslate("JS_SEP"),app.vtranslate("JS_OCT"),app.vtranslate("JS_NOV"),app.vtranslate("JS_DEC")],dayNames:[app.vtranslate("JS_SUNDAY"),app.vtranslate("JS_MONDAY"),app.vtranslate("JS_TUESDAY"),app.vtranslate("JS_WEDNESDAY"),app.vtranslate("JS_THURSDAY"),app.vtranslate("JS_FRIDAY"),app.vtranslate("JS_SATURDAY")],dayNamesShort:[app.vtranslate("JS_SUN"),app.vtranslate("JS_MON"),app.vtranslate("JS_TUE"),app.vtranslate("JS_WED"),app.vtranslate("JS_THU"),app.vtranslate("JS_FRI"),app.vtranslate("JS_SAT")],buttonText:{today:app.vtranslate("JS_TODAY"),month:app.vtranslate("JS_MONTH"),week:app.vtranslate("JS_WEEK"),day:app.vtranslate("JS_DAY")},allDayText:app.vtranslate("JS_ALL_DAY"),eventLimitText:app.vtranslate("JS_MORE")})},loadCalendarData:function(c){var a=jQuery.progressIndicator();var m=this;m.getCalendarView().fullCalendar("removeEvents");var l=m.getCalendarView().fullCalendar("getView");var j=l.start.format();var b=l.end.format();var i=document.getElementById("calendarActivityTypeList");types=[];if(i){jQuery(i).find(".switchBtn").each(function(){if(jQuery(this).prop("checked")){types.push(jQuery(this).data("value"))}})}else{c=true}var e=document.getElementById("calendarUserList");var g=[];if(e){g=m.getValues(e,g);if(g.length<1){g.push("-1")}}else{if(c){var g=[jQuery("#current_user_id").val()]}}var k=document.getElementById("calendarGroupList");if(k){g=m.getValues(k,g)}var d=jQuery("#showType").val();if(c==true||types.length>0){var f={module:"Calendar",action:"Calendar",mode:"getEvents",start:j,end:b,user:g,time:d,types:types};AppConnector.request(f).then(function(n){m.getCalendarView().fullCalendar("addEventSource",n.result);a.hide()})}else{m.getCalendarView().fullCalendar("removeEvents");a.hide()}},getValues:function(a,b){jQuery(a).find(".switchBtn").each(function(){if(jQuery(this).prop("checked")){b.push(jQuery(this).data("value"))}});return b},updateEvent:function(b,f,a){var c=jQuery.progressIndicator();var e=b.start.format();var d={module:"Calendar",action:"Calendar",mode:"updateEvent",id:b.id,start:e,delta:f._data,allDay:b.allDay};AppConnector.request(d).then(function(g){c.hide();if(!g.result){Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_NO_EDIT_PERMISSION"));a()}},function(g){c.hide();Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_NO_EDIT_PERMISSION"));a()})},selectDays:function(f,b){var c=this;if(b.hasTime()==false){b.add(-1,"days")}f=f.format();b=b.format();var a=c.getCalendarView().fullCalendar("getView");if(a.name=="month"){var e=$("#start_hour").val();var d=$("#end_hour").val();if(e==""){e="00"}if(d==""){d="00"}f=f+"T"+e+":00";b=b+"T"+d+":00"}this.getCalendarCreateView().then(function(l){if(l.length<=0){return}var g=l.find('[name="date_start"]').data("dateFormat");var k=l.find('[name="time_start"]').data("format");if(k==24){var n="HH:mm"}else{n="hh:mm tt"}var p=Date.parse(f);var r=app.getDateInVtigerFormat(g,p);var i=p.toString(n);var j=Date.parse(b);var m=app.getDateInVtigerFormat(g,j);var q=j.toString(n);l.find('[name="date_start"]').val(r);l.find('[name="due_date"]').val(m);l.find('[name="time_start"]').val(i);l.find('[name="time_end"]').val(q);l.find(".tabbable").before('<input type="hidden" name="selectedTimeStart" value="'+q+'">');var o=new Vtiger_Header_Js();o.handleQuickCreateData(l,{callbackFunction:function(s){c.addCalendarEvent(s.result)}});jQuery(".modal-body").css({"max-height":"500px","overflow-y":"auto"})})},addCalendarEvent:function(e){var f=$(".fc-toolbar input.switchBtn").bootstrapSwitch("state");var b={};var d=$.inArray(e.activitystatus,["PLL_POSTPONED","PLL_CANCELLED","PLL_COMPLETED"]);if(f==true&&d>=0){return false}if(f!=true&&d==-1){return false}b.id=e._recordId;b.title=e.subject.display_value;var a=Date.parse(e.date_start.display_value+"T"+e.time_start.display_value);b.start=a.toString();var g=Date.parse(e.due_date.display_value+"T"+e.time_end.display_value);var c=e.assigned_user_id.value;b.end=g.toString();b.url="index.php?module=Calendar&view=Detail&record="+e._recordId;b.activitytype=e.activitytype.value;if("on"==e.allday.value){b.allDay=true}else{b.allDay=false}b.state=e.state.value;b.vis=e.visibility.value;b.sta=e.activitystatus.value;b.className="userCol_"+e.assigned_user_id.value+" calCol_"+e.activitytype.value;this.getCalendarView().fullCalendar("renderEvent",b)},getCalendarCreateView:function(){var b=this;var a=jQuery.Deferred();if(this.calendarCreateView!==false){a.resolve(this.calendarCreateView.clone(true,true));return a.promise()}var c=jQuery.progressIndicator();this.loadCalendarCreateView().then(function(d){c.hide();b.calendarCreateView=d;a.resolve(d.clone(true,true))},function(){c.hide()});return a.promise()},loadCalendarCreateView:function(){var a=jQuery.Deferred();var d=app.getModuleName();var c="index.php?module="+d+"&view=QuickCreateAjax";var b=Vtiger_Header_Js.getInstance();b.getQuickCreateForm(c,d).then(function(e){a.resolve(jQuery(e))},function(){a.reject()});return a.promise()},getCalendarView:function(){if(this.calendarView==false){this.calendarView=jQuery("#calendarview")}return this.calendarView},registerChangeView:function(){var a=this;a.getCalendarView().find("button.fc-button:not(.dropdown-toggle)").click(function(){a.loadCalendarData()})},createAddButton:function(){var a=this;var b=this.getCalendarView();jQuery('<span class=""><button class="btn btn-default fc-button fc-state-default addButton">'+app.vtranslate("JS_ADD_EVENT_TASK")+"</button></span>").prependTo(b.find(".fc-toolbar .fc-right")).on("click","button",function(c){a.getCalendarCreateView().then(function(e){var d=new Vtiger_Header_Js();d.handleQuickCreateData(e,{callbackFunction:function(f){a.addCalendarEvent(f.result)}})})})},createAddSwitch:function(){var c=this;var d=this.getCalendarView();var b=jQuery(".listViewMassActions").clone(true,true);b.removeClass("hide");b.prependTo(d.find(".fc-toolbar .fc-left"));var a=jQuery('<span class=""><input class="switchBtn" type="checkbox" title="'+app.vtranslate("JS_CHANGE_ACTIVITY_TIME")+'" checked data-size="small" data-handle-width="90" data-label-width="5" data-on-text="'+app.vtranslate("JS_TO_REALIZE")+'" data-off-text="'+app.vtranslate("JS_HISTORY")+'"></span>').prependTo(d.find(".fc-toolbar .fc-right")).on("switchChange.bootstrapSwitch",function(g,f){if(f){jQuery("#showType").val("current")}else{jQuery("#showType").val("history")}c.loadCalendarData()});app.showBtnSwitch(a.find(".switchBtn"))},registerEvents:function(){this.registerCalendar();this.createAddButton();this.createAddSwitch();this.loadCalendarData(true);this.registerChangeView()}});jQuery(document).ready(function(){var a=Calendar_CalendarView_Js.getInstanceByView();a.registerEvents();Calendar_CalendarView_Js.currentInstance=a});