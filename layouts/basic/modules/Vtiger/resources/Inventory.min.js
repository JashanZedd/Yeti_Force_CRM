jQuery.Class("Vtiger_Inventory_Js",{},{inventoryContainer:!1,inventoryHeadContainer:!1,summaryTaxesContainer:!1,summaryDiscountContainer:!1,summaryCurrenciesContainer:!1,rowClass:"tr.inventoryRow",discountModalFields:["aggregationType","globalDiscount","groupCheckbox","groupDiscount","individualDiscount","individualDiscountType"],taxModalFields:["aggregationType","globalTax","groupCheckbox","groupTax","individualTax"],getInventoryItemsContainer:function(){return this.inventoryContainer===!1&&(this.inventoryContainer=$(".inventoryItems")),this.inventoryContainer},getInventoryHeadContainer:function(){return this.inventoryHeadContainer===!1&&(this.inventoryHeadContainer=$(".inventoryHeader")),this.inventoryHeadContainer},getInventorySummaryDiscountContainer:function(){return this.summaryDiscountContainer===!1&&(this.summaryDiscountContainer=$(".inventorySummaryDiscounts")),this.summaryDiscountContainer},getInventorySummaryTaxesContainer:function(){return this.summaryTaxesContainer===!1&&(this.summaryTaxesContainer=$(".inventorySummaryTaxes")),this.summaryTaxesContainer},getInventorySummaryCurrenciesContainer:function(){return this.summaryCurrenciesContainer===!1&&(this.summaryCurrenciesContainer=$(".inventorySummaryCurrencies")),this.summaryCurrenciesContainer},getNextLineItemRowNumber:function(){var e=$("#inventoryItemsNo"),t=parseInt(e.val());return e.val(t+1),++t},getAccountId:function(){var e=$("#accountReferenceField").val();return""!=e?$('[name="'+e+'"]').val():""},checkDeleteIcon:function(){var e=this.getInventoryItemsContainer();e.find(this.rowClass).length>1?this.showLineItemsDeleteIcon():this.hideLineItemsDeleteIcon()},showLineItemsDeleteIcon:function(){this.getInventoryItemsContainer().find(".deleteRow").removeClass("hide")},hideLineItemsDeleteIcon:function(){this.getInventoryItemsContainer().find(".deleteRow").addClass("hide")},getClosestRow:function(e){return e.closest(this.rowClass)},getBasicRow:function(){return $("#blackIthemTable").find("tbody").clone(!0,!0)},isRecordSelected:function(e){var t=e.closest("tr"),a=t.find(".recordLabel");return a.validationEngine("validate")},getTaxModeSelectElement:function(e){var t=this.getInventoryHeadContainer();return t.find("thead .taxMode").length>0?$(".taxMode"):!!e&&e.find(".taxMode")},isIndividualTaxMode:function(e){var t=this.getTaxModeSelectElement(e),a=t.find("option:selected");return"1"==a.val()},isGroupTaxMode:function(){var e=this.getTaxModeSelectElement();if(e){var t=e.find("option:selected");if("0"==t.val())return!0}return!1},showIndividualTax:function(e){var t=this,a=t.getInventorySummaryTaxesContainer().find(".groupTax"),n=t.getInventoryItemsContainer(),i=$("#blackIthemTable").find("tbody");t.isIndividualTaxMode()?(a.addClass("hide"),n.find(".changeTax").removeClass("hide"),i.find(".changeTax").removeClass("hide")):(a.removeClass("hide"),n.find(".changeTax").addClass("hide"),i.find(".changeTax").addClass("hide")),t.setTax(n,0),t.setTaxParam(n,[]),t.rowsCalculations()},getDiscountModeSelectElement:function(e){var t=this.getInventoryHeadContainer();return t.find("thead .discountMode").length>0?$(".discountMode"):e.find(".discountMode")},isIndividualDiscountMode:function(e){var t=this.getDiscountModeSelectElement(e),a=t.find("option:selected");return"1"==a.val()},showIndividualDiscount:function(e){var t=this,a=t.getInventorySummaryDiscountContainer().find(".groupDiscount"),n=t.getInventoryItemsContainer(),i=$("#blackIthemTable").find("tbody");t.isIndividualDiscountMode()?(a.addClass("hide"),n.find(".changeDiscount").removeClass("hide"),i.find(".changeDiscount").removeClass("hide")):(a.removeClass("hide"),n.find(".changeDiscount").addClass("hide"),n.find(".changeDiscount").addClass("hide")),t.setDiscount(n,0),t.setDiscountParam(n,[]),t.rowsCalculations()},getCurrency:function(){var e=$('[name="currency"]',this.getInventoryHeadContainer());return e.find("option:selected").val()},getTax:function(e){return $(".tax",e).getNumberFromValue()},getQuantityValue:function(e){return $(".qty",e).getNumberFromValue()},getUnitPriceValue:function(e){return $(".unitPrice",e).getNumberFromValue()},getDiscount:function(e){return $(".discount",e).getNumberFromValue()},getNetPrice:function(e){return $(".netPrice",e).getNumberFromValue()},getTotalPrice:function(e){return 0!=$(".totalPrice",e).length?$(".totalPrice",e).getNumberFromValue():0},getGrossPrice:function(e){return $(".grossPrice",e).getNumberFromValue()},getPurchase:function(e){var t=this.getQuantityValue(e),a=$(".purchase",e),n=0;return a.length>0&&(n=app.parseNumberToFloat(a.val())),n*t},getSummaryGrossPrice:function(){var e=this,t=0;return this.getInventoryItemsContainer().find(e.rowClass).each(function(a){t+=e.getGrossPrice($(this))}),app.parseNumberToFloat(t)},setUnitPrice:function(e,t){return t=app.parseNumberToShow(t),e.find(".unitPrice").val(t).attr("title",t),this},setNetPrice:function(e,t){t=app.parseNumberToShow(t),$(".netPriceText",e).text(t),$(".netPrice",e).val(t)},setGrossPrice:function(e,t){t=app.parseNumberToShow(t),$(".grossPriceText",e).text(t),$(".grossPrice",e).val(t)},setTotalPrice:function(e,t){t=app.parseNumberToShow(t),$(".totalPriceText",e).text(t),$(".totalPrice",e).val(t)},setMargin:function(e,t){t=app.parseNumberToShow(t),$(".margin",e).val(t)},setMarginP:function(e,t){t=app.parseNumberToShow(t),$(".marginp",e).val(t)},setDiscount:function(e,t){t=app.parseNumberToShow(t),$(".discount",e).val(t)},setDiscountParam:function(e,t){$(".discountParam",e).val(JSON.stringify(t))},setTax:function(e,t){t=app.parseNumberToShow(t),$(".tax",e).val(t)},setTaxParam:function(e,t){$(".taxParam",e).val(JSON.stringify(t))},quantityChangeActions:function(e){this.rowCalculations(e),this.summaryCalculations()},rowCalculations:function(e){this.calculateTotalPrice(e),this.calculateDiscounts(e),this.calculateNetPrice(e),this.calculateTaxes(e),this.calculateGrossPrice(e),this.calculateMargin(e)},rowsCalculations:function(){var e=this;this.getInventoryItemsContainer().find(e.rowClass).each(function(t){e.quantityChangeActions($(this))}),e.calculateItemNumbers()},calculateDiscounts:function(e){var t=e.find(".discountParam").val(),a=$(".aggregationTypeDiscount").val();if(""==t||"[]"==t||void 0==t)return 0;t=JSON.parse(t);var n=this.getTotalPrice(e),i=0,r=t.aggregationType;"string"==typeof r&&(r=[r]),r&&r.forEach(function(e){var r;if("individual"==e){r=t.individualDiscount;var o=t.individualDiscountType;i+="percentage"==o?n*(r/100):app.parseNumberToFloat(r)}"global"==e&&(r=t.globalDiscount,i+=n*(r/100)),"group"==e&&(r=t.groupDiscount,i+=n*(r/100)),"2"==a&&(n-=i)}),this.setDiscount(e,i)},calculateTaxes:function(e){var t=e.find(".taxParam").val();if(""==t||"[]"==t||void 0==t)return 0;t=JSON.parse(t);var a=$(".aggregationTypeTax").val(),n=this.getNetPrice(e),i=0,r=t.aggregationType;"string"==typeof r&&(r=[r]),r&&r.forEach(function(e){var r=0;"individual"==e&&(r=t.individualTax),"global"==e&&(r=t.globalTax),"group"==e&&(r=t.groupTax),"regional"==e&&(r=t.regionalTax),i+=n*(app.parseNumberToFloat(r)/100),"2"==a&&(n+=i)}),this.setTax(e,i)},summaryCalculations:function(){var e=this;e.getInventoryItemsContainer().find("tfoot .wisableTd").each(function(t){e.calculatSummary($(this),$(this).data("sumfield"))}),e.calculatDiscountSummary(),e.calculatTaxSummary(),e.calculatCurrenciesSummary(),e.calculatMarginPSummary()},calculatSummary:function(e,t){var a=this,n=0;this.getInventoryItemsContainer().find(a.rowClass).each(function(e){var a=$(this).find("."+t);a.length>0&&(n+=app.parseNumberToFloat(a.val()))}),e.text(app.parseNumberToShow(n))},calculatMarginPSummary:function(){var e,t=this,a=t.getInventoryItemsContainer().find("tfoot");e=jQuery('[data-sumfield="netPrice"]',a).length?a.find('[data-sumfield="netPrice"]').text():a.find('[data-sumfield="totalPrice"]').text(),e=app.parseNumberToFloat(e);var n=app.parseNumberToFloat(a.find('[data-sumfield="purchase"]').text()),i=e-n,r="0";0!==n&&(r=i/n*100),a.find('[data-sumfield="marginP"]').text(app.parseNumberToShow(r))},calculatDiscountSummary:function(){var e=this,t=e.getAllDiscount(),a=e.getInventorySummaryDiscountContainer();a.find("input").val(app.parseNumberToShow(t))},getAllDiscount:function(){var e=this,t=0;return this.getInventoryItemsContainer().find(e.rowClass).each(function(a){var n=$(this);t+=e.getDiscount(n)}),t},calculatCurrenciesSummary:function(){var e=this,t=e.getInventorySummaryCurrenciesContainer(),a=$('[name="currency"] option:selected',e.getInventoryHeadContainer()),n=$('[name="currency"] option[data-base-currency="1"]',e.getInventoryHeadContainer()),i=a.data("conversionRate"),r=n.data("conversionRate");if(i==r)return void t.addClass("hide");i=parseFloat(r)/parseFloat(i),t.removeClass("hide");var o=e.getAllTaxs(),s=0;t.find(".panel-body").html(""),$.each(o,function(e,a){if(void 0!=a){a*=i;var n=t.find(".hide .form-group").clone();n.find(".percent").text(e+"%"),n.find("input").val(app.parseNumberToShow(a)),n.appendTo(t.find(".panel-body")),s+=a}}),t.find(".panel-footer input").val(app.parseNumberToShow(s))},calculatTaxSummary:function(){var e=this,t=e.getAllTaxs(),a=e.getInventorySummaryTaxesContainer();a.find(".panel-body").html("");var n=0;for(var i in t){var r=a.find(".hide .form-group").clone();r.find(".percent").text(app.parseNumberToShow(app.parseNumberToFloat(i))+"%"),r.find("input").val(app.parseNumberToShow(t[i])),r.appendTo(a.find(".panel-body")),n+=t[i]}a.find(".panel-footer input").val(app.parseNumberToShow(n))},getAllTaxs:function(){var e=this,t=[],a=$(".aggregationTypeTax").val();return this.getInventoryItemsContainer().find(e.rowClass).each(function(n){var i=$(this),r=e.getNetPrice(i),o=i.find(".taxParam").val();if(""!=o&&"[]"!=o&&void 0!=o){var s=$.parseJSON(o);"string"==typeof s.aggregationType&&(s.aggregationType=[s.aggregationType]),s.aggregationType&&$.each(s.aggregationType,function(e,n){n+="Tax";var i=s[n],o=0;void 0!=t[i]&&(o=parseFloat(t[i]));var c=r*(app.parseNumberToFloat(i)/100);t[i]=o+c,"2"==a&&(r+=c)})}}),t},calculateNetPrice:function(e){var t=this.getTotalPrice(e)-this.getDiscount(e);this.setNetPrice(e,t)},calculateGrossPrice:function(e){var t=this.getNetPrice(e);(this.isIndividualTaxMode(e)||this.isGroupTaxMode(e))&&(t+=this.getTax(e)),this.setGrossPrice(e,t)},calculateTotalPrice:function(e){var t=this.getQuantityValue(e)*this.getUnitPriceValue(e);this.setTotalPrice(e,t)},calculateMargin:function(e){var t;t=jQuery(".netPrice",e).length?this.getNetPrice(e):this.getTotalPrice(e);var a=this.getPurchase(e),n=t-a;this.setMargin(e,n);var i="0";0!==a&&(i=n/a*100),this.setMarginP(e,i)},calculateDiscount:function(e,t){var a=app.parseNumberToFloat(t.find(".valueTotalPrice").text()),n=a,i=0,r=0,o=0,s=t.find(".discountsType").val();if("0"==s||"1"==s){if(t.find(".activepanel .globalDiscount").length>0&&(i=app.parseNumberToFloat(t.find(".activepanel .globalDiscount").val())),t.find(".activepanel .individualDiscountType").length>0){var c=t.find(".activepanel .individualDiscountType:checked").val(),u=app.parseNumberToFloat(t.find(".activepanel .individualDiscountValue").val());o="percentage"==c?a*(u/100):u}t.find(".activepanel .groupCheckbox").length>0&&1==t.find(".activepanel .groupCheckbox").prop("checked")&&(r=app.parseNumberToFloat(t.find(".groupValue").val()),r=a*(r/100)),n*=(100-i)/100,n-=o,n-=r}else"2"==s&&t.find(".activepanel").each(function(e){var t=$(this);if(t.find(".globalDiscount").length>0){var a=app.parseNumberToFloat(t.find(".globalDiscount").val());n*=(100-a)/100}else if(t.find(".groupCheckbox").length>0&&1==t.find(".groupCheckbox").prop("checked")){var i=app.parseNumberToFloat(t.find(".groupValue").val());n*=(100-i)/100}else if(t.find(".individualDiscountType").length>0){var r=app.parseNumberToFloat(t.find(".individualDiscountValue").val());"percentage"==t.find('.individualDiscountType[name="individual"]:checked').val()?n*=(100-r)/100:n-=r}});t.find(".valuePrices").text(app.parseNumberToShow(n)),t.find(".valueDiscount").text(app.parseNumberToShow(a-n))},calculateTax:function(e,t){var a=app.parseNumberToFloat(t.find(".valueNetPrice").text()),n=a,i=0,r=0,o=0,s=0,c=t.find(".taxsType").val();if("0"==c||"1"==c){if(t.find(".activepanel .globalTax").length>0&&(i=app.parseNumberToFloat(t.find(".activepanel .globalTax").val())),t.find(".activepanel .individualTaxValue").length>0){var u=app.parseNumberToFloat(t.find(".activepanel .individualTaxValue").val());s=u/100*n}t.find(".activepanel .groupTax").length>0&&(r=app.parseNumberToFloat(t.find(".groupTax").val()),r=a*(r/100)),t.find(".activepanel .regionalTax").length>0&&(o=app.parseNumberToFloat(t.find(".regionalTax").val()),o=a*(o/100)),n*=(100+i)/100,n+=s,n+=r,n+=o}else"2"==c&&t.find(".activepanel").each(function(e){var t=$(this);if(t.find(".globalTax").length>0){var a=app.parseNumberToFloat(t.find(".globalTax").val());n*=(100+a)/100}else if(t.find(".groupTax").length>0){var i=app.parseNumberToFloat(t.find(".groupTax").val());n*=(100+i)/100}else if(t.find(".regionalTax").length>0){var r=app.parseNumberToFloat(t.find(".regionalTax").val());n*=(100+r)/100}else if(t.find(".individualTaxValue").length>0){var o=app.parseNumberToFloat(t.find(".individualTaxValue").val());n=(o+100)/100*n}});t.find(".valuePrices").text(app.parseNumberToShow(n)),t.find(".valueTax").text(app.parseNumberToShow(n-a))},updateRowSequence:function(){var e=this.getInventoryItemsContainer();e.find(this.rowClass).each(function(e){$(this).find(".sequence").val(e+1)})},registerInventorySaveData:function(e){var t=this;e.on(Vtiger_Edit_Js.recordPreSave,function(a,n){if(!t.checkLimits(e))return!1;var i=e.find("#blackIthemTable");i.find("[name]").removeAttr("name")})},pricebooksPopupHandler:function(e){var t=this,a=e.closest(this.rowClass),n=a.find(".rowName"),i={};i.module="PriceBooks",i.src_module=$('[name="popupReferenceModule"]',n).val(),i.src_record=$(".sourceField",n).val(),i.src_field=$('[name="popupReferenceModule"]',n).data("field"),i.get_url="getProductUnitPriceURL",i.currency_id=t.getCurrency(),this.showPopup(i).then(function(e){var i=JSON.parse(e);for(var r in i)t.setUnitPrice(a,i[r]);t.quantityChangeActions(t.getClosestRow(n))})},showPopup:function(e){var t=$.Deferred(),a=Vtiger_Popup_Js.getInstance();return a.show(e,function(e){t.resolve(e)}),t.promise()},subProductsCashe:[],loadSubProducts:function(e,t){var a=this,n=jQuery("input.sourceField",e).val(),i=e.find('.rowName input[name="popupReferenceModule"]').val();if(a.removeSubProducts(e),"0"==n||$.inArray(i,["Products","Services"])<0)return!1;if(a.subProductsCashe[n])return a.addSubProducts(e,a.subProductsCashe[n]),!1;var r={module:"Products",action:"SubProducts",record:n};if(t)var o=jQuery.progressIndicator();AppConnector.request(r).then(function(t){var i=t.result;a.subProductsCashe[n]=i,a.addSubProducts(e,i),o&&o.hide()},function(e,t){o&&o.hide(),console.error(e,t)})},removeSubProducts:function(e){var t=$(".subProductsContainer ul",e);t.find("li").remove()},addSubProducts:function(e,t){var a=$(".subProductsContainer ul",e);for(var n in t){var i=$("<li>").text(t[n]);a.append(i)}},mapResultsToFields:function(e,t,a){var n,i,r=this;for(var o in a){var s=a[o],c=s.description,u=s.unitPriceValues,l=JSON.stringify(u);for(var d in s.autoFields)t.find("input."+d).val(s.autoFields[d]),s.autoFields[d+"Text"]&&t.find("."+d+"Text").text(s.autoFields[d+"Text"]);var p=r.getCurrency();if(i="undefined"!=typeof u[p]?u[p]:s.price,r.setUnitPrice(t,app.parseNumberToFloat(i)),$("input.unitPrice",t).attr("list-info",l),$("textarea.commentTextarea",t).val(c),"undefined"!=typeof s.autoFields.unit)switch($("input.qtyparam",t).prop("checked",!1),s.autoFields.unit){default:$(".qtyparamButton",t).addClass("hidden"),n="validate[required,funcCall[Vtiger_NumberUserFormat_Validator_Js.invokeValidation]]",$("input.qty",t).attr("data-validation-engine",n);break;case"pack":$(".qtyparamButton",t).removeClass("hidden"),$(".qtyparamButton",t).removeClass("active"),n="validate[required,funcCall[Vtiger_WholeNumber_Validator_Js.invokeValidation]]",$("input.qty",t).attr("data-validation-engine",n);break;case"pcs":$(".qtyparamButton",t).addClass("hidden"),n="validate[required,funcCall[Vtiger_WholeNumber_Validator_Js.invokeValidation]]",$("input.qty",t).attr("data-validation-engine",n)}}"Products"===e&&r.loadSubProducts(t,!0),r.quantityChangeActions(t)},saveDiscountsParameters:function(e,t){var a=this,n={},i=["aggregationType","groupCheckbox","individualDiscountType"];$.each(a.discountModalFields,function(e,a){$.inArray(a,i)>=0?t.find('[name="'+a+'"]:checked').length>1?(n[a]=[],t.find('[name="'+a+'"]:checked').each(function(e){n[a].push($(this).val())})):n[a]=t.find('[name="'+a+'"]:checked').val():n[a]=t.find('[name="'+a+'"]').val()}),a.setDiscountParam($("#blackIthemTable"),n),a.setDiscountParam(e,n)},saveTaxsParameters:function(e,t){var a=this,n={},i=["aggregationType","groupCheckbox","individualTaxType"];$.each(a.taxModalFields,function(e,a){$.inArray(a,i)>=0?t.find('[name="'+a+'"]:checked').length>1?(n[a]=[],t.find('[name="'+a+'"]:checked').each(function(e){n[a].push($(this).val())})):n[a]=t.find('[name="'+a+'"]:checked').val():n[a]=t.find('[name="'+a+'"]').val()}),a.setTaxParam(e,n),a.setTaxParam($("#blackIthemTable"),n)},showExpandedRow:function(e){var t=this,a=t.getInventoryItemsContainer(),n=a.find('[numrowex="'+e.attr("numrow")+'"]'),i=e.find(".toggleVisibility");i.data("status","1"),i.find(".glyphicon").removeClass("glyphicon-menu-down"),i.find(".glyphicon").addClass("glyphicon-menu-up"),n.removeClass("hide");var r=Vtiger_Edit_Js.getInstance();$.each(n.find(".ckEditorSource"),function(e,t){r.loadCkEditorElement(jQuery(t))})},hideExpandedRow:function(e){var t=this,a=t.getInventoryItemsContainer(),n=a.find('[numrowex="'+e.attr("numrow")+'"]'),i=e.find(".toggleVisibility");i.data("status","0"),i.find(".glyphicon").removeClass("glyphicon-menu-up"),i.find(".glyphicon").addClass("glyphicon-menu-down"),n.addClass("hide"),$.each(n.find(".ckEditorSource"),function(e,t){var a=CKEDITOR.instances[jQuery(t).attr("id")];a&&a.destroy()})},initDiscountsParameters:function(e,t){var a=this,n=e.find(".discountParam").val();""!=n&&void 0!=n&&(n=JSON.parse(n),$.each(a.discountModalFields,function(e,a){var i=n[a],r=t.find('[name="'+a+'"]');if("checkbox"==r.attr("type")||"radio"==r.attr("type")){var o=i;$.isArray(o)||(o=[o]),$.each(o,function(e,t){var n=r.filter('[value="'+t+'"]').prop("checked",!0);"aggregationType"==a&&(n.closest(".panel").find(".panel-body").show(),n.closest(".panel").addClass("activepanel"))})}else"SELECT"==r.prop("tagName")?r.find('option[value="'+i+'"]').prop("selected","selected").change():t.find('[name="'+a+'"]').val(i)}),a.calculateDiscount(e,t))},initTaxParameters:function(e,t){var a=this,n=e.find(".taxParam").val();""!=n&&(n=JSON.parse(n),$.each(a.taxModalFields,function(e,a){var i=n[a],r=t.find('[name="'+a+'"]');if("checkbox"==r.attr("type")||"radio"==r.attr("type")){var o=i;$.isArray(o)||(o=[o]),$.each(o,function(e,t){var n=r.filter('[value="'+t+'"]').prop("checked",!0);"aggregationType"==a&&(n.closest(".panel").find(".panel-body").show(),n.closest(".panel").addClass("activepanel"))})}else"SELECT"==r.prop("tagName")?r.find('option[value="'+i+'"]').prop("selected","selected").change():t.find('[name="'+a+'"]').val(i)}),a.calculateTax(e,t))},limitEnableSave:!1,checkLimits:function(){var e=this,t=e.getAccountId(),a=!0;if(""==t||e.limitEnableSave)return a;var n={};n.data={module:app.getModuleName(),action:"Inventory",mode:"checkLimits",record:t,currency:e.getCurrency(),price:e.getSummaryGrossPrice(),limitConfig:app.getMainParams("inventoryLimit")},n.async=!1,n.dataType="json";var i=jQuery.progressIndicator();return AppConnector.request(n).then(function(t){i.hide();var n=Vtiger_Edit_Js.getInstance().getForm();0==t.result.status&&(app.showModalWindow(t.result.html,function(t){t.find(".enableSave").on("click",function(t,a){e.limitEnableSave=!0,n.submit(),app.hideModalWindow()})}),a=!1)},function(e,t){i.hide(),console.error(e,t)}),a},currencyChangeActions:function(e,t){var a=this;0==t.data("baseCurrency")?a.showCurrencyChangeModal(e,t):(a.currencyConvertValues(e,t),e.data("oldValue",e.val()))},showCurrencyChangeModal:function(e,t){var a=this;if(1!=a.lockCurrencyChange){a.lockCurrencyChange=!0;var n=e.closest("th"),i=n.find(".modelContainer").clone();app.showModalWindow(i,function(i){var r=$(i),o=JSON.parse(n.find(".currencyparam").val());0!=o&&("undefined"==typeof o[t.val()]&&(o[t.val()].value=1,o[t.val()].date=""),r.find(".currencyName").text(t.text()),r.find(".currencyRate").val(o[t.val()].value),r.find(".currencyDate").text(o[t.val()].date)),r.on("click",'button[type="submit"]',function(i){var s=r.find(".currencyRate").val(),c=app.parseNumberToFloat(s),u=1/app.parseNumberToFloat(s);t.data("conversionRate",u),o[t.val()].value=c,o[t.val()].conversion=u,n.find(".currencyparam").val(JSON.stringify(o)),a.currencyConvertValues(e,t),e.data("oldValue",e.val()),app.hideModalWindow(),a.lockCurrencyChange=!1}),r.on("click",'button[type="reset"]',function(t){e.val(e.data("oldValue")).change(),a.lockCurrencyChange=!1})})}},currencyConvertValues:function(e,t){var a=this,n=e.find('option[value="'+e.data("oldValue")+'"]'),i=t.data("conversionRate"),r=n.data("conversionRate");i=parseFloat(i)/parseFloat(r),this.getInventoryItemsContainer().find(a.rowClass).each(function(e){var t=$(this);a.setUnitPrice(t,app.parseNumberToFloat(a.getUnitPriceValue(t)*i)),a.setDiscount(t,app.parseNumberToFloat(a.getDiscount(t)*i)),a.setTax(t,app.parseNumberToFloat(a.getTax(t)*i)),a.quantityChangeActions(t)})},registerAddItem:function(e){var t=this,a=this.getInventoryItemsContainer();e.find(".btn-toolbar .addItem").on("click",function(n,i){var r=(e.find("#blackIthemTable"),t.getBasicRow()),o=t.getNextLineItemRowNumber(),s=$(n.currentTarget).data("module"),c=$(n.currentTarget).data("field"),u=($(n.currentTarget).data("wysiwyg"),r.html().replace(/_NUM_/g,o));r.html(u),r=r.find("tr").appendTo(a.find("tbody")),r.find('.rowName input[name="popupReferenceModule"]').val(s).data("field",c),r.find("select").each(function(e,t){t=$(t),t.find("option").each(function(e,t){t=$(t),t.data("module")!=s&&t.remove()}),app.showSelect2ElementView(t)}),t.initItem(r),Vtiger_Edit_Js.getInstance().registerAutoCompleteFields(r)})},registerSortableItems:function(){var e=this,t=e.getInventoryItemsContainer();t.sortable({handle:".dragHandle",items:e.rowClass,revert:!0,tolerance:"pointer",placeholder:"ui-state-highlight",helper:function(e,t){return t.children().each(function(e,t){t=$(t),t.width(t.width())}),t},start:function(a,n){t.find(e.rowClass).each(function(t,a){var n=$(a);e.hideExpandedRow(n)}),n.item.startPos=n.item.index()},stop:function(a,n){var i=$(n.item.context).attr("numrow"),r=t.find(".numRow"+i).remove().clone();t.find('[numrow="'+i+'"]').after(r),n.item.startPos<n.item.index()&&(r=t.find(".numRow"+i).next().remove().clone(),t.find('[numrow="'+i+'"]').before(r)),e.updateRowSequence()}})},registerShowHideExpanded:function(e){var t=this;e.on("click",".toggleVisibility",function(e){var a=$(e.currentTarget),n=t.getClosestRow(a);"0"==a.data("status")?t.showExpandedRow(n):t.hideExpandedRow(n)})},registerPriceBookPopUp:function(e){var t=this;e.on("click",".priceBookPopup",function(e){var a=$(e.currentTarget),n=t.isRecordSelected(a);1!=n&&t.pricebooksPopupHandler(a)})},registerRowChangeEvent:function(e){var t=this;e.on("focusout",".qty",function(e){var a=$(e.currentTarget);t.quantityChangeActions(t.getClosestRow(a))}),e.on("focusout",".unitPrice",function(e){var a=$(e.currentTarget);t.quantityChangeActions(t.getClosestRow(a))}),e.on("focusout",".purchase",function(e){var a=$(e.currentTarget);t.quantityChangeActions(t.getClosestRow(a))});var a=t.getInventoryHeadContainer();a.on("change",".taxMode",function(e){var a=$(e.currentTarget);t.showIndividualTax(t.getClosestRow(a)),t.rowsCalculations()}),a.on("change",".discountMode",function(e){var a=$(e.currentTarget);t.showIndividualDiscount(t.getClosestRow(a)),t.rowsCalculations()})},registerSubProducts:function(e){var t=this;e.find(".inventoryItems "+t.rowClass).each(function(e){t.loadSubProducts($(this),!1)})},registerClearReferenceSelection:function(e){var t=this;e.on("click",".clearReferenceSelection",function(e){var a=$(e.currentTarget),n=t.getClosestRow(a);t.removeSubProducts(n),n.find(".unitPrice,.tax,.discount,.margin,.purchase").val("0"),n.find("textarea,.valueVal").val(""),n.find(".valueText").text(""),n.find(".qtyparamButton").addClass("hidden"),n.find("input.qtyparam").prop("checked",!1),t.quantityChangeActions(n)})},registerDeleteLineItemEvent:function(e){var t=this;e.on("click",".deleteRow",function(e){var a=$(e.currentTarget);t.getClosestRow(a).remove(),t.checkDeleteIcon(),t.rowsCalculations()})},registerChangeDiscount:function(e){var t=this;e.on("click",".changeDiscount",function(e){var a,n=$(e.currentTarget),i={module:app.getModuleName(),view:"Inventory",mode:"showDiscounts",currency:t.getCurrency(),relatedRecord:t.getAccountId()};n.hasClass("groupDiscount")?(a=t.getInventoryItemsContainer(),0!=a.find("tfoot .colTotalPrice").length?i.totalPrice=app.parseNumberToFloat(a.find("tfoot .colTotalPrice").text()):i.totalPrice=0,i.discountType=1):(a=n.closest(t.rowClass),i.totalPrice=t.getTotalPrice(a),i.discountType=0);var r=jQuery.progressIndicator();AppConnector.request(i).then(function(e){app.showModalWindow(e,function(e){t.initDiscountsParameters(a,$(e)),t.registerChangeDiscountModal(e,a,i)}),r.hide()},function(e,t){r.hide(),console.error(e,t)})})},registerChangeDiscountModal:function(e,t,a){var n=this;e.on("change",".individualDiscountType",function(t){var a=$(t.currentTarget);e.find(".individualDiscountContainer .input-group-addon").text(a.data("symbol"))}),e.on("change",'.activeCheckbox[name="aggregationType"]',function(t){var a=$(t.currentTarget);"checkbox"==a.attr("type")&&this.checked?(a.closest(".panel").find(".panel-body").show(),a.closest(".panel").addClass("activepanel")):"radio"==a.attr("type")?(e.find(".panel").removeClass("activepanel"),e.find(".panel .panel-body").hide(),a.closest(".panel").find(".panel-body").show(),a.closest(".panel").addClass("activepanel")):(a.closest(".panel").find(".panel-body").hide(),a.closest(".panel").removeClass("activepanel"))}),e.on("change",".activeCheckbox, .globalDiscount,.individualDiscountValue,.individualDiscountType,.groupCheckbox",function(a){$(a.currentTarget);n.calculateDiscount(t,e)}),e.on("click",".saveDiscount",function(i){if(n.saveDiscountsParameters(t,e),0==a.discountType)n.setDiscount(t,app.parseNumberToFloat(e.find(".valueDiscount").text())),n.quantityChangeActions(t);else{var r=app.parseNumberToFloat(e.find(".valueDiscount").text())/app.parseNumberToFloat(e.find(".valueTotalPrice").text());t.find(n.rowClass).each(function(e){n.setDiscount($(this),n.getTotalPrice($(this))*r),n.quantityChangeActions($(this))})}app.hideModalWindow()})},registerChangeTax:function(e){var t=this;e.on("click",".changeTax",function(e){var a,n=$(e.currentTarget),i={module:app.getModuleName(),view:"Inventory",mode:"showTaxes",currency:t.getCurrency(),sourceRecord:app.getRecordId()};if(n.hasClass("groupTax")){a=t.getInventoryItemsContainer();var r=0;a.find("tfoot .colNetPrice").length>0?r=a.find("tfoot .colNetPrice").text():a.find("tfoot .colTotalPrice ").length>0&&(r=a.find("tfoot .colTotalPrice ").text()),i.totalPrice=app.parseNumberToFloat(r),i.taxType=1}else a=n.closest(t.rowClass),i.totalPrice=t.getNetPrice(a),i.taxType=0,i.record=a.find(".rowName .sourceField").val(),i.recordModule=a.find('.rowName [name="popupReferenceModule"]').val();var o=jQuery.progressIndicator();AppConnector.request(i).then(function(e){app.showModalWindow(e,function(e){t.initTaxParameters(a,$(e)),t.registerChangeTaxModal(e,a,i)}),o.hide()},function(e,t){o.hide(),console.error(e,t)})})},lockCurrencyChange:!1,registerChangeCurrency:function(e){var t=this;e.on("change",'[name="currency"]',function(a){var n=$(a.currentTarget),i=n.find("option:selected").data("conversionSymbol");t.currencyChangeActions(n,n.find("option:selected")),e.find(".currencySymbol").text(i)})},registerChangeTaxModal:function(e,t,a){var n=this;e.on("change",".individualTaxType",function(t){var a=$(t.currentTarget);e.find(".individualTaxContainer .input-group-addon").text(a.data("symbol"))}),e.on("change",'.activeCheckbox[name="aggregationType"]',function(t){var a=$(t.currentTarget);"checkbox"==a.attr("type")&&this.checked?(a.closest(".panel").find(".panel-body").show(),a.closest(".panel").addClass("activepanel")):"radio"==a.attr("type")?(e.find(".panel").removeClass("activepanel"),e.find(".panel .panel-body").hide(),a.closest(".panel").find(".panel-body").show(),a.closest(".panel").addClass("activepanel")):(a.closest(".panel").find(".panel-body").hide(),a.closest(".panel").removeClass("activepanel"))}),e.on("change",".activeCheckbox, .globalTax, .individualTaxValue, .groupTax, .regionalTax",function(a){$(a.currentTarget);n.calculateTax(t,e)}),e.on("click",".saveTaxs",function(i){if(n.saveTaxsParameters(t,e),"0"==a.taxType)n.setTax(t,app.parseNumberToFloat(e.find(".valueTax").text())),n.quantityChangeActions(t);else{var r=app.parseNumberToFloat(e.find(".valueTax").text())/app.parseNumberToFloat(e.find(".valueNetPrice").text());t.find(n.rowClass).each(function(e){var t;$(".netPrice",$(this)).length>0?t=n.getNetPrice($(this)):$(".totalPrice",$(this)).length>0&&(t=n.getTotalPrice($(this))),n.setTax($(this),t*r),n.quantityChangeActions($(this))})}app.hideModalWindow()})},registerRowAutoComplete:function(e){var t=this,a=e.find(".rowName .sourceField");a.on(Vtiger_Edit_Js.postReferenceSelectionEvent,function(e,a){var n,i=$(e.currentTarget),r=i.closest(t.rowClass);if(a.data.label)n=a.data.id;else for(var o in a.data)n=o;var s=r.find('.rowName [name="popupReferenceModule"]').val(),c="index.php?module="+app.getModuleName()+"&action=Inventory&mode=getDetails&record="+n+"&currency_id="+t.getCurrency();AppConnector.request(c).then(function(e){for(var a in e)if("object"==typeof e[a]){var n=e[a];t.mapResultsToFields(s,r,n)}},function(e,t){console.error(e,t)})})},registerRowAutoCompleteAfterAdding:function(e){var t=this,a=e.find(".rowName .sourceField"),n=a.closest(t.rowClass),i=e.find(".sourceField").val(),r=n.find('.rowName [name="popupReferenceModule"]').val(),o="index.php?module="+app.getModuleName()+"&action=Inventory&mode=getDetails&record="+i+"&currency_id="+t.getCurrency();AppConnector.request(o).then(function(e){for(var a in e)if("object"==typeof e[a]){var i=e[a];t.mapResultsToFields(r,n,i)}},function(e,t){console.error(e,t)})},calculateItemNumbers:function(){var e=this,t=this.getInventoryItemsContainer(),a=1;t.find(e.rowClass).each(function(e){$(this).find(".itemNumberText").text(a),a++})},initItem:function(e){var t=this;"undefined"==typeof e&&(e=t.getInventoryItemsContainer()),t.registerDeleteLineItemEvent(e),t.registerPriceBookPopUp(e),t.registerRowChangeEvent(e),t.registerRowAutoComplete(e),t.checkDeleteIcon(),t.rowsCalculations(),t.updateRowSequence()},registerChangeQtyparam:function(e){e.on("click",".qtyparamButton",function(e){var t=$(e.currentTarget),a=t.data("rownum"),n=$('input[name="qtyparam'+a+'"]');n.is(":checked")?(t.removeClass("active"),n.prop("checked",!1)):(t.addClass("active"),n.prop("checked",!0))})},registerEvents:function(e){this.registerInventorySaveData(e),this.registerAddItem(e),this.initItem(),this.registerSortableItems(),this.registerSubProducts(e),this.registerChangeDiscount(e),this.registerChangeTax(e),this.registerClearReferenceSelection(e),this.registerShowHideExpanded(e),this.registerChangeCurrency(e),this.registerChangeQtyparam(e)}}),jQuery(document).ready(function(){var e=app.getModuleName(),t=e+"_Inventory_Js";if("undefined"==typeof window[t]&&(t="Vtiger_Inventory_Js"),"undefined"!=typeof window[t]){var a=new window[t];a.registerEvents(Vtiger_Edit_Js.getInstance().getForm())}});