
jQuery.Class("Vtiger_TreeCategory_Js",{},{modalContainer:false,treeInstance:false,treeData:false,getModalContainer:function(){if(this.modalContainer==false){this.modalContainer=jQuery("#modalTreeCategoryModal")}return this.modalContainer},getRecords:function(b){if(this.treeData==false&&b!="undefined"){var a=b.find("#treePopupValues").val();this.treeData=JSON.parse(a)}return this.treeData},generateTree:function(b){var c=this;if(c.treeInstance==false){c.treeInstance=b.find("#treePopupContents");var a=["search"];if(c.isActiveCategory()){a.push("category")}if(c.getRelationType()=="2"){a.push("checkbox")}if(c.getRelationType()=="1"){a.push("edit")}c.treeInstance.jstree({core:{data:c.getRecords(),themes:{name:"proton",responsive:true}},plugins:a})}},isActiveCategory:function(){return this.getModalContainer().find("#isActiveCategory").val()=="1"},getRelationType:function(){return this.getModalContainer().find("#relationType").val()},searching:function(a){this.treeInstance.jstree(true).search(a)},registerSearchEvent:function(){var c=this;var a=$("#valueSearchTree");var b=$("#btnSearchTree");a.keypress(function(d){if(d.which==13){c.searching(a.val())}});b.click(function(){c.searching(a.val())})},registerSaveRecords:function(c){var j=this;var d=[],f=[],h=[],a=[],b=[],g=[],e=[],i=[];$.each(j.getRecords(),function(k,l){if(l.state&&l.state.selected&&l.type=="record"){d.push(l.record_id)}if(l.category&&l.category.checked){f.push(l.record_id)}});c.find('[name="saveButton"]').on("click",function(k){$(this).attr("disabled","disabled");$.each(j.treeInstance.jstree("get_selected",true),function(l,m){if(jQuery.inArray(m.original.record_id,d)==-1&&m.original.type=="record"){b.push(m.original.record_id)}h.push(m.original.record_id)});$.each(d,function(l,m){if(jQuery.inArray(m,h)==-1){g.push(m)}});if(j.isActiveCategory()){a=j.treeInstance.jstree("getCategory");$.each(a,function(l,m){if(jQuery.inArray(m,f)==-1){e.push(m)}});$.each(f,function(l,m){if(jQuery.inArray(m,a)==-1){i.push(m)}})}AppConnector.request({module:app.getModuleName(),action:"RelationAjax",mode:"updateRelation",recordsToAdd:b,recordsToRemove:g,categoryToAdd:e,categoryToRemove:i,src_record:app.getRecordId(),related_module:c.find("#relatedModule").val(),}).then(function(l){Vtiger_Detail_Js.getInstance().reloadTabContent();app.hideModalWindow()})})},registerCounterSelected:function(){var a=this;this.treeInstance.on("changed.jstree",function(f,c){var d=0;var b="";$.each(a.treeInstance.jstree("get_selected",true),function(e,g){var h=g.original.record_id.toString();if(h.indexOf("T")){d++}});b=app.vtranslate("JS_SELECTED_ELEMENTS")+": "+d;$(".counterSelected").text(b)})},registerEvents:function(){var a=this.getModalContainer();this.getRecords(a);this.generateTree(a);this.registerSaveRecords(a);this.registerSearchEvent();this.registerCounterSelected()}});jQuery(function(){var a=new Vtiger_TreeCategory_Js();a.registerEvents()});