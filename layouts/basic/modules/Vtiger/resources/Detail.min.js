
jQuery.Class("Vtiger_Detail_Js",{detailInstance:false,SaveResultInstance:false,getInstance:function(){if(Vtiger_Detail_Js.detailInstance==false){var d=app.getModuleName();var b=app.getViewName();var c=d+"_"+b+"_Js";var e=Vtiger_Detail_Js;if(typeof window[c]!="undefined"){var a=new window[c]()}else{var a=new e()}Vtiger_Detail_Js.detailInstance=a}return Vtiger_Detail_Js.detailInstance},triggerSendEmail:function(b,a){Vtiger_Helper_Js.checkServerConfig(a).then(function(e){if(e==true){var d=Vtiger_Detail_Js.getInstance();var c=new Array();var f={};c.push(d.getRecordId());f.module=app.getModuleName();f.view="MassActionAjax";f.selected_ids=c;f.mode="showComposeEmailForm";f.step="step1";f.relatedLoad=true;Vtiger_Index_Js.showComposeEmailPopup(f)}else{alert(app.vtranslate("JS_EMAIL_SERVER_CONFIGURATION"))}})},triggerDetailViewAction:function(f,c){var e=Vtiger_Detail_Js.getInstance();var b=new Array();b.push(e.getRecordId());var a={selected_ids:JSON.stringify(b)};var d={type:"POST",url:f,dataType:"html",data:a};AppConnector.request(d).then(function(g){if(g){app.showModalWindow(g,{"text-align":"left"});if(typeof c=="function"){c(g)}}},function(g,h){})},triggerSendSms:function(b,a){Vtiger_Helper_Js.checkServerConfig(a).then(function(c){if(c==true){Vtiger_Detail_Js.triggerDetailViewAction(b)}else{alert(app.vtranslate("JS_SMS_SERVER_CONFIGURATION"))}})},triggerTransferOwnership:function(c){var b=this;b.getRelatedModulesContainer=false;var a={type:"POST",url:c,dataType:"html",data:{}};AppConnector.request(a).then(function(d){if(d){var e=function(f){var g=app.validationEngineOptions;g.onValidationComplete=function(i,h){if(h){if(i.attr("name")=="changeOwner"){b.transferOwnershipSave(i)}}return false};jQuery("#changeOwner").validationEngine(app.validationEngineOptions)};app.showModalWindow(d,function(g){var f=b.getRelatedModuleContainer();app.changeSelectElementView(f,"select2");if(typeof e=="function"){e(g)}})}})},transferOwnershipSave:function(c){var b=this;var f=jQuery("#transferOwnerId").val();var d=jQuery("#related_modules").val();var a=jQuery("#recordId").val();var e={module:app.getModuleName(),action:"TransferOwnership",record:a,transferOwnerId:f,related_modules:d};AppConnector.request(e).then(function(i){if(i.success){app.hideModalWindow();var k={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_RECORDS_TRANSFERRED_SUCCESSFULLY"),animation:"show",type:"info"};var j=jQuery(".assigned_user_id").val();var h=jQuery(".assigned_user_id ");h.find('option[value="'+j+'"]').removeAttr("selected");h.find('option[value="'+f+'"]').attr("selected","selected");h.trigger("liszt:updated");var g=h.find('option[value="'+f+'"]').data("picklistvalue");h.closest(".row-fluid").find(".value").html('<a href="index.php?module=Users&amp;parent=Settings&amp;view=Detail&amp;record='+f+'">'+g+"</a>");Vtiger_Helper_Js.showPnotify(k)}})},getRelatedModuleContainer:function(){if(this.getRelatedModulesContainer==false){this.getRelatedModulesContainer=jQuery("#related_modules")}return this.getRelatedModulesContainer},deleteRecord:function(b){var a=app.vtranslate("LBL_DELETE_CONFIRMATION");Vtiger_Helper_Js.showConfirmationBox({message:a}).then(function(c){AppConnector.request(b+"&ajaxDelete=true").then(function(d){if(d.success==true){window.location.href=d.result}else{Vtiger_Helper_Js.showPnotify(d.error.message)}})},function(c,d){})},reloadRelatedList:function(){var a=jQuery('[name="currentPageNum"]').val();var b=Vtiger_Detail_Js.getInstance();b.loadRelatedList(a)},showWorkflowTriggerView:function(a){$(a).popover("hide");var b=Vtiger_Detail_Js.getInstance();var c={module:app.getModuleName(),view:"WorkflowTrigger",record:b.getRecordId()};var d=function(e){e.find('[type="submit"]').click(function(h){var g=[];e.find('input[type="checkbox"]:checked').each(function(j){g.push($(this).val())});if(g.length==0){var i={title:app.vtranslate("JS_INFORMATION"),text:app.vtranslate("JS_NOT_SELECTED_WORKFLOW_TRIGGER"),type:"error",animation:"show"};Vtiger_Helper_Js.showPnotify(i)}else{var i={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_STARTED_PERFORM_WORKFLOW"),type:"info",animation:"show"};Vtiger_Helper_Js.showPnotify(i);var f={module:app.getModuleName(),action:"Workflow",mode:"execute",user:e.find('[name="user"]').val(),record:b.getRecordId(),ids:g};AppConnector.request(f).then(function(j){var k={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_COMPLETED_PERFORM_WORKFLOW"),type:"success",animation:"show"};Vtiger_Helper_Js.showPnotify(k);app.hideModalWindow();b.loadWidgets()},function(j,k){var l={title:app.vtranslate("JS_ERROR"),text:app.vtranslate("JS_ERROR_DURING_TRIGGER_OF_WORKFLOW"),type:"error",animation:"show"};Vtiger_Helper_Js.showPnotify(l);app.hideModalWindow()})}})};AppConnector.request(c).then(function(e){if(e){app.showModalWindow(e,"",d)}},function(e,f){})},},{targetPicklistChange:false,targetPicklist:false,detailViewContentHolder:false,detailViewForm:false,detailViewDetailsTabLabel:"LBL_RECORD_DETAILS",detailViewSummaryTabLabel:"LBL_RECORD_SUMMARY",detailViewRecentCommentsTabLabel:"ModComments",detailViewRecentActivitiesTabLabel:"Activities",detailViewRecentUpdatesTabLabel:"LBL_UPDATES",detailViewRecentDocumentsTabLabel:"Documents",fieldUpdatedEvent:"Vtiger.Field.Updated",widgetPostLoad:"Vtiger.Widget.PostLoad",updatedFields:["company","designation","title"],fieldPreSave:"Vtiger.Field.PreSave",tempData:[],referenceFieldNames:{Calendar:{Accounts:"link",Leads:"link",Contacts:"link",Vendors:"link",OSSEmployees:"link",Campaigns:"process",HelpDesk:"process",Projects:"process",ServiceContracts:"process",},OutsourcedProducts:{Leads:"parent_id",Accounts:"parent_id",Contacts:"parent_id"},Assets:{Accounts:"parent_id",Contacts:"parent_id"},OSSOutsourcedServices:{Leads:"parent_id",Accounts:"parent_id",Contacts:"parent_id"},OSSSoldServices:{Accounts:"parent_id",Contacts:"parent_id"},},init:function(){},getDeleteMessageKey:function(){return"JS_DELETE_CONFIRMATION"},loadWidgets:function(){var a=this;var b=jQuery('[class^="widgetContainer_"]');b.each(function(c,e){var d=jQuery(e);a.loadWidget(d)});a.registerRelatedModulesRecordCount()},loadWidget:function(f){var e=this;var b=jQuery.Deferred();var d=jQuery(".widget_header,.widgetHeader",f);var c=jQuery(".widget_contents",f);var a=f.data("url");var h=d.find('[name="relatedModule"]').val();var g={type:"GET",dataType:"html",data:a};c.progressIndicator({});AppConnector.request(g).then(function(i){c.progressIndicator({mode:"hide"});c.html(i);c.trigger(e.widgetPostLoad,{widgetName:h});app.showPopoverElementView(c.find(".popoverTooltip"));app.registerModal(c);b.resolve(g)},function(i){c.progressIndicator({mode:"hide"});b.reject()});return b.promise()},loadCommentsWidget:function(){},loadContents:function(b,e){var d=this;var a=jQuery.Deferred();var c=this.getContentHolder();var f=b;if(typeof e!="undefined"){f={};f.url=b;f.data=e}AppConnector.requestPjax(f).then(function(g){c.html(g);g=c.html();d.registerBlockStatusCheckOnLoad();app.changeSelectElementView(c);app.registerEventForDatePickerFields(c);d.getForm().validationEngine();c.trigger(jQuery.Event("Detail.LoadContents.PostLoad"),g);a.resolve(g)},function(){});return a.promise()},getUpdatefFieldsArray:function(){return this.updatedFields},getTabByLabel:function(a){var c=this.getTabs();var b=false;c.each(function(e,f){var g=jQuery(f);var d=g.data("labelKey");if(d==a){b=g;return false}});return b},selectModuleTab:function(){var a=this.getTabContainer();var b=a.find("li.module-tab");this.deSelectAllrelatedTabs();this.markTabAsSelected(b)},deSelectAllrelatedTabs:function(){var a=this.getTabContainer();this.getTabs().removeClass("active")},markTabAsSelected:function(a){a.addClass("active");jQuery('.related .dropdown [data-reference="'+a.data("reference")+'"]').addClass("active")},reloadTabContent:function(){this.getSelectedTab().trigger("click")},getSelectedTab:function(){var a=this.getTabContainer();return a.find(".nav li.active:not(.hide)")},getTabContainer:function(){return jQuery("div.related")},getTabs:function(){return this.getTabContainer().find("li")},getContentHolder:function(){if(this.detailViewContentHolder==false){this.detailViewContentHolder=jQuery("div.details div.contents")}return this.detailViewContentHolder},getForm:function(){if(this.detailViewForm==false){this.detailViewForm=jQuery("#detailView")}return this.detailViewForm},getRecordId:function(){return app.getRecordId()},getRelatedModuleName:function(){if(jQuery(".relatedModuleName",this.getContentHolder()).length==1){return jQuery(".relatedModuleName",this.getContentHolder()).val()}},saveFieldValues:function(b){var a=jQuery.Deferred();var c=this.getRecordId();var d={};if(typeof b!="undefined"){d=b}d.record=c;d.module=app.getModuleName();d.action="SaveAjax";var e={};e.data=d;e.async=false;e.dataType="json";AppConnector.request(e).then(function(f){a.resolve(f)});return a.promise()},getRelatedListCurrentPageNum:function(){return jQuery('input[name="currentPageNum"]',this.getContentHolder()).val()},removeCommentBlockIfExists:function(){var a=this.getContentHolder();var b=jQuery(".commentsBody",a);jQuery(".addCommentBlock",b).remove()},getCommentThread:function(b){var a=jQuery.Deferred();AppConnector.request(b).then(function(c){a.resolve(c)},function(c,d){});return a.promise()},saveCommentAjax:function(d,e,h,i,f,b,g){var j=this;var c=jQuery.progressIndicator({});var a={commentcontent:h,related_to:j.getRecordId(),module:"ModComments"};if(e=="edit"){a.record=f;a.reasontoedit=i;a.parent_comments=b;a.mode="edit";a.action="Save"}else{if(e=="add"){a.parent_comments=f;a.action="SaveAjax"}}AppConnector.request(a).then(function(k){c.progressIndicator({mode:"hide"});g.resolve(k)},function(l,k){c.progressIndicator({mode:"hide"});d.removeAttr("disabled");g.reject(l,k)})},saveComment:function(i){var n=this;var h=jQuery.Deferred();var a=jQuery(i.currentTarget);var d=a.data("mode");var m=a.closest(".addCommentBlock");var o=m.find(".commentcontent");var j=o.val();var g;if(j==""){g=app.vtranslate("JS_LBL_COMMENT_VALUE_CANT_BE_EMPTY");o.validationEngine("showPrompt",g,"error","bottomLeft",true);h.reject();return h.promise()}if(d=="edit"){var l=m.find('[name="reasonToEdit"]').val()}var c=jQuery(i.currentTarget);c.attr("disabled","disabled");var k=m.closest(".commentDetails").find(".commentInfoHeader");var f=k.data("commentid");var b=k.data("parentcommentid");n.saveCommentAjax(c,d,j,l,f,b,h);return h.promise()},getCommentUI:function(c){var b=jQuery.Deferred();var a={view:"DetailAjax",module:"ModComments",record:c};AppConnector.request(a).then(function(d){b.resolve(d)},function(d,e){});return b.promise()},getCommentBlock:function(){var b=this.getContentHolder();var a=jQuery(".basicAddCommentBlock",b).clone(true,true).removeClass("basicAddCommentBlock hide").addClass("addCommentBlock");a.find(".commentcontenthidden").removeClass("commentcontenthidden").addClass("commentcontent");return a},getEditCommentBlock:function(){var b=this.getContentHolder();var a=jQuery(".basicEditCommentBlock",b).clone(true,true).removeClass("basicEditCommentBlock hide").addClass("addCommentBlock");a.find(".commentcontenthidden").removeClass("commentcontenthidden").addClass("commentcontent");return a},registerSendSmsSubmitEvent:function(){var a=this;jQuery("body").on("submit","#massSave",function(f){var d=jQuery(f.currentTarget);var b=d.find("#message").val().length;if(b>160){var g={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("LBL_SMS_MAX_CHARACTERS_ALLOWED"),animation:"show",type:"error"};Vtiger_Helper_Js.showPnotify(g);return false}var c=d.find(":submit");c.attr("disabled","disabled");a.SendSmsSave(d);f.preventDefault()})},SendSmsSave:function(b){var c=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var a=b.serializeFormData();AppConnector.request(a).then(function(d){app.hideModalWindow();c.progressIndicator({mode:"hide"})},function(d,e){})},registerNameAjaxEditEvent:function(){var b=this;var a=b.getContentHolder();a.on(b.fieldUpdatedEvent,".nameField",function(i,j){var h=b.getForm();var f=h.data("nameFields");var d="";for(var g in f){if(g!=0){d+=" "}var k=f[g];d+=h.find('[name="'+k+'"]').val()}var c=a.closest(".contentsDiv").find(".recordLabel");c.text(d)})},updateHeaderNameFields:function(){var k=this;var a=k.getContentHolder();var c=k.getForm();var b=c.data("nameFields");var l=a.closest(".contentsDiv").find(".recordLabel");var i="";for(var g in b){var f=b[g];var j=c.find('[name="'+f+'"]');if(j.length>0){var h=j.val();i+=h+" ";l.find('[class="'+f+'"]').text(h)}}var d=l.find(".salutation");if(d.length>0){var e=d.text();i=e+i}l.attr("title",i)},registerAjaxEditEvent:function(){var b=this;var a=b.getContentHolder();a.on(b.fieldUpdatedEvent,"input,select,textarea",function(c){b.updateHeaderValues(jQuery(c.currentTarget))})},updateHeaderValues:function(d){var f=this;if(d.hasClass("nameField")){f.updateHeaderNameFields();return true}var c=d.attr("name");var g=this.getUpdatefFieldsArray();var e=f.getContentHolder();if(jQuery.inArray(c,g)!="-1"){var b=d.val();var a=e.closest(".contentsDiv").find("."+c+"_label");a.text(b)}},registerEmailFieldClickEvent:function(){var a=this.getContentHolder();a.on("click",".emailField",function(b){b.stopPropagation()})},registerPhoneFieldClickEvent:function(){var a=this.getContentHolder();a.on("click",".phoneField",function(b){b.stopPropagation()})},registerUrlFieldClickEvent:function(){var a=this.getContentHolder();a.on("click",".urlField",function(b){b.stopPropagation()})},registerRelatedRowClickEvent:function(){var a=this.getContentHolder();a.on("click",".listViewEntries",function(d){var b=jQuery(d.target,jQuery(d.currentTarget));if(b.is("td:first-child")&&(b.children('input[type="checkbox"]').length>0)){return}if(jQuery(d.target).is('input[type="checkbox"]')){return}var c=jQuery(d.currentTarget);var f=c.data("recordurl");if(typeof f!="undefined"){window.location.href=f}})},loadRelatedList:function(a){var b=new Vtiger_RelatedList_Js(this.getRecordId(),app.getModuleName(),this.getSelectedTab(),this.getRelatedModuleName());var c={page:a};b.loadRelatedList(c)},registerEventForRelatedListPagination:function(){var b=this;var a=this.getContentHolder();a.on("click","#relatedListNextPageButton",function(g){var d=jQuery(g.currentTarget);if(d.attr("disabled")=="disabled"){return}var c=b.getSelectedTab();var h=b.getRelatedModuleName();var f=new Vtiger_RelatedList_Js(b.getRecordId(),app.getModuleName(),c,h);f.nextPageHandler()});a.on("click","#relatedListPreviousPageButton",function(){var c=b.getSelectedTab();var e=b.getRelatedModuleName();var d=new Vtiger_RelatedList_Js(b.getRecordId(),app.getModuleName(),c,e);d.previousPageHandler()});a.on("click","#relatedListPageJump",function(f){var c=b.getSelectedTab();var g=b.getRelatedModuleName();var d=new Vtiger_RelatedList_Js(b.getRecordId(),app.getModuleName(),c,g);d.getRelatedPageCount()});a.on("click","#relatedListPageJumpDropDown > li",function(c){c.stopImmediatePropagation()}).on("keypress","#pageToJump",function(f){var c=b.getSelectedTab();var g=b.getRelatedModuleName();var d=new Vtiger_RelatedList_Js(b.getRecordId(),app.getModuleName(),c,g);d.pageJumpHandler(f)});a.on("click",".pageNumber",function(){var e=$(this).hasClass("disabled");if(e){return false}var c=$(this).data("id");var d=b.getSelectedTab();var g=b.getRelatedModuleName();var f=new Vtiger_RelatedList_Js(b.getRecordId(),app.getModuleName(),d,g);f.selectPageHandler(c)})},registerEventForRelatedList:function(){var b=this;var a=this.getContentHolder();b.registerEventForAddingRelatedRecord(a);a.on("click",".relatedListHeaderValues",function(g){var d=jQuery(g.currentTarget);var c=b.getSelectedTab();var h=b.getRelatedModuleName();var f=new Vtiger_RelatedList_Js(b.getRecordId(),app.getModuleName(),c,h);f.sortHandler(d)});a.on("click","button.selectRelation",function(g){var c=b.getSelectedTab();var i=b.getRelatedModuleName();if(i==undefined){i=jQuery(g.currentTarget).data("modulename")}var d=jQuery(g.currentTarget).data("rf");var h={};if(d&&Object.keys(d).length>0){h={search_key:d.key,search_value:d.name}}var f=new Vtiger_RelatedList_Js(b.getRecordId(),app.getModuleName(),c,i);f.showSelectRelationPopup(h).then(function(j){var e=jQuery(j).find('[name="emailEnabledModules"]').val();if(e){b.registerEventToEditRelatedStatus()}})});a.on("click","a.relationDelete",function(h){h.stopImmediatePropagation();var f=jQuery(h.currentTarget);var c=Vtiger_Detail_Js.getInstance();var d=c.getDeleteMessageKey();var g=app.vtranslate(d);Vtiger_Helper_Js.showConfirmationBox({message:g}).then(function(m){var o=f.closest("tr");var k=o.data("id");var i=f.closest(".widget_contents");var j=b.getSelectedTab();var n=b.getRelatedModuleName();if(n==undefined){n=i.find(".relatedModuleName").val()}var l=new Vtiger_RelatedList_Js(b.getRecordId(),app.getModuleName(),j,n);l.deleteRelation([k]).then(function(e){l.loadRelatedList()})},function(e,i){})});a.on("click","a.favorites",function(j){var d=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var g=jQuery(j.currentTarget);var l=Vtiger_Detail_Js.getInstance();var m=g.closest("tr");var i=m.data("id");var f=g.closest(".widget_contents");var h=b.getSelectedTab();var k=b.getRelatedModuleName();if(k==undefined){k=f.find(".relatedModuleName").val()}var c=new Vtiger_RelatedList_Js(b.getRecordId(),app.getModuleName(),h,k);c.favoritesRelation(i,g.data("state")).then(function(e){if(e){var n=g.data("state")?0:1;g.data("state",n);g.find(".glyphicon").each(function(){if(jQuery(this).hasClass("hide")){jQuery(this).removeClass("hide")}else{jQuery(this).addClass("hide")}});d.progressIndicator({mode:"hide"});var o=app.vtranslate("JS_REMOVED_FROM_FAVORITES");if(n){o=app.vtranslate("JS_ADDED_TO_FAVORITES")}Vtiger_Helper_Js.showPnotify({text:o,type:"success",animation:"show"})}})})},registerBlockAnimationEvent:function(){var a=this.getContentHolder();a.find(".blockHeader").click(function(){var f=$(this).find(".blockToggle").not(".hide");var b=f.data("id");var i=f.closest(".detailViewTable");var h=i.find(".blockContent");var d=f.data();var c=app.getModuleName();var g=function(){h.addClass("hide");app.cacheSet(c+"."+b,0)};var e=function(){h.removeClass("hide");app.cacheSet(c+"."+b,1)};var d=f.data();if(d.mode=="show"){g();f.addClass("hide");i.find('[data-mode="hide"]').removeClass("hide")}else{e();f.addClass("hide");i.find("[data-mode='show']").removeClass("hide")}})},registerBlockStatusCheckOnLoad:function(){var b=this.getContentHolder().find(".detailViewTable");var a=app.getModuleName();b.each(function(d,j){var g=jQuery(j);var f=g.find(".blockToggle").not(".hide");var i=g.find(".blockContent");var c=f.data("id");var h=a+"."+c;var e=app.cacheGet(h,null);if(e!=null){if(e==1){f.addClass("hide");g.find("[data-mode='show']").removeClass("hide");i.removeClass("hide")}else{f.addClass("hide");g.find("[data-mode='hide']").removeClass("hide");i.addClass("hide")}}})},registerEventForAddingRelatedRecord:function(){var b=this;var a=this.getContentHolder();a.on("click",'[name="addButton"]',function(g){var d=jQuery(g.currentTarget);var c=b.getSelectedTab();var h=b.getRelatedModuleName();if(d.hasClass("quickCreateSupported")!=true){window.location.href=d.data("url");return}var f=new Vtiger_RelatedList_Js(b.getRecordId(),app.getModuleName(),c,h);f.addRelatedRecord(d)})},ajaxEditHandling:function(e){var d=this;var b=jQuery(".setReadRecord");b.prop("disabled",true);var c=jQuery(".value",e);var g=jQuery(".edit",e);var f=jQuery(".summaryViewEdit",e);var a=jQuery(".fieldname",g);jQuery(a).each(function(m,l){var o=jQuery(l).val();var k=jQuery(l);var h=jQuery('[name="'+o+'"]',g);if(h.attr("disabled")=="disabled"){return}if(g.length<=0){return}if(g.is(":visible")){return}h.inputmask();var j=false;if(h.inputmask("hasMaskedValue")){j=true}c.addClass("hide");f.addClass("hide");g.removeClass("hide").children().filter('input[type!="hidden"]input[type!="image"],select').filter(":first").focus();var p=false;var n=false;var i=function(y){var x=jQuery(y.target);if((x.closest(".fieldValue").is(e))){return}h.inputmask("remove");e.removeAttr("tabindex");var v=k.data("prevValue");var A=d.getForm();var u=A.serializeFormData();var B=u[o];var t=B;var r=Vtiger_Field_Js.getInstance(h.data("fieldinfo"));var w=[];var D=false;if(g.find("[data-fieldinfo]").length==2){g.find("[data-fieldinfo]").each(function(){var E=[];E.name=jQuery(this).attr("name");E.type=jQuery(this).data("fieldinfo").type;if(E.type=="datetime"){D=true}w.push(E)})}if(h.is("input:checkbox")){if(h.is(":checked")){B="1"}else{B="0"}h=h.filter('[type="checkbox"]')}var z=h.validationEngine("validate");if(z){if(j){h.inputmask()}return}h.validationEngine("hide");if(v==B){g.addClass("hide");c.removeClass("hide");f.removeClass("hide");b.prop("disabled",false);jQuery(document).off("click","*",i)}else{var q=jQuery.Event(d.fieldPreSave);h.trigger(q,{fieldValue:t,recordId:d.getRecordId()});if(q.isDefaultPrevented()){p=false;n=true;b.prop("disabled",false);return}n=false;jQuery(document).off("click","*",i);if(!p&&!n){p=true;if(Vtiger_Detail_Js.SaveResultInstance==false){Vtiger_Detail_Js.SaveResultInstance=new SaveResult()}u.record=d.getRecordId();u.module=app.getModuleName();u.view="quick_edit";if(Vtiger_Detail_Js.SaveResultInstance.checkData(u)==false){g.addClass("hide");c.removeClass("hide");f.removeClass("hide");jQuery(document).off("click","*",i);b.prop("disabled",false);h.val(v);return}}else{return}e.progressIndicator();g.addClass("hide");var C={};if(r.getType()=="multipicklist"||r.getType()=="sharedOwner"||r.getType()=="taxes"){var s=o.split("[]");o=s[0]}C.value=t;C.field=o;C=d.getCustomFieldNameValueMap(C);d.saveFieldValues(C).then(function(E){b.prop("disabled",false);var I=E.result;e.progressIndicator({mode:"hide"});c.removeClass("hide");f.removeClass("hide");var H=I[o].display_value;if(w.length&&D){H=I[w[0].name].display_value+" "+I[w[1].name].display_value}c.html(H);h.trigger(d.fieldUpdatedEvent,{old:v,"new":t});k.data("prevValue",B);h.data("selectedValue",B);if(d.targetPicklistChange){if(jQuery(".summaryView",d.getForm()).length>0){d.targetPicklist.find(".summaryViewEdit").trigger("click")}else{d.targetPicklist.trigger("click")}d.targetPicklistChange=false;d.targetPicklist=false}var G=d.getSelectedTab();if(G.data("linkKey")==d.detailViewSummaryTabLabel){var F=d.getContentHolder();d.reloadTabContent();d.registerSummaryViewContainerEvents(F);d.registerEventForPicklistDependencySetup(d.getForm());d.registerEventForRelatedList()}else{if(G.data("linkKey")==d.detailViewDetailsTabLabel){d.registerEventForPicklistDependencySetup(d.getForm())}}d.updateRecordsPDFTemplateBtn(d.getForm())},function(E){b.prop("disabled",false);e.progressIndicator({mode:"hide"})})}};jQuery("body :not(.popover *)").click(i)})},triggerDisplayTypeEvent:function(){var a=app.cacheGet("widthType","narrowWidthType");if(a){var b=jQuery("#detailView").find("td");b.addClass(a)}},addElementsToQuickCreateForCreatingRelation:function(a,b){jQuery('<input type="hidden" name="relationOperation" value="true" >').appendTo(a);jQuery.each(b,function(c,d){jQuery('<input type="hidden" name="'+c+'" value="'+d+'" >').appendTo(a)})},registerEventForActivityWidget:function(){var a=this;jQuery(".createActivity").on("click",function(j){var b="Calendar";var f=a.getRecordId();var c=app.getModuleName();var h=jQuery(j.currentTarget);var d={};d.sourceModule=c;d.sourceRecord=f;if(c!=""&&b!=""&&typeof a.referenceFieldNames[b]!="undefined"&&typeof a.referenceFieldNames[b][c]!="undefined"){var l=a.referenceFieldNames[b][c];d[l]=f}var k=h.data("url");var m=function(q){a.addElementsToQuickCreateForCreatingRelation(q,d);var o=q.find('[class^="CalendarQuikcCreateContents"]').find("#goToFullForm");var p=q.find('[class^="EventsQuikcCreateContents"]').find("#goToFullForm");var e=o.data("edit-view-url")+"&"+k;var n=p.data("edit-view-url")+"&"+k;o.data("editViewUrl",e);p.data("editViewUrl",n)};var i=function(){var o=h.closest(".summaryWidgetContainer");var e=o.find(".widgetContentBlock");var n=e.data("url");var p={type:"GET",dataType:"html",data:n};AppConnector.request(p).then(function(r){var q=o.find(".widget_contents");q.html(r);app.changeSelectElementView(q);a.registerEventForActivityWidget()});a.loadWidgets()};var g={};g.callbackPostShown=m;g.callbackFunction=i;g.data=d;g.noCache=false;Vtiger_Header_Js.getInstance().quickCreateModule(b,g)})},getEndDate:function(a){var d=a.split("-");var c=new Date(d[0],d[1],d[2]);var b=new Date();b.setDate(c.getDate()+2);return app.getStringDate(b)},getSingleEventType:function(e,b,g){var f=jQuery('[name="date_start"]');var c=jQuery(f).val();var h=jQuery(f).data("date-format");var j=Vtiger_Helper_Js.convertToDateString(c,h,e,g);var a=jQuery.extend({},["#b6a996,black"]);var i=this;var d={module:"Calendar",action:"Feed",start:j,end:this.getEndDate(j),type:g,mapping:a};AppConnector.request(d).then(function(m){var k=Vtiger_Helper_Js.convertToDateString(c,h,e);if(!jQuery.isEmptyObject(m)){if(m[0]["activitytype"]==="Task"){for(var n in m){if(m[n]["start"].indexOf(k)>-1){jQuery("#"+b+" .table").append('<tr><td><a target="_blank" href="'+m[n]["url"]+'">'+m[n]["title"]+"</a></td></tr>")}}}else{for(var l=0;l<m[0].length;l++){if(m[0][l]["start"].indexOf(k)>-1){jQuery("#"+b+" .table").append('<tr><td><a target="_blank" href="'+m[0][l]["url"]+'">'+m[0][l]["title"]+"</a></td></tr>")}}}}})},registerFilterForAddingModuleRelatedRecordFromSummaryWidget:function(){var a=this;jQuery(".createRecordFromFilter").on("click",function(o){var m=jQuery(o.currentTarget);var n=m.closest(".summaryWidgetContainer");var g=n.find(".widget_contents");var h=g.find('[name="relatedModule"]').val();var q=m.data("url");var k=a.getRecordId();var i={};var f=m.data("prf");var l=m.data("acf");var c=m.closest(".widget_header").find('[name="relatedModule"]').val();var j={};var d=function(e){a.postSummaryWidgetAddRecord(e,m);if(h=="ProjectTask"){a.loadModuleSummary()}};if(typeof f!="undefined"){j[f]=k}if(typeof l!="undefined"){$.each(l,function(e,r){j[e]=r})}if(Object.keys(j).length>0){i.data=j}i.noCache=true;i.callbackFunction=d;var b=jQuery.progressIndicator();var p=new Vtiger_Header_Js();p.getQuickCreateForm(q,c,i).then(function(e){p.handleQuickCreateData(e,i);b.progressIndicator({mode:"hide"})})})},registerChangeFilterForWidget:function(){var a=this;jQuery(".widget_header .filterField").on("change",function(m){var n=this.name;var j={};var i={};var k=jQuery(m.currentTarget);var l=k.closest(".summaryWidgetContainer");var b=l.find(".widget_contents");b.progressIndicator();var f=b.find('[name="relatedModule"]').val();var h=a.getRecordId();var d=app.getModuleName();var o=k.find("option:selected").val();var c=k.data("fieldlable");var g=l.find('[name="filter_data"]').val();if(o!=c){j[g]=o;i.whereCondition=j}i.record=h;i.view="Detail";i.module=d;i.page=b.find('[name="page"]').val();i.limit=b.find('[name="pageLimit"]').val();i.col=b.find('[name="col"]').val();i.relatedModule=f;i.mode="showRelatedRecords";AppConnector.request(i).then(function(e){b.html(e);currentDiv.progressIndicator({mode:"hide"})})})},registerChangeSwitchForWidget:function(){var a=this;$(".summaryWidgetContainer .widget_header .switchBtnReload").on("switchChange.bootstrapSwitch",function(j,c){var h=jQuery(j.currentTarget);var i=h.closest(".summaryWidgetContainer");var g=i.find(".widgetContentBlock");var d=g.data("url");var f=h.data("urlparams");if(f!=""){var l=h.data("on-val");var k=h.data("off-val");d=d.replace("&"+f+"="+l,"");d=d.replace("&"+f+"="+k,"");if(c){var b=l}else{var b=k}if(b!=""){d+="&"+f+"="+b}g.data("url",d);a.loadWidget($(g))}});$(".activityWidgetContainer .switchBtn").on("switchChange.bootstrapSwitch",function(h,g){var d=jQuery(h.currentTarget);var b=d.closest(".summaryWidgetContainer");var f=b.find(".widgetContentBlock");var c=f.data("url");c=c.replace("&type=current","");c+="&type=";if(g){c+="current"}else{c+="history"}f.data("url",c);a.loadWidget($(f))});$(".calculationsWidgetContainer .calculationsSwitch").on("switchChange.bootstrapSwitch",function(h,g){var d=jQuery(h.currentTarget);var b=d.closest(".summaryWidgetContainer");var f=b.find(".widgetContentBlock");var c=f.data("url");c=c.replace("&showtype=open","");c=c.replace("&showtype=archive","");c+="&showtype=";if(g){c+="open"}else{c+="archive"}f.data("url",c);a.loadWidget($(f))})},registerSummaryViewContainerEvents:function(d){var b=this;this.registerEventForActivityWidget();this.registerChangeFilterForWidget();this.registerChangeSwitchForWidget();this.registerFilterForAddingModuleRelatedRecordFromSummaryWidget();if(Vtiger_Detail_Js.SaveResultInstance==false){Vtiger_Detail_Js.SaveResultInstance=new SaveResult()}var a=b.getForm();var c=a.serializeFormData();d.off("click").on("click",".row .summaryViewEdit",function(h){var g=jQuery(h.currentTarget);g.addClass("hide");var f=g.closest(".fieldValue");b.ajaxEditHandling(f);Vtiger_Detail_Js.SaveResultInstance.loadFormData(c)});Vtiger_Detail_Js.SaveResultInstance.loadFormData(c);d.on(b.fieldUpdatedEvent,".recordDetails",function(g,h){var f=d.find("[data-type='Updates']");if(f.length){b.loadWidget(f)}});d.on("click",".editDefaultStatus",function(h){var g=jQuery(h.currentTarget);g.popover("hide");var f=g.data("url");if(f&&typeof f!="undefined"){app.showModalWindow(null,f)}});d.on("click",".editDescription",function(k){var m=this;var g=jQuery(k.currentTarget);var o=g.closest(".activityDescription");var i=o.find(".edit");var h=o.find(".value");g.hide();h.addClass("hide");i.removeClass("hide").show();var l=jQuery(".fieldname",i);var n=l.val();var f=jQuery('[name="'+n+'"]',i);var j=function(){var r=l.data("prevValue");var w=f.val();var v=f.val();var q=o.closest(".activityEntries");var p=q.find(".activityId").val();var e=q.find(".activityModule").val();var x=q.find(".activityType").val();if(Vtiger_Detail_Js.SaveResultInstance==false){Vtiger_Detail_Js.SaveResultInstance=new SaveResult()}var t={};t.record=p;t.module=e;t.view="quick_edit";t[n]=w;t["p_"+n]=r;if(Vtiger_Detail_Js.SaveResultInstance.checkData(t)==false){return}if(r==w){i.addClass("hide");h.removeClass("hide");g.show()}else{var u=f.validationEngine("validate");if(u){Vtiger_Helper_Js.addClickOutSideEvent(o,j);return}o.progressIndicator();i.addClass("hide");var s={action:"SaveAjax",record:p,field:n,value:w,module:e,activitytype:x};AppConnector.request(s).then(function(y){o.progressIndicator({mode:"hide"});h.removeClass("hide");g.show();h.html(v);l.data("prevValue",w)})}};f.focus();o.one("focusout",j)});jQuery(".changeDetailViewMode").on("click",function(f){b.getTabs().filter('[data-link-key="'+b.detailViewDetailsTabLabel+'"]:not(.hide)').trigger("click")});jQuery(".createRecord").on("click",function(p){var n=jQuery(p.currentTarget);var o=n.closest(".summaryWidgetContainer");var l=o.find(".widget_header");var g=l.find('[name="relatedModule"]').val();var k=b.getRecordId();var h=app.getModuleName();var j={};j.sourceModule=h;j.sourceRecord=k;if(h!=""&&g!=""&&typeof b.referenceFieldNames[g]!="undefined"&&typeof b.referenceFieldNames[g][h]!="undefined"){var q=b.referenceFieldNames[g][h];j[q]=k}var f=function(e){b.postSummaryWidgetAddRecord(e,n)};var i=function(e){b.addElementsToQuickCreateForCreatingRelation(e,j)};var m={};m.callbackFunction=f;m.goToFullFormcallback=i;m.data=j;m.noCache=false;Vtiger_Header_Js.getInstance().quickCreateModule(g,m)});this.registerFastEditingFiels()},addRelationBetweenRecords:function(e,a){var b=jQuery.Deferred();var d=this;var c=d.getSelectedTab();var f=new Vtiger_RelatedList_Js(d.getRecordId(),app.getModuleName(),c,e);f.addRelations(a).then(function(h){var i=d.getContentHolder();var g=i.find("[data-type='Updates']");if(g.length>0){d.loadWidget(g)}b.resolve(h)},function(h,g){b.reject(h,g)});return b.promise()},postSummaryWidgetAddRecord:function(f,h){var i=h.closest(".summaryWidgetContainer");var e=i.find(".widget_header");var a=i.find(".widget_contents");var b=e.find('[name="relatedModule"]').val();var d=this.getRecordId();var c=app.getModuleName();var g=new Array();g.push(f.result._recordId);a.progressIndicator({});this.addRelationBetweenRecords(b,g).then(function(j){var k={};k.record=d;k.view="Detail";k.module=c;k.page=a.find('[name="page"]').val();k.limit=a.find('[name="pageLimit"]').val();k.col=a.find('[name="col"]').val();k.relatedModule=b;k.mode="showRelatedRecords";AppConnector.request(k).then(function(m){var l=jQuery("#relatedDocuments");a.progressIndicator({mode:"hide"});a.html(m);app.changeSelectElementView(l)})})},registerEventForEmailsRelatedRecord:function(){var a=this.getContentHolder();var c=a.find('[name="emailsRelatedRecord"]');var d=this.getRecordId();var b=Vtiger_Popup_Js.getInstance();a.on("click",'[name="emailsRelatedRecord"]',function(h){var g=jQuery(h.currentTarget);var f=g.data("id");var i={};i.module="Emails";i.view="ComposeEmail";i.mode="emailPreview";i.record=f;i.parentId=d;i.relatedLoad=true;b.show(i)});a.on("click",'[name="emailsEditView"]',function(g){g.stopPropagation();var f="Emails";Vtiger_Helper_Js.checkServerConfig(f).then(function(k){if(k==true){var i=jQuery(g.currentTarget);var e=i.closest("tr");var h=e.data("id");var j=new Array();j.push(d);var l={};l.module="Emails";l.view="ComposeEmail";l.mode="emailEdit";l.record=h;l.selected_ids=j;l.parentId=d;l.relatedLoad=true;b.show(l)}else{Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_EMAIL_SERVER_CONFIGURATION"))}})})},registerEventForAddingEmailFromRelatedList:function(){var a=this.getContentHolder();var b=this.getRecordId();a.on("click",'[name="composeEmail"]',function(f){f.stopPropagation();var c=jQuery(f.currentTarget);var d=new Array();var g={};d.push(b);g.module=app.getModuleName();g.view="MassActionAjax";g.selected_ids=d;g.mode="showComposeEmailForm";g.step="step1";g.relatedLoad=true;Vtiger_Index_Js.showComposeEmailPopup(g)})},registerEnterClickEventForTagRecord:function(){jQuery("#tagRecordText").keypress(function(a){if(a.which==13){jQuery("#tagRecord").trigger("click")}})},checkTagExists:function(e){var b=e.split(" ");for(var d=0;d<b.length;d++){var a=jQuery("#tagsList").find("[data-tagname='"+b[d]+"']");if(a.length>0){b.splice(d,1);d--}}var c=b.join(" ");if(c==""){return true}else{return c}},addTagsToList:function(d){for(var b in d.result[1]){var c=d.result[1][b];var a=jQuery("#tagsList").find("[data-tagid='"+c+"']");if(a.length==0){jQuery("#tagsList").prepend('<div class="btn-info btn-xs pull-left tag" data-tagname="'+b+'" data-tagid="'+c+'"><span class="glyphicon glyphicon-asterisk">&nbsp;</span><span class="tagName textOverflowEllipsis"><a class="cursorPointer">'+b+'</a></span><span id="deleteTag" class="glyphicon glyphicon-remove cursorPointer deleteTag" aria-hidden="true"></span></div>')}}},checkTagMaxLengthExceeds:function(d){var a=d.split(" ");var c=jQuery("#maxTagLength").val();for(var b=0;b<a.length;b++){if(a[b].length>parseInt(c)){return true}}return false},registerClickEventForAddingTagRecord:function(){var a=this;jQuery("#tagRecord").on("click",function(){var d=jQuery("#tagRecordText");var h=d.val();tagTextSplit=h.split(" ");if((tagTextSplit.length+$("#tagsList").children().length)>$("#maxTag").val()){var c=jQuery("#maxTag").val();d.validationEngine("showPrompt",app.vtranslate("JS_MAX_TAG_EXCEEDS")+" "+c,"error","bottomLeft",true);return}if(h==""){d.validationEngine("showPrompt",app.vtranslate("JS_PLEASE_ENTER_A_TAG"),"error","bottomLeft",true);return}var e=a.checkTagMaxLengthExceeds(h);if(e==true){var b=jQuery("#maxTagLength").val();d.validationEngine("showPrompt",app.vtranslate("JS_MAX_TAG_LENGTH_EXCEEDS")+" "+b,"error","bottomLeft",true);return}var g=a.checkTagExists(h);if(g==true){d.validationEngine("showPrompt",app.vtranslate("JS_TAG_NAME_ALREADY_EXIST"),"error","bottomLeft",true);return}else{h=g}var f={module:app.getModuleName(),action:"TagCloud",mode:"save",tagname:h,record:a.getRecordId()};AppConnector.request(f).then(function(i){a.addTagsToList(i);d.val("")})})},registerRemovePromptEventForTagCloud:function(a){jQuery("#tagRecordText").on("focus",function(c){var b=jQuery(".formError",a);if(b.length>0){b.remove()}})},registerDeleteEventForTag:function(b){var a=this;jQuery(b).on("click",".deleteTag",function(f){var c=jQuery(f.currentTarget).closest(".tag");var d=c.data("tagid");c.fadeOut("slow",function(){c.remove()});var g={module:app.getModuleName(),action:"TagCloud",mode:"delete",tag_id:d,record:a.getRecordId()};AppConnector.request(g).then(function(e){})})},registerTagClickEvent:function(b){var a=this;jQuery(b).on("click",".tagName",function(f){var c=jQuery(f.currentTarget);var d=c.closest(".tag").data("tagid");var g={module:app.getModuleName(),view:"TagCloudSearchAjax",tag_id:d,tag_name:c.find("a").text()};AppConnector.request(g).then(function(e){var h={data:e};app.showModalWindow(h);a.registerChangeEventForModulesList()})})},registerChangeEventForModulesList:function(){jQuery("#tagSearchModulesList").on("change",function(c){var a=jQuery(c.currentTarget);if(a.val()=="all"){jQuery('[name="tagSearchModuleResults"]').removeClass("hide")}else{jQuery('[name="tagSearchModuleResults"]').removeClass("hide");var b=a.val();jQuery('[name="tagSearchModuleResults"]').filter(":not(#"+b+")").addClass("hide")}})},registerPostTagCloudWidgetLoad:function(){var a=this;app.getContentsContainer().on("Vtiger.Widget.Load.LBL_TAG_CLOUD",function(c,b){a.registerClickEventForAddingTagRecord();a.registerEnterClickEventForTagRecord();a.registerDeleteEventForTag(b);a.registerRemovePromptEventForTagCloud(b);a.registerTagClickEvent(b)})},registerGetAllTagCloudWidgetLoad:function(){var a=this;var b={module:app.getModuleName(),mode:"showTags",source_module:app.getModuleName(),record:this.getRecordId(),view:"ShowTagCloudTop"};AppConnector.request(b).then(function(c){if(c.length>0){c=$(c);$(".detailViewTitle .tagContainer").append(c);a.registerDeleteEventForTag(c);a.registerRemovePromptEventForTagCloud(c);a.registerTagClickEvent(c);a.registerClickEventForAddingTagRecord();a.registerEnterClickEventForTagRecord()}})},registerEventForRelatedTabClick:function(){var c=this;var b=c.getContentHolder();var a=b.closest("div.detailViewInfo");jQuery(".related",a).on("click","li",function(j,i){var g=jQuery(j.currentTarget);if(!g.hasClass("dropdown")){var f=jQuery("<div></div>");f.progressIndicator({position:"html",blockInfo:{enabled:true,elementToBlock:a}});var d=g.data("url");if(typeof i!="undefined"){var h=i.callback;delete i.callback}c.loadContents(d,i).then(function(e){c.deSelectAllrelatedTabs();c.markTabAsSelected(g);app.showBtnSwitch(b.find(".switchBtn"));Vtiger_Helper_Js.showHorizontalTopScrollBar();f.progressIndicator({mode:"hide"});c.registerHelpInfo();app.registerModal(b);if(typeof h=="function"){h(e)}if(g.data("linkKey")==c.detailViewSummaryTabLabel){c.loadWidgets()}c.registerBasicEvents();app.notifyPostAjaxReady()},function(){f.progressIndicator({mode:"hide"})})}})},registerEventForPicklistDependencySetup:function(a){var e=this;var c=jQuery('[name="picklistDependency"]',a);if(c.length<=0){return}var d=JSON.parse(c.val());var f=Object.keys(d);if(f.length<=0){return}var h=[];for(var b=0;b<f.length;b++){h.push('[name="'+f[b]+'"]')}h=h.join(",");var g=a.find(h);g.on("change",function(o){var m=jQuery(o.currentTarget);var l=m.attr("name");var k=d[l];var n=m.val();var j=k[n];var i=k.__DEFAULT__;if(typeof j=="undefined"){j=i}jQuery.each(i,function(w,y){var q=j[w];if(typeof q=="undefined"){q=y}var x=jQuery('[name="'+w+'"]',a);if(x.length<=0){return}var v=x.data("selectedValue");if(jQuery.inArray(v,q)==-1){e.targetPicklistChange=true;e.targetPicklist=x.closest("td")}else{e.targetPicklistChange=false;e.targetPicklist=false}var p=x.data("availableOptions");if(typeof p=="undefined"){p=jQuery("option",x);x.data("available-options",p)}var t=new jQuery();var r=[];r.push("");for(var u=0;u<q.length;u++){r.push(q[u])}jQuery.each(p,function(z,B){var A=jQuery(B).val();if(jQuery.inArray(A,r)!=-1){t=t.add(jQuery(B))}});var s="";s=t.filter("[selected]").val();if(q.length==1){s=q[0]}x.html(t).val(s).trigger("chosen:updated")})});g.trigger("change")},getChildComments:function(d){var b=jQuery.Deferred();var c="module="+app.getModuleName()+"&view=Detail&record="+this.getRecordId()+"&mode=showChildComments&commentid="+d;var a=this.getCommentThread(c);a.then(function(e){b.resolve(e)});return b.promise()},registerEventForTotalRecordsCount:function(){var b=this;var a=this.getContentHolder();a.on("click",".totalNumberOfRecords",function(g){var d=jQuery(g.currentTarget);var i=jQuery("#totalCount").val();d.addClass("hide");d.parent().progressIndicator({});if(i==""){var c=b.getSelectedTab();var h=b.getRelatedModuleName();var f=new Vtiger_RelatedList_Js(b.getRecordId(),app.getModuleName(),c,h);f.getRelatedPageCount().then(function(){b.showPagingInfo()})}else{b.showPagingInfo()}d.parent().progressIndicator({mode:"hide"})})},showPagingInfo:function(){var c=jQuery("#totalCount").val();var e=jQuery(".pageNumbersText");var d=e.text();var b=d+" ("+c+")";var a=parseInt(jQuery("#noOfEntries").val());if(a!=0){jQuery(".pageNumbersText").html(b)}else{jQuery(".pageNumbersText").html("")}},getCustomFieldNameValueMap:function(a){return a},registerSetReadRecord:function(a){var b=this;a.on("click",".setReadRecord",function(d){var c=jQuery(d.currentTarget);c.closest(".btn-group").addClass("hide");jQuery("#Accounts_detailView_fieldValue_was_read").find(".value").text(app.vtranslate("LBL_YES"));var f={module:app.getModuleName(),action:"SaveAjax",record:b.getRecordId(),field:"was_read",value:"on",};AppConnector.request(f).then(function(g){var h={text:app.vtranslate("JS_SET_READ_RECORD"),title:app.vtranslate("System"),type:"info",animation:"show"};Vtiger_Helper_Js.showPnotify(h);var e=jQuery(".related li.active");if(e.data("linkKey")==b.detailViewSummaryTabLabel||e.data("linkKey")==b.detailViewDetailsTabLabel){b.reloadTabContent()}})})},registerFastEditingFiels:function(){var a=this;var b=jQuery(".summaryWidgetFastEditing select");b.on("change",function(l){var f=jQuery(l.currentTarget);var j=f.closest(".editField");var i=jQuery.progressIndicator({message:app.vtranslate("JS_SAVE_LOADER_INFO"),position:"summaryWidgetFastEditing",blockInfo:{enabled:true}});var o=j.data("fieldname");o=o.replace("q_","");var k=j.data("prevvalue");var d=f.val();var m=f.validationEngine("validate");if(m){j.progressIndicator({mode:"hide"});return}var c=jQuery.Event(a.fieldPreSave);f.trigger(c,{fieldValue:d,recordId:a.getRecordId()});if(Vtiger_Detail_Js.SaveResultInstance==false){Vtiger_Detail_Js.SaveResultInstance=new SaveResult()}var g={};g.record=a.getRecordId();g.module=app.getModuleName();g.view="quick_edit";g[o]=d;g["p_"+o]=k;if(Vtiger_Detail_Js.SaveResultInstance.checkData(g)==false){i.progressIndicator({mode:"hide"});a.reloadTabContent();return}var n={};n.value=d;n.field=o;n=a.getCustomFieldNameValueMap(n);a.saveFieldValues(n);i.progressIndicator({mode:"hide"});var h={title:app.vtranslate("JS_SAVE_NOTIFY_OK"),type:"success",animation:"show"};Vtiger_Helper_Js.showPnotify(h);a.reloadTabContent()})},registerHelpInfo:function(){var a=this.getForm();app.showPopoverElementView(a.find(".HelpInfoPopover"))},registerRelatedModulesRecordCount:function(c){var d=this;if(!jQuery.isFunction(d.refreshRelatedList)){d=new Vtiger_Detail_Js()}var a=$(".related .nav .dropdown-menu");var b=c;if(!b||(typeof b.length=="undefined")){b=$(".related .nav > .relatedNav, .related .nav > .mainNav")}b.each(function(g,e){if($(e).data("count")=="1"){var f={module:app.getModuleName(),action:"RelationAjax",record:app.getRecordId(),relatedModule:$(e).data("reference"),mode:"getRelatedListPageCount",tab_label:$(e).data("label-key"),};AppConnector.request(f).then(function(h){if(h.success){$(e).find(".count").text(h.result.numberOfRecords);a.find('[data-reference="'+$(e).data("reference")+'"] .count').text(h.result.numberOfRecords);d.refreshRelatedList()}})}})},saveCommentModal:function(d,a){var m=this;var h=jQuery.Deferred();var b=d;var e=a.data("mode");var l=d.closest(".addCommentBlock");var n=l.find(".commentcontent");var i=n.val();var g;if(i==""){g=app.vtranslate("JS_LBL_COMMENT_VALUE_CANT_BE_EMPTY");n.validationEngine("showPrompt",g,"error","bottomLeft",true);h.reject();return h.promise()}if(e=="edit"){var k=l.find('[name="reasonToEdit"]').val()}d.attr("disabled","disabled");var j=a.closest(".commentDetails").find(".commentInfoHeader");var f=j.data("commentid");var c=j.data("parentcommentid");m.saveCommentAjax(d,e,i,k,f,c,h);return h.promise()},registerCommentModalEvents:function(a){var b=this;a.on("click",".detailViewCommentModalBtn",function(g){var f=jQuery(g.currentTarget);var c=f.closest(".addCommentBlock");var d=c.find(".commentcontent").val();var h=c.find('[name="reasonToEdit"]').val();app.showModalWindow($(".commentModal").html(),function(){var e=$(".commentModalContent");e.find(".commentcontent").html(d);e.find('[name="reasonToEdit"]').val(h);if(f.data("mode")=="edit"){e.find(".reason").removeClass("hide")}else{e.find(".reason").addClass("hide")}$(".modalSaveComment").on("click",function(k){var j=jQuery(k.currentTarget);if(!j.is(":disabled")){var i=b.saveCommentModal(j,f);i.then(function(){b.registerRelatedModulesRecordCount();var l=a.find("[data-type='Comments']");b.loadWidget(l).then(function(){app.hideModalWindow();j.removeAttr("disabled")})})}})})});a.on("click",".commentModalBtn",function(g){var f=jQuery(g.currentTarget);var c=f.closest(".addCommentBlock");var d=c.find(".commentcontent").val();var h=c.find('[name="reasonToEdit"]').val();app.showModalWindow($(".commentModal").html(),function(){var e=$(".commentModalContent");e.find(".commentcontent").html(d);e.find('[name="reasonToEdit"]').val(h);if(f.data("mode")=="edit"){e.find(".reason").removeClass("hide")}else{e.find(".reason").addClass("hide")}$(".modalSaveComment").on("click",function(k){var j=jQuery(k.currentTarget);if(!j.is(":disabled")){var i=b.saveCommentModal(j,f);i.then(function(m){var l=b.getTabByLabel(b.detailViewRecentCommentsTabLabel);b.registerRelatedModulesRecordCount(l);b.addComment(f,m);app.hideModalWindow()})}})})})},addComment:function(c,g){var k=this;var h=c.data("mode");var d=c.closest(".addCommentBlock");var b=d.find(".commentcontent");var l=c.closest(".singleComment");b.val("");if(h=="add"){if($("#typeView").val()=="Timeline"){k.registerRefreshTimeline("last")}var i=g.result["id"];var f=k.getCommentUI(i);f.then(function(p){var s=d.closest(".commentDetails");var o=k.getContentHolder();var r=jQuery(".noCommentsMsgContainer",o);r.remove();if(s.length>0){d.remove();var n=s.find("ul");if(n.length<=0){var q=l.find(".viewThreadBlock").data("childCommentsCount");var u=q+1;l.find(".childCommentsCount").text(u);var t=l.find(".commentInfoHeader").data("commentid");k.getChildComments(t).then(function(v){jQuery(v).appendTo(s);l.find(".viewThreadBlock").hide();l.find(".hideThreadBlock").show()})}else{jQuery('<ul class="liStyleNone"><li class="commentDetails">'+p+"</li></ul>").appendTo(s)}}else{jQuery('<ul class="liStyleNone"><li class="commentDetails">'+p+"</li></ul>").prependTo(d.closest(".contents").find(".commentsList"))}l.find(".commentActionsContainer").show()})}else{if(h=="edit"){k.registerRefreshTimeline(l.find(".commentInfoHeader").data("commentid"));var e=l.find(".commentModifiedTime");var j=l.find(".commentInfoContent");var a=l.find('[name="editStatus"]');var m=l.find('[name="editReason"]');j.html(g.result.commentcontent);m.html(g.result.reasontoedit);e.text(g.result.modifiedtime);e.attr("title",g.result.modifiedtimetitle);if(a.hasClass("hide")){a.removeClass("hide")}if(g.result.reasontoedit!=""){l.find(".editReason").removeClass("hide")}j.show();l.find(".commentActionsContainer").show();d.remove()}}},registerCommentEvents:function(a){var b=this;b.registerCommentModalEvents(a);a.on("click",".addCommentBtn",function(d){b.removeCommentBlockIfExists();var c=b.getCommentBlock();c.appendTo(".commentBlock")});a.on("click",".closeCommentBlock",function(f){var d=jQuery(f.currentTarget);var c=d.closest(".singleComment");c.find(".commentActionsContainer").show();c.find(".commentInfoContent").show();b.removeCommentBlockIfExists()});a.on("click",".replyComment",function(g){b.removeCommentBlockIfExists();var f=jQuery(g.currentTarget);var d=f.closest(".singleComment");var c=b.getCommentBlock();d.find(".commentActionsContainer").hide();c.appendTo(d).show()});a.on("click",".editComment",function(i){b.removeCommentBlockIfExists();var h=jQuery(i.currentTarget);var d=h.closest(".singleComment");var g=d.find(".commentInfoContent");var f=d.find('[name="editReason"]');var c=b.getEditCommentBlock();c.find(".commentcontent").val(g.text());c.find('[name="reasonToEdit"]').val(f.text());g.hide();d.find(".commentActionsContainer").hide();c.appendTo(d).show()});a.on("click",".deleteComment",function(k){b.removeCommentBlockIfExists();var j=jQuery(k.currentTarget);var h=j.closest(".singleComment");var g=h.find(".commentInfoHeader");var i="index.php?module=ModComments&action=DeleteAjax&record="+g.data("commentid");var f=j.closest(".commentDetails");var c=f.find(".commentDetails");var d=f.find(".viewThreadBlock");if(c.length>0||d.length>0){Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_CAN_NOT_REMOVE_COMMENT"))}else{Vtiger_Helper_Js.showConfirmationBox({message:app.vtranslate("JS_DELETE_COMMENT_CONFIRMATION")}).then(function(e){AppConnector.request(i).then(function(m){if(m.success==true){f.fadeOut(400,function(){f.remove()});b.reloadTabContent();var l=b.getTabByLabel(b.detailViewRecentCommentsTabLabel);b.registerRelatedModulesRecordCount(l)}else{Vtiger_Helper_Js.showPnotify(m.error.message)}})},function(e,l){})}});a.on("click",".detailViewSaveComment",function(f){var d=jQuery(f.currentTarget);if(!d.is(":disabled")){var c=b.saveComment(f);c.then(function(){b.registerRelatedModulesRecordCount();var e=a.find("[data-type='Comments']");b.loadWidget(e).then(function(){d.removeAttr("disabled")})})}});a.on("click",".saveComment",function(g){var d=jQuery(g.currentTarget);if(!d.is(":disabled")){var f=jQuery(g.currentTarget);var c=b.saveComment(g);c.then(function(h){var e=b.getTabByLabel(b.detailViewRecentCommentsTabLabel);b.registerRelatedModulesRecordCount(e);b.addComment(f,h);d.removeAttr("disabled")})}});a.find(".commentsBar .switchBtn").on("switchChange.bootstrapSwitch",function(g,f){var d=b.getSelectedTab();var c=d.data("url");if(f){c=c.replace("type=List","type=Timeline");d.data("url",c)}else{c=c.replace("type=Timeline","type=List");d.data("url",c)}d.trigger("click")});a.on("click",".moreRecentComments",function(){var c=b.getTabByLabel(b.detailViewRecentCommentsTabLabel);c.trigger("click")})},registerMailPreviewWidget:function(a){var b=this;a.on("click",".showMailBody",function(g){var h=$(g.currentTarget).closest(".row");var d=h.find(".mailBody");var f=h.find(".mailTeaser");var c=$(g.currentTarget).find(".glyphicon");if(d.hasClass("hide")){d.removeClass("hide");f.addClass("hide");c.removeClass("glyphicon-triangle-bottom").addClass("glyphicon-triangle-top")}else{d.addClass("hide");f.removeClass("hide");c.removeClass("glyphicon-triangle-top").addClass("glyphicon-triangle-bottom")}});a.find('[name="mail-type"]').change(function(c){b.loadMailPreviewWidget(a)});a.find('[name="mailFilter"]').change(function(c){b.loadMailPreviewWidget(a)});a.on("click",".showMailsModal",function(f){var c=$(f.currentTarget).data("url");c+="&type="+a.find('[name="mail-type"]').val();if(a.find('[name="mailFilter"]').length>0){c+="&mailFilter="+a.find('[name="mailFilter"]').val()}var d=jQuery.progressIndicator();app.showModalWindow("",c,function(e){d.progressIndicator({mode:"hide"});b.registerMailPreviewWidget(e);Vtiger_Index_Js.registerMailButtons(e);e.find(".expandAllMails").click();e.find(".showMailModal").click(function(h){var g=jQuery.progressIndicator();app.showModalWindow("",$(h.currentTarget).data("url"),function(){g.progressIndicator({mode:"hide"})})})})});a.find(".expandAllMails").click(function(c){a.find(".mailBody").removeClass("hide");a.find(".mailTeaser").addClass("hide");a.find(".showMailBody .glyphicon").removeClass("glyphicon-triangle-bottom").addClass("glyphicon-triangle-top")});a.find(".collapseAllMails").click(function(c){a.find(".mailBody").addClass("hide");a.find(".mailTeaser").removeClass("hide");a.find(".showMailBody .glyphicon").removeClass("glyphicon-triangle-top").addClass("glyphicon-triangle-bottom")});a.find(".widget_contents").on(b.widgetPostLoad,function(d,c){Vtiger_Index_Js.registerMailButtons(a);a.find(".showMailModal").click(function(g){var f=jQuery.progressIndicator();app.showModalWindow("",$(g.currentTarget).data("url"),function(e){Vtiger_Index_Js.registerMailButtons(e);f.progressIndicator({mode:"hide"})})})})},loadMailPreviewWidget:function(a){var e=this;var b=a.find(".widget_contents");var d=$("#recordId").val();var c=b.progressIndicator();var f={};f.module="OSSMailView";f.view="widget";f.smodule=$("#module").val();f.srecord=d;f.mode="showEmailsList";f.type=$('[name="mail-type"]').val();f.mailFilter=$('[name="mailFilter"]').val();AppConnector.request(f).then(function(g){b.html(g);b.trigger(e.widgetPostLoad,{widgetName:"Emails"});c.progressIndicator({mode:"hide"})})},registerBasicEvents:function(){var c=this;var b=c.getContentHolder();var a=c.getSelectedTab();c.registerSummaryViewContainerEvents(b);c.registerCommentEvents(b);app.registerEventForDatePickerFields(b);app.registerEventForClockPicker();b.on("click","#detailViewNextRecordButton",function(g){var d=a.data("url");var f=c.getRelatedListCurrentPageNum();var i=parseInt(f)+1;var h=d+"&page="+i;c.loadContents(h)});b.on("click","#detailViewPreviousRecordButton",function(g){var d=a.data("url");var f=c.getRelatedListCurrentPageNum();var j=parseInt(f)-1;var i={};var h=d+"&page="+j;c.loadContents(h)});b.on("click","div.detailViewTable div.fieldValue",function(f){if(jQuery(f.target).closest("a").hasClass("btnNoFastEdit")){return}var d=jQuery(f.currentTarget);c.ajaxEditHandling(d)});b.on("click","div.recordDetails span.squeezedWell",function(g){var f=jQuery(g.currentTarget);var d=f.data("reference");jQuery('.detailViewInfo .related .nav > li[data-reference="'+d+'"]').trigger("click")});b.on("click",".relatedPopup",function(f){var d=new Vtiger_Edit_Js();d.openPopUp(f);return false});b.on("click",".viewThread",function(j){var i=jQuery(j.currentTarget);var h=i.parent();var d=i.closest(".commentActions");var f=i.closest(".commentDetails");var k=f.find("ul");if(k.length>0){k.show();d.find(".hideThreadBlock").show();h.hide();return}var g=i.closest(".commentDiv").find(".commentInfoHeader").data("commentid");c.getChildComments(g).then(function(e){jQuery(e).appendTo(jQuery(j.currentTarget).closest(".commentDetails"));d.find(".hideThreadBlock").show();h.hide()})});b.on("click",".hideThread",function(i){var h=jQuery(i.currentTarget);var g=h.parent();var d=h.closest(".commentActions");var f=h.closest(".commentDetails");f.find("ul").hide();g.hide();d.find(".viewThreadBlock").show()});b.on("click",".detailViewThread",function(h){var g=c.getTabByLabel(c.detailViewRecentCommentsTabLabel);var f=jQuery(h.currentTarget).closest(".singleComment").find(".commentInfoHeader").data("commentid");var d=function(e){window.location.href=window.location.href+"#"+f};g.trigger("click",{commentid:f,callback:d})});b.on("click",".moreRecentRecords",function(g){g.preventDefault();var d=jQuery(g.currentTarget);var f=c.getTabByLabel(d.data("label-key"));f.trigger("click")});b.on("click",".moreRecentUpdates",function(){var g=jQuery("#updatesCurrentPage").val();var f=jQuery("#recordId").val();var d=parseInt(g)+1;var e="index.php?module="+app.getModuleName()+"&view=Detail&record="+f+"&mode=showRecentActivities&page="+d+"&tab_label=LBL_UPDATES";AppConnector.request(e).then(function(h){jQuery("#updatesCurrentPage").remove();jQuery("#moreLink").remove();jQuery("#updates").append(h)},function(h,i){})});b.on("click",".moreRecentDocuments",function(){var d=c.getTabByLabel(c.detailViewRecentDocumentsTabLabel);d.trigger("click")});b.on("click",".moreRecentActivities",function(){var d=c.getTabByLabel(c.detailViewRecentActivitiesTabLabel);d.trigger("click")});b.off("switchChange.bootstrapSwitch").on("switchChange.bootstrapSwitch",".relatedContainer .switchBtn",function(h,g){var d=c.getTabByLabel(c.detailViewRecentActivitiesTabLabel);var f=d.data("url");f=f.replace("&time=current","");f=f.replace("&time=history","");f+="&time=";if(g){f+="current"}else{f+="history"}d.data("url",f);d.trigger("click")});c.registerEventForRelatedList();c.registerEventForRelatedListPagination();c.registerBlockAnimationEvent();c.registerMailPreviewWidget(b.find('.widgetContentBlock[data-type="EmailList"]'));if(a.data("reference")=="Comments"){c.registerRefreshTimeline()}},refreshRelatedList:function(){var a=jQuery(".related");var b=a.find(".dropdown");var i=a.find(".nav .dropdown-menu");var e=3;var h=15;var f=a.width();var g=0;var c=0;b.removeClass("hide");var d=b.width()+e;b.addClass("hide");c=f-d-h;a.find(".nav > .mainNav").each(function(j){jQuery(this).removeClass("hide");if(c>jQuery(this).width()){i.find('[data-reference="'+jQuery(this).data("reference")+'"]').addClass("hide");c-=Math.ceil(jQuery(this).width())+e}else{jQuery(this).addClass("hide");i.find('[data-reference="'+jQuery(this).data("reference")+'"]').removeClass("hide");c=0}});if(c===0){i.find(".relatedNav").removeClass("hide");a.find(".spaceRelatedList").addClass("hide");b.removeClass("hide")}else{c-=a.find(".spaceRelatedList").removeClass("hide").width()+e;a.find(".nav > .relatedNav").each(function(){jQuery(this).removeClass("hide");if(c>jQuery(this).width()){i.find('[data-reference="'+jQuery(this).data("reference")+'"]').addClass("hide");c-=Math.ceil(jQuery(this).width())+e}else{c=0;jQuery(this).addClass("hide");i.find('[data-reference="'+jQuery(this).data("reference")+'"]').removeClass("hide")}});if(c===0){b.removeClass("hide")}}},refreshCommentContainer:function(b){var c=this;var a=$(".commentsBody");var e={module:app.getModuleName(),view:"Detail",record:c.getRecordId(),mode:"showThreadComments",commentid:b};var d=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true,elementToBlock:a}});AppConnector.request(e).then(function(f){d.progressIndicator({mode:"hide"});a.html(f)})},registerRefreshTimeline:function(e){if($("#typeView").val()=="List"){return}var b=this;var a={width:"100%",height:"100%",layout:"portrait",timenav_position:"top",marker_height_min:48,marker_width_min:150,marker_padding:5,scale_factor:1,optimal_tick_width:700,slide_padding_lr:100,slide_default_fade:"0%",language:app.getLanguage().substring(0,2)};var d={module:"ModComments",srcModule:app.getModuleName(),action:"TimelineAjax",record:b.getRecordId()};var c=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true,elementToBlock:b.getContentHolder()}});if(typeof e=="undefined"){e=$("#currentComment").val()}AppConnector.request(d).then(function(h){c.progressIndicator({mode:"hide"});var g=h.result;if(typeof g.events!="undefined"){var f=new TL.Timeline("timeline",g,a);f.on("change",function(j){var k=j.unique_id;b.refreshCommentContainer(k.substr(2,k.length-2))});if(!e||e=="last"){if(g.events.length==1){var i=g.events[0].unique_id;b.refreshCommentContainer(i.substr(2,i.length-2))}else{f.goToEnd()}}else{if(g.events[g.events.length-1].unique_id=="Id"+e){b.refreshCommentContainer(e)}else{f.goToId("Id"+e)}}}else{b.refreshCommentContainer()}})},updateRecordsPDFTemplateBtn:function(a){var b={};b.data={module:"Vtiger",action:"PDF",mode:"hasValidTemplate",record:app.getRecordId(),modulename:app.getModuleName(),view:app.getViewName()};b.dataType="json";AppConnector.request(b).then(function(f){var c=f.result;var e=jQuery(".detailViewToolbar .btn-toolbar");if(c.valid==false){var d=e.find('.btn-group:eq(1) [href*="showPdfModal"]');if(d.length){d.remove()}}else{var g=e.find(".btn-group:eq(1)");var d=e.find('.btn-group:eq(1) [href*="showPdfModal"]');if(d.length==0){g.append('<a class="btn btn-default popoverTooltip" href=\'javascript:Vtiger_Header_Js.getInstance().showPdfModal("index.php?module='+app.getModuleName()+"&view=PDF&fromview=Detail&record="+app.getRecordId()+'");\' data-content="'+app.vtranslate("LBL_EXPORT_PDF")+'" data-original-title="" title=""><span class="glyphicon glyphicon-save-file icon-in-button"></span></a>')}}},function(d,c){app.errorLog(d,c)})},registerEvents:function(){var b=this;b.refreshRelatedList();this.registerHelpInfo();b.registerSendSmsSubmitEvent();b.registerAjaxEditEvent();this.registerRelatedRowClickEvent();this.registerBlockStatusCheckOnLoad();this.registerEmailFieldClickEvent();this.registerPhoneFieldClickEvent();this.registerEventForEmailsRelatedRecord();this.registerEventForAddingEmailFromRelatedList();this.registerPostTagCloudWidgetLoad();this.registerEventForRelatedTabClick();Vtiger_Helper_Js.showHorizontalTopScrollBar();this.registerUrlFieldClickEvent();var a=jQuery("div.detailViewContainer");if(a.length<=0){return}this.registerBasicEvents();this.registerSetReadRecord(a);b.registerEventForPicklistDependencySetup(b.getForm());b.getForm().validationEngine(app.validationEngineOptionsForRecord);b.loadWidgets();this.registerEventForTotalRecordsCount();this.registerGetAllTagCloudWidgetLoad();var c=Vtiger_Header_Js.getInstance();c.registerQuickCreateCallBack(this.registerRelatedModulesRecordCount)}});