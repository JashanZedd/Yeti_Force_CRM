
jQuery.Class("Vtiger_TreeCategory_Js",{},{modalContainer:false,treeInstance:false,treeData:false,getModalContainer:function(){if(this.modalContainer==false){this.modalContainer=jQuery("#globalmodal .modal-content")}return this.modalContainer},getRecords:function(b){if(this.treeData==false&&b!="undefined"){var a=b.find("#treePopupValues").val();this.treeData=JSON.parse(a)}return this.treeData},generateTree:function(a){var b=this;if(b.treeInstance==false){b.treeInstance=a.find("#treePopupContents");b.treeInstance.jstree({core:{data:b.getRecords(),themes:{name:"proton",responsive:true}},plugins:["checkbox","search"]})}},searching:function(a){this.treeInstance.jstree(true).search(a)},registerSearchEvent:function(){var c=this;var a=$("#valueSearchTree");var b=$("#btnSearchTree");a.keypress(function(d){if(d.which==13){c.searching(a.val())}});b.click(function(){c.searching(a.val())})},registerSaveRecords:function(b){var f=this;var a=[];var e=[];var c=[];var d=[];$.each(f.getRecords(),function(g,h){if(h.state.selected){a.push(h.record_id)}});b.find('[name="saveButton"]').on("click",function(g){$(this).attr("disabled","disabled");$.each(f.treeInstance.jstree("get_selected",true),function(h,i){if(jQuery.inArray(i.original.record_id,a)==-1){c.push(i.original.record_id)}e.push(i.original.record_id)});$.each(a,function(h,i){if(jQuery.inArray(i,e)==-1){d.push(i)}});AppConnector.request({module:app.getModuleName(),action:"RelationAjax",mode:"updateRelation",toAdd:c,toRemove:d,src_record:app.getRecordId(),related_module:b.find('[name="related_module"]').val(),}).then(function(i){var h=jQuery(".related li.active");h.trigger("click");app.hideModalWindow()})})},registerCounterSelected:function(){var a=this;this.treeInstance.on("changed.jstree",function(f,c){var d=0;var b="";$.each(a.treeInstance.jstree("get_selected",true),function(e,g){var h=g.original.record_id.toString();if(h.indexOf("T")){d++}});b=app.vtranslate("JS_SELECTED_ELEMENTS")+": "+d;$(".counterSelected").text(b)})},registerEvents:function(){var a=this.getModalContainer();this.getRecords(a);this.generateTree(a);this.registerSaveRecords(a);this.registerSearchEvent();this.registerCounterSelected()}});jQuery(function(){var a=new Vtiger_TreeCategory_Js();a.registerEvents()});